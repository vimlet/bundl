<template>
  <div class="workweek-break-rows">
    <div class="workweek-break-type">
      <eon-variable class="workweek-break-label" bind="locale.registry.type" global="true"></eon-variable>
      <eon-combo eon-ref="type" bind:placeholder="global locale.registry.type" label-anim="false" filter="true"
        class="workweek-break-field workweek-break-marginright" inline="false">
      </eon-combo>
    </div>
    <div class="workweek-break-rows">
      <div class="workweek-break-from workweek-break-marginright">
        <div class="workweek-break-cols">
          <eon-variable class="workweek-break-label" bind="locale.from" global="true"></eon-variable>
          <div class="workweek-break-date">
            <eon-combo eon-ref="startDay" filter="true" class="workweek-break-dayCombo workweek-break-grow" inline="false">
            </eon-combo>

            <eon-date eon-ref="startHour" class="from-time plan-range-field workweek-break-grow workweek-break-time" time="true"
              date="false" mask="DDMMYYYY" value-format="hh:mm" inline="false">
            </eon-date>
          </div>
        </div>
      </div>

      <div class="workweek-break-to">
        <div class="workweek-break-cols">
          <eon-variable class="workweek-break-label" bind="locale.to" global="true"></eon-variable>
          <div class="workweek-break-date">
            <eon-combo eon-ref="endDay" filter="true" class="workweek-break-dayCombo workweek-break-grow" inline="false">
            </eon-combo>
            <eon-date eon-ref="endHour" class="to-time plan-range-field workweek-break-grow workweek-break-time" time="true" date="false"
              mask="DDMMYYYY" value-format="hh:mm" inline="false">
            </eon-date>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="workweek-break-actions">
    <div eon-ref="deleteClickable" class="action-icon delete-icon vicon-bin clickable">
    </div>
  </div>
</template>

<script>
  eon.element("workweek-break", {
    style: "workweek-break.css",
    parse: true,

    dependencies: [
      "@ui/eon-date",
      "@ui/eon-combo"
    ],
    properties: {
      refs: {
        value: {}
      },
      entryDay: {
        value: 1
      },
      exitDay: {
        value: 1
      },
      weekStart: {
        value: 1
      },
      entryHour: {
        value: ""
      },
      exitHour: {
        value: ""
      },
      type: {
        value: "break"
      },
      notes: {
        value: ""
      },
      position: {
        value: {}
      }, 
      constraint: {
        value: false
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function _getValue (private)
      getValue: function () {
        var el = this;

        var values = {
          entryDay: el._refs.startDay.value,
          exitDay: el._refs.endDay.value,
          entryHour: el._refs.startHour.value,
          exitHour: el._refs.endHour.value,
          type: eon.util.isTrue(el.isBreak) ? el._refs.type.value : "activity",
          isBreak: eon.util.isTrue(el.isBreak),
          notes: el.notes,
          position: el.position,
          constraint: el.constraint
        };

        return values;
      },
    },
    privateFunctions: {
      // @function _setupAdvRefs (private)
      setupAdvRefs: function () {
        this._refs.locationDialog = document.querySelector("#entry-location-dialog");
        this._refs.editNotesDialog = document.querySelector("#edit-notes-dialog");
      },
      // @function _setInitialValues (private)
      setInitialValues: function () {
        var el = this;
        el._refs.startDay.onReady(function () {
          el._setupDaysSelector();
          
          el._refs.startDay.value = el.entryDay;
          el._refs.endDay.value = el.exitDay;
          el._refs.startHour.value = el.entryHour ? el.entryHour : "";
          el._refs.endHour.value = el.exitHour ? el.exitHour : "";
        });

        el._setTypes();

        el._refs.type.onReady(function () {
          el._refs.type.value = el.type;
        });
      },
      // @function _setTypes (private)
      setTypes: function () {
        var el = this;
        var combo = el._refs.type;
        var item, valueNumber;
        var types = ["break", "food"];
        if (eon.util.isTrue(el.isBreak)) {
          // Create range combo items
          for (var i = 0; i < types.length; i++) {
            item = document.createElement("eon-item");
            item.setAttribute("value", types[i]);
            item.setAttribute("display-value", eon.locale.events[types[i]]);
            combo.addItem(item);
          }
        } else {
          el.classList.add("no-type");
          var label = el.querySelector(".workweek-break-type .workweek-break-label");
          label.parentNode.classList.add("hide");
          combo.parentNode.removeChild(combo);
          label.parentNode.removeChild(label);
        }
      },
      // @function _setupDelete (private)
      setupDelete: function () {
        var el = this;

        el.addEventListener("transitionend", function (e) {

          if (e.propertyName == "opacity" && el._misc.removed) {
            setTimeout(function () {
              if (el.parentNode) {
                el.parentNode.removeChild(el);
              }
            }, 200);
          }

        });

        el._refs.deleteClickable.addEventListener("click", function () {
          el._misc.removed = true;
          el.classList.add("workweek-break-hidden");
        });
      },
      // @function _setupDaysSelector (private)
      setupDaysSelector: function () {
        var el = this;
        var dayCombos = el.querySelectorAll(".workweek-break-dayCombo");
        var day;
        
        for (var i = 0; i < dayCombos.length; i++) {
          day = dayCombos[i];
          
          if (el.constraint) {
            el._fillDays(day, parseInt(el.constraint), true);
          } else {
            el._fillDays(day);
          }

        }
      },

      // @function _fillDays(private)
      fillDays: function (combo, from, weekday) {
        var el = this;
        var dayItem;

        combo.clearItems();

        var to = from && el._refs.startDay == combo ? from + 1 : 7;
        from = from && el._refs.startDay == combo ? from : 0;

        for (var i = from; i < to; i++) {
          dayItem = document.createElement("eon-item");
         
          dayItem.value = weekday && el._refs.startDay == combo ? i : (i + el.weekStart) % 7;
          dayItem.displayValue = eon.locale.workspace.plans[el._weekdayName(dayItem.value)];
          combo.addItem(dayItem);
        }
      },

       /*
        @function (private) _weekdayName
        @description 
      */
      weekdayName: function (index) {
        var el = this;
        var weekDays = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];

        return weekDays[index];
      },
    },
    onTransformed: function () {
      this._setupAdvRefs();
      this._setInitialValues();
      this._setupDelete();
    },
  });
</script>