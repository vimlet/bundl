<template>
  <eon-text class="app-editable-text-content" label-anim="false" inline="false" eon-ref="content">
  </eon-text>
  <div class="app-editable-text-action app-editable-text-hide" eon-ref="action">
    <div class="app-editable-text-action-buttons">
      <eon-button bind:label="global locale.global.accept" design="filled" eon-ref="addAccept">
      </eon-button>
      <eon-button bind:label="global locale.global.cancel" design="filled" eon-ref="addCancel">
      </eon-button>
    </div>
  </div>
  <div class="app-editable-text-measure" eon-ref="measure"></div>
</template>

<script>
  eon.element("app-editable-text", {
    style: "app-editable-text.css",
    dependencies: [
      "@ui/eon-text",
      "@ui/eon-button"
    ],

    properties: {
      // @html-attribute placeholder
      placeholder: {
        value: "",
        reflect: true
      },
      // @html-attribute placeholderExpanded [If set, the placeholder will change when expanded]
      placeholderExpanded: {
        value: "",
        reflect: true
      },
      // @html-attribute value
      value: {
        value: "",
        reflect: true
      },
      // @html-attribute color [Font color]
      color: {
        value: "",
        reflect: true
      },
      // @html-attribute saveOnBlur
      saveOnBlur: {
        value: "false",
        reflect: true
      },
      // @html-attribute revertOnBlur [If no saveOnBlur and revertOnBlur is enabled, the text will go back to value when blur]
      revertOnBlur: {
        value: "false",
        reflect: true
      },
      // @html-attribute editable [If set to false the text is not editable. Default true]
      editable: {
        value: "true",
        reflect: true,
        reflectDefault: true
      },
      // @html-attribute type [area or input]
      type: {
        value: "input"
      },
      // @html-attribute fixedWidth [Prevent component from resizing. Default false]
      fixedWidth: {
        value: "false"
      },
      // @html-attribute widthPadding [Component width from text. There is a class "app-editable-text-measure" that needs to be resize according to text style in order to give a correct measure]
      widthPadding: {
        value: "10"
      },
      // @html-attribute footer [Footer with accept/cancel buttons]
      footer: {
        value: "true",
        reflect: true,
        reflectDefault: true
      },
      // @html-attribute open [Element is open]
      open: {
        value: "false",
        reflect: true,
        reflectDefault: true
      },
      // @html-attribute boxShadow [Box shadow when open]
      boxShadow: {
        value: "false",
        reflect: true,
        reflectDefault: true
      },
      // @html-attribute doubleClick [Edit mode on double click]
      doubleClick: {
        value: "false",
        reflect: true
      },
      // @ html-attribute autoGrow (public) [Pass attribute to eon-text]
      autoGrow: {
        value: false
      }
    },

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function setEditable (public) @param value
      setEditable: function (value) {
        var el = this;
        if (eon.util.isTrue(value)) {
          el._refs.content.onReady(function () {
            el._refs.content.readonly = "false";
          });
        } else {
          el._refs.content.onReady(function () {
            el._refs.content.readonly = "true";
          });
        }
      },
      // @function setPlaceholder (public) @param value
      setPlaceholder: function (value) {
        var el = this;
        el._refs.content.onReady(function () {
          el._refs.content.placeholder = value;
          el.adjustWidth();
        });
      },
      // @function setColor (public) @param value
      setColor: function (value) {
        var el = this;
        el._refs.content.onReady(function () {
          if (el.type === "input") {
            el._refs.content._refs.input.style.color = value;
          } else if (el.type === "area") {
            el._refs.content._refs.editableArea.style.color = value;
          }
        });
      },
      // @function focus (public)
      focus: function () {
        var el = this;
        setTimeout(function () {
          el._refs.content.focus();
        }, 0);
      },
      // @function setCursorToEnd (public) [Set cursor position at the end]
      setCursorToEnd: function () {
        var el = this;
        var content = el.type === "area" ? el._refs.content.querySelector(".eon-text-editable") : el._refs
          .content.querySelector("input");          
        setTimeout(function () {          
          content.selectionStart = content.selectionEnd = content.value ? content.value.length ? content.value.length : 10000 : 10000;


          // setTimeout(() => {
          //   console.log("trigger");
          //   // content.scrollRight = content.scrollWidth;

          //   var keyboardEvent = document.createEvent("KeyboardEvent");
          //   var initMethod = typeof keyboardEvent.initKeyboardEvent !== 'undefined' ?
          //     "initKeyboardEvent" : "initKeyEvent";
          //   keyboardEvent[initMethod](
          //     "keydown", // event type: keydown, keyup, keypress
          //     true, // bubbles
          //     true, // cancelable
          //     window, // view: should be window
          //     false, // ctrlKey
          //     false, // altKey
          //     false, // shiftKey
          //     false, // metaKey
          //     37, // keyCode: unsigned long - the virtual key code, else 0
          //     0 // charCode: unsigned long - the Unicode character associated with the depressed key, else 0
          //   );
          //   document.dispatchEvent(keyboardEvent);



          //   // if (typeof window.getSelection != "undefined" &&
          //   //   typeof document.createRange != "undefined") {
          //   //   var range = document.createRange();
          //   //   range.selectNodeContents(content);
          //   //   range.collapse(false);
          //   //   var sel = window.getSelection();
          //   //   sel.removeAllRanges();
          //   //   sel.addRange(range);
          //   // } else if (typeof document.body.createTextRange != "undefined") {
          //   //   var textRange = document.body.createTextRange();
          //   //   textRange.moveToElementText(content);
          //   //   textRange.collapse(false);
          //   //   textRange.select();
          //   // }
          // }, 2000);

        }, 0);
      },

      // // @function setCursorToEnd (public) [Set cursor position at the end]
      // setCursorToEnd: function () {
      //   var el = this;
      //   var content = el.type === "area" ? el._refs.content.querySelector(".eon-text-editable") : el._refs
      //     .content;
      //   if (typeof window.getSelection != "undefined" &&
      //     typeof document.createRange != "undefined") {
      //     var range = document.createRange();
      //     range.selectNodeContents(content);
      //     range.collapse(false);
      //     var sel = window.getSelection();
      //     sel.removeAllRanges();
      //     sel.addRange(range);
      //   } else if (typeof document.body.createTextRange != "undefined") {
      //     var textRange = document.body.createTextRange();
      //     textRange.moveToElementText(content);
      //     textRange.collapse(false);
      //     textRange.select();
      //   }
      // },

      // // @function _setCursorToEnd (private) [Set cursor position at the end] @param el
      // setCursorToEnd: function (el) {
      //   if (typeof window.getSelection != "undefined" &&
      //     typeof document.createRange != "undefined") {
      //     var range = document.createRange();
      //     range.selectNodeContents(el);
      //     range.collapse(false);
      //     var sel = window.getSelection();
      //     sel.removeAllRanges();
      //     sel.addRange(range);
      //   } else if (typeof document.body.createTextRange != "undefined") {
      //     var textRange = document.body.createTextRange();
      //     textRange.moveToElementText(el);
      //     textRange.collapse(false);
      //     textRange.select();
      //   }
      // },

      // @function setValue (public) [Set value] @param value
      setValue: function (value) {
        var el = this;
        el._refs.content.value = value;
        el.adjustWidth();
      },
      // @function showFooter (public) [Show footer]
      showFooter: function () {
        var el = this;
        if (eon.util.isTrue(el.footer)) {
          el._refs.action.classList.remove("app-editable-text-hide");
          el._refs.content.classList.add("app-editable-text-expanded");
          el._refs.measure.classList.add("app-editable-text-expanded");
          if (el.placeholderExpanded) {
            el._refs.content.placeholder = el.placeholderExpanded;
          }
        }
      },
      // @function hideFooter (public) [Hide footer]
      hideFooter: function () {
        var el = this;
        if (eon.util.isTrue(el.footer)) {
          el._refs.action.classList.add("app-editable-text-hide");
          el._refs.content.classList.remove("app-editable-text-expanded");
          el._refs.measure.classList.remove("app-editable-text-expanded");
          if (el.placeholderExpanded) {
            el._refs.content.placeholder = el.placeholder;
          }
        }
      },
      // @function adjustWidth (private) [Adjust component width to text] @param event [Last letter event]
      adjustWidth: function (event) {
        var el = this;
        if (!eon.util.isTrue(el.fixedWidth)) {
          if (el._refs.content.value && el._refs.content.value != "" && !event || (el._refs.content.value.length >
              1 || (
                event && (event.keyCode != 46 && event.keyCode != 8)))) {
            el._refs.measure.innerText = el._refs.content.value;
            if (event && event.keyCode != 46 && event.keyCode != 8) {
              el._refs.measure.innerText = el._refs.measure.innerText + event.key;
            }
            setTimeout(function () {
              var measureWidth = (el._refs.measure.clientWidth + parseInt(el.widthPadding) + 1) + "px";
              el._refs.content.style.width = measureWidth;
            }, 0);
          } else {
            if (el._misc.focus && el.placeholderExpanded && el.placeholderExpanded != "") {
              el._refs.measure.innerText = el.placeholderExpanded;
            } else {
              el._refs.measure.innerText = el.placeholder;
            }
            var measureWidth = (el._refs.measure.clientWidth + parseInt(el.widthPadding) + 1) + "px";
            el._refs.content.style.width = measureWidth;
          }
        }
      }
    },

    privateFunctions: {
      // @function init (private)
      init: function () {
        var el = this;
        el.setValue(el.value);
        el.setEditable(el.editable);
        el.setPlaceholder(el.placeholder);
        el.setColor(el.color);
        if (el.type === "area") {
          el._refs.content.type = "area";
        }
        el._refs.content.autoGrow = el.autoGrow;
        el._setUp();
      },
      // @function setUp (private)
      setUp: function (value) {
        var el = this;
        el._addListeners();
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        el._refs.content.onBlur(function (e) {
          if (el._misc.focus) {
            setTimeout(function () {
              if (!el._misc.forcedBlur && eon.util.isTrue(el.saveOnBlur)) {
                el._onEdit();
                el.open = false;
                el._misc.focus = false;
                el.hideFooter();
              }
              if (!eon.util.isTrue(el.saveOnBlur) && eon.util.isTrue(el.revertOnBlur)) {
                if (el._refs.content.value != el.value) {
                  el._refs.content.value = el.value;
                }
              }
              if (!el._refs.content.value || el._refs.content.value == "") {
                el.hideFooter();
                el._refs.content.value = "";
                el.open = false;
                el._misc.focus = false;
              }
              el.adjustWidth();
            }, 0);
          }
          eon.triggerCallback("onBlur", el, el);
        });
        el._refs.content.onFocus(function () {
          el.open = true;
          el._misc.focus = true;
          el._misc.startValue = el._refs.content.value;
          el.adjustWidth();
          el.showFooter();
          eon.triggerCallback("onOpen", el, el);
        });
        el._refs.addAccept.addEventListener("mousedown", function (e) {
          el._onAccept(e);
        });
        el._refs.addAccept.addEventListener("pointerdown", function (e) {
          el._onAccept(e);
        });
        el._refs.addCancel.addEventListener("mousedown", function (e) {
          el._onCancel(e);
        });
        el._refs.addCancel.addEventListener("pointerdown", function (e) {
          el._onCancel(e);
        });
        el._refs.content.addEventListener("keydown", function (event) {
          if (event.isComposing || event.keyCode === 229) {
            return;
          } else if ((event.shiftKey || event.ctrlKey) && (event.keyCode === 13 || event.keyCode === 10)) {
            return true;
          } else if (event.keyCode === 13) {
            el._submit();
            return false;
          } else {
            el.adjustWidth(event);
          }
        });
        el.addEventListener("dblclick", function (event) {
          if (eon.util.isTrue(el.doubleClick) && !eon.util.isTrue(el.open)) {
            el.editable = true;
            el._refs.content._refs.input.blur();
            el._refs.content.readonly = "false";
            el.focus();
            el.open = true;
            el._misc.focus = true;
            el._misc.startValue = el._refs.content.value;
            el.setCursorToEnd();
            el.adjustWidth();
            el.showFooter();
          }
        });
        // el.addEventListener("click", function (e) {          
        //   e.preventDefault();
        //   e.stopPropagation();
        // });
        // el._refs.action.addEventListener("click", function (e) {          
        //   e.preventDefault();
        //   e.stopPropagation();
        // });
        // el._refs.action.addEventListener("pointerdown", function (e) {          
        //   e.preventDefault();
        //   e.stopPropagation();
        // });
        // el._refs.action.addEventListener("mousedown", function (e) {          
        //   e.preventDefault();
        //   e.stopPropagation();
        // });
      },
      // @function _submit (private) [Submit changes]
      submit: function () {
        var el = this;
        if (!el._misc.submitting) {
          el._misc.submitting = true;
          el._misc.forcedBlur = true;
          el._onEdit();
          if (el.type === "input") {
            el._refs.content._refs.input.blur();
          } else if (el.type === "area") {
            el._refs.content._refs.editableArea.blur();
          }
          setTimeout(function () {
            el._misc.forcedBlur = false;
            el._misc.submitting = false;
            el.open = false;
            el._misc.focus = false;
          }, 50);
        }
      },
      // @function _onEdit (private) [Actions when the text is edited]
      onEdit: function () {
        var el = this;
        if (el.value != el._refs.content.value) {
          el.value = el._refs.content.value;
        }
        eon.triggerCallback("onEdit", el, el, [el.value]);
      },
      // @function _selectContent (private) [Select content of content editable] @param el
      selectContent: function (el) {
        setTimeout(function () {
          var range = document.createRange();
          range.selectNodeContents(el);
          var sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }, 0);
      },
      // @function _onAccept (private) [Actions when accept button is pressed] @param event
      onAccept: function (event) {
        var el = this;
        if (event.button == 0) {
          el._submit();
        }
        event.preventDefault();
        event.stopPropagation();
      },
      // @function _onCancel (private) [Actions when cancel button is pressed] @param event
      onCancel: function (event) {
        var el = this;
        if (event.button == 0) {
          el._refs.content.value = el._misc.startValue || "";
          el.open = false;
          el._misc.focus = false;
          if (el.type != "area" && !eon.util.isTrue(el.preventNative)) {
            el._refs.content.querySelector("input").blur();
          }
          el.hideFooter();
        }
        event.preventDefault();
        event.stopPropagation();
      }
    },

    onCreated: function () {
      var el = this;
      eon.createCallback("onEdit", el);
      eon.createCallback("onBlur", el);
      eon.createCallback("onOpen", el);
    },
    onRender: function () {
      var el = this;
      el._init();
    },
    onPropertyChanged: function (key, oldVal, newVal) {
      switch (key) {
        case "value":
          this.setValue(newVal);
          break;
        case "placeholder":
          this.setPlaceholder(newVal);
          break;
        case "color":
          this.setColor(newVal);
          break;
        case "editable":
          this.setEditable(newVal);
          break;
      }
    }
  });
</script>