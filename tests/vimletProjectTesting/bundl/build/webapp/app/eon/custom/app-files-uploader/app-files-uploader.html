<template>
  <!-- <eon-form default-style="false" eon-ref="form"> -->
  <div class="app-files-uploader hide" eon-ref="drop">
    <div eon-ref="description"></div>
    <input type="file" multiple accept="" eon-ref="input">
    <eon-button design="filled" eon-ref="select">
    </eon-button>
  </div>
  <!-- </eon-form> -->
</template>

<script>
  eon.element("app-files-uploader", {
    style: "app-files-uploader.css",
    dependencies: [
      // "@ui/eon-form",
      "@ui/eon-text",
      "@ui/eon-button"
    ],

    properties: {
      // @html-attribute value
      value: {
        value: "",
        observe: true
      },
      // @html-attribute buttonLabel
      buttonLabel: {
        value: "",
        reflect: true
      },
      // @html-attribute description
      description: {
        value: "",
        observe: true
      },
      // @html-attribute accept [Accepted formats]
      accept: {
        value: "",
        reflect: true
      },
      // @html-attribute dropNode [Element to drop elements]
      dropNode: {
        value: ""
      },
      // @html-attribute selectButton [Given button to open file chooser]
      selectButton: {
        value: ""
      },
      // @html-attribute showUploader [Show uploader by default.]
      showUploader: {
        value: "true"
      }

    },

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function setButtonLabel (public) 
      setButtonLabel: function (value) {
        var el = this;
        el._refs.select.onBubbleRender(function () {
          if (value && value != "") {
            el._refs.select.setAttribute("label", value);
          } else {
            el._refs.select.setAttribute("label", "Select images");
          }
        });
      },
      // @function setDescription (public) @param value
      setDescription: function (value) {
        var el = this;
        if (value && value != "") {
          var select = document.createElement("eon-variable");
          select.setAttribute("global", true);
          select.setAttribute("bind", value);
          el._refs.description.appendChild(select);
        }
      },
      // @function onChange (public) [Handle files upload event]
      onChange: function (files) {
        var el = this;
        eon.triggerCallback("onUpload", el, el, [files]);
      }
    },

    privateFunctions: {
      // @function init (private)
      init: function () {
        var el = this;
        el.setButtonLabel(el.buttonLabel);
        el.setDescription(el.description);
        el._refs.input.setAttribute("accept", el.accept);
        if (eon.util.isTrue(el.showUploader)) {
          el._refs.drop.classList.remove("hide");
        }
        el._setUp();
      },
      // @function setUp (private)
      setUp: function (value) {
        var el = this;
        el._addListeners();
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        var dropArea = el._selectDropArea();
        dropArea.addEventListener("dragenter", function (e) {
          if (el._areDragFiles(e)) {
            dropArea.classList.add("highlight");
            eon.triggerCallback("onDragHoverEnter", el, el, [e]);
            e.preventDefault();
            e.stopPropagation();
          }
        }, false);
        dropArea.addEventListener("dragover", function (e) {
          if (el._areDragFiles(e)) {
            dropArea.classList.add("highlight");
            eon.triggerCallback("onDragHoverEnter", el, el, [e]);
            e.preventDefault();
            e.stopPropagation();
          }
        }, false);
        dropArea.addEventListener("dragleave", function (e) {
          if (el._areDragFiles(e)) {
            dropArea.classList.remove("highlight");
            eon.triggerCallback("onDragHoverLeave", el, el, [e]);
            e.preventDefault();
            e.stopPropagation();
          }
        }, false);
        dropArea.addEventListener("drop", function (e) {
          if (el._areDragFiles(e)) {
            dropArea.classList.remove("highlight");
            eon.triggerCallback("onDragHoverLeave", el, el, [e]);
            el.onChange(e.dataTransfer.files);
            e.preventDefault();
            e.stopPropagation();
          }
        }, false);
        el._refs.select.addEventListener("click", function () {
          el._refs.input.value = "";
          el._refs.input.click();
        });
        el._refs.input.addEventListener("change", function () {
          el.onChange(el._refs.input.files);
        });
        if (el.selectButton && el.selectButton != "") {
          if (!Array.isArray(el.selectButton)) {
            el.selectButton = [el.selectButton];
          }
          for (var i = 0; i < el.selectButton.length; i++) {
            el.selectButton[i].addEventListener("click", function () {
              el._refs.input.value = "";
              el._refs.input.click();
            });
          }
        }
      },
      // @function _selectDropArea (private) [Select element where files can be drop. It may be an element passed by user or the default one]
      selectDropArea: function () {
        var el = this;
        return el.dropNode != "" ? el.dropNode : el._refs.drop;
      },
      // @function _areDragFiles (private) [Are drag elements files] @param event
      areDragFiles: function (event) {
        var el = this;
        var areFiles = false;
        if (event.dataTransfer.types) {
          for (var i = 0; i < event.dataTransfer.types.length; i++) {
            if (event.dataTransfer.types[i] == "Files") {
              areFiles = true;
              break;
            }
          }
        }
        return areFiles;
      }
    },

    onCreated: function () {
      var el = this;
      eon.createCallback("onUpload", el);
      eon.createCallback("onDragHoverEnter", el);
      eon.createCallback("onDragHoverLeave", el);
    },

    onRender: function () {
      var el = this;
      el._init();
    },

    onPropertyChanged: function (key, oldVal, newVal) {
      var el = this;
      switch (key) {
        case "buttonLabel":
          el.setButtonLabel(newVal);
          break;
        case "description":
          el.setDescription(newVal);
          break;
        case "value":
          break;
      }
    }



  });
</script>