<template>
  <div class="app-color-label hide" eon-ref="label"></div>
  <div class="app-color-layout">
    <div eon-ref="button"></div>
    <i class="app-color-custom app-color-margin-top eon-fg2-hoverable" eon-ref="custom">
      <div class="app-color-preview app-color-margin-top" eon-ref="preview"></div>
    </i>
    <eon-scroll static="true" type="horizontal" thickness="8">
      <div class="app-color-predefined hide" eon-ref="predefined"></div>
    </eon-scroll>
    <input type="color" eon-ref="input">
  </div>
</template>

<script>
  eon.element("app-color", {
    style: "app-color.css",

    dependencies: [
      "@ui/eon-button",
      "@ui/eon-scroll"
    ],

    properties: {
      /*
        @html-attribute {String} label
      */
      label: {
        value: "",
        reflect: true
      },
      // @html-attribute predefined (public) [Predefined colors separated by ",". If there are no predefined colors the option won't be shown]
      predefined: {
        value: "",
        observe: true
      },
      // @html-attribute preview (public) [A box showing the selected color. Default true]
      preview: {
        value: "true",
        reflect: true
      },
      // @html-attribute button (public) [Show clickable button to open input color selector]
      button: {
        value: "true",
        reflect: true
      },
      // @html-attribute icon (public) [Button icon]
      icon: {
        value: "ticon-edit",
        reflect: true
      },
      // @html-attribute buttonLabel (public) [Text for the button]
      buttonLabel: {
        value: "",
        reflect: true
      },
      // @html-attribute value (public)
      value: {
        value: "#ffffff",
        reflect: true
      }
    },

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function setValue (public) @param value
      setValue: function (value) {
        var el = this;
        value = value || el.value;
        el._refs.preview.style.backgroundColor = value;
      },
      // @function setLabel (public) @param label
      setLabel: function (label) {
        var el = this;

        if (label && label != "") {
          el._refs.label.innerText = label;
          el._refs.label.classList.remove("hide");
        } else {
          el._refs.label.classList.add("hide");
        }
      },
      // @function setPredefined (public) @param predefined
      setPredefined: function (predefined) {
        var el = this;
        if (predefined && predefined != "") {
          el._refs.predefined.innerHTML = "";
          predefined = predefined.split(",");
          var fragment = document.createDocumentFragment();
          for (var i = 0; i < predefined.length; i++) {
            var current = document.createElement("div");
            current.classList.add("app-color-predefined-color");
            current.style.backgroundColor = predefined[i];
            current.setAttribute("bcolor", predefined[i]);
            current.addEventListener("click", function () {
              // Deselect previous
              if (el._refs.selected) {
                el._refs.selected.classList.remove("selected");
              }
              el.value = this.getAttribute("bcolor");
              // Highlight current     
              this.classList.add("selected");
              el._refs.selected = this;
              eon.triggerCallback("onSelected", el, el, [el.value]);
            }, false);
            fragment.appendChild(current);
          }
          el._refs.predefined.appendChild(fragment);
          el._refs.predefined.classList.remove("hide");
        } else {
          el._refs.predefined.classList.add("hide");
        }
      }
    },

    privateFunctions: {
      // @function _init (private)
      init: function () {
        var el = this;

        el._setUp();
        if (el.label && el.label != "") {
          el.setLabel(el.label);
        }
        if (el.predefined && el.predefined != "") {
          el.setPredefined(el.predefined);
        }
      },
      // @function setUp (private)
      setUp: function (value) {
        var el = this;
        if (eon.util.isTrue(el.button)) {
          el._misc.button = document.createElement("eon-button");
          el._misc.button.value = el.buttonLabel;
          if (el.icon) {
            el._misc.button.icon = "<i class='" + el.icon + "'></i>";
          }
          el._refs.button.appendChild(el._misc.button);
        }
        if (!eon.util.isTrue(el.preview)) {
          el._refs.input.style.display = "none";
        }
        el._refs.custom.classList.add(el.icon);
        el.setValue();
        el._addListeners();
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        el._refs.button.addEventListener("click", function () {
          var defColor = el.value;
          defColor = defColor === "#ffffff" ? "#e8e8e8" : defColor;
          el._refs.input.value = defColor;
          el._refs.input.click();
        });
        el._refs.custom.addEventListener("click", function () {
          var defColor = el.value;
          defColor = defColor === "#ffffff" ? "#e8e8e8" : defColor;
          el._refs.input.value = defColor;
          el._refs.input.click();
        });
        el._refs.input.addEventListener("input", function () {
          el.value = this.value;
          // Deselect previous
          if (el._refs.selected) {
            el._refs.selected.classList.remove("selected");
          }
          // el.value = this.getAttribute("bcolor");
          // Highlight current     
          el._refs.custom.classList.add("selected");
          el._refs.selected = el._refs.custom;
        }, false);
      }
    },


    onCreated: function () {
      eon.createCallback("onSelected", this);
    },
    onBubbleRender: function () {
      var el = this;
      el._init();
    },

    onPropertyChanged: function (key, oldVal, newVal) {
      var el = this;
      switch (key) {
        case "value":
          el.setValue(newVal);
          break;
        case "label":
          el.setLabel(newVal);
          break;
        case "predefined":
          el.setPredefined(newVal);
          break;
        case "buttonLabel":
          el._misc.button.value = newVal;
          break;
      }
    }
  });
</script>