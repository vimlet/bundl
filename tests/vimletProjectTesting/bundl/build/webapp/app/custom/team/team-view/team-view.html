<template>
  <div>
    <app-generic-bar title="locale.workspace.userTitle" button="global locale.workspace.buttons.invite"
      eon-ref="membersBar">
    </app-generic-bar>
    <app-pagination eon-ref="usersPagination" container="users-grid"></app-pagination>
    <member-grid id="users-grid" class="grid" eon-ref="membersGrid"></member-grid>
  </div>

  <div>
    <app-generic-bar title="locale.workspace.groups.title" button="global locale.workspace.groups.create"
      eon-ref="groupsBar">
    </app-generic-bar>
    <app-pagination eon-ref="groupsPagination" container="groups-grid"></app-pagination>
    <groups-grid id="groups-grid" class="grid" eon-ref="groupsGrid"></groups-grid>
  </div>

  <!-- Group dialog -->
  <eon-dialog id="groupDialog" class="dialog-form interactDialog" allow-scroll="false" default-style="false"
    modal="true" blur="true" eon-ref="groupsDialog">
    <eon-section type="content">
      <groups-form eon-ref="groupsForm"></groups-form>
      <eon-loading eon-ref="groupsMask" duration="10000" class="form-mask" format="descendant" display="false">
      </eon-loading>
    </eon-section>
    <eon-section type="footer" class="form-actions">
      <eon-button bind:value="global locale.global.delete" design="delete" class="hide delete-button"
        eon-ref="groupsDialogDelete">
      </eon-button>
      <eon-button bind:value="global locale.global.accept" eon-ref="groupsDialogAccept"></eon-button>
    </eon-section>
  </eon-dialog>

  <!-- Edit member dialog -->
  <eon-dialog id="member-edit-dialog" class="dialog-form interactDialog"
    bind:heading="global locale.workspace.dialogTitles.editMember" modal="true" blur="true" default-style="false"
    eon-ref="editMemberDialog">
    <eon-section type="content">
      <member-form eon-ref="memberFormEdit"></member-form>
      <eon-loading eon-ref="memberEditMask" duration="10000" class="form-mask" format="descendant" display="false">
      </eon-loading>
    </eon-section>
    <eon-section type="footer" class="form-actions">
      <eon-button id="member-delete" eon-ref="memberDelete" design="delete" class="delete-button"
        bind:value="global locale.workspace.buttons.delete"></eon-button>
      <eon-button id="member-apply" eon-ref="memberApply" class="" bind:value="global locale.workspace.buttons.apply">
      </eon-button>
    </eon-section>
  </eon-dialog>

  <!-- Reinvite member dialog -->
  <eon-dialog id="member-reinvite-dialog" eon-ref="reinviteDialog" class="alertDialog reinvite-dialog" modal="true"
    blur="true" bind:heading="global locale.member.reinviteText" default-style="false">
    <eon-section type="content">
      <eon-form eon-ref="reinviteForm" default-style="false">
        <eon-text bind:label="global locale.member.inviteMail" eon-ref="reinviteMail" id="member-reinvite-mail" class="form-text"
          bind:placeholder="global locale.member.mailPlaceHolder" name="mail" label-anim="false" inline="false">
        </eon-text>
      </eon-form>
    </eon-section>
    <eon-section type="footer">
      <eon-button id="member-reinvite-button" eon-ref="reinviteButton" bind:value="global locale.member.reinviteButton">
      </eon-button>
    </eon-section>
  </eon-dialog>


  <!-- MASK -->
  <eon-mask>
    <div class="mask-title-row">
      <div class="mask-title eon-mask-background1"></div>
      <div class="mask-button eon-mask-background1"></div>
    </div>

    <div class="mask-row mask-grid-titles eon-mask-background1"></div>

    <div class="mask-grid-content">
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
    </div>

    <div class="mask-title-row">
      <div class="mask-title eon-mask-background1"></div>
      <div class="mask-button eon-mask-background1"></div>
    </div>

    <div class="mask-row mask-grid-titles eon-mask-background1"></div>

    <div class="mask-grid-content">
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
    </div>
  </eon-mask>

</template>

<script>
  eon.element({
    name: "team-view",
    style: "team-view.css",
    parse: true,

    dependencies: [
      "member-grid",
      "member-form",
      "groups-grid",
      "groups-form",
      "@custom/app-generic-bar",
      "@custom/app-pagination"
    ],

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function refresh (public)
      refresh: function () {
        var el = this;
        var membersData;
        var groupsData;

        // Show container masks
        mask.showViewMask("member-grid");
        mask.showViewMask("groups-grid");

        el._refs.membersGrid.clean();
        el._refs.groupsGrid.clean();
        
        if (session.isAdmin()) {
          el._loadData(null, function (error, data) {
            if (!error) {
              el._misc.data = data;
              el._refs.usersPagination.setPaginationItems(el._misc.data, "members");
              el._refs.groupsPagination.setPaginationItems(el._misc.data, "groups");
            }
          });
        } else {
          // Redirect to home view
          if (document.body.dataset.view == "team") {
            showView("home");
          }
        }
      }
    },
    privateFunctions: {
      // @function _drawStatic (private)
      drawStatic: function () {
        var el = this;

        // Hide view mask after language loaded at least
        eon.onLocaleLoaded(function(){
          // Minimun mask time to avoid flickering
          setTimeout(function(){
            // Hide home mask
            mask.hideViewMask("team");
            el.hideEonMask();
          }, 100);
        });
      },
      // @function _loadData (private) [Load data from database] @param filters @param callback
      loadData: function (filters, callback) {
        var el = this;
        if (session.isAdmin()) {
          readWorkspace(session.data.currentWorkspaceId, function (error, data) {
            if (!error) {
              session.data.currentWorkspace = data;
              callback(null, data);
            }
          });
        } else {
          if (callback) {
            callback(null, {});
          }
        }
      },
      // @function _addListener (private)
      addListener: function () {
        var el = this;

        this._refs.addMemberDialog = $1("#member-add-dialog");

        this._refs.addMemberDialog.onReady(function () {
          el._refs.memberFormAdd = el._refs.addMemberDialog.$1("member-form");
          el._refs.memberAddMask = el._refs.addMemberDialog.$1("eon-loading");
        });

        // Members 
        el._refs.membersBar.onButtonClick(function () {
          el._refs.addMemberDialog._misc.data = {
            role: "user"
          };

          // Do not remove this since it coulbe useful for invitation requests
          el._refs.memberFormAdd._misc.workspaceId = session.data.currentWorkspaceId;

          util.resetCallback("onOpened", el._refs.addMemberDialog);

          el._refs.addMemberDialog.onOpened(function () {
            el._refs.memberFormAdd.clear();

            readWorkspace(session.data.currentWorkspaceId, function (error, data) {
              if (!error) {

                session.data.currentWorkspace = data;

                el._refs.memberFormAdd.setData(data, el._refs.addMemberDialog._misc.data);
                el._refs.memberAddMask.hide();
              } else {
                el._refs.inviteForm._refs.linkInput.value = "";
                el._refs.memberFormAdd._hideLink();
              }
            });
          });

          // TODO change to declarative value
          el._refs.memberFormAdd.onSubmit(function (error, data) {
            if (!validateEmail(data.mail)) {
              error = true;
              this.querySelector(".member-mail").invalid = true;
            } else {
              this.querySelector(".member-mail").invalid = false;
            }

            if (!error) {
              inviteMember(session.data.currentWorkspaceId, data.mail, data, function (error, invData) {
                if (!error) {
                  el._loadData(null, function (error, data) {
                    el._misc.data = data;
                    el._refs.usersPagination.setPaginationItems(data, "members");
                  });
                } else{
                  showInfoDialog(eon.locale.member.inviteSelfError);
                }
              });
              // el._refs.addMemberDialog.close();
            }
          });

          el._refs.memberFormAdd.showInviteFields();
          el._refs.addMemberDialog.open();
          // Push dialog state
          pushDialogState(el._refs.addMemberDialog);
        });
        el._refs.membersGrid.onEditMember(function (memberEntry) {
          el._refs.editMemberDialog._misc.memberEntry = memberEntry;

          el._refs.memberFormEdit.showEditFields();
          el._refs.editMemberDialog.open();
          // Push dialog state
          pushDialogState(el._refs.editMemberDialog);
        });

        el._memberListener();

        // Groups
        el._refs.groupsBar.onButtonClick(function () {
          el._refs.groupsDialog.heading = eon.locale.workspace.groups.create;
          el._misc.groupDialogStatus = "add";
          el._refs.groupsDialogDelete.classList.add("hide");
          el._misc.groupId = "";

          el._refs.groupsDialog.open();
           // Push dialog state
           pushDialogState(el._refs.groupsDialog);
        });
        el._refs.groupsGrid.onEdit(function (groupId) {
          el._refs.groupsDialog.heading = eon.locale.workspace.groups.edit;
          el._misc.groupDialogStatus = "edit";
          el._refs.groupsDialogDelete.classList.remove("hide");
          el._misc.groupId = groupId;
          el._refs.groupsDialog.open();
          // Push dialog state
          pushDialogState(el._refs.groupsDialog);
        });

        el._groupsListener();
      },
      // @function _memberListener (private) [Manage members listeners]
      memberListener: function () {
        var el = this;

        // EDIT MEMBER
        el._refs.editMemberDialog.onClose(function () {
          el._refs.memberEditMask.hide();
        });
        el._refs.editMemberDialog.onOpen(function () {
          el._refs.memberEditMask.show();
        });
        el._refs.editMemberDialog.onOpened(function () {
          el._refs.memberFormEdit.clear();

          readWorkspace(session.data.currentWorkspaceId, function (error, data) {
            if (!error) {
              session.data.currentWorkspace = data;
              el._refs.memberFormEdit.setData(data, el._refs.editMemberDialog._misc.memberEntry._misc.data);

              el._refs.memberEditMask.hide();
            }
          });
        });

        el._refs.memberFormEdit.onSubmit(function (error, data) {
          // Inject member user id
          data.userId = el._refs.editMemberDialog._misc.memberEntry._misc.data.userId;
          if (!error) {
            if (data.delete) {
              delete data.delete;
              deleteMember(session.data.currentWorkspaceId, data, function (error, data) {
                if (!error) {
                  el._misc.data = data;
                  el._refs.usersPagination.setPaginationItems(data, "members");
                } else {
                  if (data.status == 403) {
                    showInfoDialog(eon.locale.workspace.alert.memberOwnerDeleteFailed);
                  } else {
                    showInfoDialog(eon.locale.workspace.alert.error);
                  }
                }
              });
            } else {
              updateMember(session.data.currentWorkspaceId, data, function (error, data) {
                if (!error) {
                  el._misc.data = data;
                  el._refs.membersGrid.refresh(data);
                } else {
                  showInfoDialog(eon.locale.workspace.alert.error);
                }
              });
            }
            el._refs.editMemberDialog.close();
          }
        });
        el._refs.memberFormEdit.setReadOnly();

        // REINVITE MEMBER
        el._refs.reinviteButton.addEventListener("click", function () {
          el._misc.reinviteFn(el._refs.reinviteDialog._misc.data);
        });

        el._refs.reinviteDialog.onOpened(function () {
          el._misc.data.currentMail = el._refs.reinviteMail.value;
        });

        el._refs.membersGrid.onReinviteMember(function (memberEntry) {
          el._refs.reinviteDialog._misc.data = memberEntry;
          el._refs.reinviteMail.value = memberEntry._misc.data.mail;

          el._refs.reinviteDialog.open();
          // Push dialog state
          pushDialogState(el._refs.reinviteDialog);
        });
      },
      // @function _groupsListener (private) [Manage groups listeners]
      groupsListener: function () {
        var el = this;

        el._refs.groupsDialog.onClose(function () {
          el._refs.groupsMask.hide();
        });
        el._refs.groupsDialog.onOpen(function () {
          el._refs.groupsForm.clear();
          var dataCopy = JSON.parse(JSON.stringify(el._misc.data));
          if (el._misc.groupId) {
            el._refs.groupsForm.setChecks(dataCopy, el._misc.groupId);
          } else {
            el._refs.groupsForm.setChecks(dataCopy);
          }
          el._refs.groupsMask.show();
        });

        el._refs.groupsDialog.onOpened(function () {
          el._refs.groupsMask.hide();
        });

        el._refs.groupsDialogAccept.addEventListener("click", function () {
          el._groupDialogAccept();
        });
        el._refs.groupsDialogDelete.addEventListener("click", function () {
          el._groupDialogDelete(el._misc.groupId);
        });
      },
      // @function _setupReinviteForm (private)
      setupReinviteForm: function () {
        var el = this;

        el._refs.reinviteSchema = {
          properties: {
            "mail": {
              required: true
            }
          }
        };

        el._misc.reinviteFn = function (memberEntry) {
          var formData = el._refs.reinviteForm.getData();

          // Inject member user id
          formData.userId = memberEntry._misc.data.userId;

          el._refs.reinviteForm.validate(el._refs.reinviteSchema, null, function (error) {
            if (!error) {

              reinviteMember(session.data.currentWorkspaceId, el._misc.data.currentMail, formData,
                function (error, data) {

                  if (!error) {

                    if (data.status == "204") {
                      showInfoDialog(eon.locale.workspace.alert.isMember);
                    } else {
                      data = JSON.parse(data.responseText);
                      // Refresh user data
                      memberEntry._misc.data.userId = data.id;
                      memberEntry._misc.data.mail = data.mail;
                      el._misc.data.currentMail = data.mail;
                    }

                  }
                });

              el._refs.reinviteDialog.close();
            }
          });
        }
      },
      // @function _groupDialogAccept (private) [Actions to take when group dialog accept button is pressed]
      groupDialogAccept: function () {
        var el = this;
        el._refs.groupsForm.validate(function (error, data) {
          if (!error) {
            if (el._misc.groupDialogStatus === "add") {
              var url = "/rest/workspace/group/" + session.data.currentWorkspaceId;
              eon.ajax(url, {
                contentType: "application/json",
                payload: JSON.stringify(data),
                method: "POST"
              }, function (error, data) {
                if (!error) {
                  el._misc.data = JSON.parse(data.responseText);
                  el._refs.groupsPagination.setPaginationItems(el._misc.data, "groups");
                  el._refs.groupsDialog.close();
                } else if (data.status == 401) {
                  showInfoDialog(eon.locale.workspace.groups.alert.creationFailed,
                    function () { });
                }
              });
            } else if (el._misc.groupDialogStatus === "edit") {
              var url = "/rest/workspace/group/" + session.data.currentWorkspaceId + "/" + el._misc.groupId;
              eon.ajax(url, {
                contentType: "application/json",
                payload: JSON.stringify(data),
                method: "PUT"
              }, function (error, data) {
                if (!error) {
                  el._misc.data = JSON.parse(data.responseText);
                  el._refs.groupsGrid.refresh(el._misc.data);
                  el._refs.groupsDialog.close();
                } else if (data.status == 401) {
                  showInfoDialog(eon.locale.workspace.groups.alert.editionFailed,
                    function () { });
                }
              });
            }
          }
        });
      },
      // @function _groupDialogDelete (private) [Actions to take when group dialog delete button is pressed] @param groupId
      groupDialogDelete: function (groupId) {
        var el = this;

        el._refs.groupsForm.validateDelete(function (error, data) {
          if (!error) {
            var url = "/rest/workspace/group/" + session.data.currentWorkspaceId + "/" + groupId;
            eon.ajax(url, {
              contentType: "application/json",
              method: "DELETE"
            }, function (error, data) {
              if (!error) {
                el._misc.data = JSON.parse(data.responseText);
                el._refs.groupsPagination.setPaginationItems(el._misc.data, "groups");
                // el._refs.groupsGrid.refresh(el._misc.data);
                el._refs.groupsDialog.close();
              } else if (data.status == 401) {
                showInfoDialog(eon.locale.workspace.groups.alert.deletionFailed,
                  function () { });
              }
            });

          }
        });

      }
    },
    onTransformed: function () {
      // Draw static content
      this._drawStatic();
      this._setupReinviteForm();
      this._addListener();
    },
    onReady: function () {
      var el = this;

      session.onReady(function () {
        el.refresh();
      });
      session.onWorkspaceChanged(function () {
        el.refresh();
      });
    }
  });
</script>