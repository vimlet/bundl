<template>
  <!-- GPS information dialog -->
  <eon-dialog id="location-dialog" class="info-dialog alertDialog" default-style="false" modal="true" closable="false">
    <eon-section type="content">
      <eon-variable class="main-title" bind="locale.home.dialog.title" global="true"></eon-variable>
      <eon-variable class="location-message" bind="locale.home.dialog.subTitle" global="true"></eon-variable>
    </eon-section>
  </eon-dialog>
  <div class="location-dialog-mask eon-bg0"></div>
  <landing-wizard eon-ref="wizard"></landing-wizard>

  <!-- Create workspace -->
  <eon-dialog id="workspace-create-dialog" eon-ref="createWorkspaceDialog" class="dialog-workspace interactDialog"
    bind:heading="global locale.workspace.dialogTitles.create" modal="true" blur="true" default-style="false">
    <eon-section type="content">
      <workspace-form standalone="false"></workspace-form>
    </eon-section>
    <eon-section type="footer" class="form-actions">
      <eon-button id="workspace-create-apply" class="" eon-ref="workspaceCreateApply"
        bind:value="global locale.workspace.buttons.apply"></eon-button>
    </eon-section>
  </eon-dialog>

  <task-dialog id="taskDialog"></task-dialog>

  <!-- Join Workspace -->
  <eon-dialog id="joinWorkspaceDialog" class="alertDialog footerless"
    bind:heading="global locale.main.dialog.joinAction" modal="true" default-style="false">
    <eon-section type="content">
      <div class="join-content">
        <eon-text id="join-code" bind:label="global locale.main.dialog.invitation"
          bind:placeholder="global locale.main.dialog.code" name="code" label-anim="false" inline="false"></eon-text>
        <eon-button id="join-workspace" bind:label="global locale.main.dialog.join" onclick="joinWorkspaceSubmit()">
        </eon-button>
      </div>
    </eon-section>
  </eon-dialog>

  <!-- Add member dialog -->
  <eon-dialog id="member-add-dialog" class="dialog-form interactDialog"
    bind:heading="global locale.workspace.dialogTitles.inviteMember" modal="true" blur="true" default-style="false">
    <eon-section type="content">
      <member-form></member-form>
      <eon-loading duration="10000" class="form-mask" format="descendant" display="false">
      </eon-loading>
    </eon-section>
  </eon-dialog>

  <!-- Delete confirmation -->
  <eon-dialog id="deleteDialog" class="alertDialog" modal="true" closable="false" default-style="false">
    <eon-section type="content">
      <div class="main-title">
        <eon-variable bind="locale.main.dialog.deleteTitle" global="true"></eon-variable>
      </div>
      <div class="main-buttons">
        <eon-button id="delete-confirmation" bind:label="global locale.main.dialog.deleteContinue"></eon-button>
        <eon-button bind:label="global locale.main.dialog.cancel"
          onclick="document.querySelector('#deleteDialog').close()"></eon-button>
      </div>
    </eon-section>
  </eon-dialog>

  <!-- Delete Alert -->
  <eon-dialog id="deleteAlert" modal="true" class="alertDialog" closable="false" default-style="false">
    <eon-section type="content">
      <eon-variable class="delete-title" bind="locale.main.dialog.alertDelete" global="true"></eon-variable>

      <div class="main-text" id="delete-text"></div>
      <eon-form eon-ref="formDelete" default-style="false">
        <div>
          <eon-text bind:label="global locale.user.password" name="deletePassword" class="form-text" type="password"
            label-anim="false" inline="false">
          </eon-text>
        </div>
        <div class="form-actions">
          <eon-button id="deleteAlert-confirmation" design="delete" class="delete-button"
            bind:value="global locale.main.dialog.deleteButton"></eon-button>
          <eon-button bind:label="global locale.main.dialog.cancel"
            onclick="document.querySelector('#deleteAlert').close()"></eon-button>
        </div>
      </eon-form>
    </eon-section>
  </eon-dialog>

  <!-- Alert dialog -->
  <eon-dialog id="alert-dialog" modal="true" class="alertDialog" blur="true" closable="false" default-style="false">
    <eon-section type="content"></eon-section>
    <eon-section type="footer" location="right">
      <eon-button bind:label="global locale.main.dialog.ok" design="flat"
        onclick="document.querySelector('#alert-dialog').close()"></eon-button>
    </eon-section>
  </eon-dialog>

  <!-- Confiramation dialog -->
  <eon-dialog id="confirm-dialog" class="alertDialog" modal="true" closable="false" default-style="false">
    <eon-section type="content"></eon-section>
    <eon-section type="footer" location="right">
      <eon-button id="confirm-dialog-cancel" bind:label="global locale.global.cancel" design="flat"
        onclick="document.querySelector('#confirm-dialog').close()"></eon-button>
      <eon-button id="confirm-dialog-accept" class="dialog-accept-button" bind:value="global locale.global.accept">
      </eon-button>
    </eon-section>
  </eon-dialog>

  <div id="toast"></div>

  <!-- Main menu -->
  <eon-sticky class="main-menu" wrapper-class="main-menu-wrapper">
    <!-- Wizard back button -->
    <i class="wizard-back-btn hide vicon vicon-arrow-back"></i>

    <!-- Menu icon -->
    <span id="main-menu-icon" class="built-menu-icon collapsed clickable">
      <div class="built-chevron-left">
        <div class="built-line"></div>
        <div class="built-line"></div>
      </div>
      <div class="built-icon">
        <span class="built-icon-bar1"></span>
        <span class="built-icon-bar2"></span>
        <span class="built-icon-bar3"></span>
      </div>
      <div class="built-chevron-right">
        <div class="built-line"></div>
        <div class="built-line"></div>
      </div>
    </span>

    <div class="main-menu-workspace">
      <workspace-menu id="main-workspace" anchor="left" layout="body"></workspace-menu>
    </div>
    <div class="logo-icon">
      <span></span>
    </div>
    <!-- Desktop -->
    <div class="user">
      <app-avatar class="menuAvatar"></app-avatar>
      <!-- <i class="vicon vicon-contact"></i> -->
      <div class="user-name"></div>
      <!-- TODO both combo and context can't be use right now -->
      <eon-combo id="user-settings-combo" dropdown-min-width="150" class="user-combo lineless-combo" input="false"
        origin=".user">
        <eon-item bind:display-value="global locale.main.sticky.settings" eon-ref="userSettingsMenu" value="settings">
        </eon-item>
        <eon-item bind:display-value="global locale.main.sticky.logout" value="logout"></eon-item>
      </eon-combo>
    </div>
    <i class="vicon vicon-notifications main-view-notifications" data-tooltip="notifications" onclick="showView('notifications')">
      <div class="main-view-notifications-new hide" eon-ref="notificationUnread"></div>
    </i>
  </eon-sticky>
  <div class="drawer-placeholder"></div>
  <!-- Left menu -->
  <eon-drawer spacing="38" class="left-menu" type="left" drag="false" hide="true" static="true" static-limit="1470"
    prevent-close-nodes=".built-menu-icon, .eon-combo-overlay">
    <div class="drawer-overlay-holder"></div>

    <workspace-menu id="drawer-workspace" anchor="left" layout="body"></workspace-menu>

    <!-- Drawer menu icon -->
    <span id="drawer-menu-icon" class="built-menu-icon clickable">
      <div class="built-chevron-left">
        <div class="built-line"></div>
        <div class="built-line"></div>
      </div>
      <div class="built-icon">
        <span class="built-icon-bar1"></span>
        <span class="built-icon-bar2"></span>
        <span class="built-icon-bar3"></span>
      </div>
      <div class="built-chevron-right">
        <div class="built-line"></div>
        <div class="built-line"></div>
      </div>
    </span>

    <div class="section-btn home-section-btn ticon ticon-home eon-unselectable" data-tooltip="home" onclick="showView('home')"
      onmousedown="this.parentElement.parentElement._middleButton(event,'home')">
      <span></span>
      <eon-variable class="section-menu-title" bind="locale.home.title" global="true"></eon-variable>
    </div>
    <!-- <div class="section-btn calendar-section-btn ticon ticon-calendar eon-unselectable" onclick="showView('calendar')">
      <span></span>
      <eon-variable class="section-menu-title" bind="locale.calendar.title" global="true"></eon-variable>
    </div> -->
    <div class="section-btn projects-section-btn ticon ticon-projects eon-unselectable" data-tooltip="projects" onclick="showView('projects')"
      onmousedown="this.parentElement.parentElement._middleButton(event,'projects')">
      <span></span>
      <eon-variable class="section-menu-title" bind="locale.projects.title" global="true"></eon-variable>
    </div>
    <div class="section-btn registry-section-btn ticon ticon-activity eon-unselectable" data-tooltip="activity" onclick="showView('registry')"
      onmousedown="this.parentElement.parentElement._middleButton(event,'registry')">
      <span></span>
      <eon-variable class="section-menu-title" bind="locale.registry.title" global="true"></eon-variable>
    </div>
    <div id="team-btn" class="section-btn team-section-btn ticon ticon-users eon-unselectable admin-item hide" data-tooltip="team" 
      onclick="showView('team')" onmousedown="this.parentElement.parentElement._middleButton(event,'team')">
      <span></span>
      <eon-variable class="section-menu-title" bind="locale.team.title" global="true"></eon-variable>
    </div>
    <div class="section-btn report-section-btn ticon ticon-reports eon-unselectable" data-tooltip="report" onclick="showView('report')"
      onmousedown="this.parentElement.parentElement._middleButton(event,'report')">
      <span></span>
      <eon-variable class="section-menu-title" bind="locale.report.title" global="true"></eon-variable>
    </div>
    <div class="section-btn business-section-btn ticon vicon-pms eon-unselectable admin-item hide" data-tooltip="business" 
      onclick="showView('business')" onmousedown="this.parentElement.parentElement._middleButton(event,'business')">
      <span></span>
      <eon-variable class="section-menu-title" bind="locale.business.title" global="true"></eon-variable>
    </div>
    <div id="backoffice-btn" class="section-btn back-section-btn vicon vicon-globe eon-unselectable hide"
      onclick="showView('back', {}, false)">
      <span></span>
      <div class="section-menu-title">Back Office</div>
    </div>
    <!-- PLACEHOLDER -->
    <div class="section-btn placeholder-btn"></div>

    <div id="plan-info" class="admin-item">
      <div id="plan-current">
        <span></span>
        <b class="eon-fg0"></b>
      </div>
      <div id="plan-upgrade-btn">
        <i id="plan-icon" class="ticon ticon-upgrade eon-fg2-hoverable"></i>
        <eon-variable id="plan-upgrade-label" bind="locale.workspace.fields.upgrade" global="true"></eon-variable>
      </div>
    </div>
  </eon-drawer>

</template>
<script>
  eon.element("main-view", {
    parse: true,
    properties: {
      refs: {
        value: {}
      }
    },
    dependencies: [
      "@custom/eon-drawer",
      "@custom/app-avatar",
      "@custom/app-toggle-menu", //Delete
      "@ui/eon-loading",
      "@ui/eon-sticky",
      "../landing-wizard",
      "../workspace-menu",
      "../../workspace/workspace-view/workspace-form",
      "../../projects/projects-view/task-dialog",
      "../../team/team-view/member-form"
    ],
    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },

    functions: {
      // @function activateNotificationBell (public) [Light the notification bell so the user will know about new notifications]
      activateNotificationBell: function () {
        var el = this;
        el._refs.notificationUnread.classList.remove("hide");
      },
      // @function deactivateNotificationBell (public) [Turn off the notification bell]
      deactivateNotificationBell: function () {
        var el = this;
        el._refs.notificationUnread.classList.add("hide");
      }
    },

    privateFunctions: {
      // @function _init (private)
      init: function () {
        this._addListeners();
        eon.onLocaleLoaded(function () {
          popup.setupTooltips(this);  
        });
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        notification.onNotification_viewed(function () {
          el.deactivateNotificationBell();
        });
        notification.onNotification_new(function () {
          el.activateNotificationBell();
        });

        // Invite listeners
        var inviteDlg = this.$1("#member-add-dialog");
        
        inviteDlg.onReady(function(){
          var memberFormAdd = inviteDlg.$1("member-form");
          var memberFormMask = inviteDlg.$1("eon-loading");

          inviteDlg.onClose(function () {
            memberFormMask.hide();
          });
          inviteDlg.onOpen(function () {
            memberFormMask.show();
          });
        });
      },
      // @function _middleButton (private) [Detect middle mouse button click and open in new tab]
      middleButton: function (event, view) {
        var el = this;
        if (event.button === 1) {
          var pathname = "/app/" + view;
          var url = window.location.origin + pathname + window.location.search;
          window.open(url, '_blank');

          // var a = document.createElement("a");
          // a.href = url;
          // var evt = document.createEvent("MouseEvents");
          // // evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, true, false, false, false, 0,null);
          // evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 1, null);
          // // evt.initMouseEvent("click", true, true, window, 0, 0, 0, 101, 101, false, false, false, false, 1,null);
          // a.dispatchEvent(evt);

          // var a = document.createElement("a");
          // a.href = url;
          // var middleClick = new MouseEvent( "click", { "button": 1, "which": 2 });
          // a.dispatchEvent(middleClick);

          // var a = document.createElement("a");
          // a.href = url;
          // a.target='_blank';
          // var evt = document.createEvent("MouseEvents");
          // evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0,
          //   true, false, false, false, 0, null);
          // a.dispatchEvent(evt);
        }
      }
    },
    onTransformed: function () {
      var el = this;
      setMomentLocale(navigator.language.split("-")[0] == "es" ? "es" : "en");

      setupMenus();
      el._init();

      session.onReady(function () {

        session.toggleAdminItems();

        notification.check(function (isAny) {
          if (isAny) {
            el.activateNotificationBell();
          }
        });
        task.init();
      });
      this._refs.wizard.onReady(function(){
        session.getSession();
      });
    }
  });
</script>