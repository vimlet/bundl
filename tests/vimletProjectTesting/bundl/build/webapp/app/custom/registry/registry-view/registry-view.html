<template>

  <div class="title-row">
    <eon-variable class="section-title eon-fg-h1" bind="locale.registry.title" global="true"></eon-variable>
    <div class="action-buttons">
      <eon-button class="bar-button h1-button registry-bar-create" eon-ref="create"
        bind:label="global locale.registry.new" icon="<i class='vicon vicon-add'></i>" design="filled"></eon-button>
      <!-- <eon-button class="bar-button h1-button" eon-ref="batch" bind:label="global locale.registry.createBatch"
        icon="<i class='vicon vicon-list'></i>" design="filled"></eon-button> -->
    </div>
  </div>

  <registry-filter eon-ref="filter"></registry-filter>

  <registry-grid class="grid" eon-ref="grid"></registry-grid>

  <registry-filter search="false" eon-ref="noSearchFilter"></registry-filter>

  <!-- Edit registry dialog -->
  <eon-dialog id="registry-edit-dialog" class="dialog-form registry-dialog interactDialog" eon-ref="editDialog"
    default-style="false" bind:heading="global locale.registry.editTitle" modal="true" blur="true" allow-scroll="false">
    <eon-section type="content">
      <registry-edit></registry-edit>
    </eon-section>
    <eon-section type="footer" class="registry-view-actions form-actions">
      <eon-button eon-ref="editDelete" design="delete" class="edit-delete-button delete-button dialog-button"
        bind:value="global locale.registry.deleteButton">
      </eon-button>
      <eon-button eon-ref="editApply" class="edit-apply-button ghost dialog-button"
        bind:value="global locale.registry.applyButton">
      </eon-button>
      <eon-button eon-ref="editNext" class="edit-next-button" bind:value="global locale.registry.nextButton">
      </eon-button>
    </eon-section>
  </eon-dialog>

  <!-- Create dialog -->
  <eon-dialog id="registry-create-dialog" class="dialog-form registry-dialog interactDialog" eon-ref="createDialog"
    default-style="false" bind:heading="global locale.registry.createTitle" modal="true" blur="true"
    allow-scroll="false">
    <eon-section type="content" class="batch-section">
      <registry-create></registry-create>
      <eon-loading class="form-mask registry-create-mask" duration="60000" display="false" format="descendant">
      </eon-loading>
    </eon-section>
    <eon-section type="footer" class="registry-view-actions form-actions">
      <eon-button class="create-delete-button delete-button dialog-button hide" design="delete"
        bind:value="global locale.registry.deleteButton">
      </eon-button>
      <eon-button eon-ref="batchApply" class="create-apply-button ghost dialog-button"
        bind:value="global locale.registry.applyButton">
      </eon-button>
      <eon-button eon-ref="batchNext" class="create-next-button" bind:value="global locale.registry.nextButton">
      </eon-button>
    </eon-section>
  </eon-dialog>

  <!-- Show event notes dialog -->
  <eon-dialog id="show-notes-dialog" class="dialog-form" eon-ref="notesDialog" default-style="false"
    bind:heading="global locale.registry.notesTitle" modal="true" blur="true" allow-scroll="false">
    <eon-section type="content">
      <div class="note-text"></div>
    </eon-section>
    <eon-section type="footer">
      <eon-button class="accept-button" value="OK" onclick="document.querySelector('#show-notes-dialog').close()">
      </eon-button>
    </eon-section>
  </eon-dialog>

  <!-- Edit event notes dialog -->
  <eon-dialog id="edit-notes-dialog" class="dialog-form interactDialog" eon-ref="editNotesDialog" default-style="false"
    bind:heading="global locale.registry.notesTitle" modal="true" blur="true" allow-scroll="false">
    <eon-section type="content">
      <eon-text type="area" class="note-text" area-height="170"></eon-text>
    </eon-section>
    <eon-section type="footer">
      <eon-button class="accept-button" bind:value="global locale.registry.applyButton"
        onclick="document.querySelector('#show-notes-dialog').close()"></eon-button>
    </eon-section>
  </eon-dialog>

  <eon-mask>
    <div class="mask-title-row">
      <div class="mask-text eon-mask-background1"></div>
      <div class="mask-button eon-mask-background1"></div>
    </div>

    <div class="mask-bar eon-mask-background1"></div>
    <div class="mask-row mask-grid-titles eon-mask-background1"></div>

    <div class="mask-grid-content">
      <div class="mask-text eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>

      <div class="mask-text eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>

      <div class="mask-text eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>

      <div class="mask-text eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>
    </div>
  </eon-mask>
</template>

<script>
  eon.element("registry-view", {
    parse: true,
    style: "registry-view.css",

    dependencies: [
      "registry-filter",
      "registry-grid",
      "../registry-edit",
      "../registry-create",
      "@ui/eon-dialog",
      "@ui/eon-form",
      "@ui/eon-text",
      "@ui/eon-date",
      "@ui/eon-combo",
      "@ui/eon-button",
      "@ui/eon-loading"
    ],

    properties: {
      refs: {
        value: {}
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      },
      refreshing: false
    },
    functions: {
      // @function refresh
      refresh: function () {
        this._refresh();
      },
      refreshFilters: function () {
        // TODO - For all instances
        var filters = this.$("registry-filter");

        for (var i = 0; i < filters.length; i++) {
          filters[i].refresh();
        }
      },
      // @function setPaging
      setPaging: function (data) {
        // TODO - For all instances
        var filters = this.$("registry-filter");
        
        for (var i = 0; i < filters.length; i++) {
          filters[i].setPaging(data);
        }
      },
      // @function getStateParams
      getStateParams: function () {
        var params = {};
        params.start = Number(getParameterByName("start"));
        params.date = getParameterByName("date");

        if (params.start && params.start != 0) {
          params.end = Number(getParameterByName("end"));
          if (params.end) {
            params.date = "";
          }
        }

        params.member = getParameterByName("member");
        return params;
      },
      // @function storeRegistry
      setCurrent: function (data) {
        this._misc.data = data;
      },
      // @function enableActions
      enableActions: function (dlg) {
        // TODO
        var actions = Array.prototype.slice.call(dlg.querySelector(".registry-view-actions").children);

        for (var i = 0; i < actions.length; i++) {
          actions[i].classList.remove("disabled");
        }
      },
      // @function disableActions
      disableActions: function (dlg) {
        // TODO
        var actions = Array.prototype.slice.call(dlg.querySelector(".registry-view-actions").children);

        for (var i = 0; i < actions.length; i++) {
          actions[i].classList.add("disabled");
        }
      },
      // @function enableActions
      enablePlansActions: function () {
        this._refs.plansCreateApply.classList.add("enable");
      },
    },
    privateFunctions: {
       // @function _drawStatic (private)
       drawStatic: function () {
        var el = this;

        // Hide view mask after language loaded at least
        eon.onLocaleLoaded(function(){
          // Minimun mask time to avoid flickering
          setTimeout(function(){
            // Hide home mask
            mask.hideViewMask("registry");
            el.hideEonMask();
          }, 100);
        });
      },
      // @function _setupAdvRefs (private)
      setupAdvRefs: function () {
        this.apply = this._refs.apply;
        this.delete = this._refs.delete;
      },
      // @function _refresh (private)
      refresh: function () {
        var el = this;
        // Setup read all registries request
        var workspaceId = session.data.currentWorkspaceId;
        var momentEs = moment().locale("es");

        mask.showViewMask("registry-grid");

        // Get url params and fetch state
        var paramsObj = el.getStateParams();
      
        paramsObj.date = paramsObj.date || momentEs.format("YYYYMMDD");
        paramsObj.from = 0;
        paramsObj.count = 10;

        var options = {
          params: paramsObj,
          contentType: "application/json"
        };
        var url = "/rest/registry/" + workspaceId;
        if (!el._refreshing) {

          el._refreshing = true;
          // Update members combo (admin/user)
          if (session.isAdmin()) {
            // Show create registry button
            el._refs.create.classList.remove("hide");
            // el._refs.batch.classList.remove("hide");
            // TODO
            if (paramsObj.member) {
              url += "/" + paramsObj.member;
            }
            readWorkspace(session.data.currentWorkspaceId, function (error, data) {
              if (!error) {
                // Update session
                session.data.currentWorkspace = data;

                if (data && data.members) {
                  el._refs.filter.setMembers(data.members);
                  el._refs.noSearchFilter.setMembers(data.members);

                  el._updateStateFilters(paramsObj);
                }
              }
            });
          } else {
            url += "/" + session.data.id;
            // Hide create registry button
            el._refs.create.classList.add("hide");
            // el._refs.batch.classList.add("hide");
            // TODO handle combo members
            var selfMember = {};
            selfMember[session.data.id] = session.data.id;
            el._refs.filter.setMembers(selfMember);
            el._refs.noSearchFilter.setMembers(selfMember);
            el._updateStateFilters(paramsObj);

          }

          el.refreshFilters();

          // Clean registry-view
          el._refs.grid.clean();

          eon.ajax(url, options, function (error, data) {
            if (!error) {

              el._misc.data = JSON.parse(data.responseText);

              eon.triggerCallback("onDataLoaded", el, el);
              // :: Filter element API 
              el.setPaging(el._misc.data);
              // :: Grid element API 
              // ** Dummy data TO BE REMOVED
              var firstRegistry = el._misc.data.entries[0];

              el._refs.grid._createEntries(el._misc.data);

            } else if (data.status == 401) {
              session.logout();
            }
            el._refreshing = false;
          });
        }
      },
      // @function _addListener(private)
      addListener: function () {
        var el = this;
        var registryCreate = this._refs.createDialog.querySelector("registry-create");
        var registryEdit = el._refs.editDialog.querySelector("registry-edit");

        // CREATE
        el._refs.createDialog.onClose(function () {
          registryCreate._refs.mainMask.hide();
        });
        el._refs.createDialog.onOpen(function () {
          registryCreate._refs.mainMask.show();
        });

        el._refs.createDialog.onOpened(function () {
          registryCreate.reset();
          // Set advanced data
          readWorkspace(session.data.currentWorkspaceId, function (error, data) {
            if (!error) {
              registryCreate.setData(data);

              // Refresh workweek scroll
              registryCreate._refs.workweek.querySelector("eon-scroll").update();
              registryCreate._refs.mainMask.hide();
            }
          });
        });

        el._refs.create.addEventListener("click", function (e) {
          el._refs.createDialog.open();
          // Push dialog state
          pushDialogState(el._refs.createDialog);
        });

        // EDIT
        el._refs.editDialog.onClose(function () {
          registryEdit._refs.mainMask.hide();
        });
        el._refs.editDialog.onOpen(function () {
          registryEdit._refs.mainMask.show();
        });

        el._refs.editDialog.onOpened(function () {
          // el._refs.registryView.hideCreateActions(registryEdit);
          registryEdit.clear();
          // Set advanced data
          registryEdit.setMainData(this._misc.data);
          registryEdit.setData(this._misc.data);

          // Refresh workweek scroll
          registryEdit._refs.workweek.querySelector("eon-scroll").update();
          registryEdit._refs.mainMask.hide();
        });

        // Edit submit form
        registryEdit.onSubmit(function (error, data) {
          if (!error) {
            // Check submit type
            if (data.delete) {
              delete data.delete;
              deleteRegistry(session.data.currentWorkspaceId, data.id, function (error, data) {
                if (!error) {
                  // Update registry grid
                  document.querySelector("registry-view").refresh();
                } else {
                  showInfoDialog(eon.locale.failMessage);
                }
              });
            } else {
              updateRegistry(session.data.currentWorkspaceId, data.id, data, function (error, data) {
                if (!error) {
                  // Update registry grid
                  document.querySelector("registry-view").refresh();
                } else {
                  showInfoDialog(eon.locale.failMessage);
                }
              });
            }
            el._refs.editDialog.close();
          }
        });

        el._refs.editNotesDialog.querySelector(".accept-button").addEventListener("click", function () {
          // Get event information
          el._refs.editNotesDialog.data.breakRange.notes = el._refs.editNotesDialog.querySelector(".note-text").value;
          el._refs.editNotesDialog.close();
        });
      },
      // @function (private) _updateStateFilters 
      updateStateFilters: function (params) {
        // Set date picker with end value
        var dateString = !params.end ? params.date : params.end;
        dateString = dateString.constructor === Number ? moment(dateString).format("YYYYMMDD") : dateString;

        var year = Number(dateString.substring(0, 4));
        var month = Number(dateString.substring(4, 6));
        var day = Number(dateString.substring(6, 8));
        var date = moment().year(year).month(month - 1).date(day).toDate();

        this._refs.filter.setDate(date);
        this._refs.noSearchFilter.setDate(date);
        // Set member value
        this._refs.filter.setMember(params.member);
        this._refs.noSearchFilter.setMember(params.member);
      },
      // @function (private) _setupFilterListeners 
      setupFilterListeners: function () {
        var el = this;
        // Hide filters on grid data changes
        onGridDataChange(el._refs.filter, function () {
          // Update bottom filter data
          el._refs.noSearchFilter.setDate(this._refs.date.value);
          el._refs.noSearchFilter.setMember(this._refs.members.value);

          // Hide pagination filter copy to avoid visual errors
          el._refs.noSearchFilter.classList.add("hide");
        }, function () {
          // Show pagination filter
          el._refs.noSearchFilter.classList.remove("hide");
          el._refs.grid._refreshing = false;
        });

        // Hide filters on grid data changes
        onGridDataChange(el._refs.noSearchFilter, function () {
          // Hide pagination filter copy to avoid visual errors
          this.classList.add("hide");
        }, function () {
          // Show pagination filter
          this.classList.remove("hide");
        });
      }
    },
    onCreated: function () {
      eon.createCallback("onDataLoaded", this, "ready");
    },
    onTransformed: function () {
      // STUDY! This will not work onCreated due to refs taking time to be created!
      var el = this;

       // Draw static content
      this._drawStatic();

      el._setupAdvRefs();

      session.onReady(function () {
        el.refresh();
      });
      session.onWorkspaceChanged(function () {
        el.refresh();
      });

      el._addListener();

      el._setupFilterListeners();
    }
  });
</script>