<template>
  <div class="form-rows">
    <div class="edit-range-type form-marginright">
      <eon-variable class="form-label eon-fg0" bind="locale.registry.type" global="true"></eon-variable>
      <eon-combo eon-ref="type" bind:placeholder="global locale.registry.type" label-anim="false" filter="true"
        class="edit-range-field" inline="false">
      </eon-combo>
    </div>

    <div class="edit-range-from form-marginright form-marginleft">
      <div class="edit-range-cols">
        <eon-variable class="form-label eon-fg0" bind="locale.from" global="true"></eon-variable>
        <div class="edit-range-start dateTimeWrapper">

          <eon-date eon-ref="startDay" class="edit-range-field edit-range-date form-date" time="true" time-icon="true" mask="DDMMYYYY"
            value-format="YYYY-MM-DD hh:mm" inline="false">
          </eon-date>
        </div>
      </div>
    </div>

    <div class="edit-range-to form-marginleft">
      <div class="edit-range-cols">
        <eon-variable class="form-label eon-fg0" bind="locale.to" global="true"></eon-variable>
        <div class="edit-range-start dateTimeWrapper">

          <eon-date eon-ref="endDay" class="edit-range-field edit-range-date form-date" time="true" time-icon="true" mask="DDMMYYYY"
            value-format="YYYY-MM-DD hh:mm" inline="false">
          </eon-date>
        </div>
      </div>
    </div>
    <!-- </div> -->
  </div>

  <div class="edit-range-actions">
    <span eon-ref="notes" class="action-icon action-notes vicon vicon-book clickable">
    </span>
    <div eon-ref="deleteClickable" class="action-icon delete-icon vicon-bin clickable">
    </div>
  </div>
</template>

<script>
  eon.element("edit-range", {
    style: "edit-range.css",
    parse: true,

    dependencies: [
      "@ui/eon-date",
      "@ui/eon-combo"
    ],
    properties: {
      refs: {
        value: {}
      },
      entry: {
        value: ""
      },
      exit: {
        value: ""
      },
      type: {
        value: "break"
      },
      notes: {
        value: ""
      },
      position: {
        value: {}
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function _getValue (private)
      getValue: function () {
        var el = this;
        
        var values = {
          entry: el._refs.startDay.value,
          exit: el._refs.endDay.value,
          type: eon.util.isTrue(el.isBreak) ? el._refs.type.value : "activity",
          isBreak: eon.util.isTrue(el.isBreak),
          notes: el.notes,
          position: el.position
        };
        
        return values;
      }
    },
    privateFunctions: {
      // @function _setupAdvRefs (private)
      setupAdvRefs: function () {
        this._refs.editNotesDialog = document.querySelector("#edit-notes-dialog");
      },
      // @function _setInitialValues (private)
      setInitialValues: function () {
        var el = this;
        el._refs.startDay.onReady(function () {
          // Check time values
          if(!el.entry.split(" ")[1]) {
            el.entry += " " + moment().format("HH:mm");
          }
          if(!el.exit.split(" ")[1]) {
            el.exit += " " + moment().add(1, "minutes").format("HH:mm");
          }
          
          el._refs.startDay.value = el.entry ? el.entry : "";
          el._refs.endDay.value = el.exit ? el.exit : "";
        });

        el._setTypes();

        el._refs.type.onReady(function () {
          el._refs.type.value = el.type;
        });
      },
      // @function _setTypes (private)
      setTypes: function () {
        var el = this;
        var combo = el._refs.type;
        var item, valueNumber;
        var types = ["break", "food", "absence"];
        if (eon.util.isTrue(el.isBreak)) {
          // Create range combo items
          for (var i = 0; i < types.length; i++) {
            item = document.createElement("eon-item");
            item.setAttribute("value", types[i]);
            item.setAttribute("display-value", eon.locale.events[types[i]]);
            combo.addItem(item);
          }
        } else {
          el.classList.add("no-type");
          var label = el.querySelector(".edit-range-type .form-label");
          label.parentNode.classList.add("hide");
          combo.parentNode.removeChild(combo);
          label.parentNode.removeChild(label);
        }
      },
      // @function _setupActions (private)
      setupActions: function () {
        var el = this;

        el._refs.notes.addEventListener("click", function () {
          // Get event information
          el._refs.editNotesDialog.querySelector(".note-text").value = el.notes;
          el._refs.editNotesDialog.data.breakRange = el;

          // Show notes dialog
          el._refs.editNotesDialog.open();
          // Push dialog state
          pushDialogState(el._refs.editNotesDialog);
        });
      },
      // @function _setupDelete (private)
      setupDelete: function () {
        var el = this;

        el.addEventListener("transitionend", function (e) {

          if (e.propertyName == "opacity" && el._misc.removed) {
            setTimeout(function () {
              if (el.parentNode) {
                el.parentNode.removeChild(el);
              }
            }, 200);
          }

        });

        el._refs.deleteClickable.addEventListener("click", function () {
          el._misc.removed = true;
          el.classList.add("edit-range-hidden");
        });
      }
    },
    onTransformed: function () {
      this._setupAdvRefs();
      this._setInitialValues();
      this._setupDelete();
      this._setupActions();
    }
  });
</script>