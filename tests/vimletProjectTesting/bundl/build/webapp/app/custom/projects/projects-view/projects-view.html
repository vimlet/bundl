<template>
  <eon-swiper transition="500" external-slide="true" eon-ref="swiper">
    <eon-swiper-slide class="projects-view-slide">
      <div class="title-row">
        <eon-variable class="section-title eon-fg-h1" bind="locale.projects.title" global="true"></eon-variable>
        <div class="action-buttons">
          <eon-button class="bar-button h1-button hide" bind:label="global locale.global.new"
            icon="<i class='ticon ticon-add'></i>" design="filled" eon-ref="create"></eon-button>
        </div>
      </div>
      <eon-scroll thickness="8" class="projects-view-projects-scroll">

        <div class="view-content">
          <div eon-ref="mask" class="content-mask">
            <div class="project-mask-row">
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
              <div class="project-mask-card eon-mask-background1"></div>
            </div>
          </div>
          <div class="projects-view-content" eon-ref="content">
          </div>
        </div>

      </eon-scroll>
      <!-- <div class="view-content" eon-ref="content"></div> -->
    </eon-swiper-slide>
    <eon-swiper-slide style="flex-grow: 1;" class="board-view" eon-ref="projectSlide">
      <project-view eon-ref="project"></project-view>
    </eon-swiper-slide>
  </eon-swiper>
  <eon-dialog id="leanDialog" allow-scroll="false" class="dialog-form interactDialog" modal="true" default-style="false"
    eon-ref="dialog">
    <eon-section type="content">
      <eon-form class="board-form" default-style="false" eon-ref="form">
        <div class="form-content">
          <eon-text eon-ref="dialog.name" bind:label="global locale.global.projectName"
            bind:placeholder="global locale.projects.name" class="form-text form-marginbottom-description" name="name" label-anim="false"
            inline="false">
          </eon-text>
          <app-color icon="ticon-color" class="form-marginbottom" button="false" eon-ref="colorPicker"></app-color>


          <eon-combo bind:label="global locale.projects.view.defaultView" label-anim="false" dropdown-min-width="150"
            class="projects-view-settings-view hide-description form-marginbottom" value="board" name="defaultView" eon-ref="defaultView">
            <eon-item bind:display-value="global locale.projects.view.list" value="list"></eon-item>
            <eon-item bind:display-value="global locale.projects.view.board" value="board"></eon-item>
            <eon-item bind:display-value="global locale.projects.view.timeline" value="timeline"></eon-item>
            <eon-item bind:display-value="global locale.projects.view.calendar" value="calendar"></eon-item>
          </eon-combo>


        </div>
        <app-user-selector label="locale.global.inviteMembers" eon-ref="userSelector">
        </app-user-selector>

        <eon-loading eon-ref="boardMask" duration="10000" class="form-mask" format="descendant" display="false">
        </eon-loading>
      </eon-form>
    </eon-section>
    <eon-section type="footer" class="form-actions projects-view-settings-footer">
      <eon-button class="hide delete-button" bind:value="global locale.global.delete" design="delete"
        eon-ref="dialog.deleteButton">
      </eon-button>
      <eon-button bind:value="global locale.global.cancel" eon-ref="dialog.cancelButton">
      </eon-button>
      <eon-button bind:value="global locale.global.accept" eon-ref="dialog.addButton">
      </eon-button>
    </eon-section>
  </eon-dialog>
  <!-- <eon-loading eon-ref="mask" class="projects-mask" duration="5000" format="descendant" display="false">
  </eon-loading> -->

  <!-- MASK -->
  <eon-mask class="section expanded">
    <div class="mask-title-row">
      <div class="mask-title eon-mask-background1"></div>
      <div class="mask-button eon-mask-background1"></div>
    </div>
    <div class="project-mask-row">
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
      <div class="project-mask-card eon-mask-background1"></div>
    </div>
  </eon-mask>
</template>

<script>
  eon.element("projects-view", {
    style: "projects-view.css",
    parse: true,

    dependencies: [
      "@ui/eon-form",
      "@ui/eon-scroll",
      "@ui/eon-button",
      "@ui/eon-dialog",
      "@ui/eon-swiper",
      "@ui/eon-text",
      "@ui/eon-loading",
      "@ui/eon-combo",
      "@custom/app-toggle-menu",
      "@custom/app-color",
      "@custom/app-user-selector",
      "../projects-view/project-view"
    ],

    properties: {
      // @html-property boards (public) [Contains boards data from database]
      boards: {
        value: "",
        observe: true
      },
      // @html-property tasks (public)
      // tasks: {
      //   value: "",
      //   observe: true
      // },
      // @html-property taskCount (public) [Task count by column type]
      taskCount: {
        value: "",
        observe: true
      },
      // @html-property defaultLists (public) [Default lists names separated by "," if any. List names should be at locale]
      defaultLists: {
        value: {
          pending: {
            name: "pending",
            type: "pending",
            color: "#8c27cf"
          },
          inProgress: {
            name: "inProgress",
            type: "inProgress",
            color: "blue"
          },
          done: {
            name: "done",
            type: "done",
            color: "green"
          }
        }
      }
    },

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function refresh (public) [Refresh view]
      refresh: function () {
        var el = this;

        this._showContentMask();

        session.onReady(function () {
          if (session.isAdmin()) {
            el._refs.create.classList.remove("hide");
          }
          el.loadData();
        });
      },
      // @function reset (public) [Reset view.]
      reset: function () {
        var el = this;
        el._refs.create.classList.add("hide");
      },
      // @function openBoard (public) [Open board view] @param boardId @param cancelAnimation
      openBoard: function (boardId, cancelAnimation) {
        var el = this;
        el._refs.project.projectsView = el;
        el._refs.project.id = boardId;
        el._refs.project._misc.workspaceData = el._misc.workspaceData;
        if (!cancelAnimation) {
          el._refs.swiper._refs.wrapper.style.transition = "transform 0.2s";
        }
        if (boardId) {
          // el._refs.mask.classList.remove("hide");
          // el._refs.mask.show();
          el._refs.project.showMask();
          el._refs.swiper.slideTo(1, cancelAnimation);
          el.classList.add("projects-view-task-view-slide");
        } else {
          el._refs.swiper.slideTo(0, cancelAnimation);
          el.classList.remove("projects-view-task-view-slide");
          el._hideLoadingMask();
        }
      },
      // @function getData (public) [Retrieve data from database] @param callback
      getData: function (callback) {
        var el = this;
        session.onReady(function () {
          var workspaces = [];
          for (var key in session.data.workspaces) {
            workspaces.push(key);
          }
          var url = "/rest/board/" + session.data.currentWorkspaceId;
          eon.ajax(url, {
            contentType: "application/json"
          }, function (error, data) {
            if (!error) {
              var data = JSON.parse(data.responseText);
              el.boards = data.boards;
              if (callback) {
                callback(el.boards);
              }
            } else if (data.status == 401) {
              session.logout();
            }
          });
        });
      },
      // @function setData (public) [Print data to screen] @param-optional data [If not given previously stored data will be used]
      setData: function (data) {
        var el = this;
        data = data || el.boards;
        el._misc.boardLoaded = 0;
        el._misc.taskCounts = {};
        el._refs.content.innerHTML = "";
        var urlParams = new URLSearchParams(window.location.search);
        var boardId = urlParams.get('board');
        if (data && data != "") {
          el._printBoardsAsync(data);
        } else {
          el._emptyPlaceholder(el._refs.content);
          eon.triggerCallback("onDataShown", el, el);
        }
        el.onWorkspaceLoaded(function () {
          el.onDataShown(function () {
            el._hideContentMask();
            el.openBoard(boardId, true);
          });
          el._refs.project.refresh();
        });
        el._refs.swiper._refs.wrapper.style.transition = "none";
      },

      // @function setData_board (public) [Set board data] @param boardData
      setData_board: function (boardData) {
        var el = this;
        var board = el._setBoard(boardData);
        el._appendContent(board.board);
        el._misc.boardLoaded++;
        eon.triggerCallback("onDataShown", el, el);
        if (el._misc.boardLoaded === el.boards.length) {
          el._misc.isLoading = false;
          eon.triggerCallback("onAllDataShown", el, el);
        }
      },
      // @function editBoard (public) [Open board dialog with current dialog data] @param boardData
      editBoard: function (boardData) {
        var el = this;

      },
      // @function validate (public) [Validate form] @param callback [Callback called (error,data)]
      validate: function (callback) {
        var el = this;
        var formData = el._refs.form.getData();
        var usersData = el._refs.userSelector.getData();

        formData.users = usersData.members;
        formData.groups = usersData.groups;
        formData.color = el._refs.colorPicker.value;
        el._refs.form.validate(el._refs.schema, null, function (error) {
          if (callback) {
            callback(error, formData);
          }
        });
      },
      // @function loadWorkspaceData (public) [Load workspace data from database] @param filters @param callback
      loadWorkspaceData: function (filters, callback) {
        var el = this;
        if (session.isAdmin()) {
          var url = "/rest/workspace/" + session.data.currentWorkspaceId;
          eon.ajax(url, {
            params: filters,
            contentType: "application/json"
          }, function (error, data) {
            if (!error) {
              el._misc.workspaceData = JSON.parse(data.responseText);
              eon.triggerCallback("onWorkspaceLoaded", el, el);
              if (callback) {
                callback(null, el._misc.workspaceData);
              }
            } else if (data.status == 401) {
              callback(true);
              session.logout();
            }
          });
        } else {
          var url = "/rest/workspace/" + session.data.currentWorkspaceId + "/" + session.data.id;
          eon.ajax(url, {
            params: filters,
            contentType: "application/json"
          }, function (error, data) {
            if (!error) {
              el._misc.workspaceData = JSON.parse(data.responseText);
              eon.triggerCallback("onWorkspaceLoaded", el, el);
              if (callback) {
                callback(null, el._misc.workspaceData);
              }
            } else if (data.status == 401) {
              callback(true);
              session.logout();
            }
          });
        }
      },
      // @function loadData (public) [Load data from database]
      loadData: function () {
        var el = this;
        if (!el._misc.isLoading) {
          el._misc.isLoading = true;
          el.getData(function (data) {
            el.setData(data);
          });
          el.loadWorkspaceData(null, function (error, data) {
            el._misc.data = data;
          });
        } else {
          // TODO In case the data is reloaded while loading, which seems not possible 
          // el.onAllDataShown(function () {      
          //   el._misc.isLoading = true;
          //   el.getData(function (data) {
          //     el.setData(data);
          //   });
          //   el.loadWorkspaceData(null, function (error, data) {
          //     el._misc.data = data;
          //     mask.hideViewMask("projects");
          //     setTimeout(function () {
          //       el.hideEonMask();
          //     }, 100);
          //   });
          // });
        }
      },
      // @function backToBoards (public) [Back to boards view]
      backToBoards: function () {
        var el = this;
        el.updateUrl(null);
        el._refs.swiper._refs.wrapper.style.transition = "transform 0.2s";
        el._refs.swiper.slideTo(0);
        el.classList.remove("projects-view-task-view-slide");
      },
      // @function updateUrl (public) [Update url with board parameter] @param board
      updateUrl: function (board) {
        var url = window.location.href;
        url = setParameterByName("board", board, url);
        window.history.replaceState({}, document.title, url);
      },
      // @function loadTasks (public) [Load tasks data] @param boardId @param callback
      loadTasks: function (boardId, callback) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + boardId;
        eon.ajax(url, {}, function (error, data) {
          if (!error) {
            if (callback) {
              callback(JSON.parse(data.responseText));
            }
          } else if (data.status == 401) {
            session.logout();
          }
        });
      }
    },
    privateFunctions: {
      // @function _drawStatic (private)
      drawStatic: function () {
        var el = this;

        // Hide view mask after language loaded at least
        eon.onLocaleLoaded(function () {
          // Minimun mask time to avoid flickering
          setTimeout(function () {
            // Hide home mask
            mask.hideViewMask("projects");
            el.hideEonMask();
          }, 100);
        });
      },
      // @function _showContentMask (private)
      showContentMask: function () {
        this._refs.content.classList.add("hide");
        this._refs.mask.classList.remove("hide");
      },
      // @function _hideContentMask (private)
      hideContentMask: function () {
        this._refs.content.classList.remove("hide");
        this._refs.mask.classList.add("hide");
      },
      // @function _init (private)
      init: function () {
        var el = this;
        el._setup();
      },
      // @function _setup (private)
      setup: function () {
        var el = this;
        el._misc.boards = el._misc.boards || {};
        el._refs.colorPicker.label = eon.locale.global.color;
        el._refs.colorPicker.predefined = config.colors.generic.join(",");
        el._addListener();
        el._setupSchema();
        el._socketListeners();
      },
      // @function _setupSchema (private)
      setupSchema: function () {
        var el = this;
        el._refs.schema = {
          properties: {
            "name": {
              required: true
            },
            "defaultView": {}
          }
        };
      },
      // @function _addListener (private)
      addListener: function () {
        var el = this;
        // Boards management listeners
        el._boardListeners();

        el._refs.dialog.cancelButton.addEventListener("click", function (e) {
          el._refs.dialog.close();
        });
        // el._refs.dialog.name.addEventListener("input", function (val) {
        //   el._checkLeanDialogAdd();
        // });
        el._refs.project.onBack(function () {
          el.backToBoards();
        });
        el._refs.project.onProjectUpdated(function (boardData, options) {
          el._updateBoard(boardData);
          if (options && options.type) {
            for (var i = 0; i < el.boards.length; i++) {
              if (el.boards[i].id === boardData.id) {
                el.boards[i] = boardData;
                el._countBoardsTask();
              }
            }
          }
        });
        el._refs.project.onDataShown(function (boardData) {
          // Minimum mask visual effect          
          setTimeout(function () {
            el._hideLoadingMask();
          }, 100);
        });
        el._refs.project.onTaskCreated(function (boardId, task) {
          el._countBoardsTask();
        });
        task.onTask_listChange(function (data, taskId, target, order) {
          el._onTask_listChange(data, taskId, target, order);
        });
        // el._refs.project.onTaskDeleted(function (boardId) {
        //   el._countBoardsTask();
        // });
        client_render.onViewChanged(function (view) {
          if (view) {
            view = view.split("/");
            if (view[2].indexOf("projects") > -1) {
              var urlParams = new URLSearchParams(window.location.search);
              urlParams.delete("board");
              var url = window.location.href.split("?")[0];
              window.history.replaceState({}, document.title, url);
              el._refs.swiper.slideTo(0, true);
            }
          }
        });
        el._refs.swiper.onTransitionEnd(function () {
          el._refs.swiper._refs.wrapper.style.transition = "none";
        });
      },
      // @function _onTask_listChange (private) [Actions when a task changes it list]
      onTask_listChange: function (data, taskId, target, order) {
        var el = this;
        boardId = data.task.boardId;
        el._countBoardsTask();
      },
      // @function _boardListeners (private) []
      boardListeners: function () {
        var el = this;
        var boardData = {};
        // Create board
        el._refs.create.addEventListener("click", function (e) {
          el._refs.dialog.heading = eon.locale.projects.create;
          el._misc.editBoard = false;
          el._refs.dialog.open();
          // Push dialog state
          pushDialogState(el._refs.dialog);
        });
        // Edit board
        el._refs.project.onEditProject(function (boardData) {
          el._editProject(boardData);
        });

        // Dialog close/display management
        el._refs.dialog.onClose(function () {
          el._refs.boardMask.hide();
        });
        el._refs.dialog.onOpen(function () {
          el._refs.boardMask.show();
        });
        el._refs.dialog.onOpened(function () {
          setTimeout(function () {
            el._refs.colorPicker.querySelector("eon-scroll").update(); // TODO fix scroll bug
          }, 0);
          el._refs.form.clear();
          // el._checkLeanDialogAdd();
          if (el._misc.editBoard) {
            el._refs.dialog.deleteButton.classList.remove("hide");
            boardData = JSON.parse(JSON.stringify(el._refs.dialog._misc.boardData));
            el._refs.dialog.name.value = boardData.name;
            el._refs.colorPicker.value = boardData.color || config.colors.generic[Math.floor(Math.random() *
            config.colors.generic.length)];
            el._refs.dialog.deleteButton.classList.remove("hide");
            el._refs.userSelector.setData(el._misc.workspaceData, boardData.users, boardData.groups);
            var defaultView = "board";
            if (boardData.defaultView && boardData.defaultView[session.data.id]) {
              defaultView = boardData.defaultView[session.data.id];
            }
            el._refs.defaultView.value = defaultView;
            el._misc.boardUsers = boardData.users;
            el._misc.boardGroups = boardData.groups;
          } else {
            el._refs.dialog.deleteButton.classList.add("hide");
            boardData = el._refs.dialog._misc.boardData;
            el._refs.userSelector.setData(el._misc.workspaceData, [session.data.id]);
            el._refs.colorPicker.value = config.colors.generic[Math.floor(Math.random() * config.colors.generic.length)];
            el._refs.defaultView.value = "board";
          }

          // Minimum mask visual effect
          setTimeout(function () {
            el._refs.dialog.name.focus();
            el._refs.boardMask.hide();
          }, 100);
        });

        // Dialog interactions
        el._refs.dialog.addButton.addEventListener("click", function (e) {
          if (el._misc.editBoard) {
            el._sendEditBoard(el._misc.editBoard);
          } else {
            el._sendNewBoard();
          }
        });
        el._refs.dialog.name.addEventListener("keydown", event => {
          if (event.isComposing || event.keyCode === 229) {
            return;
          } else if (event.keyCode === 13) {
            if (!el._refs.dialog.name != "") {
              if (el._misc.editBoard) {
                el._sendEditBoard(el._misc.editBoard);
              } else {
                el._sendNewBoard();
              }
            } else {
              el._refs.dialog.name.invalid = true;
            }
          }
        });
        el._refs.dialog.deleteButton.addEventListener("click", function (val) {
          openDeleteConfirmation(function () {
            el._deleteBoard(el._misc.editBoard);
          });
        });
      },
      // @function _editProject (private) [Edit project] @param boardData
      editProject: function (boardData) {
        var el = this;
        el._refs.dialog.heading = eon.locale.projects.edit;
        el._misc.editBoard = boardData.id;
        el._refs.dialog._misc.boardData = boardData;
        el._checkLeanDialogAdd();
        el._refs.dialog.open();
        // Push dialog state
        pushDialogState(el._refs.dialog);
      },
      // @function _checkLeanDialogAdd (private) [Check if next button should be enabled or disabled]
      checkLeanDialogAdd: function () {
        var el = this;
        if (el._refs.dialog.name.value && el._refs.dialog.name.value != "" || el._misc.editBoard) {
          el._refs.dialog.name.invalid = false;
        } else {
          el._refs.dialog.name.invalid = true;
        }
      },
      // @function _hideLoadingMask (private) [Hide loading mask when content is loaded]
      hideLoadingMask: function () {
        var el = this;
        mask.hide(null, 600);
        el._refs.project.hideMask();
      },
      // @function _setBoard (private) [Setup a board button] @param data [Board data]
      setBoard: function (data) {
        var el = this;
        var board = document.createElement("div");
        board.classList.add("card", "item-card");
        var headerColor = document.createElement("div");
        headerColor.classList.add("item-card-header-color");
        if (data.color) {
          headerColor.style.backgroundColor = data.color;
          // board.style.backgroundColor = data.color;
          // board.classList.add("colored-card");
        }
        board.appendChild(headerColor);
        var titleRow = document.createElement("div");
        titleRow.classList.add("row", "projects-view-card-title");
        var title = document.createElement("div");
        title.classList.add("item-card-title");
        title.innerText = data.name;
        titleRow.appendChild(title);
        var options = document.createElement("app-toggle-menu");
        options.anchor = "right";
        options.icon = "vicon-more-vert";
        var settings = document.createElement("div");
        settings.setAttribute("key", data.id);
        settings.classList.add("app-toggle-menu-item");
        var settingsTitle = document.createElement("span");
        settingsTitle.innerText = eon.locale.global.settings;
        var settingsIcon = document.createElement("i");
        settingsIcon.classList.add("vicon", "vicon-cog");
        settings.appendChild(settingsIcon);
        settings.appendChild(settingsTitle);
        settings.parent = options;
        settings.addEventListener("click", function () {
          for (var i = 0; i < el.boards.length; i++) {
            if (el.boards[i].id == this.getAttribute("key")) {
              el._editProject(el.boards[i]);
            }
          }
          options.close();
        });
        options.addItem(settings);
        var titleSeparator = document.createElement("div");
        titleSeparator.classList.add("separator");
        titleRow.appendChild(titleSeparator);
        session.onReady(function () {
          if (session.isAdmin()) {
            titleRow.appendChild(options);
          }
        });
        if (data.color) {
          if (el._isColorBright(data.color)) {
            title.classList.add("projects-view-item-card-title-bright");
            options.classList.add("projects-view-item-card-title-bright");
          }
        } else {
          title.classList.add("projects-view-item-card-title-bright");
          options.classList.add("projects-view-item-card-title-bright");
        }
        var statsBlock = el._setBoard_status(data);
        board.appendChild(titleRow);
        board.appendChild(statsBlock);
        board.setAttribute("id", data.id);
        board.setAttribute("name", data.name);
        board.addEventListener("click", function () {
          el.updateUrl(this.getAttribute("id"));
          el.openBoard(this.getAttribute("id"));
        });
        el._misc.boards[data.id] = board;
        var result = {};
        result.board = board;
        return result;
      },
      // @function _setBoard_status (private) [Add status to board card] @param data
      setBoard_status: function (data) {
        var el = this;
        el._misc.taskCounts[data.id] = {};
        var count = el._countBoardTask(data.lists.data);
        var statsBlock = document.createElement("div");
        statsBlock.classList.add("row", "projects-view-content-card-stats");
        var pending = document.createElement("div");
        pending.classList.add("column");
        var pendingIconAmount = document.createElement("div");
        pendingIconAmount.classList.add("row");
        var pendingIconAmountIcon = document.createElement("i");
        pendingIconAmountIcon.classList.add("projects-view-content-card-stats-icon", "vicon", "ticon-pending");
        pendingIconAmount.appendChild(pendingIconAmountIcon);
        var pendingIconAmountText = document.createElement("div");
        pendingIconAmountText.classList.add("projects-view-content-card-stats-amount");
        pendingIconAmountText.innerHTML = count.pending;
        el._misc.taskCounts[data.id].pending = pendingIconAmountText;
        pendingIconAmount.appendChild(pendingIconAmountText);
        pending.appendChild(pendingIconAmount);
        var pendingTitle = document.createElement("div");
        pendingTitle.classList.add("projects-view-content-card-stats-title");
        pendingTitle.innerHTML = eon.locale.projects.board.type.pending;
        pending.appendChild(pendingTitle);
        statsBlock.appendChild(pending);
        var inProgress = document.createElement("div");
        inProgress.classList.add("column");
        var inProgressIconAmount = document.createElement("div");
        inProgressIconAmount.classList.add("row");
        var inProgressIconAmountIcon = document.createElement("i");
        inProgressIconAmountIcon.classList.add("projects-view-content-card-stats-icon", "vicon", "ticon-wip");
        inProgressIconAmount.appendChild(inProgressIconAmountIcon);
        var inProgressIconAmountText = document.createElement("div");
        inProgressIconAmountText.classList.add("projects-view-content-card-stats-amount");
        inProgressIconAmountText.innerHTML = count.inProgress;
        el._misc.taskCounts[data.id].inProgress = inProgressIconAmountText;
        inProgressIconAmount.appendChild(inProgressIconAmountText);
        inProgress.appendChild(inProgressIconAmount);
        var inProgressTitle = document.createElement("div");
        inProgressTitle.classList.add("projects-view-content-card-stats-title");
        inProgressTitle.innerHTML = eon.locale.projects.board.type.inProgress;
        inProgress.appendChild(inProgressTitle);
        statsBlock.appendChild(inProgress);
        var done = document.createElement("div");
        done.classList.add("column");
        var doneIconAmount = document.createElement("div");
        doneIconAmount.classList.add("row");
        var doneIconAmountIcon = document.createElement("i");
        doneIconAmountIcon.classList.add("projects-view-content-card-stats-icon", "vicon", "ticon-done");
        doneIconAmount.appendChild(doneIconAmountIcon);
        var doneIconAmountText = document.createElement("div");
        doneIconAmountText.classList.add("projects-view-content-card-stats-amount");
        doneIconAmountText.innerHTML = count.done;
        el._misc.taskCounts[data.id].done = doneIconAmountText;
        doneIconAmount.appendChild(doneIconAmountText);
        done.appendChild(doneIconAmount);
        var doneTitle = document.createElement("div");
        doneTitle.classList.add("projects-view-content-card-stats-title");
        doneTitle.innerHTML = eon.locale.projects.board.type.done;
        done.appendChild(doneTitle);
        statsBlock.appendChild(done);
        if (data.color) {
          if (el._isColorBright(data.color)) {
            pendingIconAmountIcon.classList.add("projects-view-item-card-title-bright");
            pendingIconAmountText.classList.add("projects-view-item-card-title-bright");
            pendingTitle.classList.add("projects-view-item-card-title-bright");
            inProgressIconAmountIcon.classList.add("projects-view-item-card-title-bright");
            inProgressIconAmountText.classList.add("projects-view-item-card-title-bright");
            inProgressTitle.classList.add("projects-view-item-card-title-bright");
            doneIconAmountIcon.classList.add("projects-view-item-card-title-bright");
            doneIconAmountText.classList.add("projects-view-item-card-title-bright");
            doneTitle.classList.add("projects-view-item-card-title-bright");
          }
        } else {
          pendingIconAmountIcon.classList.add("projects-view-item-card-title-bright");
          pendingIconAmountText.classList.add("projects-view-item-card-title-bright");
          pendingTitle.classList.add("projects-view-item-card-title-bright");
          inProgressIconAmountIcon.classList.add("projects-view-item-card-title-bright");
          inProgressIconAmountText.classList.add("projects-view-item-card-title-bright");
          inProgressTitle.classList.add("projects-view-item-card-title-bright");
          doneIconAmountIcon.classList.add("projects-view-item-card-title-bright");
          doneIconAmountText.classList.add("projects-view-item-card-title-bright");
          doneTitle.classList.add("projects-view-item-card-title-bright");
        }
        return statsBlock;
      },
      // @function _countBoardsTask (private) [Count task of each type]
      countBoardsTask: function () {
        var el = this;
        var count = {};
        for (var boardIndex = 0; boardIndex < el.boards.length; boardIndex++) {
          var boardId = el.boards[boardIndex].id;
          count[el.boards[boardIndex].id] = el._countBoardTask(el.boards[boardIndex].lists.data);
        }
        el.taskCount = count;
      },
      // @function  _countBoardTask (private) [Count task by a single board] @param boardLists
      countBoardTask: function (boardLists) {
        var el = this;
        var count = {
          pending: 0,
          inProgress: 0,
          done: 0
        };
        for (var key in boardLists) {
          if (boardLists[key].tasks) {
            switch (boardLists[key].type) {
              case "pending":
                count.pending += boardLists[key].tasks.length;
                break;
              case "inProgress":
                count.inProgress += boardLists[key].tasks.length;
                break;
              case "done":
                count.done += boardLists[key].tasks.length;
                break;
            }
          }
        }
        return count;
      },
      // @function _isColorBright (private) [Return true if it is a bright color or false if not] @param hexColor
      isColorBright: function (hexColor) {
        var parse = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hexColor);
        var rgb = parse ? {
          r: parseInt(parse[1], 16),
          g: parseInt(parse[2], 16),
          b: parseInt(parse[3], 16)
        } : null;
        var bright = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
        return bright > 0.5 ? true : false;
      },
      // @function _sendNewBoard (private) [Send new board to database]
      sendNewBoard: function () {
        var el = this;
        el.validate(function (error, data) {
          if (!error) {
            el._refs.dialog.close();
            var url = "/rest/board/" + session.data.currentWorkspaceId;
            data = el._addDefaultLists(data);
            eon.ajax(url, {
              contentType: "application/json",
              method: "POST",
              payload: JSON.stringify(data)
            }, function (error, data) {
              if (!error) {
                popup.displayToast(eon.locale.projects.createSuccess);
              } else if (data.status == 401) {
                session.logout();
              }
            });
          } else {}
        });
      },
      // @function _appendContent (private) [Append content sorted] @param element
      appendContent: function (element) {
        var el = this;
        var children = el._refs.content.childNodes;
        if (children.length > 0) {
          var appended = false;
          for (var i = 0; i < children.length; i++) {
            if (children[i] && children[i].getAttribute("name") && children[i].getAttribute("name")
            .toLowerCase() > element.getAttribute("name").toLowerCase()) {
              el._refs.content.insertBefore(element, children[i]);
              appended = true;
              break;
            }
          }
          if (!appended) {
            el._refs.content.appendChild(element);
          }
        } else {
          el._refs.content.appendChild(element);
        }
      },
      // @function _addDefaultLists (private) [Add default list to new project if any] @param data
      addDefaultLists: function (data) {
        var el = this;
        if (Object.keys(el.defaultLists).length > 0) {
          var count = 0;
          data.lists = {};
          for (var key in el.defaultLists) {
            data.lists[count] = {
              name: eon.locale.projects.board.type[el.defaultLists[key].name],
              type: el.defaultLists[key].type,
              color: el.defaultLists[key].color
            };
            count++;
          }
        }
        return data;
      },
      // @function _sendEditBoard (private) [Send board edition to database]  @param boardId
      sendEditBoard: function (boardId) {
        var el = this;
        el.validate(function (error, data) {
          if (!error) {
            el._refs.dialog.close();
            var url = "/rest/board/" + session.data.currentWorkspaceId + "/" + boardId;
            eon.ajax(url, {
              contentType: "application/json",
              method: "PUT",
              payload: JSON.stringify(data)
            }, function (error, data) {
              if (!error) {
                popup.displayToast(eon.locale.projects.editSuccess);
              } else if (data.status == 401) {
                session.logout();
              }
            });
          } else {}
        });
      },
      // @function _updateBoard (private) [Update projects view and projects view data when a board is modified withing board-view]
      updateBoard: function (boardData) {
        var el = this;
        el.onReady(function () {
          if (el.boards && el.boards != "") {
            for (var i = 0; i < el.boards.length; i++) {
              if (el.boards[i].id === boardData.id) {
                el.boards[i] = boardData;
              }
            }
          }
          if (el._misc.boards[boardData.id]) {
            el._misc.boards[boardData.id].querySelector(".item-card-title")
              .innerHTML = boardData.name;
            // el._misc.boards[boardData.id].style.backgroundColor = boardData.color;
            el._misc.boards[boardData.id].querySelector(".item-card-header-color").style.backgroundColor =
              boardData.color;
          }
        });
      },
      // @function _deleteBoard (private) [Delete a board] @param boardId
      deleteBoard: function (boardId) {
        var el = this;
        var url = "/rest/board/" + session.data.currentWorkspaceId + "/" + boardId;
        el._refs.dialog.close();
        eon.ajax(url, {
          contentType: "application/json",
          method: "DELETE"
        }, function (error, data) {
          if (!error) {
            popup.displayToast(eon.locale.projects.deleteSuccess);
          } else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _socketListeners (private)
      socketListeners: function () {
        var el = this;
        session.onReady(function () {
          socket.onSocketBoard(function (board) {
            var projectIndex = -1;
            for (var i = 0; i < el.boards.length; i++) {
              if (el.boards[i].id === board.id) {
                projectIndex = i;
                break;
              }
            }
            if (projectIndex > -1) { // Update board
              el.boards[projectIndex] = board;
              el._updateBoard(board);
              el._countBoardsTask();
              if (el._refs.swiper.currentSlide.el == el._refs.projectSlide) {
                el._refs.project.board = board;
              }
            } else { // Create board
              el.boards.push(board);
              el.setData_board(board);
              el._emptyPlaceholder();
            }
          });
          socket.onSocketBoardDeleted(function (boardId) {
            var index = -1;
            for (var i = 0; i < el.boards.length; i++) {
              if (el.boards[i].id === boardId) {
                index = i;
              }
            }
            if (index > -1) {
              el.boards.splice(index, 1);
            }
            if (el._misc.boards[boardId]) {
              el._misc.boards[boardId].parentElement.removeChild(el
                ._misc
                .boards[boardId]);
            }
            el.backToBoards();
            el._refs.dialog.close();
            if (Object.keys(el.boards).length <= 0) {
              el._emptyPlaceholder(el._refs.content);
            }
          });
        });
      },
      // @function _getBoardData (private) [Read board from database]
      getBoardData: function (id, callback) {
        var el = this;
        var url = "/rest/board/" + session.data.currentWorkspaceId + "/" + id;
        eon.ajax(url, {
          contentType: "application/json"
        }, function (error, data) {
          if (!error) {
            if (callback) {
              callback(JSON.parse(data.responseText));
            }
          } else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _emptyPlaceholder (private) [Toggle empty placeholder] @param parent [Element where to append the placeholder]
      emptyPlaceholder: function (parent) {
        var el = this;
        if (parent) {
          if (!el._refs.placeHolder) {
            el._refs.placeHolder = createPlaceHolder(eon.locale.global.noProjects,
              "img/no-content/no-content.svg", eon.locale.global.noProjectsTitle);
          }
          el._refs.placeHolder.classList.remove("hide");
          parent.appendChild(this._refs.placeHolder);
          if (!this._refs.placeHolder.querySelector(".add-new")) {
            var createNew = document.createElement("div");
            createNew.classList.add("add-new", "eon-fg0");
            createNew.addEventListener("click", function () {
              el._refs.dialog.heading = eon.locale.projects.create;
              el._misc.editBoard = false;
              el._refs.dialog.open();
              // Push dialog state
              pushDialogState(el._refs.dialog);
            });
            createNew.innerText = eon.locale.projects.addNew;
            this._refs.placeHolder.appendChild(createNew);
          }
        } else if (el._refs.placeHolder) {
          el._refs.placeHolder.parentElement.removeChild(el._refs.placeHolder);
          el._refs.placeHolder = null;
        }
      },
      // @function _setTaskCount (private) [Set tasks status for each board] @param taskCount
      setTaskCount: function (taskCount) {
        var el = this;
        for (var key in el._misc.taskCounts) {
          if (taskCount[key]) {
            for (var type in el._misc.taskCounts[key]) {
              el._misc.taskCounts[key][type].innerHTML = taskCount[key][type];
            }
          }
        }
      },
      // @function _isDesktop (private)
      isDesktop: function () {
        if (window.innerWidth <= 600) {
          this._misc.desktop = false;
        } else {
          this._misc.desktop = true;
        }

        return this._misc.desktop;
      },
      // @function _printBoardsAsync (private) [Print boards to screen async] @param data
      printBoardsAsync: function (data) {
        var el = this;
        var length = data.length;
        (function __printBoard(i) {
          if (data[i]) {
            el.setData_board(data[i]);
          }
          if (i < length) {
            setTimeout(function () {
              __printBoard(i + 1);
            }, 1);
          } else {

          }
        }(0));
      }
    },

    onCreated: function () {
      var el = this;
      eon.createCallback("onWorkspaceLoaded", el, "ready");
      eon.createCallback("onDataShown", el, "ready");
      eon.createCallback("onAllDataShown", el, "ready");
    },

    onTransformed: function () {
      var el = this;

      // Draw static content
      this._drawStatic();

      el._init();

      var pagination = el._isDesktop() ? 6 : 3;

      el._refs.userSelector.pagination = pagination;
    },
    onReady: function () {
      var el = this;
      session.onReady(function () {
        el.refresh();
      });

      session.onWorkspaceChanged(function () {        
        el.reset();
        el.refresh();
      });
    },
    onPropertyChanged: function (key, oldVal, newVal) {
      var el = this;
      switch (key) {
        case "taskCount":
          el._setTaskCount(newVal);
          break;
      }
    },

    onWindowResize: function () {
      var el = this;
      var throttled = false;
      var delay = 10;

      // Decrease resize calls
      if (!throttled) {
        throttled = true;
        // Check resolution
        var isDesktop = window.innerWidth <= 600 ? false : true;

        if (isDesktop && !el._misc.desktop) {
          el._misc.desktop = true;
          el._refs.userSelector.pagination = 6;
          if (el._misc.editBoard) {
            el._refs.userSelector.setData(el._misc.workspaceData, el._misc.boardUsers, el._misc.boardGroups);
          } else {
            el._refs.userSelector.setData(el._misc.workspaceData, [session.data.id]);
          }

        } else if (!isDesktop && el._misc.desktop) {
          el._misc.desktop = false;
          el._refs.userSelector.pagination = 3;
          if (el._misc.editBoard) {
            el._refs.userSelector.setData(el._misc.workspaceData, el._misc.boardUsers, el._misc.boardGroups);
          } else {
            el._refs.userSelector.setData(el._misc.workspaceData, [session.data.id]);
          }
        }

        // Set a timeout to un-throttle
        setTimeout(function () {
          throttled = false;
        }, delay);
      }
    }
  });
</script>