<template>
  <eon-dialog allow-scroll="false" class="task-dialog interactDialog" modal="true" closable="false"
    default-style="false" eon-ref="dialog">
    <eon-loading eon-ref="mask" duration="5000" class="form-mask" format="descendant" display="false">
    </eon-loading>
    <eon-section type="content" class="task-dialog-content-section" eon-ref="dialogContent">
      <div class="task-dialog-content" eon-ref="sectionContent">
        <div class="task-dialog-name-options task-dialog-task-data-content-format">
          <eon-label editable="true" class="task-dialog-task-name h-color" double-click="true" blur-save="true"
            eon-ref="taskName">
          </eon-label>
          <i class="vicon vicon-close task-dialog-close" eon-ref="close"></i>
        </div>
        <div class="task-dialog-content-header">
          <app-toggle-menu icon="ticon-flag" button-full-width="false" content-full-width="false"
            class="task-dialog-priority task-dialog-priority-pc" content-class="task-dialog-priority-content"
            anchor="left" eon-ref="priority">
            <eon-variable bind="locale.projects.board.task.priorityLabel" global="true"
              class="app-toggle-menu-label eon-fg-h4">
            </eon-variable>
            <eon-button class="app-toggle-menu-item" icon="<i class='vicon ticon-flag task-dialog-priority-urgent'></i>"
              bind:label="global locale.projects.board.task.priority.urgent" design="flat" eon-ref="priority_urgent">
            </eon-button>
            <eon-button class="app-toggle-menu-item" icon="<i class='vicon ticon-flag task-dialog-priority-high'></i>"
              bind:label="global locale.projects.board.task.priority.high" design="flat" eon-ref="priority_high">
            </eon-button>
            <eon-button class="app-toggle-menu-item" icon="<i class='vicon ticon-flag task-dialog-priority-normal'></i>"
              bind:label="global locale.projects.board.task.priority.normal" design="flat" eon-ref="priority_normal">
            </eon-button>
            <eon-button class="app-toggle-menu-item" icon="<i class='vicon ticon-flag task-dialog-priority-low'></i>"
              bind:label="global locale.projects.board.task.priority.low" design="flat" eon-ref="priority_low">
            </eon-button>
            <eon-button class="app-toggle-menu-item" icon="<i class='vicon ticon-flag task-dialog-priority-none'></i>"
              bind:label="global locale.projects.board.task.priority.none" design="flat" eon-ref="priority_clear">
            </eon-button>
          </app-toggle-menu>


          <div class="task-dialog-menu-header" eon-ref="menuHeader">

            <div class="task-dialog-status-layout" eon-ref="task_status">
              <div class="row">
                <div>
                  <div class="task-dialog-status-pc">
                    <eon-variable class="task-dialog-status-pc-title task-dialog-pc-title no-selectable h-color"
                      bind="locale.projects.board.task.status" global="true">
                    </eon-variable>
                    <div class="row task-dialog-menu-value">
                      <i class="vicon vicon-list task-dialog-menu-icon"></i>
                      <div class="task-dialog-status-value" eon-ref="status_pc_value"></div>
                    </div>
                  </div>
                </div>
                <app-toggle-menu class="task-dialog-status-estimated"
                  content-class="task-dialog-status-estimated-content" anchor="left" hidden-menu="true"
                  eon-ref="status_menu">
                </app-toggle-menu>
                <!-- <eon-button class="task-dialog-status-layout-next" icon="<i class='vicon ticon-chevron-right'></i>"
                  design="outlined" eon-ref="task_status_next">
                </eon-button> -->
              </div>
            </div>

            <div class="task-dialog-schedule task-dialog-date">
              <div class="task-dialog-schedule-menu-duration">
                <div class="task-dialog-schedule-estimated-icon" eon-ref="schedule_estimated">
                  <div class="task-dialog-schedule-pc">
                    <eon-variable class="task-dialog-schedule-pc-title task-dialog-pc-title no-selectable h-color"
                      bind="locale.projects.board.task.duration" global="true">
                    </eon-variable>
                    <div class="row task-dialog-menu-value">
                      <i class="vicon vicon-clock task-dialog-menu-icon"></i>
                      <div class="task-dialog-schedule-value" eon-ref="schedule_estimated_pc_value"></div>
                    </div>
                  </div>
                </div>
                <app-toggle-menu class="task-dialog-schedule-estimated"
                  content-class="task-dialog-schedule-estimated-content" anchor="left" hidden-menu="true"
                  eon-ref="estimated_menu">
                  <div class="task-dialog-menu-selector-header no-selectable eon-fg-h4">
                    <eon-variable bind="locale.projects.board.task.duration" global="true">
                    </eon-variable>
                    <div class="separator"></div>
                    <i class="vicon-close task-dialog-menu-selector-header-close" eon-ref="estimatedClose"></i>
                  </div>
                  <eon-number min="0" bind:label="global locale.projects.board.task.days" label-anim="false"
                    eon-ref="estimated_days"></eon-number>
                  <eon-number min="0" bind:label="global locale.projects.board.task.hours" label-anim="false"
                    eon-ref="estimated_hours"></eon-number>
                  <eon-number min="0" bind:label="global locale.projects.board.task.minutes" label-anim="false"
                    eon-ref="estimated_minutes"></eon-number>
                  <div class="row task-dialog-schedule-context-menu-footer">
                    <eon-variable class="task-dialog-schedule-clear" bind="locale.global.clear" global="true"
                      eon-ref="estimatedClear">
                    </eon-variable>
                    <eon-variable class="task-dialog-schedule-ok" bind="locale.global.ok" global="true"
                      eon-ref="estimatedOk">
                    </eon-variable>
                  </div>
                </app-toggle-menu>
              </div>
              <div>
                <div class="task-dialog-schedule-menu-worked" eon-ref="schedule_worked">
                  <div class="row">
                    <div class="column">
                      <eon-variable class="task-dialog-schedule-pc-title task-dialog-pc-title no-selectable h-color"
                        bind="locale.projects.board.task.worked" global="true">
                      </eon-variable>
                      <div class="row task-dialog-menu-value">
                        <i class="vicon ticon-chrono task-dialog-menu-icon"></i>
                        <div class="task-dialog-schedule-value" eon-ref="schedule_worked_value"></div>
                      </div>
                    </div>
                    <div class="task-dialog-worked-play" eon-ref="worked_play">
                      <i class="task-dialog-worked-play-button vicon vicon-play" eon-ref="worked_play_button"></i>
                      <div class="task-dialog-worked-play-animation eon-bg1-gradient hide"
                        eon-ref="worked_play_animation"></div>
                    </div>
                  </div>
                </div>
                <app-toggle-menu class="task-dialog-schedule-worked" content-class="task-dialog-schedule-worked-content"
                  anchor="left" hidden-menu="true" eon-ref="worked_menu">
                  <div class="task-dialog-menu-selector-header no-selectable eon-fg-h4">
                    <eon-variable bind="locale.projects.board.task.worked" global="true">
                    </eon-variable>
                    <div class="separator"></div>
                    <i class="vicon-close task-dialog-menu-selector-header-close" eon-ref="workedClose"></i>
                  </div>
                  <eon-number min="0" bind:label="global locale.projects.board.task.hours" label-anim="false"
                    eon-ref="worked_hours"></eon-number>
                  <eon-number min="0" bind:label="global locale.projects.board.task.minutes" label-anim="false"
                    eon-ref="worked_minutes"></eon-number>
                  <eon-number min="0" bind:label="global locale.projects.board.task.seconds" label-anim="false"
                    eon-ref="worked_seconds"></eon-number>                    
                    <div class="row task-dialog-schedule-context-menu-footer">
                      <eon-variable class="task-dialog-schedule-clear" bind="locale.global.clear" global="true"
                        eon-ref="workedClear">
                      </eon-variable>
                      <eon-variable class="task-dialog-schedule-ok" bind="locale.global.ok" global="true"
                        eon-ref="workedOk">
                      </eon-variable>
                    </div>
                </app-toggle-menu>
              </div>


              <div class="task-dialog-schedule-menu-padding" eon-ref="schedule_start">
                <div class="task-dialog-schedule-pc">
                  <eon-variable class="task-dialog-schedule-pc-title task-dialog-pc-title no-selectable h-color"
                    bind="locale.projects.board.task.startDate" global="true">
                  </eon-variable>
                  <div class="row task-dialog-menu-value">
                    <i class="vicon ticon-date task-dialog-menu-icon"></i>
                    <div class="task-dialog-schedule-value" eon-ref="schedule_start_pc_value"></div>
                  </div>
                  <eon-date picker-width="300" bind:picker-label="global locale.projects.board.task.startDate"
                    inline="false" locale="es-ES" mask="DDMMYYYY" value-format="YYYY/MM/DD" bind:clear-text="global locale.global.clear"
                    clear-button="true" eon-ref="schedule_start_pc_date"></eon-date>
                </div>
              </div>
              <div class="task-dialog-schedule-menu-padding" eon-ref="schedule_due">
                <div class="task-dialog-schedule-pc">
                  <eon-variable class="task-dialog-schedule-pc-title task-dialog-pc-title no-selectable h-color"
                    bind="locale.projects.board.task.dueDate" global="true">
                  </eon-variable>
                  <div class="row task-dialog-menu-value">
                    <i class="vicon ticon-date task-dialog-menu-icon"></i>
                    <div class="task-dialog-schedule-value" eon-ref="schedule_due_pc_value"></div>
                  </div>
                  <eon-date picker-width="300" bind:picker-label="global locale.projects.board.task.dueDate"
                    inline="false" locale="es-ES" mask="DDMMYYYY" value-format="YYYY/MM/DD" bind:clear-text="global locale.global.clear"
                    clear-button="true" eon-ref="schedule_due_pc_date">
                  </eon-date>
                </div>
              </div>
            </div>
            <app-toggle-menu class="task-dialog-labels-selector-button" content-class="task-dialog-labels-selector"
              icon="vicon-tags" button-full-width="false" anchor="left" eon-ref="labels"></app-toggle-menu>
            <app-toggle-menu icon="ticon-add-user" button-full-width="false" class="task-dialog-observers"
              content-class="task-dialog-observers-content" anchor="left" eon-ref="observers">
              <div class="task-dialog-menu-selector-header no-selectable eon-fg-h4 app-toggle-menu-fixed">
                <eon-variable bind="locale.projects.board.task.assignees" global="true">
                </eon-variable>
                <div class="separator"></div>
                <i class="vicon-close task-dialog-menu-selector-header-close" eon-ref="viewersClose"></i>
              </div>
              <app-user-selector eon-ref="selectObservers" pagination="3" class="selectObservers">
              </app-user-selector>
            </app-toggle-menu>
            <div class="task-dialog-viewers" eon-ref="viewers"></div>
          </div>
          <div class="separator"></div>
          <app-toggle-menu anchor="right" class="task-dialog-options main-color" icon="vicon-more-vert"
            eon-ref="options">
            <eon-toggle class="task-dialog-chat-filter" label-position="left"
              bind:label="global locale.projects.board.task.toggleLog" eon-ref="toggleLog"></eon-toggle>
            <div class="app-toggle-menu-item" type="delete" eon-ref="delete">
              <i class='vicon vicon-bin'></i>
              <eon-variable class="" bind="locale.global.delete" global="true"></eon-variable>
            </div>
          </app-toggle-menu>
        </div>
        <div class="task-dialog-split task-dialog-column-to-row">
          <div class="task-dialog-task-data-content">
            <div class="task-dialog-mobile-toggle-conversation" eon-ref="toggleConversation">
              <i class="vicon vicon-chat"></i>
              <eon-variable class="" bind="locale.projects.board.task.viewConversation" global="true"></eon-variable>
            </div>
            <eon-scroll id="task-dialog-content-scroll" class="task-dialog-task-data-content-scroll" thickness="8"
              static="true" eon-ref="scrollContent">
              <div class=" task-dialog-task-data-content-format">
                <div class="task-dialog-menu-header-mobile task-dialog-menu-header-mobile-active"
                  eon-ref="menuHeaderMobile">
                  <div class="task-dialog-menu-header-mobile-element task-dialog-menu-header-mobile-element-priority">
                    <div class="row">
                      <app-toggle-menu icon="ticon-flag" button-full-width="false" content-full-width="false"
                        class="task-dialog-priority task-dialog-priority-mobile"
                        content-class="task-dialog-priority-content" anchor="left" eon-ref="priority_mobile">
                        <div class="task-dialog-menu-selector-header no-selectable eon-fg-h4">
                          <eon-variable bind="locale.projects.board.task.priorityLabel" global="true">
                          </eon-variable>
                          <!-- <i class="vicon-close task-dialog-menu-selector-header-close" eon-ref="priorityClose"></i> -->
                        </div>
                        <eon-button class="app-toggle-menu-item"
                          icon="<i class='vicon ticon-flag task-dialog-priority-urgent'></i>"
                          bind:label="global locale.projects.board.task.priority.urgent" design="flat"
                          eon-ref="priority_urgent_mobile">
                        </eon-button>
                        <eon-button class="app-toggle-menu-item"
                          icon="<i class='vicon ticon-flag task-dialog-priority-high'></i>"
                          bind:label="global locale.projects.board.task.priority.high" design="flat"
                          eon-ref="priority_high_mobile">
                        </eon-button>
                        <eon-button class="app-toggle-menu-item"
                          icon="<i class='vicon ticon-flag task-dialog-priority-normal'></i>"
                          bind:label="global locale.projects.board.task.priority.normal" design="flat"
                          eon-ref="priority_normal_mobile">
                        </eon-button>
                        <eon-button class="app-toggle-menu-item"
                          icon="<i class='vicon ticon-flag task-dialog-priority-low'></i>"
                          bind:label="global locale.projects.board.task.priority.low" design="flat"
                          eon-ref="priority_low_mobile">
                        </eon-button>
                        <eon-button class="app-toggle-menu-item"
                          icon="<i class='vicon ticon-flag task-dialog-priority-none'></i>"
                          bind:label="global locale.projects.board.task.priority.none" design="flat"
                          eon-ref="priority_clear_mobile">
                        </eon-button>
                      </app-toggle-menu>


                      <div class="column" eon-ref="priority_mobile_data_opener">
                        <eon-variable class="task-dialog-pc-title no-selectable h-color"
                          bind="locale.projects.board.task.priority.priority" global="true">
                        </eon-variable>
                        <div class="task-dialog-status-value" eon-ref="priority_mobile_value"></div>
                      </div>

                      <app-toggle-menu anchor="right" class="task-dialog-options task-dialog-options-mobile main-color"
                        icon="vicon-more-vert" eon-ref="options_mobile">
                        <eon-toggle class="task-dialog-chat-filter task-dialog-options-mobile-toggleLogs"
                          label-position="left" bind:label="global locale.projects.board.task.toggleLog"
                          eon-ref="toggleLog_mobile">
                        </eon-toggle>
                        <div class="app-toggle-menu-item" type="delete" eon-ref="delete_mobile">
                          <i class='vicon vicon-bin'></i>
                          <eon-variable class="" bind="locale.global.delete" global="true"></eon-variable>
                        </div>
                      </app-toggle-menu>
                    </div>
                  </div>

                  <div class="task-dialog-menu-header-mobile-element task-dialog-menu-header-mobile-element-list"
                    eon-ref="task_status_mobile">
                    <div class="row">
                      <i class="vicon vicon-list task-dialog-menu-icon"></i>
                      <div class="column">
                        <eon-variable class="task-dialog-status-pc-title task-dialog-pc-title no-selectable h-color"
                          bind="locale.projects.board.task.status" global="true">
                        </eon-variable>
                        <div class="task-dialog-status-value" eon-ref="status_mobile_value"></div>
                      </div>
                      <app-toggle-menu class="task-dialog-status-estimated"
                        content-class="task-dialog-status-estimated-content" anchor="left" hidden-menu="true"
                        eon-ref="status_menu_mobile">
                      </app-toggle-menu>
                      <!-- <div class="task-dialog-status-layout-next-mobile-layout" eon-ref="task_status_next_mobile">
                        <eon-button class="task-dialog-status-layout-next"
                          icon="<i class='vicon ticon-chevron-right'></i>" design="outlined"
                          eon-ref="task_status_next_mobile_button">
                        </eon-button>
                      </div> -->

                    </div>
                  </div>
                  <div class="task-dialog-menu-header-mobile-element task-dialog-menu-header-mobile-element-status"
                    eon-ref="schedule_estimated_mobile">
                    <div class="row">
                      <i class="vicon vicon-clock task-dialog-menu-icon"></i>
                      <div class="column">
                        <eon-variable class="task-dialog-schedule-pc-title task-dialog-pc-title no-selectable h-color"
                          bind="locale.projects.board.task.duration" global="true">
                        </eon-variable>
                        <div class="task-dialog-schedule-value" eon-ref="schedule_estimated_mobile_value"></div>
                      </div>
                      <app-toggle-menu class="task-dialog-schedule-estimated"
                        content-class="task-dialog-schedule-estimated-content" anchor="left" hidden-menu="true"
                        eon-ref="estimated_menu_mobile">
                        <div class="task-dialog-menu-selector-header no-selectable eon-fg-h4">
                          <eon-variable bind="locale.projects.board.task.duration" global="true">
                          </eon-variable>
                          <div class="separator"></div>
                          <i class="vicon-close task-dialog-menu-selector-header-close"
                            eon-ref="estimatedClose_mobile"></i>
                        </div>
                        <eon-number min="0" bind:label="global locale.projects.board.task.days" label-anim="false"
                          eon-ref="estimated_days_mobile"></eon-number>
                        <eon-number min="0" bind:label="global locale.projects.board.task.hours" label-anim="false"
                          eon-ref="estimated_hours_mobile"></eon-number>
                        <eon-number min="0" bind:label="global locale.projects.board.task.minutes" label-anim="false"
                          eon-ref="estimated_minutes_mobile"></eon-number>
                          <div class="row task-dialog-schedule-context-menu-footer">
                            <eon-variable class="task-dialog-schedule-clear" bind="locale.global.clear" global="true"
                              eon-ref="estimatedClear_mobile">
                            </eon-variable>
                            <eon-variable class="task-dialog-schedule-ok" bind="locale.global.ok" global="true"
                              eon-ref="estimatedOk_mobile">
                            </eon-variable>
                          </div>
                      </app-toggle-menu>
                    </div>
                  </div>
                  <div
                    class="task-dialog-menu-header-mobile-element task-dialog-menu-header-mobile-element-status task-dialog-date"
                    eon-ref="schedule_worked_mobile">
                    <div class="row">
                      <i class="vicon ticon-chrono task-dialog-menu-icon"></i>
                      <div class="column">
                        <eon-variable class="task-dialog-schedule-pc-title task-dialog-pc-title no-selectable h-color"
                          bind="locale.projects.board.task.worked" global="true">
                        </eon-variable>
                        <div class="task-dialog-schedule-value" eon-ref="schedule_worked_value_mobile"></div>
                      </div>

                      <div class="task-dialog-worked-play" eon-ref="worked_play_mobile">
                        <i class="task-dialog-worked-play-button vicon vicon-play"
                          eon-ref="worked_play_button_mobile"></i>
                        <div class="task-dialog-worked-play-animation eon-bg1-gradient hide"
                          eon-ref="worked_play_animation_mobile"></div>
                      </div>

                      <app-toggle-menu class="task-dialog-schedule-worked"
                        content-class="task-dialog-schedule-worked-content" anchor="left" hidden-menu="true"
                        eon-ref="worked_menu_mobile">
                        <div class="task-dialog-menu-selector-header no-selectable eon-fg-h4">
                          <eon-variable bind="locale.projects.board.task.worked" global="true">
                          </eon-variable>
                          <div class="separator"></div>
                          <i class="vicon-close task-dialog-menu-selector-header-close"
                            eon-ref="workedClose_mobile"></i>
                        </div>
                        <eon-number min="0" bind:label="global locale.projects.board.task.hours" label-anim="false"
                          eon-ref="worked_hours_mobile"></eon-number>
                        <eon-number min="0" bind:label="global locale.projects.board.task.minutes" label-anim="false"
                          eon-ref="worked_minutes_mobile"></eon-number>
                        <eon-number min="0" bind:label="global locale.projects.board.task.seconds" label-anim="false"
                          eon-ref="worked_seconds_mobile"></eon-number>             
                          <div class="row task-dialog-schedule-context-menu-footer">
                            <eon-variable class="task-dialog-schedule-clear" bind="locale.global.clear" global="true"
                              eon-ref="workedClear_mobile">
                            </eon-variable>
                            <eon-variable class="task-dialog-schedule-ok" bind="locale.global.ok" global="true"
                              eon-ref="workedOk_mobile">
                            </eon-variable>
                          </div>
                      </app-toggle-menu>


                    </div>
                  </div>
                  <div
                    class="task-dialog-menu-header-mobile-element task-dialog-menu-header-mobile-element-status task-dialog-date"
                    eon-ref="schedule_start_mobile">
                    <div class="row">
                      <i class="vicon ticon-date task-dialog-menu-icon"></i>
                      <div class="column">
                        <eon-variable class="task-dialog-schedule-pc-title task-dialog-pc-title no-selectable h-color"
                          bind="locale.projects.board.task.startDate" global="true">
                        </eon-variable>
                        <div class="task-dialog-schedule-value" eon-ref="schedule_start_mobile_value"></div>
                      </div>
                      <eon-date picker-width="300" bind:picker-label="global locale.projects.board.task.startDate"
                        inline="false" locale="es-ES" mask="DDMMYYYY" value-format="YYYY/MM/DD" bind:clear-text="global locale.global.clear"
                        clear-button="true" eon-ref="schedule_start_mobile_date"></eon-date>
                    </div>
                  </div>

                  <div
                    class="task-dialog-menu-header-mobile-element task-dialog-menu-header-mobile-element-status task-dialog-date"
                    eon-ref="schedule_due_mobile">
                    <div class="row">
                      <i class="vicon ticon-date task-dialog-menu-icon"></i>
                      <div class="column">
                        <eon-variable class="task-dialog-schedule-pc-title task-dialog-pc-title no-selectable h-color"
                          bind="locale.projects.board.task.dueDate" global="true">
                        </eon-variable>
                        <div class="task-dialog-schedule-value" eon-ref="schedule_due_mobile_value"></div>
                      </div>
                      <eon-date picker-width="300" bind:picker-label="global locale.projects.board.task.dueDate"
                        inline="false" locale="es-ES" mask="DDMMYYYY" value-format="YYYY/MM/DD" bind:clear-text="global locale.global.clear"
                        clear-button="true" eon-ref="schedule_due_mobile_date"></eon-date>
                    </div>
                  </div>


                  <div class="task-dialog-menu-header-mobile-element task-dialog-menu-header-mobile-element-members"
                    eon-ref="observers_mobile">
                    <div class="row">
                      <i class="vicon ticon-add-user task-dialog-menu-icon"></i>
                      <div class="column">
                        <eon-variable class="task-dialog-pc-title no-selectable h-color"
                          bind="locale.projects.board.task.assignees" global="true" eon-ref="viewers_mobile_label">
                        </eon-variable>
                        <eon-variable class="task-dialog-mobile-add-new no-selectable"
                          bind="locale.projects.board.task.placeholder.assignee" global="true"
                          eon-ref="viewers_mobile_placeholder">
                        </eon-variable>
                        <div class="task-dialog-viewers-mobile" eon-ref="viewers_mobile"></div>
                      </div>
                      <app-toggle-menu button-full-width="false" class="task-dialog-observers"
                        content-class="task-dialog-observers-content" anchor="left" hidden-menu="true"
                        eon-ref="observers_menu_mobile">
                        <div class="task-dialog-menu-selector-header no-selectable eon-fg-h4 app-toggle-menu-fixed">
                          <eon-variable bind="locale.projects.board.task.assignees" global="true">
                          </eon-variable>
                          <div class="separator"></div>
                          <i class="vicon-close task-dialog-menu-selector-header-close"
                            eon-ref="viewersClose_mobile"></i>
                        </div>
                        <app-user-selector class="selectObservers" eon-ref="selectObservers_mobile" pagination="8">
                        </app-user-selector>
                      </app-toggle-menu>
                    </div>
                  </div>
                  <div class="task-dialog-menu-header-mobile-element task-dialog-menu-header-mobile-element-labels"
                    eon-ref="labels_mobile">
                    <div class="row">
                      <i class="vicon vicon-tags task-dialog-menu-icon"></i>
                      <div class="column">
                        <eon-variable class="task-dialog-schedule-pc-title task-dialog-pc-title no-selectable h-color"
                          bind="locale.projects.board.task.labels" global="true">
                        </eon-variable>
                        <div class="task-dialog-labels-show-mobile" eon-ref="labelsShow_mobile">
                        </div>
                      </div>
                      <app-toggle-menu class="" content-class="task-dialog-labels-selector" button-full-width="false"
                        anchor="left" hidden-menu="true" eon-ref="labels_menu_mobile"></app-toggle-menu>
                    </div>
                  </div>

                </div>
                <!-- <div class="task-dialog-menu-header-mobile-toggle task-dialog-menu-header-mobile-toggle-active"
                  eon-ref="menuHeaderMobileToggle">
                  <i class='vicon vicon-chevron-up' eon-ref="menuHeaderMobileToggleIcon"></i>
                </div> -->
                <div class="task-dialog-labels-show" eon-ref="labelsShow"></div>
                <div class="task-dialog-title task-dialog-title-description" eon-ref="taskDescriptionTitle">
                  <eon-variable class="task-dialog-title-text h-color" bind="locale.global.description" global="true">
                  </eon-variable>
                </div>
                <app-editable-text type="area" auto-grow="true" class="task-dialog-description" save-on-blur="true"
                  bind:placeholder="global locale.projects.board.task.placeholder.description"
                  eon-ref="taskDescription">
                </app-editable-text>
                <div class="task-dialog-title task-dialog-title-checklist">
                  <eon-variable class="task-dialog-title-text h-color" bind="locale.projects.board.task.checklist"
                    global="true">
                  </eon-variable>
                  <!-- <eon-button icon="<i class='vicon vicon-add'></i>"
                    bind:label="global locale.projects.board.task.addChecklist" design="outlined"
                    eon-ref="addCheckList">
                  </eon-button> -->
                </div>
                <div class="task-dialog-added" eon-ref="added"></div>
                <!-- <app-add-new class="task-dialog-checklist-add-new" close-on-empty="true"
                  bind:placeholder="global locale.global.typeName" eon-ref="checkListAddNew">
                </app-add-new> -->
                <app-editable-text class="task-dialog-checklist-add-new" fixed-width="true" footer="true"
                  bind:placeholder="global locale.projects.board.task.addChecklist"
                  bind:placeholder-expanded="global locale.global.typeName" eon-ref="checkListAddNew">
                </app-editable-text>

                <div class="task-dialog-title">
                  <eon-variable class="task-dialog-title-text h-color" bind="locale.projects.board.task.attachments"
                    global="true"></eon-variable>
                  <!-- <eon-button class="task-dialog-addImages-mobile" icon="<i class='vicon vicon-add'></i>"
                    bind:label="global locale.projects.board.task.addAttachment" design="outlined" eon-ref="addImages">
                  </eon-button> -->
                </div>
                <div eon-ref="fileUploader"></div>
                <eon-scroll class="task-dialog-scroll-attachments" thickness="8" static="true">
                  <eon-variable class="task-dialog-addImages-mobile" bind="locale.projects.board.task.addAttachment"
                    global="true" eon-ref="addImages"></eon-variable>
                  <div class="task-dialog-attachments" eon-ref="attachments"></div>
                </eon-scroll>
                <div class="task-dialog-task-data-content-format-bottom"></div>
              </div>
            </eon-scroll>
            <div class="task-dialog-data-content-footer task-dialog-footer">
              <i class="vicon vicon-cloud-o"></i>
              <eon-variable bind="locale.projects.board.task.dropToAttach" global="true"></eon-variable>
              <eon-variable class="task-dialog-data-content-footer-browse main-color"
                bind="locale.projects.board.task.browse" global="true" eon-ref="browseFiles"></eon-variable>
            </div>
          </div>
          <div class="task-dialog-chat" eon-ref="chatWindow">
            <div class="task-dialog-chat-menu" eon-ref="chatMenu">
              <div class="task-dialog-chat-mobile-button task-dialog-chat-mobile-button-close"
                eon-ref="closeMobileChat">
                <i class="vicon vicon-arrow-back"></i>
                <eon-variable class="no-selectable" bind="locale.global.goBack" global="true"></eon-variable>
              </div>
              <div class="separator"></div>

              <app-toggle-menu anchor="right" class="task-dialog-options main-color task-dialog-options-mobile-chat"
                icon="vicon-more-vert" eon-ref="options_mobile_chat">
                <eon-toggle class="task-dialog-chat-filter" label-position="left"
                  bind:label="global locale.projects.board.task.toggleLog" eon-ref="toggleLog_mobile_chat"></eon-toggle>
              </app-toggle-menu>

            </div>
            <eon-scroll class="task-dialog-chat-scroll-content" thickness="8" static="true" eon-ref="chatScrollContent">
              <div class="task-dialog-chat-layout task-dialog-chat-content" eon-ref="chatContent"></div>
            </eon-scroll>
            <div class="task-dialog-chat-layout task-dialog-chat-entry task-dialog-footer" eon-ref="chatInputLayout">
              <eon-variable class="task-dialog-chat-placeholder" bind="locale.projects.board.task.typeMessage"
                global="true" eon-ref="chatPlaceholder"></eon-variable>
              <i class="task-dialog-chat-icon ticon-chat" eon-ref="chatIcon"></i>
              <div class="task-dialog-chat-input" contenteditable="true" eon-ref="chatEntry"></div>
              <eon-button class="bar-button h1-button task-dialog-chat-footer" icon="<i class='vicon vicon-send'></i>"
                bind:label="global locale.global.send" design="filled" eon-ref="chatSend">
              </eon-button>
              <i class="task-dialog-chat-footer-mobile vicon-send" eon-ref="chatSend_mobile"></i>
            </div>
          </div>
        </div>
      </div>
    </eon-section>
    <div class="task-dialog-attach-overlay" eon-ref="attachOverlay">
      <eon-variable bind="locale.projects.board.task.attachToTask" global="true"></eon-variable>
    </div>
  </eon-dialog>
  <eon-dialog allow-scroll="false" class="task-dialog-image-zoom-in" modal="true" closable="true" default-style="false"
    eon-ref="fileZoomIn">
    <eon-section type="content">
      <div class="task-dialog-image-zoom-in-content" eon-ref="imageZoomInContent"></div>
    </eon-section>
  </eon-dialog>
</template>

<script>
  eon.element("task-dialog", {
    style: "task-dialog.css",
    dependencies: [
      "@ui/eon-dialog",
      "@ui/eon-text",
      "@ui/eon-scroll",
      "@ui/eon-date",
      "@ui/eon-label",
      "@ui/eon-number",
      "@ui/eon-check",
      "@ui/eon-toggle",
      "@ui/eon-button",
      "@custom/app-add-new",
      "@custom/eon-contextmenu",
      "@custom/app-editable-text",
      "@custom/app-toggle-menu",
      "@custom/app-user-selector",
      "@custom/app-files-uploader",
      "@custom/app-avatar"
    ],

    properties: {
      // @html-attribute task (private) [Task data]
      task: {
        value: ""
      },
      // @html-property board (public)
      board: {
        value: "",
        observe: true
      },
      // @html-property maxViewersShown (public)
      maxViewersShown: {
        value: "3",
        reflect: true
      },
      // @html-attribute mobileSize (private) [Screen size to go mobile view]
      mobileSize: {
        value: "800"
      }
    },

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function open (public) [Open task dialog] @param taskId @param workspace @param board
      open: function (taskId, workspace, board) {
        var el = this;
        el._refs.mask.show();
        el.board = board;
        el._misc.workspaceData = workspace;
        el._misc.taskId = taskId;
        el._misc.chat = el._misc.chat || {};
        el._misc.drop = {
          checklist_item: {},
          checklist: {}
        };
        el._misc.drag = {};
        el._misc.content = {};
        el._misc.log = {};
        el._refs.worked_play_animation.classList.add("hide");
        el._refs.worked_play_animation_mobile.classList.add("hide");
        el._refs.worked_play_button.classList.remove("vicon-pause");
        el._refs.worked_play_button_mobile.classList.remove("vicon-pause");
        el._refs.worked_play_button.classList.add("vicon-play");
        el._refs.worked_play_button_mobile.classList.add("vicon-play");
        clearInterval(el._misc.workingInterval);
        el._misc.chat.offset = 0;
        session.onReady(function () {
          if (session.isAdmin()) {
            el._refs.observers.classList.remove("hide");
            el._refs.observers_mobile.classList.remove("disabled");
          } else {
            el._refs.observers.classList.add("hide");
            el._refs.observers.classList.add("disabled");
          }
        });
        el._refs.dialog.open();
        // Push dialog state
        pushDialogState(el._refs.dialog);
      },
      // @function getData (public) [Get task data from database]
      getData: function (taskId, callback) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + taskId;
        eon.ajax(url, {
          contentType: "application/json"
        }, function (error, data) {
          if (!error) {
            data = JSON.parse(data.responseText);
            if (callback) {
              callback(data);
            }
          } else if (data.status == 401) {
            session.logout();
          } else if (data.status == 500) {
            showInfoDialog(eon.locale.projects.board.task.notFound, function () {});
            task.close();
            // eon.triggerCallback("onClose", el, el);
          }
        });
      },
      // @function setData (public) [Fill form with existing data]
      setData: function (data) {
        var el = this;
        el._misc.data = data;
        el._refs.taskName.value = data.name;
        el._refs.taskDescription.value = data.description ? data.description : "";
        el._refs.added.innerHTML = "";
        setTimeout(function () {
          el._refs.mask.hide();
        }, 0);
        el.setDataAsync(function () { // TODO Callback hell
          el._setTaskList(data);
        }, function () {
          el.setDataAsync(function () {
            if (el.task.schedule) {
              el._setSchedule(el.task.schedule);
            } else {
              el._setSchedule();
            }
          }, function () {
            el.setDataAsync(function () {
              el._setLabelsShow();
            }, function () {
              el.setDataAsync(function () {
                el._setViewers();
              }, function () {
                el.setDataAsync(function () {
                  el._setPriority();
                }, function () {
                  el.setDataAsync(function () {
                    if (data.viewers) {
                      el._refs.selectObservers.setData(el._misc.workspaceData, data.viewers.members, data.viewers.groups);
                      el._refs.selectObservers_mobile.setData(el._misc.workspaceData, data.viewers.members, data.viewers
                        .groups);

                    } else {
                      el._refs.selectObservers.setData(el._misc.workspaceData);
                      el._refs.selectObservers_mobile.setData(el._misc.workspaceData);
                    }
                  }, function () {
                    el.setDataAsync(function () {
                      el._setLabels();
                    }, function () {
                      el.setDataAsync(function () {
                        el._setContent(data.items);
                      }, function () {
                        el.setDataAsync(function () {
                          el._misc.chat.height = el._refs.chatWindow
                            .getBoundingClientRect().height;
                          el._misc.chat.limit = el._misc.chat.limit ||
                            parseInt(el._misc.chat.height / 94) + 1;
                          el.getChatData(function (logs) {
                            el._setChatContent(logs);
                          });
                        }, function () {
                          el.setDataAsync(function () {
                            el._refs.attachments.innerHTML = "";
                            el._setImages(data.attachments);
                          }, function () {
                            // el.setDataAsync(function () {

                            // }, function () {

                            // });
                          });
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });




      },
      // @function setDataAsync (public) [Set single element async]
      setDataAsync: function (func, callback) {
        var el = this;
        setTimeout(function () {
          func();
          if (callback) {
            callback();
          }
        }, 1);
      },
      // @function openChatInput (public) [Open chat input]
      openChatInput: function () {
        var el = this;
        el._refs.chatEntry.innerText = "";
        el._refs.chatScrollContent.classList.add("task-dialog-chat-content-active");
        el._refs.chatInputLayout.classList.add("task-dialog-chat-entry-active");
        el._refs.chatIcon.classList.add("task-dialog-chat-icon-hide");
        el._refs.chatPlaceholder.classList.add("task-dialog-chat-icon-hide");
        setTimeout(function () {
          el._refs.chatScrollContent.scrollTo(el._refs.chatContent.scrollHeight);
        }, 100);
      },
      // @function closeChatInput (public) [Open chat input]
      closeChatInput: function () {
        var el = this;
        el._refs.chatScrollContent.classList.remove("task-dialog-chat-content-active");
        el._refs.chatInputLayout.classList.remove("task-dialog-chat-entry-active");
        el._refs.chatIcon.classList.remove("task-dialog-chat-icon-hide");
        el._refs.chatEntry.innerText = "";
        el._refs.chatPlaceholder.classList.remove("task-dialog-chat-icon-hide");
      },
      // @function getChatData (private) [Read chat data]
      getChatData: function (callback) {
        var el = this;
        var url = "/rest/log/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el
          .task.id + "/" + el._misc.chat.limit + "/" + el._misc.chat.offset;
        eon.ajax(url, {
          contentType: "application/json"
        }, function (error, data) {
          if (!error) {
            data = JSON.parse(data.responseText);
            if (callback) {
              callback(data);
            }
          } else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function close (public) [Close dialog]
      close: function () {
        var el = this;
        el._refs.dialog.close();
      }
    },

    privateFunctions: {
      // @function _init (private)
      init: function () {
        var el = this;
        el._misc.content = {};
        el._createFileUploader();
        el._setUp();
      },
      // @function _setUp (private)
      setUp: function (value) {
        var el = this;
        // el._refs.chatOptions.layout = el._refs.chatMenu;
        el._addListeners();
        el._refs.estimated_menu.layout = el._refs.dialogContent;
        el._refs.estimated_menu_mobile.layout = el._refs.schedule_estimated_mobile;
        el._refs.estimated_menu_mobile.layoutHeight = el._refs.schedule_estimated_mobile;
        el._refs.worked_menu.layout = el._refs.dialogContent;
        el._refs.worked_menu_mobile.layout = el._refs.schedule_worked_mobile;
        el._refs.worked_menu_mobile.layoutHeight = el._refs.schedule_worked_mobile;
        el._socketListeners();
        el._refs.status_menu.layout = el._refs.sectionContent;
        el._refs.status_menu.layoutHeight = el._refs.task_status;
        el._refs.status_menu_mobile.layout = el._refs.task_status_mobile;
        el._refs.status_menu_mobile.layoutHeight = el._refs.task_status_mobile;
        el._refs.observers_menu_mobile.layout = el._refs.observers_mobile;
        el._refs.observers_menu_mobile.layoutHeight = el._refs.observers_mobile;
        el._refs.labels_menu_mobile.layout = el._refs.labels_mobile;
        el._refs.labels_menu_mobile.layoutHeight = el._refs.labels_mobile;
        el._refs.observers.layout = el._refs.dialogContent;
        el._refs.labels.layout = el._refs.dialogContent;
        el._misc.img = {};
        el._misc.img.checklist = document.createElement("img");
        el._misc.img.checklist.src = "img/projects/task/checklist-ghost.png";
        el._misc.img.checklistItem = document.createElement("img");
        el._misc.img.checklistItem.src = "img/projects/task/checklistItem-ghost.png";
        el.onClose(function () {
          clearInterval(el._misc.workingInterval);
        });
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        el._refs.taskName.onBlur(function () {
          el._updateName(el._refs.taskName.value);
        });
        el._refs.close.addEventListener("click", function () {
          el._refs.dialog.close();
        });
        el._refs.delete.addEventListener("click", function () {
          el._refs.options.close();
          openDeleteConfirmation(function () {
            task.delete(el.task.id);
            el._refs.dialog.close();
          });
        });
        el._refs.delete_mobile.addEventListener("click", function () {
          task.delete(el.task.id);
          el._refs.options_mobile.close();
          el._refs.dialog.close();
        });
        // el._autoGrowDescription();
        el._refs.viewers.addEventListener("click", function () {
          el._refs.observers.open();
        });
        el._refs.viewersClose.addEventListener("click", function () {
          el._refs.observers.close();
        });
        el._refs.viewersClose_mobile.addEventListener("click", function () {
          el._refs.observers_menu_mobile.close();
        });
        el._refs.observers_mobile.addEventListener("click", function () {
          el._refs.observers_menu_mobile.open();
        });
        el._refs.estimatedClose.addEventListener("click", function () {
          el._refs.estimated_menu.close();
        });
        el._refs.estimatedClose_mobile.addEventListener("click", function () {
          el._refs.estimated_menu_mobile.close();
        });
        el._refs.workedClose.addEventListener("click", function () {
          el._refs.worked_menu.close();
        });
        el._refs.workedClose_mobile.addEventListener("click", function () {
          el._refs.worked_menu_mobile.close();
        });
        el._refs.worked_menu.onOpen(function () {
          el._setupWorkingContextmenu();
        });
        el._refs.worked_menu_mobile.onOpen(function () {
          el._setupWorkingContextmenu();
        });
        el._refs.worked_play_button.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          var toggleTo = el.task.schedule ? el.task.schedule.running ? !eon.util.isTrue(el.task.schedule
            .running) : true : true;
          var scheduleData = {
            running: toggleTo
          };
          if (toggleTo) {
            scheduleData.startUTC = "" + new Date().getTime();
          } else {
            var currentElapsed = el.task.schedule.elapsed ? parseFloat(el.task.schedule.elapsed) : 0;

            scheduleData.elapsed = "" + (parseFloat(currentElapsed) + new Date().getTime() - parseFloat(el
              .task.schedule.startUTC));
          }
          el._updateTask({
            schedule: scheduleData
          });
        });
        el._refs.worked_play_button_mobile.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          var toggleTo = el.task.schedule ? el.task.schedule.running ? !eon.util.isTrue(el.task.schedule
            .running) : true : true;
          var scheduleData = {
            running: toggleTo
          };
          if (toggleTo) {
            scheduleData.startUTC = "" + new Date().getTime();
          } else {
            var currentElapsed = el.task.schedule.elapsed ? parseFloat(el.task.schedule.elapsed) : 0;

            scheduleData.elapsed = "" + (parseFloat(currentElapsed) + new Date().getTime() - parseFloat(el
              .task.schedule.startUTC));
          }
          el._updateTask({
            schedule: scheduleData
          });
        });
        el._refs.taskDescription.onEdit(function (value) {
          el._updateTask({
            description: value
          });
        });
        el._refs.chatEntry.addEventListener("focus", function () {
          el.openChatInput();
        });
        el._refs.chatEntry.addEventListener("blur", function (e) {
          el.closeChatInput();
        });
        el._refs.chatEntry.addEventListener("keydown", function (event) {
          if (event.isComposing || event.keyCode === 229) {
            return;
          } else if ((event.shiftKey || event.ctrlKey) && (event.keyCode === 13 || event.keyCode === 10)) {
            return true;
          } else if (event.keyCode === 13) {
            if (el._refs.chatEntry.innerText != "") {
              el._sendLog({
                log: el._refs.chatEntry.innerText,
                type: "message"
              });
            }
            setTimeout(function () {
              el._refs.chatEntry.innerText = "";
            }, 0);
            return false;
          }
        });
        el._refs.chatSend.addEventListener("mousedown", function (e) {
          if (el._refs.chatEntry.innerText != "") {
            el._sendLog({
              log: el._refs.chatEntry.innerText,
              type: "message"
            });
          }
          el._refs.chatEntry.innerText = "";
        });
        el._refs.chatSend_mobile.addEventListener("mousedown", function (e) {
          if (el._refs.chatEntry.innerText != "") {
            el._sendLog({
              log: el._refs.chatEntry.innerText,
              type: "message"
            });
          }
          el._refs.chatEntry.innerText = "";
        });
        el._refs.selectObservers.onChange(function (viewers) {
          el._updateTask({
            viewers: viewers
          });
        });
        el._refs.selectObservers_mobile.onChange(function (viewers) {
          el._updateTask({
            viewers: viewers
          });
        });
        el._refs.dialog.onOpened(function () {
          if (el._misc.workspaceData) {
            if (el.board) {
              el.getData(el._misc.taskId, function (data) {
                el.task = data;
                el.setData(data);
              });
            } else {
              var taskSplit = el._misc.taskId.split(":");
              var boardId = taskSplit[0] + ":" + taskSplit[1];
              task.getBoardData(boardId, function (boardData) {
                el.board = boardData;
                el.getData(el._misc.taskId, function (data) {
                  el.task = data;
                  el.setData(data);
                });
              });
            }
          } else {
            task.getWorkspaceData(function (workspace) {
              el._misc.workspaceData = workspace;
              if (el.board) {
                el.getData(el._misc.taskId, function (data) {
                  el.task = data;
                  el.setData(data);
                });
              } else {
                var taskSplit = el._misc.taskId.split(":");
                var boardId = taskSplit[0] + ":" + taskSplit[1];
                task.getBoardData(boardId, function (boardData) {
                  el.board = boardData;
                  el.getData(el._misc.taskId, function (data) {
                    el.task = data;
                    el.setData(data);
                  });
                });
              }
            });
          }



        });
        el._refs.dialog.onClose(function () {
          eon.triggerCallback("onClose", el, el);
          el._refs.mask.hide();
        });
        // el._refs.addCheckList.addEventListener("click", function () {
        //   el._addContent("checklist", "", true);
        // });
        el._refs.imageUploader.onUpload(function (files) {
          var loadingMask = el._createLoadingAttachments();
          if (el._refs.placeHolder) {
            el._refs.placeHolder.classList.add("hide");
          }
          el._refs.attachments.appendChild(loadingMask);
          el._uploadImages(files, loadingMask);
        });
        el._refs.priority_urgent.addEventListener("click", function (e) {
          el._updatePriority("urgent", e);
          el._refs.priority.close(event);
        });
        el._refs.priority_high.addEventListener("click", function (e) {
          el._updatePriority("high", e);
          el._refs.priority.close(event);
        });
        el._refs.priority_normal.addEventListener("click", function (e) {
          el._updatePriority("normal", e);
          el._refs.priority.close(event);
        });
        el._refs.priority_low.addEventListener("click", function (e) {
          el._updatePriority("low", e);
          el._refs.priority.close(event);
        });
        el._refs.priority_clear.addEventListener("click", function (e) {
          el._updatePriority(false, e);
          el._refs.priority.close(event);
        });

        el._refs.priority_urgent_mobile.addEventListener("click", function (e) {
          el._updatePriority("urgent", e);
          el._refs.priority_mobile.close(event);
        });
        el._refs.priority_high_mobile.addEventListener("click", function (e) {
          el._updatePriority("high", e);
          el._refs.priority_mobile.close(event);
        });
        el._refs.priority_normal_mobile.addEventListener("click", function (e) {
          el._updatePriority("normal", e);
          el._refs.priority_mobile.close(event);
        });
        el._refs.priority_low_mobile.addEventListener("click", function (e) {
          el._updatePriority("low", e);
          el._refs.priority_mobile.close(event);
        });
        el._refs.priority_clear_mobile.addEventListener("click", function (e) {
          el._updatePriority(false, e);
          el._refs.priority_mobile.close(event);
        });
        el._refs.priority_mobile_data_opener.addEventListener("click", function () {
          el._refs.priority_mobile.open();
        });
        el._refs.schedule_estimated.addEventListener("click", function () {
          el._refs.estimated_menu.open();
        });
        el._refs.schedule_estimated_mobile.addEventListener("click", function () {
          el._refs.estimated_menu_mobile.open();
        });
        el._refs.schedule_worked.addEventListener("click", function () {
          el._refs.worked_menu.open();
        });
        el._refs.schedule_worked_mobile.addEventListener("click", function () {
          el._refs.worked_menu_mobile.open();
        });
        el._refs.labels_mobile.addEventListener("click", function () {
          el._refs.labels_menu_mobile.open();
        });
        el._refs.estimated_menu.onClose(function () {
          if (!el.task.schedule || !el.task.schedule.estimated || el.task.schedule.estimated.days != el._refs
            .estimated_days.value || el.task.schedule.estimated.hours != el._refs.estimated_hours.value || el
            .task.schedule.estimated.minutes != el._refs.estimated_minutes.value) {
            el._updateSchedule("estimated", {
              days: el._refs
                .estimated_days.value,
              hours: el._refs.estimated_hours.value,
              minutes: el._refs.estimated_minutes.value
            });
          }
        });
        el._refs.estimated_menu_mobile.onClose(function () {
          if (!el.task.schedule || !el.task.schedule.estimated || el.task.schedule.estimated.days != el._refs
            .estimated_days_mobile.value || el.task.schedule.estimated.hours != el._refs
            .estimated_hours_mobile.value || el
            .task.schedule.estimated.minutes != el._refs.estimated_minutes_mobile.value) {
            el._updateSchedule("estimated", {
              days: el._refs
                .estimated_days_mobile.value,
              hours: el._refs.estimated_hours_mobile.value,
              minutes: el._refs.estimated_minutes_mobile.value
            });
          }
        });
        el._refs.estimatedClear.addEventListener("click", function () {
          el._refs.estimated_days.value = 0;
          el._refs.estimated_hours.value = 0;
          el._refs.estimated_minutes.value = 0;
          el._refs.estimated_menu.close();
        });
        el._refs.estimatedClear_mobile.addEventListener("click", function () {
          el._refs.estimated_days_mobile.value = 0;
          el._refs.estimated_hours_mobile.value = 0;
          el._refs.estimated_minutes_mobile.value = 0;
          el._refs.estimated_menu_mobile.close();
        });
        el._refs.estimatedOk.addEventListener("click", function () {
          el._refs.estimated_menu.close();
        });
        el._refs.estimatedOk_mobile.addEventListener("click", function () {
          el._refs.estimated_menu_mobile.close();
        });
        el._refs.workedOk.addEventListener("click", function () {
          el._refs.worked_menu.close();
        });
        el._refs.workedOk_mobile.addEventListener("click", function () {
          el._refs.worked_menu_mobile.close();
        });
        el._refs.workedClear.addEventListener("click", function () {
          el._refs.worked_hours.value = 0;
          el._refs.worked_minutes.value = 0;
          el._refs.worked_seconds.value = 0;
          el._refs.worked_menu.close();
        });
        el._refs.workedClear_mobile.addEventListener("click", function () {
          el._refs.worked_hours_mobile.value = 0;
          el._refs.worked_minutes_mobile.value = 0;
          el._refs.worked_seconds_mobile.value = 0;
          el._refs.worked_menu_mobile.close();
        });
        el._refs.worked_menu.onClose(function () {
          var currentElapsed = 0;
          currentElapsed += el._refs.worked_hours.value ? parseInt(el._refs.worked_hours.value) * 60 * 60 *
            1000 : 0;
          currentElapsed += el._refs.worked_minutes.value ? parseInt(el._refs.worked_minutes.value) * 60 *
            1000 : 0;
          currentElapsed += el._refs.worked_seconds.value ? parseInt(el._refs.worked_seconds.value) * 1000 :
            0;
          var currentMoment = moment.duration(Number(currentElapsed), "milliseconds");
          var currentTime = currentMoment.format(
            "hh:mm:ss", {
              trim: false
            });
          if (!el.task.schedule || !el.task.schedule.elapsed || el.task.schedule.elapsed != currentElapsed) {
            var scheduleData = {
              elapsed: "" + currentElapsed,
              startUTC: "" + new Date().getTime()
            };
            el._updateTask({
              schedule: scheduleData
            });
          }
        });
        el._refs.worked_menu_mobile.onClose(function () {
          var currentElapsed = 0;
          currentElapsed += el._refs.worked_hours_mobile.value ? parseInt(el._refs.worked_hours_mobile
              .value) * 60 * 60 *
            1000 : 0;
          currentElapsed += el._refs.worked_minutes_mobile.value ? parseInt(el._refs.worked_minutes_mobile
              .value) * 60 *
            1000 : 0;
          currentElapsed += el._refs.worked_seconds_mobile.value ? parseInt(el._refs.worked_seconds_mobile
              .value) * 1000 :
            0;
          if (!el.task.schedule || !el.task.schedule.elapsed || el.task.schedule.elapsed != currentElapsed) {
            var scheduleData = {
              elapsed: "" + currentElapsed,
              startUTC: "" + new Date().getTime()
            };
            el._updateTask({
              schedule: scheduleData
            });
          }
        });
        el._refs.schedule_start.addEventListener("click", function () {
          // el._refs.schedule_start_pc_date.clear();
          // el._refs.schedule_start_pc_date.value = el.task.schedule.start || "";
          el._refs.schedule_start_pc_date._expand(null, el._refs.schedule_start);
        });
        el._refs.schedule_start_mobile.addEventListener("click", function () {
          //   el._refs.schedule_start_mobile_date.clear();
          //   el._refs.schedule_start_mobile_date.value = el.task.schedule.start || "";
          el._refs.schedule_start_mobile_date._expand(null, el._refs.schedule_start_mobile);
        });
        el._refs.schedule_due.addEventListener("click", function () {
          el._refs.schedule_due_pc_date._expand(null, el._refs.schedule_due);
        });
        el._refs.schedule_due_mobile.addEventListener("click", function () {
          el._refs.schedule_due_mobile_date._expand(null, el._refs.schedule_due_mobile);
        });
        el._refs.schedule_start_pc_date.onClosed(function (value) {
          if (!el.task.schedule || el.task.schedule.start != el._refs.schedule_start_pc_date.value) {
            el._updateSchedule("start", el._refs.schedule_start_pc_date.value);
          }
        });
        el._refs.schedule_start_mobile_date.onClosed(function (value) {
          if (!el.task.schedule || el.task.schedule.start != el._refs.schedule_start_mobile_date.value) {
            el._updateSchedule("start", el._refs.schedule_start_mobile_date.value);
          }
        });
        el._refs.schedule_due_pc_date.onClosed(function (value) {
          if (!el.task.schedule || el.task.schedule.due != el._refs.schedule_due_pc_date.value) {
            el._updateSchedule("due", el._refs.schedule_due_pc_date.value);
          }
        });
        el._refs.schedule_due_mobile_date.onClosed(function (value) {
          if (!el.task.schedule || el.task.schedule.due != el._refs.schedule_due_mobile_date.value) {
            el._updateSchedule("due", el._refs.schedule_due_mobile_date.value);
          }
        });
        el._refs.toggleLog.onCheck(function () {
          // el._refs.toggleLog_mobile_chat.value = true;
          // el._refs.toggleLog_mobile_chat.checked = true;
          el._toggleChatLogs(true);
        });
        el._refs.toggleLog.onUncheck(function () {
          // el._refs.toggleLog_mobile_chat.value = false;
          // el._refs.toggleLog_mobile_chat.checked = false;
          el._toggleChatLogs();
        });
        el._refs.toggleLog_mobile.onCheck(function () {
          el._toggleChatLogs(true);
        });
        el._refs.toggleLog_mobile.onUncheck(function () {
          el._toggleChatLogs();
        });
        el._refs.toggleLog_mobile_chat.onCheck(function () {
          // el._refs.toggleLog.value = true;
          // el._refs.toggleLog.checked = true;
          el._toggleChatLogs(true);
        });
        el._refs.toggleLog_mobile_chat.onUncheck(function () {
          // el._refs.toggleLog.value = false;
          // el._refs.toggleLog.checked = false;
          el._toggleChatLogs();
        });
        el._refs.toggleConversation.addEventListener("click", function () {
          el._refs.chatWindow.classList.add("task-dialog-chat-expand-mobile");
          setTimeout(function () {
            el._refs.chatScrollContent.scrollTo(el._refs.chatContent.scrollHeight);
          }, 100);
        });
        el._refs.closeMobileChat.addEventListener("click", function () {
          el._refs.chatWindow.classList.remove("task-dialog-chat-expand-mobile");
        });
        el._refs.task_status.addEventListener("click", function () {
          el._refs.status_menu.open();
        });
        el._refs.task_status_mobile.addEventListener("click", function () {
          el._refs.status_menu_mobile.open();
        });
        el._refs.chatScrollContent.onScrolled(function (value) {
          if (value.scrollTop < 200 && !el._misc.chat.loadingScrolledData && !el._misc.chat.endData) {
            el._misc.chat.loadingScrolledData = true;
            el._loadMoreChat();
          }
        });
        // el._refs.menuHeaderMobileToggle.addEventListener("click", function () {
        //   if (el._refs.menuHeaderMobile.classList.contains("task-dialog-menu-header-mobile-active")) {
        //     el._refs.menuHeaderMobile.classList.remove("task-dialog-menu-header-mobile-active");
        //     el._refs.taskDescriptionTitle.classList.add("task-dialog-title-description");
        //     el._refs.menuHeaderMobileToggleIcon.classList.remove("vicon-chevron-up");
        //     el._refs.menuHeaderMobileToggleIcon.classList.add("vicon-chevron-down");
        //     el._refs.menuHeaderMobileToggle.classList.remove("task-dialog-menu-header-mobile-toggle-active");
        //   } else {
        //     el._refs.menuHeaderMobile.classList.add("task-dialog-menu-header-mobile-active");
        //     el._refs.taskDescriptionTitle.classList.remove("task-dialog-title-description");
        //     el._refs.menuHeaderMobileToggleIcon.classList.add("vicon-chevron-up");
        //     el._refs.menuHeaderMobileToggleIcon.classList.remove("vicon-chevron-down");
        //     el._refs.menuHeaderMobileToggle.classList.add("task-dialog-menu-header-mobile-toggle-active");
        //   }
        // });
        // el._refs.task_status_next.addEventListener("click", function (e) {
        //   el._nextStatus(e);
        // });
        // el._refs.task_status_next_mobile.addEventListener("click", function (e) {
        //   el._nextStatus(e);
        // });
        el._refs.checkListAddNew.onEdit(function (value) {
          if (value && value.trim() != "") {
            el._addContent("checklist", value, false);
            el._refs.checkListAddNew.value = "";
          }
        });
        el._refs.fileZoomIn.onClose(function () {
          el._refs.imageZoomInContent.innerHTML = "";
        });
        // el._refs.scrollContent.onScrolled(function (position) {
        //   if (!el._misc.previousScroll || el._misc.previousScroll < position.scrollTop) {
        //     el._refs.openMobileChat.setAttribute("visibility", "false");
        //   } else {
        //     el._refs.openMobileChat.setAttribute("visibility", "true");
        //   }
        //   el._misc.previousScroll = position.scrollTop;
        // });
        // bubble.init(el._refs.scrollContent, el._refs.openMobileChat);
      },
      // @function _toggleChatLogs (private) [Show or hide chat logs]
      toggleChatLogs: function (toggleTo) {
        var el = this;
        if (toggleTo) {
          var logs = el._refs.chatContent.querySelectorAll(".task-dialog-chat-log");
          for (var i = 0; i < logs.length; i++) {
            logs[i].classList.remove("hide");
          }
          setTimeout(function () {
            el._refs.chatScrollContent.scrollTo(el._refs.chatContent.scrollHeight);
          }, 100);
        } else {
          var logs = el._refs.chatContent.querySelectorAll(".task-dialog-chat-log");
          for (var i = 0; i < logs.length; i++) {
            logs[i].classList.add("hide");
          }
        }
      },
      // @function _socketListeners (private)
      socketListeners: function () {
        var el = this;
        socket.onSocketTask(function (taskData) {
          if (task.status === "open" && el.task.id === taskData.id) {
            el._updateDifferences(differ.compare(el.task, taskData, {
              arrayOrder: true
            }), taskData);
          }
        });
        socket.onSocketBoard(function (board) {
          if (task.status === "open") {
            var diffs = differ.compare(el.board, board);
            el.board = board;
            if (el.task && el.task.labels) {
              if (diffs.labels) {
                for (var key in diffs.labels) {
                  if (!diffs.labels[key]) {
                    var index = el.task.labels.indexOf(key);
                    if (index > -1) {
                      el.task.labels.splice(index, 1);
                    }
                  }
                }
                el._setLabels();
                el._setLabelsShow();
              }
            }
          }
        });
        socket.onSocketLogDeleted(function (logId) {
          if (task.status === "open") {
            var currentLogId = logId.split(":")[3];
            el._misc.log[currentLogId].parentElement.removeChild(el._misc.log[currentLogId]);
          }
        });
        socket.onSocketLog(function (log) {
          if (task.status === "open") {
            if (log.taskId === el.task.id) {
              if (!el._misc.log[log.id.split(":")[3]]) { // Create
                var currentLogId = log.id.split(":")[3];
                var currentLogItem = el._setChatItem(currentLogId, log);
                el._misc.log[currentLogId] = currentLogItem;
                el._refs.chatContent.appendChild(currentLogItem);
                setTimeout(function () {
                  el._refs.chatScrollContent.onReady(function () {
                    setTimeout(function () {
                      el._refs.chatScrollContent.scrollTo(el._refs.chatContent
                        .scrollHeight);
                    }, 100);
                  });
                }, 0);
              } else {
                var currentLogId = log.id.split(":")[3];
                el._misc.log[currentLogId].querySelector("app-editable-text").value = log.log;
              }
            }
          }
        });
      },
      // @function _updateDifferences (private) [Update differences from current task data vs new task data] @param diffs [Differences] @param data
      updateDifferences: function (diffs, data) {
        var el = this;
        el.task = data;
        for (var key in diffs) {
          switch (key) {
            case "name":
              el._refs.taskName.value = diffs[key];
              eon.triggerCallback("onTaskUpdated", el, el, [el.task]);
              break;
            case "description":
              el._refs.taskDescription.value = diffs[key];
              break;
            case "viewers":
              el._refs.selectObservers.refresh(el.task.viewers.members, el.task.viewers.groups);
              el._refs.selectObservers_mobile.refresh(el.task.viewers.members, el.task.viewers.groups);
              // el._refs.selectObservers.setData(el._misc.workspaceData, el.task.viewers.members, el.task.viewers.groups);
              // el._refs.selectObservers_mobile.setData(el._misc.workspaceData, el.task.viewers.members, el.task.viewers.groups);
              el._setViewers();
              eon.triggerCallback("onTaskUpdated", el, el, [el.task]);
              break;
            case "labels":
              el._setLabels();
              el._setLabelsShow();
              eon.triggerCallback("onTaskUpdated", el, el, [el.task]);
              break;
            case "items":
              el._updateDifferences_items(diffs, data);
              break;
            case "attachments":
              el._setImages(el.task.attachments);
              break;
            case "priority":
              el._setPriority();
              break;
            case "schedule":
              el._setSchedule(el.task.schedule);
              break;
            case "mainImage":
              if (el._misc.pinned) {
                el._misc.pinned.classList.remove("task-dialog-attachments-pin-selected");
              }
              var pins = el._refs.attachments.querySelectorAll(".task-dialog-attachments-pin");
              var newPinned;
              for (var i = 0; i < pins.length; i++) {
                if (pins[i].getAttribute("imageId") == el.task.mainImage) {
                  newPinned = pins[i];
                }
              }
              el._misc.pinned = newPinned;
              if (newPinned) {
                newPinned.classList.add("task-dialog-attachments-pin-selected");
              }
              break;
          }
        }
      },
      // @function _updateDifferences_items (private) [Update differences for items]
      updateDifferences_items: function (diffs, data) {
        var el = this;
        if (diffs.items) {
          for (var key in diffs.items) {
            switch (key) {
              case "order":
                for (var itemOrder = 0; itemOrder < Object.keys(diffs.items[key]).length; itemOrder++) {
                  var itemKey = diffs.items[key][itemOrder];
                  if (el._misc.content[itemKey]) { // Move item
                    el._misc.content[itemKey].style.order = itemOrder;
                  } else { // New item
                    if (diffs.items.data && diffs.items.data[itemKey]) {
                      var content = el._checklist_create(diffs.items.data[itemKey], itemOrder);
                      el._misc.content[itemKey] = content;
                      el._refs.added.appendChild(content);
                      el._refs.added.appendChild(el._checklist_create_marginBottom(itemKey, itemOrder));
                    }
                  }
                }
                el._sortChecklistDrop();
                break;
              case "data":
                if (diffs.items.data) {
                  for (var itemKey in diffs.items.data) {
                    if (diffs.items.data[itemKey] == null) { // Item deleted
                      el._misc.content[itemKey].parentElement.removeChild(el._misc
                        .content[itemKey]);
                      el._misc.drop.checklist[itemKey].parentElement.removeChild(el._misc.drop
                        .checklist[itemKey]);
                    } else { // Update item
                      if (el._misc.content[itemKey]) {
                        var checklist = el._misc.content[itemKey];
                        for (var itemAttribute in diffs.items.data[itemKey]) {
                          switch (itemAttribute) {
                            case "name":
                              var title = checklist.querySelector(".task-dialog-checklist-title");
                              title.value = diffs.items.data[itemKey][itemAttribute];
                              break;
                            case "items":
                              var items = checklist.querySelector(".task-dialog-checklist-items");
                              var percentage = checklist.querySelector(".task-dialog-checklist-percentage");
                              var itemsChild = items.childNodes;
                              if (diffs.items.data[itemKey][itemAttribute].data) {
                                for (var checklistItem in diffs.items.data[itemKey][itemAttribute].data) {
                                  if (diffs.items.data[itemKey][itemAttribute].data[checklistItem] != null) {
                                    var exists;
                                    for (var existingItemsKey = 0; existingItemsKey < itemsChild
                                      .length; existingItemsKey++) {
                                      var currentItem = itemsChild[existingItemsKey];
                                      if (currentItem.getAttribute("itemId") && currentItem.getAttribute(
                                          "itemId") ===
                                        checklistItem) {
                                        exists = currentItem;
                                      }
                                    }
                                    if (exists) { // Update item
                                      if (diffs.items.data[itemKey][itemAttribute].data[checklistItem].name) {
                                        exists.querySelector("app-editable-text").value = diffs.items.data[
                                            itemKey][
                                            itemAttribute
                                          ]
                                          .data[checklistItem].name;
                                      }
                                      if ("checked" in diffs.items.data[itemKey][itemAttribute].data[
                                          checklistItem]) {
                                        exists.querySelector("eon-check").checked = diffs.items.data[itemKey][
                                          itemAttribute
                                        ].data[
                                          checklistItem].checked;
                                      }
                                    } else { // Add new Item
                                      var itemId = diffs.items.data[itemKey][itemAttribute].data[checklistItem]
                                        .id;
                                      var newItemOrder = diffs.items.data[itemKey][itemAttribute].order
                                        .indexOf(
                                          itemId);
                                      var itemNode = el._checklist_createItemCheck(diffs.items.data[itemKey][
                                        itemAttribute
                                      ].data[checklistItem], newItemOrder, itemKey, percentage);
                                      items.appendChild(itemNode);
                                      var margin = el._checklistItem_create_margin(itemKey, newItemOrder);
                                      items.appendChild(margin);
                                    }
                                  } else { // Delete item
                                    var currentOrder;
                                    for (var itemIndex = 0; itemIndex < itemsChild.length; ++
                                      itemIndex) {
                                      var currentItem = itemsChild[itemIndex];
                                      if (currentItem.getAttribute("itemId") && currentItem.getAttribute(
                                          "itemId") === checklistItem) {
                                        currentOrder = currentItem.style.order;
                                        currentItem.parentElement.removeChild(currentItem);
                                      }
                                    }
                                    if (el._misc.drop.checklist_item[itemKey][currentOrder]) {
                                      el._misc.drop.checklist_item[itemKey][currentOrder].parentElement
                                        .removeChild(
                                          el._misc.drop.checklist_item[itemKey][currentOrder]);
                                      delete el._misc.drop.checklist_item[itemKey][currentOrder];
                                    }
                                  }
                                }
                                el._updateChecklistPercentage();
                              }
                              if (diffs.items.data[itemKey][itemAttribute].order) { // Checklist item moved
                                for (var itemIndex = 0; itemIndex < itemsChild.length; ++itemIndex) {
                                  var currentItem = itemsChild[itemIndex];
                                  if (currentItem.getAttribute("itemId")) {
                                    currentItem.style.order = diffs.items.data[itemKey][itemAttribute].order
                                      .indexOf(currentItem.getAttribute("itemId"));
                                  }
                                }
                                el._sortChecklistItemDrop(true);
                              }
                              break;
                          }
                        }
                      }
                    }
                  }
                }

            }
          }
        }
      },
      // @function _updateName (private) [Update board name] @param name
      updateName: function (name) {
        var el = this;
        if (name != "" && name != el.task
          .name) {
          el._updateTask({
            name: name
          });
        }
      },
      // @function _getTaskListId (private) [Get task list id]
      getTaskListId: function () {
        var el = this;
        // for (var key in el.board.lists.data) {          
        //   if (el.board.lists.data[key].tasks && el.board.lists.data[key].tasks.indexOf(el.task.id) > -1) {            
        //     return key;
        //   }
        // }
        return el.task.listId;
      },
      // @function _setTaskList (private) [Set up combo with lists] @param data
      setTaskList: function (data) {
        var el = this;
        var listId = el._getTaskListId();
        el._setTaskList_pc(data, listId);
        el._setTaskList_mobile(data, listId);
        for (var i = 0; i < el.board.lists.order.length; i++) {
          var item = el._setTaskList_item(el.board.lists.data[el.board.lists.order[i]]);
          el._refs.status_menu.addItem(item);
          var itemMobile = el._setTaskList_item(el.board.lists.data[el.board.lists.order[i]]);
          el._refs.status_menu_mobile.addItem(itemMobile);
        }
      },
      // @function _setTaskList_item (private) [Set an item for task list] @param data
      setTaskList_item: function (data) {
        var el = this;
        var item = document.createElement("div");
        item.design = "flat";
        item.setAttribute("key", data.id);
        item.innerText = data.name;
        item.classList.add("app-toggle-menu-item");
        item.addEventListener("click", function () {
          el._refs.status_menu.close();
          el._refs.status_menu_mobile.close();
          var listId = this.getAttribute("key");
          var order = el.board.lists.data[listId].tasks ? el.board.lists.data[listId].tasks.length : 0;
          task.list(el.task.id, listId, order);
        });
        return item;
      },
      // @function _setTaskList_pc (private) [Set up combo with lists for pc] @param data @param listId
      setTaskList_pc: function (data, listId) {
        var el = this;
        el._refs.status_menu.clear();
        el._refs.status_pc_value.innerText = el.board.lists.data[listId].name;
        el._refs.status_mobile_value.innerText = el.board.lists.data[listId].name;
        var title = document.createElement("eon-variable");
        title.bind = "locale.projects.board.task.status";
        title.classList.add("app-toggle-menu-label", "eon-fg-h4");
        el._refs.status_menu.addItem(title);
      },
      // @function _setTaskList_mobile (private) [Set up combo with lists for mobile] @param data @param listId
      setTaskList_mobile: function (data, listId) {
        var el = this;
        el._refs.status_menu_mobile.clear();
        el._refs.status_pc_value.innerText = el.board.lists.data[listId].name;
        el._refs.status_mobile_value.innerText = el.board.lists.data[listId].name;
        var title = document.createElement("eon-variable");
        title.bind = "locale.projects.board.task.status";
        title.classList.add("app-toggle-menu-label", "eon-fg-h4");
        el._refs.status_menu_mobile.addItem(title);
      },
      // @function _updateTask (private) [Call database with updated data] @param payload
      updateTask: function (payload) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id;
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify(payload)
        }, function (error, data) {
          if (!error) {
            el._setUpdateLog(payload);
          } else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _setUpdateLog (private) [Generate a log when a task is updated] @param payload
      setUpdateLog: function (payload) {
        var el = this;
        el._sendLog({
          log: payload,
          type: "log"
        });
      },
      // @function _setChatContent (private) [Set all stored chat logs in screen]
      setChatContent: function (content) {
        var el = this;
        var fragment = document.createDocumentFragment();
        for (var key in content) {
          var currentLogId = content[key].id.split(":")[3];
          var currentLogItem = el._setChatItem(currentLogId, content[key]);
          el._misc.log[currentLogId] = currentLogItem;
          fragment.insertBefore(currentLogItem, fragment.firstChild);
          // fragment.appendChild(el._setChatItem(currentLogId, content[key]));
        }
        el._refs.chatContent.innerHTML = "";
        el._refs.chatContent.appendChild(fragment);
        setTimeout(function () {
          el._refs.chatScrollContent.onReady(function () {
            setTimeout(function () {
              el._refs.chatScrollContent.scrollTo(el._refs.chatContent.scrollHeight);
            }, 100);
          });
        }, 0);
      },
      // @function _appendChatContent (private) [Set all stored chat logs in screen]
      appendChatContent: function (content) {
        var el = this;
        var fragment = document.createDocumentFragment();
        for (var key in content) {
          var currentLogId = content[key].id.split(":")[3];
          var currentLogItem = el._setChatItem(currentLogId, content[key]);
          el._misc.log[currentLogId] = currentLogItem;
          fragment.insertBefore(currentLogItem, fragment.firstChild);
        }
        el._refs.chatContent.insertBefore(fragment, el._refs.chatContent.firstChild);
      },
      // @function _setChatItem (private) [Set single log and return the element] @param key [Log id] @param data [Log data]
      setChatItem: function (key, data) {
        var el = this;
        if (data.type === "message") {
          return el._setChatMessage(key, data);
        } else if (data.type === "log") {
          return el._setChatLog(key, data);
        }
      },
      // @function _setChatMessage (private) [Set chat item when it is a message] @param key [Log id] @param data [Log data]
      setChatMessage: function (key, data) {
        var el = this;
        var item = document.createElement("div");
        item.classList.add("task-dialog-chat-item", "task-dialog-chat-message");
        item.classList.add("chatEntry-" + key);
        // item.id = key;
        var title = document.createElement("div");
        title.classList.add("task-dialog-chat-item-title");
        var avi = document.createElement("app-avatar");
        avi.userName = el._misc.workspaceData.members[data.sender].alias;
        avi.image = "/rest/user/avatar/" + data.sender;
        title.appendChild(avi);
        var owner = document.createElement("div");
        owner.classList.add("task-dialog-chat-item-owner");
        owner.innerText = el._misc.workspaceData.members[data.sender].alias;
        title.appendChild(owner);
        var options = document.createElement("app-toggle-menu");
        options.anchor = "right";
        options.icon = "vicon-more";
        var deleteText = document.createElement("div");
        deleteText.setAttribute("key", data.id);
        deleteText.classList.add("app-toggle-menu-item");
        deleteText.setAttribute("type", "delete");
        var deleteTextTitle = document.createElement("span");
        deleteTextTitle.innerText = eon.locale.global.delete;
        var deleteTextIcon = document.createElement("i");
        deleteTextIcon.classList.add("vicon", "vicon-bin");
        deleteText.appendChild(deleteTextIcon);
        deleteText.appendChild(deleteTextTitle);
        deleteText.parent = item;
        deleteText.addEventListener("click", function () {
          var parent = this.parent;
          el._deleteLog(this.getAttribute("key"));
          options.close();
        });
        title.appendChild(options);
        var separator = document.createElement("div");
        separator.classList.add("separator");
        title.appendChild(separator);
        var date = document.createElement("div");
        date.classList.add("task-dialog-chat-item-date");
        date.innerText = el._setChatDate(data.time);
        title.appendChild(date);
        item.appendChild(title);
        var text = document.createElement("app-editable-text");
        text.type = "area";
        text.doubleClick = true;
        text.value = data.log;
        text.setAttribute("key", data.id);
        text.onReady(function () {
          text.editable = false;
        });
        text.onEdit(function (value) {
          text.editable = false;
          el._updateLog({
            log: value
          }, this.getAttribute("key"));
        });
        item.appendChild(text);
        var editText = document.createElement("div");
        editText.setAttribute("key", key);
        var editTextTitle = document.createElement("span");
        editTextTitle.innerText = eon.locale.global.edit;
        var editTextIcon = document.createElement("i");
        editTextIcon.classList.add("vicon", "ticon-edit");
        editText.appendChild(editTextIcon);
        editText.appendChild(editTextTitle);
        editText.classList.add("app-toggle-menu-item");
        editText.parent = item;
        editText.addEventListener("click", function () {
          var text = this.parent.querySelector("app-editable-text");
          text.editable = true;
          text.focus();
          text.setCursorToEnd();
          options.close();
        });
        options.addItem(editText);
        options.addItem(deleteText);
        return item;
      },
      // @function _setChatLog (private) [Set chat item when it is a log] @param key [Log id] @param data [Log data]
      setChatLog: function (key, data) {
        var el = this;
        var item = document.createElement("div");
        item.classList.add("task-dialog-chat-item", "task-dialog-chat-log");
        if (!el._refs.toggleLog.checked && !el._refs.toggleLog_mobile_chat.checked) {
          item.classList.add("hide");
        }
        item.id = key;
        var title = document.createElement("div");
        title.classList.add("task-dialog-chat-item-title");
        var avi = document.createElement("app-avatar");
        avi.userName = el._misc.workspaceData.members[data.sender].alias;
        avi.image = "/rest/user/avatar/" + data.sender;
        title.appendChild(avi);
        var owner = document.createElement("div");
        owner.classList.add("task-dialog-chat-item-owner");
        owner.innerText = el._misc.workspaceData.members[data.sender].alias;
        title.appendChild(owner);
        var separator = document.createElement("div");
        separator.classList.add("separator");
        title.appendChild(separator);
        var date = document.createElement("div");
        date.classList.add("task-dialog-chat-item-date");
        date.innerText = el._setChatDate(data.time);
        title.appendChild(date);
        var text = document.createElement("div");
        text.innerText = el._setChatLogText(data);
        item.appendChild(title);
        item.appendChild(text);
        return item;
      },
      // @function _setChatDate (private) [Format date for chat] @param timestamp
      setChatDate: function (timestamp) {
        var el = this;
        var date = new Date(timestamp);
        return date.toISOString().replace(/T/, ' ').replace(/\..+/, '');
      },
      // @function _setChatLogText (private) [Format chat log content] @param key [Log id] @param data [Log data]
      setChatLogText: function (data) {
        var el = this;
        var content = "";
        var counter = 0;
        for (var key in data.log) {
          if (counter > 0) {
            content += "\r\n";
          }
          switch (key) {
            case "list":
              content += eon.locale.projects.board
                .task.log.moved + " " + el.board.lists.data[data.log[key]].name;
              break;
            case "name":
              content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                .task.log.modifiedM + " " + data.log[key];
              break;
            case "description":
              content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                .task.log.modifiedF + " " + data.log[key];
              break;
            case "viewers":
              content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                .task.log.modifiedPM;
              break;
            case "labels":
              content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                .task.log.modifiedPF;
              break;
            case "image":
              content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                .task.log.modifiedF + " " + data.log[key].name;
              break;
            case "text":
              content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                .task.log.addedM;
              break;
            case "checklist":
              content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                .task.log.addedF + ": " + data.log.checklist.name;
              break;
            case "priority":
              if (data.log[key]) {
                content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                  .task.log.modifiedF + " " + eon.locale.projects.board.task.priority[data.log[key]];
              } else {
                content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                  .task.log.deleted;
              }
              break;
            case "images":
              content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                .task.log.addedPF + " " + data.log[key].name;
              break;
            case "schedule":
              var text = "";
              for (var mod in data.log[key]) {
                switch (mod) {
                  case "estimated":
                    var estimatedString = [];
                    if (data.log[key][mod].days && data.log[key][mod].days != 0) {
                      estimatedString.push(data.log[key][mod].days + " " + eon.locale.projects.board.task.d);
                    }
                    if (data.log[key][mod].hours && data.log[key][mod].hours != 0) {
                      estimatedString.push(data.log[key][mod].hours + " " + eon.locale.projects.board.task.h);
                    }
                    if (data.log[key][mod].minutes && data.log[key][mod].minutes != 0) {
                      estimatedString.push(data.log[key][mod].minutes + " " + eon.locale.projects.board.task.m);
                    }
                    text += eon.locale.projects.board.task.log[mod] + " = " + estimatedString.join(", ");
                    break;
                  case "elapsed":
                    // Prevent from being added by default
                    break;
                  case "startUTC":
                    // Prevent from being added by default
                    break;
                  case "running":
                    if (eon.util.isTrue(data.log[key][mod])) {
                      text += eon.locale.projects.board.task.log.workingTrue;
                    } else {
                      text += eon.locale.projects.board.task.log.workingFalse;
                    }
                    break;
                  default:
                    text += eon.locale.projects.board.task.log[mod] + " = " + data.log[key][mod];
                    break;
                }
              }
              content += eon.locale.projects.board.task.log[key] + " " + eon.locale.projects.board
                .task.log.modifiedF + " " + text;
              break;
          }
          counter++;
        }
        return content;
      },
      // @function _sendLog (private) [Set log from chat if any] @param payload
      sendLog: function (payload) {
        var el = this;
        var url = "/rest/log/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task.id;
        eon.ajax(url, {
          contentType: "application/json",
          method: "POST",
          payload: JSON.stringify(payload)
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _updateLog (private) [Update chat log] @param payload @param logId @param callback
      updateLog: function (payload, logId, callback) {
        var el = this;
        var url = "/rest/log/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el
          .task.id + "/" + logId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify(payload)
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _deleteLog (private) [Delete a log] @param logId @param callback
      deleteLog: function (logId, callback) {
        var el = this;
        var url = "/rest/log/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el
          .task.id + "/" + logId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "DELETE"
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _setLabels (private) [Set up labels]
      setLabels: function () {
        var el = this;
        var labels = el.task.labels || [];
        var fragment = document.createDocumentFragment();
        var header = document.createElement("div");
        header.classList.add("task-dialog-menu-selector-header", "no-selectable", "eon-fg-h4");
        var title = document.createElement("div");
        title.innerText = eon.locale.projects.board.task.labels;
        header.appendChild(title);
        var separator = document.createElement("div");
        separator.classList.add("separator");
        header.appendChild(separator);
        var close = document.createElement("i");
        close.classList.add("vicon-close", "task-dialog-menu-selector-header-close");
        close.addEventListener("click", function (e) {
          el._refs.labels.close(e);
        });
        header.appendChild(close);
        // fragment.appendChild(header);
        el._refs.labels.addFixedItem(header);
        var container = document.createElement("div");
        container.classList.add("task-dialog-labels");
        for (var key in el.board.labels) {
          var label = el._newLabel(key);
          container.appendChild(label);
        }
        fragment.appendChild(container);
        var newLabel = el._newLabelButton(el._refs.labels);
        fragment.appendChild(newLabel);
        el._refs.labels.clear();
        el._refs.labels.addItem(fragment);
        el._setLabelsMobile();
      },
      // @function _setLabelsMobile (private) [Set up labels]
      setLabelsMobile: function () {
        var el = this;
        var labels = el.task.labels || [];
        var fragment = document.createDocumentFragment();
        var header = document.createElement("div");
        header.classList.add("task-dialog-menu-selector-header", "eon-fg-h4");
        var title = document.createElement("div");
        title.innerText = eon.locale.projects.board.task.labels;
        header.appendChild(title);
        var separator = document.createElement("div");
        separator.classList.add("separator");
        header.appendChild(separator);
        var close = document.createElement("i");
        close.classList.add("vicon-close", "task-dialog-menu-selector-header-close");
        close.addEventListener("click", function (e) {
          el._refs.labels_menu_mobile.close(e);
        });
        header.appendChild(close);
        // fragment.appendChild(header);
        el._refs.labels_menu_mobile.addFixedItem(header);
        var container = document.createElement("div");
        container.classList.add("task-dialog-labels");
        for (var key in el.board.labels) {
          var label = el._newLabel(key);
          container.appendChild(label);
        }
        fragment.appendChild(container);
        var newLabel = el._newLabelButton(el._refs.labels_menu_mobile);
        fragment.appendChild(newLabel);
        el._refs.labels_menu_mobile.clear();
        el._refs.labels_menu_mobile.addItem(fragment);
      },
      // @function _newLabel (private) [Create a new label for labels combo] @param key
      newLabel: function (key) {
        var el = this;
        var label = document.createElement("div");
        label.classList.add("task-dialog-labels-label");
        var background = document.createElement("div");
        background.classList.add("task-dialog-labels-label-background");
        background.setAttribute("value", key);
        background.addEventListener("click", function (e) {
          var sel = this.querySelector(".task-dialog-labels-label-selected");
          sel.classList.toggle("hide");
          if (sel.classList.contains("hide")) {
            var newLabels = JSON.parse(JSON.stringify(el.task.labels));
            var index = newLabels.indexOf(this.getAttribute("value"));
            if (index > -1) {
              newLabels.splice(index, 1);
            }
            el._updateLabels(newLabels);
          } else {
            var newLabels = el.task.labels ? JSON.parse(JSON.stringify(el.task.labels)) : [];
            newLabels.push(this.getAttribute("value"));
            el._updateLabels(newLabels);
          }
          e.stopPropagation();
        });
        var selected = el._newLabelSelected(key);
        background.appendChild(selected);
        var title = el._newLabelTitle(key);
        background.appendChild(title);
        var picker = el._newLabelPicker(key, background);
        background.appendChild(picker);
        var editable = el._newLabelEditable(key, background);
        background.appendChild(editable);
        var del = el._newLabelDelete(key, background);
        background.appendChild(del);
        label.appendChild(background);
        return label;
      },
      // @function _newLabelDelete (private) [Delete label]
      newLabelDelete: function (key, parent) {
        var el = this;
        var del = document.createElement("i");
        del.classList.add("task-dialog-labels-label-delete", "vicon-bin");
        del.setAttribute("labelId", key);
        del.setAttribute("parent", parent);
        del.addEventListener("click", function (e) {
          parent.parentElement.parentElement.removeChild(parent
            .parentElement);
          e.stopPropagation();
          var labelId = this.getAttribute("labelId");
          var url = "/rest/board/" + session.data.currentWorkspaceId + "/label/" + el.board
            .id + "/" + labelId;
          eon.ajax(url, {
            contentType: "application/json",
            method: "DELETE"
          }, function (error, data) {
            if (!error) {} else if (data.status == 401) {
              session.logout();
            }
          });
        }, false);
        return del;
      },
      // @function _newLabelSelected (private) [Selected mark for label]
      newLabelSelected: function (key) {
        var el = this;
        var selected = document.createElement("div");
        selected.classList.add("task-dialog-labels-label-selected",
          "vicon-ok");
        selected.style.color = el.board.labels[key].color;
        if (!el.task.labels || el.task.labels.indexOf(key) == -1) {
          selected.classList.add("hide");
        } else {
          selected.classList.remove("hide");
        }
        return selected;
      },
      // @function _newLabelPicker (private) [Edit label color]
      newLabelPicker: function (key, parent) {
        var el = this;
        var picker = document.createElement("div");
        picker.classList.add("task-dialog-labels-label-picker");
        var input = document.createElement("input");
        input.type = "color";
        input.value = el.board.labels[key].color;
        input.addEventListener("click", function (e) {
          e.stopPropagation();
        });
        input.setAttribute("labelId", key);
        input.setAttribute("parent", parent);
        input.addEventListener("input", function () {
          var newLabelData = {};
          newLabelData[this.getAttribute("labelId")] = {
            color: this.value
          };
          task.updateLabel(el.task.boardId, newLabelData);
          el._setLabelsShow();
        }, false);
        picker.appendChild(input);
        var icon = document.createElement("i");
        icon.classList.add("ticon-color", "task-dialog-labels-label-color");
        picker.appendChild(icon);
        return picker;
      },
      // @function _newLabelEditable (private) [Edit label color]
      newLabelEditable: function (key, parent) {
        var el = this;
        var editable = document.createElement("i");
        editable.classList.add("task-dialog-labels-label-edit", "ticon-edit");
        editable.setAttribute("labelId", key);
        editable.setAttribute("parent", parent);
        editable.addEventListener("click", function (e) {
          var text = parent.querySelector("app-editable-text");
          text.editable = true;
          text.focus();
          // el._setCursorToEnd(text._refs.content);
          e.stopPropagation();
        });
        return editable;
      },
      // @function _newLabelTitle (private) [Create title for new label] @param key
      newLabelTitle: function (key) {
        var el = this;
        // var title = document.createElement("eon-label");
        var title = document.createElement("app-editable-text");
        title.classList.add("task-dialog-labels-label-title");
        title.color = el.board.labels[key].color;
        if (el.board.labels[key].title) {
          title.value = el.board.labels[key].title;
        }
        title.setAttribute("labelId", key);
        title.addEventListener("click", function (e) {
          e.stopPropagation();
        });
        title.saveOnBlur = "true";
        title.onEdit(function (value) {
          title.editable = false;
          var newLabelData = {};
          newLabelData[this.getAttribute("labelId")] = {
            title: this.value
          };
          task.updateLabel(el.task.boardId, newLabelData);
          el._setLabelsShow();
        });
        return title;
      },
      // @function _newLabelButton (private) [Create new label buttons for labels combo]
      newLabelButton: function (menu) {
        var el = this;
        var newLabel = document.createElement("app-editable-text");
        newLabel.classList.add("task-dialog-labels-label-new");
        newLabel.footer = "true";
        newLabel.fixedWidth = "true";
        newLabel.placeholder = "+ " + eon.locale.projects.board.task.newLabel;
        newLabel.placeholderExpanded = eon.locale.global.typeName;
        newLabel.onEdit(function (value) {
          if (value && value != "") {
            var biggestKey = 0;
            for (var key in el.board.labels) {
              var currentKey = parseInt(key);
              biggestKey = currentKey > biggestKey ? currentKey : biggestKey;
            }
            biggestKey++;
            var newLabelData = {};
            newLabelData[biggestKey] = {
              title: value,
              color: "#8c27cf"
            };
            task.updateLabel(el.task.boardId, newLabelData);
          }
        });
        newLabel.parent = menu._refs.scroll;
        newLabel.onOpen(function () {
          var self = this;
          setTimeout(function () {
            self.parent.scrollTo(self.parent.scrollHeight);
          }, 0);
        });
        return newLabel;
      },
      // @function _updateLabels (private) [Update labels to database and refresh screen] @param labels
      updateLabels: function (labels) {
        var el = this;
        el._updateTask({
          labels: labels
        });
      },
      // @function _setLabelsShow (private) [Set labels exposed to user without opening the label editor combo]
      setLabelsShow: function () {
        var el = this;
        var fragment = document.createDocumentFragment();
        el.onReady(function () {
          if (el.task.labels && el.task.labels.length > 0) {
            for (var i = 0; i < el.task.labels.length; i++) {
              var label = document.createElement("div");
              label.classList.add("task-dialog-labels-show-label");
              label.style.backgroundColor = el.board.labels[el.task.labels[i]].color;
              if (el.board.labels[el.task.labels[i]].title) {
                var title = document.createElement("div");
                title.innerText = el.board.labels[el.task.labels[i]].title;
                label.appendChild(title);
              }
              fragment.appendChild(label);
            }
          }
          el._refs.labelsShow.innerHTML = "";
          el._refs.labelsShow.appendChild(fragment);
          el._setLabelsShow_mobile();
        });
      },
      // @function _setLabelsShow_mobile (private) [Set labels exposed to user without opening the label editor combo]
      setLabelsShow_mobile: function () {
        var el = this;
        var fragment = document.createDocumentFragment();
        el.onReady(function () {
          if (el.task.labels && el.task.labels.length > 0) {
            for (var i = 0; i < el.task.labels.length; i++) {
              var label = document.createElement("div");
              label.classList.add("task-dialog-labels-show-label");
              label.style.backgroundColor = el.board.labels[el.task.labels[i]].color;
              if (el.board.labels[el.task.labels[i]].title) {
                var title = document.createElement("div");
                title.innerText = el.board.labels[el.task.labels[i]].title;
                label.appendChild(title);
              }
              fragment.appendChild(label);
            }
          } else {

            var addNew = document.createElement("div");
            addNew.classList.add("task-dialog-mobile-add-new", "no-selectable");
            addNew.innerText = eon.locale.projects.board.task.placeholder.label;
            fragment.appendChild(addNew);
          }
          el._refs.labelsShow_mobile.innerHTML = "";
          el._refs.labelsShow_mobile.appendChild(fragment);
        });
      },
      // @function _setContent (private) [Add content when load task] @param content
      setContent: function (content) {
        var el = this;
        el._refs.added.appendChild(el._checklist_create_marginBottom(null, -1));
        if (content && content.data && Object.keys(content.data).length > 0) {
          var fragment = document.createDocumentFragment();
          for (var key in content.data) {
            var order = content.order.indexOf(key);
            var element;
            if (content.data[key].type === "checklist") {
              element = el._checklist_create(content.data[key], order);
            }
            if (element) {
              fragment.appendChild(element);
              fragment.appendChild(el._checklist_create_marginBottom(content.data[key].id, order));
              el._misc.content[key] = element;
            }
          }
          el._refs.added.appendChild(fragment);
        }
      },
      // @function _addContent (private) [Add extra content to task] @param type @param name @param focus
      addContent: function (type, name, focus) {
        var el = this;
        var item = {
          type: type,
          name: name
        };
        // if (type != "checklist") {
        var log = {};
        log[type] = {
          name: name
        };
        el._sendLog({
          log: log,
          type: "log"
        });
        // }
        el._addItemToDatabase(item);
      },
      // @function _addItemToDatabase (private) [Send new item to database] @param item @param callback
      addItemToDatabase: function (item, callback) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/item";
        eon.ajax(url, {
          contentType: "application/json",
          method: "POST",
          payload: JSON.stringify(item)
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _checklist_create (private) [Create a new check list and return it] @param data @param order
      checklist_create: function (data, order) {
        var el = this;
        el._misc.drop.checklist_item[data.id] = el._misc.drop.checklist_item[data.id] || {};
        var checklist = document.createElement("div");
        checklist.classList.add("task-dialog-checklist");
        checklist.setAttribute("checklistId", data.id);
        checklist.style.order = order;
        checklist.addEventListener("drop", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklist") {
            if (el._misc.drag.checklistId != this.getAttribute("checklistId")) {
              var target = e.target;
              var itemOrder;
              var oldOrder = parseInt(el._misc.content[el._misc.drag.checklistId].style.order);
              while (itemOrder == null) {
                if (target.classList.contains("task-dialog-checklist") && target.style.order) {
                  itemOrder = parseInt(target.style.order);
                } else {
                  target = target.parentElement;
                }
              }
              var rect = target.getBoundingClientRect();
              var y = e.clientY - rect.top;
              if (y < (rect.height / 2)) {
                itemOrder = itemOrder > -1 ? itemOrder - 1 : itemOrder;
              }
              if (itemOrder < oldOrder) {
                itemOrder++;
              }
              el._moveItem(el._misc.drag.checklistId, itemOrder);
              if (el._misc.currentChecklistMargin) {
                el._misc.currentChecklistMargin.classList.remove("task-dialog-checklist-dragover");
                el._misc.currentChecklistMargin = false;
              }
            }
          }
        });
        checklist.addEventListener("dragenter", function (event) {
          event.preventDefault();
          event.stopPropagation();
        });
        checklist.addEventListener("dragover", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklist") {
            if (el._misc.drag.checklistId != this.getAttribute("checklistId")) {
              var target = e.target;
              var itemOrder;
              while (itemOrder == null) {
                if (target.classList.contains("task-dialog-checklist") && target.style.order) {
                  itemOrder = parseInt(target.style.order);
                } else {
                  target = target.parentElement;
                }
              }
              var rect = target.getBoundingClientRect();
              var y = e.clientY - rect.top;
              if (y < (rect.height / 2)) {
                itemOrder = itemOrder > -1 ? itemOrder - 1 : itemOrder;
              }
              if (el._misc.currentChecklistMargin) {
                if (itemOrder === -1 && el._misc.currentChecklistMargin != el._misc.drop.checklist["-1"]) {
                  el._misc.currentChecklistMargin.classList.remove("task-dialog-checklist-dragover");
                  el._misc.drop.checklist["-1"].classList.add("task-dialog-checklist-dragover");
                  el._misc.currentChecklistMargin = el._misc.drop.checklist["-1"];
                } else {
                  for (var key in el._misc.drop.checklist) {
                    if (el._misc.drop.checklist[key].style.order == itemOrder && el._misc
                      .currentChecklistMargin != el._misc.drop.checklist[key]) {
                      el._misc.currentChecklistMargin.classList.remove("task-dialog-checklist-dragover");
                      el._misc.drop.checklist[key].classList.add("task-dialog-checklist-dragover");
                      el._misc.currentChecklistMargin = el._misc.drop.checklist[key];
                      break;
                    }
                  }
                }
              } else {
                if (itemOrder === -1) {
                  el._misc.drop.checklist["-1"].classList.add("task-dialog-checklist-dragover");
                  el._misc.currentChecklistMargin = el._misc.drop.checklist["-1"];
                } else {
                  for (var key in el._misc.drop.checklist) {
                    if (el._misc.drop.checklist[key].style.order == itemOrder) {
                      el._misc.drop.checklist[key].classList.add("task-dialog-checklist-dragover");
                      el._misc.currentChecklistMargin = el._misc.drop.checklist[key];
                      break;
                    }
                  }
                }
              }
            }
          }
        });
        checklist.addEventListener("dragleave", function (e) {
          if (el._misc.currentChecklistMargin) {
            el._misc.currentChecklistMargin.classList.remove("task-dialog-checklist-dragover");
            el._misc.currentChecklistMargin = false;
          }
        });
        var header = document.createElement("div");
        header.classList.add("task-dialog-checklist-row");
        header.setAttribute("checklistId", data.id);
        header.setAttribute("draggable", "true");
        header.addEventListener("dragstart", function (event) {
          el._misc.drag.checklistId = header.getAttribute("checklistId");
          el._misc.drag.type = "checklist";
          event.dataTransfer.setDragImage(el._misc.img.checklist, 0, 0);
        });
        var name = document.createElement("app-editable-text");
        name.saveOnBlur = "true";
        name.classList.add("task-dialog-checklist-title");
        name.value = data.name;
        name.doubleClick = "true";
        name.placeholder = eon.locale.projects.board.task.newList;
        name.setAttribute("checklistId", data.id);
        name.onReady(function () {
          name.editable = false;
        });
        name.onEdit(function (value) {
          name.editable = false;
          el._updateChecklistTitle(this.getAttribute("checklistId"), value);
        });
        header.appendChild(name);
        var percentage = document.createElement("div");
        percentage.classList = "task-dialog-checklist-percentage";
        percentage.innerHTML = el._checklist_setNamePercentage(data);
        header.appendChild(percentage);
        var checkListOptions = el._checklist_create_options(data, checklist, name);
        header.appendChild(checkListOptions);
        checklist.appendChild(header);
        var items = document.createElement("div");
        items.classList.add("task-dialog-checklist-items");
        var addNew = document.createElement("div");
        addNew.setAttribute("checklistId", data.id);
        addNew.addEventListener("drop", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklistItem") {
            var checklistId = el._misc.drag.checklistId;
            var checklistGoalId = this.getAttribute("checklistId");
            var checklistItemId = el._misc.drag.checklistItemId;
            var newOrder;
            var items = el._misc.content[checklistId].querySelector(".task-dialog-checklist-items")
              .querySelectorAll(
                ".task-dialog-checklist-row-item");
            var itemOrder;
            for (var i = 0; i < items.length; i++) {
              if (items[i].getAttribute("itemId") == checklistItemId) {
                itemOrder = items[i].style.order;
              }
              newOrder = !newOrder ? parseInt(items[i].style.order) : parseInt(items[i].style.order) >
                newOrder ? parseInt(items[i].style.order) : newOrder;
            }
            if (checklistId === checklistGoalId) {
              if (newOrder > itemOrder) {
                el._moveChecklistItem(checklistId, checklistItemId, newOrder);
              }
            } else {
              var items = el._misc.content[checklistGoalId].querySelector(".task-dialog-checklist-items")
                .querySelectorAll(
                  ".task-dialog-checklist-row-item");
              newOrder = null;
              for (var i = 0; i < items.length; i++) {
                newOrder = !newOrder ? parseInt(items[i].style.order) : parseInt(items[i].style.order) >
                  newOrder ? parseInt(items[i].style.order) : newOrder;
              }
              newOrder = newOrder ? newOrder + 1 : 0;
              el._moveChecklistItem(checklistGoalId, checklistItemId, newOrder);
            }
            el._misc.lastChecklistMargin.classList.remove("task-dialog-checklist-dragover");
            el._misc.lastChecklistMargin = false;
          }
        });
        addNew.addEventListener("dragenter", function (event) {
          event.preventDefault();
          event.stopPropagation();
        });
        addNew.addEventListener("dragover", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklistItem") {
            if (!el._misc.lastChecklistMargin) {
              var items = el._misc.content[this.getAttribute("checklistId")].querySelector(
                  ".task-dialog-checklist-items")
                .querySelectorAll(
                  ".task-dialog-checklist-item-margin");
              var item;
              for (var i = 0; i < items.length; i++) {
                item = !item ? items[i] : parseInt(items[i].style.order) > item.style.order ? items[i] :
                  item;
              }
              item.classList.add("task-dialog-checklist-dragover");
              el._misc.lastChecklistMargin = item;
            }
          }
        });
        addNew.addEventListener("dragleave", function (e) {
          if (el._misc.lastChecklistMargin) {
            el._misc.lastChecklistMargin.classList.remove("task-dialog-checklist-dragover");
            el._misc.lastChecklistMargin = false;
          }
        });
        addNew.classList.add("task-dialog-checklist-new");
        var addNewName = document.createElement("app-editable-text");
        addNewName.footer = "true";
        addNewName.fixedWidth = "true";
        addNewName.placeholder = "+ " + eon.locale.projects.board.task.addElement;
        addNewName.placeholderExpanded = eon.locale.global.typeName;
        addNewName.onEdit(function (value) {
          if (value && value.trim() != "") {
            el._checklist_addItem(data.id, value, percentage);
            setTimeout(function () {
              addNewName.value = "";
              addNewName.focus();
            }, 100);
          }
        });
        addNew.appendChild(addNewName);
        var dropTop = el._checklistItem_create_margin(data.id, -1);
        items.appendChild(dropTop);
        if (data.items) {
          for (var i = 0; i < data.items.order.length; i++) {
            var item = el._checklist_createItemCheck(data.items.data[data.items.order[i]], i, data.id,
              percentage);
            items.appendChild(item);
            var margin = el._checklistItem_create_margin(data.id, i);
            items.appendChild(margin);
          }
        }
        checklist.appendChild(items);
        checklist.appendChild(addNew);
        el._misc.content[data.id] = checklist;
        return checklist;
      },
      // @function _checklist_create_options (private) [Create options for checklist] @param data @param checklist @param name
      checklist_create_options: function (data, checklist, name) {
        var el = this;
        var checkListOptions = document.createElement("app-toggle-menu");
        checkListOptions.anchor = "left";
        checkListOptions.icon = "vicon-more";
        var editList = document.createElement("div");
        editList.setAttribute("checklistId", data.id);
        editList.classList.add("app-toggle-menu-item");
        var editListTitle = document.createElement("span");
        editListTitle.innerText = eon.locale.global.edit;
        var editListIcon = document.createElement("i");
        editListIcon.classList.add("vicon", "ticon-edit");
        editList.appendChild(editListIcon);
        editList.appendChild(editListTitle);
        editList.parent = checklist;
        editList.addEventListener("click", function (e) {
          name.editable = true;
          name.focus(e);
          // el._setCursorToEnd(name._refs.content);
          checkListOptions.close(e);
        });
        checkListOptions.addItem(editList);
        var moveUp = document.createElement("div");
        var moveUpTitle = document.createElement("span");
        moveUpTitle.innerText = eon.locale.projects.board.task.moveUp;
        var moveUpIcon = document.createElement("i");
        moveUpIcon.classList.add("vicon", "vicon-arrow-up");
        moveUp.appendChild(moveUpIcon);
        moveUp.appendChild(moveUpTitle);
        moveUp.classList.add("app-toggle-menu-item");
        moveUp.parent = checkListOptions;
        moveUp.addEventListener("click", function () {
          checkListOptions.close();
          var checkListId = this.parent.parentElement.parentElement.getAttribute("checklistId");
          var newOrder = el.task.items.order.indexOf(checkListId) - 1;
          if (newOrder > -1) {
            el._moveItem(checkListId, newOrder);
          }
        });
        checkListOptions.addItem(moveUp);
        var moveDown = document.createElement("div");
        var moveDownTitle = document.createElement("span");
        moveDownTitle.innerText = eon.locale.projects.board.task.moveDown;
        var moveDownIcon = document.createElement("i");
        moveDownIcon.classList.add("vicon", "vicon-arrow-down");
        moveDown.appendChild(moveDownIcon);
        moveDown.appendChild(moveDownTitle);
        moveDown.classList.add("app-toggle-menu-item");
        moveDown.parent = checkListOptions;
        moveDown.addEventListener("click", function () {
          checkListOptions.close();
          var checkListId = this.parent.parentElement.parentElement.getAttribute("checklistId");
          var newOrder = el.task.items.order.indexOf(checkListId) + 1;
          if (newOrder < el.task.items.order.length) {
            el._moveItem(checkListId, newOrder);
          }
        });
        checkListOptions.addItem(moveDown);
        var deleteList = document.createElement("div");
        deleteList.setAttribute("checklistId", data.id);
        deleteList.classList.add("app-toggle-menu-item");
        deleteList.setAttribute("type", "delete");
        var deleteListTitle = document.createElement("span");
        deleteListTitle.innerText = eon.locale.global.delete;
        var deleteListIcon = document.createElement("i");
        deleteListIcon.classList.add("vicon", "vicon-bin");
        deleteList.appendChild(deleteListIcon);
        deleteList.appendChild(deleteListTitle);
        deleteList.parent = checklist;
        deleteList.addEventListener("click", function (e) {
          var checklistId = this.getAttribute("checklistId");
          openDeleteConfirmation(function () {
            el._deleteItem(checklistId);
          });
          checkListOptions.close(e);
        });
        checkListOptions.addItem(deleteList);
        return checkListOptions;
      },
      // @function _moveItem (private) [Move an item] @param itemId @param order 
      moveItem: function (itemId, newOrder) {
        var el = this;
        newOrder = parseInt(newOrder);
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/moveItem/" + itemId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify({
            order: newOrder
          })
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _moveChecklistItem (private) [Move an item] @param checklistId @param checkListItemId @param order 
      moveChecklistItem: function (checklistId, checkListItemId, newOrder) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/moveChecklistItem/" + checklistId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify({
            order: newOrder,
            checkListItemId: checkListItemId
          })
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _checklist_setNamePercentage (private) [Set up checklist percentage]
      checklist_setNamePercentage: function (data) {
        var el = this;
        var totalItems = 0;
        var checkedItems = 0;
        if (data && data.items && data.items.data) {
          totalItems = Object.keys(data.items.data).length;
          for (var key in data.items.data) {
            if (data.items.data[key].checked) {
              checkedItems++;
            }
          }
        }
        return " (" + checkedItems + "/" + totalItems + ")";
      },
      // @function _updateChecklistPercentage (private) [Update checklist percentage]
      updateChecklistPercentage: function () {
        var el = this;
        for (var checklistKey in el._misc.content) {
          var percentage = el._misc.content[checklistKey].querySelector(".task-dialog-checklist-percentage");
          var totalItems = 0;
          var checkedItems = 0;
          if (el.task.items.data[checklistKey] && el.task.items.data[checklistKey].items && el.task.items.data[
              checklistKey].items.data) {
            totalItems = Object.keys(el.task.items.data[checklistKey].items.data).length;
            for (var itemKey in el.task.items.data[checklistKey].items.data) {
              if (el.task.items.data[checklistKey].items.data[itemKey].checked) {
                checkedItems++;
              }
            }
          }
          percentage.innerHTML = " (" + checkedItems + "/" + totalItems + ")";
        }
      },
      // @function _checklist_createItemCheck (private) [Create checkbox for checkList and return it] @param data @param order @param checkListId @param listPercentage
      checklist_createItemCheck: function (data, order, checkListId, listPercentage) {
        var el = this;
        var item = document.createElement("div");
        item.classList.add("task-dialog-checklist-row", "task-dialog-checklist-row-item");
        item.addEventListener("drop", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklistItem") {
            if (el._misc.drag.checklistItemId != this.getAttribute("itemId")) {
              var items = el._misc.content[el._misc.drag.checklistId].querySelector(
                  ".task-dialog-checklist-items")
                .querySelectorAll(".task-dialog-checklist-row-item");
              var oldOrder;
              for (var i = 0; i < items.length; i++) {
                if (items[i].getAttribute("itemId") == el._misc.drag.checklistItemId) {
                  oldOrder = parseInt(items[i].style.order);
                }
              }
              var target = e.target;
              var itemOrder;
              while (itemOrder == null) {
                if (target.classList.contains("task-dialog-checklist-row-item") && target.style.order) {
                  itemOrder = parseInt(target.style.order);
                } else {
                  target = target.parentElement;
                }
              }
              var rect = target.getBoundingClientRect();
              var y = e.clientY - rect.top;
              if (y > (rect.height / 2)) {
                itemOrder = parseInt(itemOrder) + 1;
              }
              if (el._misc.drag.checklistId === this.getAttribute("checklistId")) {
                if (itemOrder > oldOrder) {
                  itemOrder--;
                }
              }
              el._moveChecklistItem(this.getAttribute("checklistId"), el._misc.drag.checklistItemId,
                parseInt(itemOrder));
            }
          }
          if (el._misc.currentChecklistItemMargin) {
            el._misc.currentChecklistItemMargin.classList.remove("task-dialog-checklist-dragover");
            el._misc.currentChecklistItemMargin = false;
          }
        });
        item.addEventListener("dragenter", function (event) {
          event.preventDefault();
          event.stopPropagation();
        });
        item.addEventListener("dragover", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklistItem") {
            if (el._misc.drag.checklistItemId != this.getAttribute("itemId")) {
              var target = e.target;
              var itemOrder;
              while (itemOrder == null) {
                if (target.classList.contains("task-dialog-checklist-row-item") && target.style.order) {
                  itemOrder = parseInt(target.style.order);
                } else {
                  target = target.parentElement;
                }
              }
              var rect = target.getBoundingClientRect();
              var y = e.clientY - rect.top;
              if (y < (rect.height / 2)) {
                itemOrder = itemOrder > -1 ? itemOrder - 1 : itemOrder;
              }
              items = el._misc.content[this.getAttribute("checklistId")].querySelector(
                  ".task-dialog-checklist-items")
                .querySelectorAll(
                  ".task-dialog-checklist-item-margin");
              var item;
              for (var i = 0; i < items.length; i++) {
                if (parseInt(items[i].style.order) == itemOrder) {
                  item = items[i];
                }
              }
              if (el._misc.currentChecklistItemMargin && el._misc.currentChecklistItemMargin != item) {
                el._misc.currentChecklistItemMargin.classList.remove("task-dialog-checklist-dragover");
                item.classList.add("task-dialog-checklist-dragover");
                el._misc.currentChecklistItemMargin = item;
              } else if (!el._misc.currentChecklistItemMargin) {
                item.classList.add("task-dialog-checklist-dragover");
                el._misc.currentChecklistItemMargin = item;
              }
            }
          }
        });
        item.addEventListener("dragleave", function (e) {
          if (el._misc.currentChecklistItemMargin) {
            el._misc.currentChecklistItemMargin.classList.remove("task-dialog-checklist-dragover");
            el._misc.currentChecklistItemMargin = false;
          }
        });
        item.setAttribute("checklistId", checkListId);
        item.setAttribute("draggable", "true");
        item.addEventListener("dragstart", function (event) {
          el._misc.drag.checklistId = this.getAttribute("checklistId");
          el._misc.drag.checklistItemId = data.id;
          el._misc.drag.type = "checklistItem";
          event.dataTransfer.setDragImage(el._misc.img.checklistItem, 0, 0);
        });
        item.style.order = order;
        item.setAttribute("itemId", data.id);
        var check = document.createElement("eon-check");
        check.setAttribute("element", data.id);
        check.setAttribute("checklist", checkListId);
        check.parent = el;
        if (data.checked) {
          check.checked = true;
        }
        check.onCheck(function () {
          var itemId = this.getAttribute("checklist");
          var itemId = this.getAttribute("checklist");
          var payload = {};
          payload = {};
          payload.items = {};
          payload.items[this.getAttribute("element")] = {
            checked: true
          };
          this.parent._updateItem(this.getAttribute("checklist"), payload);
        });
        check.onUncheck(function () {
          var itemId = this.getAttribute("checklist");
          var itemId = this.getAttribute("checklist");
          var payload = {};
          payload = {};
          payload.items = {};
          payload.items[this.getAttribute("element")] = {
            checked: false
          };
          this.parent._updateItem(this.getAttribute("checklist"), payload);
        });
        item.appendChild(check);
        var text = document.createElement("app-editable-text");
        text.value = data.name;
        text.doubleClick = true;
        text.saveOnBlur = true;
        text.footer = true;
        text.setAttribute("checklist", checkListId);
        text.parent = el;
        text.setAttribute("element", data.id);
        text.onReady(function () {
          text.editable = false;
        });
        text.onEdit(function (value) {
          text.editable = false;
          var itemId = this.getAttribute("checklist");
          var payload = {};
          payload = {};
          payload.items = {};
          payload.items[this.getAttribute("element")] = {
            name: value
          };
          this.parent._updateItem(this.getAttribute("checklist"), payload);
        });
        item.appendChild(text);
        var options = document.createElement("app-toggle-menu");
        options.icon = "vicon-more";
        options.anchor = "left";
        var editName = document.createElement("div");
        editName.classList.add("app-toggle-menu-item");
        var editNameTitle = document.createElement("span");
        editNameTitle.innerText = eon.locale.global.edit;
        var editNameIcon = document.createElement("i");
        editNameIcon.classList.add("vicon", "ticon-edit");
        editName.appendChild(editNameIcon);
        editName.appendChild(editNameTitle);
        editName.addEventListener("click", function (e) {
          text.editable = true;
          text.focus(e);
          // el._setCursorToEnd(text._refs.content);
          options.close(e);
        });
        options.addItem(editName);
        var moveUp = document.createElement("div");
        moveUp.setAttribute("element", data.id);
        moveUp.setAttribute("checklistId", checkListId);
        var moveUpTitle = document.createElement("span");
        moveUpTitle.innerText = eon.locale.projects.board.task.moveUp;
        var moveUpIcon = document.createElement("i");
        moveUpIcon.classList.add("vicon", "vicon-arrow-up");
        moveUp.appendChild(moveUpIcon);
        moveUp.appendChild(moveUpTitle);
        moveUp.classList.add("app-toggle-menu-item");
        moveUp.parent = options;
        moveUp.addEventListener("click", function () {
          options.close();
          var checkListId = this.getAttribute("checklistId");
          var checkListItemId = this.getAttribute("element");
          var newOrder = el.task.items.data[checkListId].items.order.indexOf(checkListItemId) - 1;
          if (newOrder > -1) {
            el._moveChecklistItem(checkListId, checkListItemId, newOrder);
          }
        });
        options.addItem(moveUp);
        var moveDown = document.createElement("div");
        moveDown.setAttribute("element", data.id);
        moveDown.setAttribute("checklistId", checkListId);
        var moveDownTitle = document.createElement("span");
        moveDownTitle.innerText = eon.locale.projects.board.task.moveDown;
        var moveDownIcon = document.createElement("i");
        moveDownIcon.classList.add("vicon", "vicon-arrow-down");
        moveDown.appendChild(moveDownIcon);
        moveDown.appendChild(moveDownTitle);
        moveDown.classList.add("app-toggle-menu-item");
        moveDown.parent = options;
        moveDown.addEventListener("click", function () {
          options.close();
          var checkListId = this.getAttribute("checklistId");
          var checkListItemId = this.getAttribute("element");
          var newOrder = el.task.items.data[checkListId].items.order.indexOf(checkListItemId) + 1;
          if (newOrder < el.task.items.data[checkListId].items.order.length) {
            el._moveChecklistItem(checkListId, checkListItemId, newOrder);
          }
        });
        options.addItem(moveDown);
        var deleteCheck = document.createElement("div");
        deleteCheck.setAttribute("element", data.id);
        deleteCheck.setAttribute("checklist", checkListId);
        deleteCheck.classList.add("app-toggle-menu-item");
        deleteCheck.setAttribute("type", "delete");
        var deleteCheckTitle = document.createElement("span");
        deleteCheckTitle.innerText = eon.locale.global.delete;
        var deleteCheckIcon = document.createElement("i");
        deleteCheckIcon.classList.add("vicon", "vicon-bin");
        deleteCheck.appendChild(deleteCheckIcon);
        deleteCheck.appendChild(deleteCheckTitle);
        deleteCheck.parent = el;
        deleteCheck.item = item;
        deleteCheck.addEventListener("click", function () {
          var itemId = this.getAttribute("checklist");
          var payload = {};
          payload = {};
          payload.items = {};
          payload.items[this.getAttribute("element")] = null;
          this.parent._updateItem(this.getAttribute("checklist"), payload);
          options.close();
        });
        options.addItem(deleteCheck);
        item.appendChild(options);
        return item;
      },
      // @function _deleteItem (private) [Delete an item] @param itemId
      deleteItem: function (itemId) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/item/" + itemId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "DELETE"
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _updateChecklistTitle (private) [Update checklist title] @param itemId @param name
      updateChecklistTitle: function (itemId, name) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/item/" + itemId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify({
            name: name
          })
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _updateItem (private) [Update an item] @param itemId @param item @param callback
      updateItem: function (itemId, item, callback) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/item/" + itemId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify(item)
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _checklist_addItem (private) [Add a new item to a checklist] @param itemId @param name
      checklist_addItem: function (itemId, name, listPercentage, callback) {
        var el = this;
        var id = Math.random().toString(36).substring(2, 8) + Math.random().toString(36).substring(2, 8);
        var payload = {
          items: {}
        };
        payload.items[id] = {
          name: name,
          id: id
        };
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/item/" + itemId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify(payload)
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _uploadImages (private) [Upload images to database] @param img @param loadingMask
      uploadImages: function (img, loadingMask) {
        var el = this;
        var data = new FormData();
        var request = new XMLHttpRequest();
        var names = [];
        for (var i = 0; i < img.length; i++) {
          data.append("file", img[i]);
          names.push(img[i].name);
        }
        request.addEventListener('load', function (e) {
          if (request.status >= 200 && request.status < 400) {
            // el.task = request.response.task; // TODO
            // eon.triggerCallback("onTaskUpdated", el, el, [el.task]);
            // el._setImages(el.task.attachments);
            el._sendLog({
              log: {
                "images": {
                  name: names
                }
              },
              type: "log"
            });
          } else if (request.status === 507) {
            showInfoDialog(eon.locale.projects.board.task.error.maxStorage, function () {});
            loadingMask.parentElement.removeChild(loadingMask);
            el._setImages(el.task.attachments);
          } else if (request.status === 405) {
            showInfoDialog(eon.locale.projects.board.task.error.maxFileSize, function () {});
            loadingMask.parentElement.removeChild(loadingMask);
            el._setImages(el.task.attachments);
          }
        });
        request.responseType = "json";
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/file";
        request.open("post", url);
        request.send(data);
      },
      // @function _setImages (private) [Create images thumbnail]
      setImages: function (images) {
        var el = this;
        el._refs.attachments.innerHTML = "";
        var fragment = document.createDocumentFragment();
        if (images && Object.keys(images).length > 0) {
          for (var key in images) {
            fragment.appendChild(el._createThumbnail(images[key]));
          }
        } else {
          if (!this._refs.placeHolder) {
            this._refs.placeHolder = createPlaceHolder(eon.locale.global.noFiles, "img/no-content/upload.svg", eon
              .locale.global.noFilesTitle);
          }
          this._refs.placeHolder.classList.remove("hide");
          fragment.appendChild(this._refs.placeHolder);
        }

        el._refs.attachments.appendChild(fragment);
      },
      // @function _createThumbnail (private) [Create a thumbnail for an image]
      createThumbnail: function (data) {
        var el = this;
        var image = document.createElement("div");
        image.classList.add("task-dialog-attachments-image");
        var img = document.createElement("img");
        img.setAttribute("imageId", data.id);
        if (data.thumbnail) {
          img.src = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + data
            .id + "/thumbnail/" + data.id;
          img.onerror = function () {
            this.onerror = null;
            this.src = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task.id +
              "/file/" + this.getAttribute("imageId");
          }
        } else {
          switch (data.mimetype) {
            default:
              img.src = "img/projects/task/file.png";
              break;
          }
        }
        image.appendChild(img);
        var overlay = document.createElement("div");
        overlay.classList.add("task-dialog-attachments-image-overlay");
        overlay.setAttribute("imageId", data.id);
        overlay.setAttribute("mimetype", data.mimetype);
        overlay.addEventListener("click", function () {
          el._fileZoomIn(this.getAttribute("imageId"), this.getAttribute("mimetype"));
        });
        image.appendChild(overlay);
        var container = document.createElement("div");
        container.classList.add("task-dialog-attachments-preview");
        container.appendChild(image);
        var pin = document.createElement("i");
        pin.classList.add("vicon", "vicon-pushpin", "task-dialog-attachments-pin");
        pin.setAttribute("imageId", data.id);
        if (el.task.mainImage && data.id === el.task.mainImage) {
          el._misc.pinned = pin;
          pin.classList.add("task-dialog-attachments-pin-selected");
        }
        // pin.setAttribute("imageId", data.id);
        pin.addEventListener("click", function () {
          var setTo = true;
          if (el._misc.pinned) {
            el._misc.pinned.classList.remove("task-dialog-attachments-pin-selected");
            if (el._misc.pinned === this) {
              setTo = false;
              el._misc.pinned = null;
            }
          }
          if (setTo) {
            this.classList.add("task-dialog-attachments-pin-selected");
            el._misc.pinned = this;
          }
          el._pinImage(this.getAttribute("imageId"), setTo);
        });
        container.appendChild(pin);
        var footer = document.createElement("div");
        footer.classList.add("task-dialog-attachments-footer");
        var name = document.createElement("app-editable-text");
        name.classList.add("task-dialog-attachments-name");
        name.value = data.name;
        name.fixedWidth = true;
        name.footer = false;
        name.saveOnBlur = true;
        name.doubleClick = true;
        name.setAttribute("imageId", data.id);
        name.onReady(function () {
          name.editable = false;
        });
        name.onEdit(function (value) {
          name.editable = false;
          el._updateImage(this.getAttribute("imageId"), {
            name: value
          });
        });
        footer.appendChild(name);
        var footerButtons = document.createElement("div");
        footerButtons.classList.add("task-dialog-attachments-footer-buttons");
        var editImg = document.createElement("i");
        editImg.classList.add("vicon", "ticon-edit", "eon-fg2-hoverable");
        editImg.setAttribute("imageId", data.id);
        editImg.addEventListener("click", function () {
          name.editable = true;
          name.focus();
          // el._setCursorToEnd(name._refs.content);
        });
        footerButtons.appendChild(editImg);

        var downloadAttachment = document.createElement("i");
        downloadAttachment.classList.add("vicon", "ticon-download", "eon-fg2-hoverable");
        downloadAttachment.setAttribute("imageId", data.id);
        downloadAttachment.addEventListener("click", function () {
          var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task.id +
            "/file/" + this.getAttribute("imageId");
          var downloader = document.createElement("a");
          downloader.href = url;
          downloader.download = name.value;
          downloader.click();
        });
        footerButtons.appendChild(downloadAttachment);

        var deleteImg = document.createElement("i");
        deleteImg.classList.add("vicon", "ticon-garbage", "eon-fg2-hoverable-delete");
        deleteImg.setAttribute("imageId", data.id);
        deleteImg.addEventListener("click", function () {
          var imageId = this.getAttribute("imageId");
          openDeleteConfirmation(function () {
            el._deleteImage(imageId, container);
          });
        });
        footerButtons.appendChild(deleteImg);
        footer.appendChild(footerButtons);
        container.appendChild(footer);
        return container;
      },
      // @function _deleteImage (private) [Delete image] @param imageId @param image [Image object]
      deleteImage: function (imageId, image) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/file/" + imageId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "DELETE"
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _updateImage (private) [Update image name] @param imageId @param payload
      updateImage: function (imageId, payload) {
        var el = this;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task
          .id + "/file/" + imageId;
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify(payload)
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _pinImage (private) [Pin image] @param imageId @param value
      pinImage: function (imageId, value) {
        var el = this;
        el._updateImage(imageId, {
          pinned: value
        });
      },
      // @function _fileZoomIn (private) [Full screen image view] @param (fileId) @param mimetype
      fileZoomIn: function (fileId, mimetype) {
        var el = this;
        el._refs.imageZoomInContent.innerHTML = "";
        var element;
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id + "/" + el.task.id +
          "/file/" + fileId;

        // switch (mimetype.substring(0, 5)) {
        //   case "image":
        //     element = document.createElement("img");
        //     url += "?" + new Date().getTime();
        //     element.src = url;
        //     break;
        //   default:
        //     element = document.createElement("iframe");
        //     element.src = url;
        //     break;
        // }


        if (mimetype.substring(0, 5) === "image") {
          element = document.createElement("img");
          url += "?" + new Date().getTime();
          element.src = url;
        } else if (mimetype === "text/html") {
          element = document.createElement("div");
        } else if (mimetype.substring(0, 11) === "application") {
          element = document.createElement("div");
        } else {
          element = document.createElement("iframe");
          element.src = url;
        }
        el._refs.imageZoomInContent.appendChild(element);
        el._refs.fileZoomIn.open();
      },
      // @function _createFileUploader (private) [Create file uploader dynamically so it can point to another nodeElement]
      createFileUploader: function () {
        var el = this;
        var fileUploader = document.createElement("app-files-uploader");
        fileUploader.description = "locale.projects.board.task.uploadImage";
        fileUploader.dropNode = el._refs.dialogContent;
        fileUploader.selectButton = [el._refs.addImages, el._refs.browseFiles];
        fileUploader.showUploader = false;
        fileUploader.onDragHoverEnter(function (e) {
          el._refs.attachOverlay.classList.add("task-dialog-attach-overlay-hover");
        });
        fileUploader.onDragHoverLeave(function (e) {
          el._refs.attachOverlay.classList.remove("task-dialog-attach-overlay-hover");
        });
        el._refs.imageUploader = fileUploader;
        el._refs.fileUploader.appendChild(fileUploader);
      },
      // // @function _setCursorToEnd (private) [Set cursor position at the end] @param el
      // setCursorToEnd: function (el) {
      //   if (typeof window.getSelection != "undefined" &&
      //     typeof document.createRange != "undefined") {
      //     var range = document.createRange();
      //     range.selectNodeContents(el);
      //     range.collapse(false);
      //     var sel = window.getSelection();
      //     sel.removeAllRanges();
      //     sel.addRange(range);
      //   } else if (typeof document.body.createTextRange != "undefined") {
      //     var textRange = document.body.createTextRange();
      //     textRange.moveToElementText(el);
      //     textRange.collapse(false);
      //     textRange.select();
      //   }
      // },
      // @function _setViewers (private) [Show viewers icons]
      setViewers: function () {
        var el = this;
        el._refs.viewers.innerHTML = "";
        if (el.task.viewers) {
          var fragment = document.createDocumentFragment();
          var groupsMembers = el.task.viewers.members.length + el.task.viewers.groups.length;
          var max = groupsMembers < parseInt(el.maxViewersShown) ? groupsMembers : parseInt(el.maxViewersShown);
          var added = 0;
          if (el.task.viewers.groups.length > 0) {
            for (var i = 0; i < max; i++) {
              if (i < el.task.viewers.groups.length) {
                var avi = document.createElement("app-avatar");
                avi.userName = el._misc.workspaceData.groups[el.task.viewers.groups[i]].name;
                avi.icon = "ticon-users";
                avi.style.zIndex = max - i;
                // avi.style.zIndex = i;
                added++;
                fragment.appendChild(avi);
              }
            }
          }
          var maxMembers = max - added;
          if (el.task.viewers.members.length > 0 && maxMembers > 0) {
            for (var i = 0; i < maxMembers; i++) {
              if (i < el.task.viewers.members.length && el._misc.workspaceData.members[el.task.viewers.members[
                  i]]) {
                var avi = document.createElement("app-avatar");
                avi.userName = el._misc.workspaceData.members[el.task.viewers.members[i]].alias;
                avi.image = "/rest/user/avatar/" + el.task.viewers.members[i];
                avi.style.zIndex = max - (i + added);
                // avi.style.zIndex = i + added;
                fragment.appendChild(avi);
              }
            }
          }
          var extra = groupsMembers - max;
          if (extra > 0) {
            var avi = document.createElement("app-avatar");
            avi.userName = "+" + extra;
            avi.type = "extra";
            avi.style.zIndex = max + 1;
            // fragment.appendChild(avi);
            fragment.insertBefore(avi, fragment.firstChild);
          }
          el._refs.viewers.appendChild(fragment);
        }
        el._setViewers_mobile();
      },
      // @function _setViewers_mobile (private) [Show viewers icons]
      setViewers_mobile: function () {
        var el = this;
        el._refs.viewers_mobile.innerHTML = "";
        if (el.task.viewers) {
          var fragment = document.createDocumentFragment();
          var groupsMembers = el.task.viewers.members.length + el.task.viewers.groups.length;
          var max = groupsMembers < parseInt(el.maxViewersShown) ? groupsMembers : parseInt(el.maxViewersShown);
          var added = 0;
          if (el.task.viewers.groups.length > 0) {
            el._refs.viewers_mobile_label.classList.add("hide");
            el._refs.viewers_mobile_placeholder.classList.add("hide");
            for (var i = 0; i < max; i++) {
              if (i < el.task.viewers.groups.length) {
                var avi = document.createElement("app-avatar");
                avi.userName = el._misc.workspaceData.groups[el.task.viewers.groups[i]].name;
                avi.icon = "ticon-users";
                avi.style.zIndex = max - i;
                added++;
                fragment.appendChild(avi);
              }
            }
          }
          var maxMembers = max - added;
          if (el.task.viewers.members.length > 0 && maxMembers > 0) {
            el._refs.viewers_mobile_label.classList.add("hide");
            el._refs.viewers_mobile_placeholder.classList.add("hide");
            for (var i = 0; i < maxMembers; i++) {
              if (i < el.task.viewers.members.length && el._misc.workspaceData.members[el.task.viewers.members[
                  i]]) {
                var avi = document.createElement("app-avatar");
                avi.userName = el._misc.workspaceData.members[el.task.viewers.members[i]].alias;
                avi.image = "/rest/user/avatar/" + el.task.viewers.members[i];
                avi.style.zIndex = max - (i + added);
                fragment.appendChild(avi);
              }
            }
          }
          if (el.task.viewers.groups.length <= 0 && el.task.viewers.members.length <= 0) {
            el._refs.viewers_mobile_label.classList.remove("hide");
            el._refs.viewers_mobile_placeholder.classList.remove("hide");
          }
          var extra = groupsMembers - max;
          if (extra > 0) {
            var avi = document.createElement("app-avatar");
            avi.userName = "+" + extra;
            avi.type = "extra";
            // fragment.appendChild(avi);
            avi.style.zIndex = max + 1;
            fragment.insertBefore(avi, fragment.firstChild);
          }
          el._refs.viewers_mobile.appendChild(fragment);
        }
      },
      // @function _updatePriority (private) [Set task priority] @param priority @param event
      updatePriority: function (priority, event) {
        var el = this;
        el._updateTask({
          priority: priority
        });
      },
      // @function _setPriority (private) [Show priority at screen]
      setPriority: function () {
        var el = this;
        var priorityIcon = el._refs.priority.querySelector("i");
        priorityIcon.classList.remove("task-dialog-priority-urgent");
        priorityIcon.classList.remove("task-dialog-priority-high");
        priorityIcon.classList.remove("task-dialog-priority-normal");
        priorityIcon.classList.remove("task-dialog-priority-low");
        var priorityIconMobile = el._refs.priority_mobile.querySelector("i");
        priorityIconMobile.classList.remove("task-dialog-priority-urgent");
        priorityIconMobile.classList.remove("task-dialog-priority-high");
        priorityIconMobile.classList.remove("task-dialog-priority-normal");
        priorityIconMobile.classList.remove("task-dialog-priority-low");
        switch (el.task.priority) {
          case "urgent":
            priorityIcon.classList.add("task-dialog-priority-urgent");
            priorityIconMobile.classList.add("task-dialog-priority-urgent");
            el._refs.priority_mobile_value.innerHTML = eon.locale.projects.board.task.priority.urgent;
            break;
          case "high":
            priorityIcon.classList.add("task-dialog-priority-high");
            priorityIconMobile.classList.add("task-dialog-priority-high");
            el._refs.priority_mobile_value.innerHTML = eon.locale.projects.board.task.priority.high;
            break;
          case "normal":
            priorityIcon.classList.add("task-dialog-priority-normal");
            priorityIconMobile.classList.add("task-dialog-priority-normal");
            el._refs.priority_mobile_value.innerHTML = eon.locale.projects.board.task.priority.normal;
            break;
          case "low":
            priorityIcon.classList.add("task-dialog-priority-low");
            priorityIconMobile.classList.add("task-dialog-priority-low");
            el._refs.priority_mobile_value.innerHTML = eon.locale.projects.board.task.priority.low;
            break;
          default:
            el._refs.priority_mobile_value.innerHTML = eon.locale.projects.board.task.priority.none;
            break;
        }
      },
      // @function _setSchedule (private) [Set scheduled time] @param schedule
      setSchedule: function (schedule) {
        var el = this;
        var estimated = schedule.estimated;
        var start = schedule.start;
        var due = schedule.due;
        var clearValue = eon.locale.projects.board.task.placeholder.time;
        if (estimated && (estimated.days != 0 || estimated.hours != 0 || estimated.minutes != 0)) {
          var estimatedString = [];
          if (estimated.days && estimated.days != 0) {
            estimatedString.push(estimated.days + " " + eon.locale.projects.board.task.d);
          }
          if (estimated.hours && estimated.hours != 0) {
            estimatedString.push(estimated.hours + " " + eon.locale.projects.board.task.h);
          }
          if (estimated.minutes && estimated.minutes != 0) {
            estimatedString.push(estimated.minutes + " " + eon.locale.projects.board.task.m);
          }
          el._refs.schedule_estimated_pc_value.innerHTML = estimatedString.join(", ");
          if (el.task.schedule.estimated.days != el._refs.estimated_days.value) {
            el._refs.estimated_days.value = el.task.schedule.estimated.days;
          }
          if (el.task.schedule.estimated.hours != el._refs.estimated_hours.value) {
            el._refs.estimated_hours.value = el.task.schedule.estimated.hours;
          }
          if (el.task.schedule.estimated.minutes != el._refs.estimated_minutes.value) {
            el._refs.estimated_minutes.value = el.task.schedule.estimated.minutes;
          }
          el._refs.schedule_estimated_mobile_value.innerHTML = estimatedString.join(", ");
          if (el.task.schedule.estimated.days != el._refs.estimated_days_mobile.value) {
            el._refs.estimated_days_mobile.value = el.task.schedule.estimated.days;
          }
          if (el.task.schedule.estimated.hours != el._refs.estimated_hours_mobile.value) {
            el._refs.estimated_hours_mobile.value = el.task.schedule.estimated.hours;
          }
          if (el.task.schedule.estimated.minutes != el._refs.estimated_minutes_mobile.value) {
            el._refs.estimated_minutes_mobile.value = el.task.schedule.estimated.minutes;
          }
          el._refs.schedule_estimated_pc_value.classList.remove("task-dialog-mobile-add-new");
          el._refs.schedule_estimated_mobile_value.classList.remove("task-dialog-mobile-add-new");
        } else {
          el._refs.schedule_estimated_pc_value.innerHTML = eon.locale.projects.board.task.placeholder.estimate;
          el._refs.schedule_estimated_mobile_value.innerHTML = eon.locale.projects.board.task.placeholder
            .estimate;
          el._refs.schedule_estimated_pc_value.classList.add("task-dialog-mobile-add-new");
          el._refs.schedule_estimated_mobile_value.classList.add("task-dialog-mobile-add-new");
          el._refs.estimated_days.value = 0;
          el._refs.estimated_hours.value = 0;
          el._refs.estimated_minutes.value = 0;
          el._refs.estimated_days_mobile.value = 0;
          el._refs.estimated_hours_mobile.value = 0;
          el._refs.estimated_minutes_mobile.value = 0;
        }
        if (schedule.elapsed) {
          var elapsed = parseFloat(schedule.elapsed);
          if (schedule.running && schedule.startUTC) {
            el._toggleWorking(true);
            elapsed += new Date().getTime() - parseFloat(schedule.startUTC);
            clearInterval(el._misc.workingInterval);
            el._misc.workingInterval = setInterval(function () {
              if (el.task.schedule.running) {
                var elapsed = parseFloat(el.task.schedule.elapsed) + new Date().getTime() - parseFloat(el.task
                  .schedule.startUTC);
                var currentMoment = moment.duration(Number(elapsed), "milliseconds");
                var currentTime = currentMoment.format(
                  "hh:mm:ss", {
                    trim: false
                  });
                el._refs.schedule_worked_value.innerHTML = currentTime;
                el._refs.schedule_worked_value_mobile.innerHTML = currentTime;
              } else {
                clearInterval(el._misc.workingInterval);
              }
            }, 1000);
          } else {
            el._toggleWorking();
          }

          var currentMoment = moment.duration(Number(elapsed), "milliseconds");
          var currentTime = currentMoment.format(
            "hh:mm:ss", {
              trim: false
            });
          el._refs.schedule_worked_value.innerHTML = currentTime;
          el._refs.schedule_worked_value_mobile.innerHTML = currentTime;
        } else {
          el._refs.schedule_worked_value.innerHTML = "00:00:00";
          el._refs.schedule_worked_value_mobile.innerHTML = "00:00:00";
          el._refs.worked_hours.value = 0;
          el._refs.worked_minutes.value = 0;
          el._refs.worked_seconds.value = 0;
          el._refs.worked_hours_mobile.value = 0;
          el._refs.worked_minutes_mobile.value = 0;
          el._refs.worked_seconds_mobile.value = 0;
        }
        if (start) {
          el._refs.schedule_start_pc_value.innerHTML = start;
          if (el._refs.schedule_start_pc_date.value != start) {
            el._refs.schedule_start_pc_date.value = start;
          }
          el._refs.schedule_start_mobile_value.innerHTML = start;
          if (el._refs.schedule_start_mobile_date.value != start) {
            el._refs.schedule_start_mobile_date.value = start;
          }
          el._refs.schedule_start_pc_value.classList.remove("task-dialog-mobile-add-new");
          el._refs.schedule_start_mobile_value.classList.remove("task-dialog-mobile-add-new");
        } else {
          el._refs.schedule_start_pc_value.innerHTML = clearValue;
          el._refs.schedule_start_mobile_value.innerHTML = clearValue;
          el._refs.schedule_start_pc_value.classList.add("task-dialog-mobile-add-new");
          el._refs.schedule_start_mobile_value.classList.add("task-dialog-mobile-add-new");
        }
        if (due) {
          el._refs.schedule_due_pc_value.innerHTML = due;
          if (el._refs.schedule_due_pc_date.value != due) {
            el._refs.schedule_due_pc_date.value = due;
          }
          el._refs.schedule_due_mobile_value.innerHTML = due;
          if (el._refs.schedule_due_mobile_date.value != due) {
            el._refs.schedule_due_mobile_date.value = due;
          }
          el._refs.schedule_due_pc_value.classList.remove("task-dialog-mobile-add-new");
          el._refs.schedule_due_mobile_value.classList.remove("task-dialog-mobile-add-new");
        } else {
          el._refs.schedule_due_pc_value.innerHTML = clearValue;
          el._refs.schedule_due_mobile_value.innerHTML = clearValue;
          el._refs.schedule_due_pc_value.classList.add("task-dialog-mobile-add-new");
          el._refs.schedule_due_mobile_value.classList.add("task-dialog-mobile-add-new");
        }
      },
      // @function _updateSchedule (private) [Send schedule data to database] @param type @param value
      updateSchedule: function (type, value) {
        var el = this;
        var schedule = {};
        schedule[type] = value;
        el._updateTask({
          schedule: schedule
        });
      },
      // @function _setCalendarDate (private) [Format date for calendar]
      setCalendarDate: function (date, calendar) {
        var el = this;
        if (date) {
          return eon.time.getDateWithFormat(moment(date).toDate(), calendar.valueFormat, navigator
            .language);
        }
      },
      // @function _createLoadingAttachments (private) [Create loading mask while loading images]
      createLoadingAttachments: function () {
        var loadingContainer = document.createElement("div");
        loadingContainer.classList.add("task-dialog-attachments-loading-mask");
        var loading = document.createElement("div");
        loading.innerHTML =
          '<eon-loading eon-ref="mask" duration="5000" class="form-mask" format="descendant" display="true"></eon-loading>';
        loadingContainer.appendChild(loading);
        return loadingContainer;
      },
      // @function _loadMoreChat (private) [Load more content for chat when scrolling]
      loadMoreChat: function () {
        var el = this;
        el._misc.chat.offset = el._misc.chat.offset + el._misc.chat.limit;
        el.getChatData(function (logs) {
          if (logs.length == 0) {
            el._misc.chat.endData = true;
          }
          el._appendChatContent(logs);
          setTimeout(function () {
            el._misc.chat.loadingScrolledData = false;
          }, 500);
        });
      },
      // // @function _getPreviousChecklistItem (private) [Get id of the previous checklist item. Note that checklist is sorted reverse so the previous order will be the next greater one]
      // getPreviousChecklistItem: function (checklistId, targetPosition) {
      //   var el = this;
      //   var order;
      //   for (var key in el.task.items[checklistId].items) {
      //     if (!order && el.task.items[checklistId].items[key].order > targetPosition) {
      //       order = el.task.items[checklistId].items[key].order;
      //     }
      //     if (el.task.items[checklistId].items[key].order > targetPosition && el.task.items[checklistId].items[
      //         key].order < order) {
      //       order = el.task.items[checklistId].items[key].order;
      //     }
      //   }
      //   order = order ? order : targetPosition;
      //   return order;
      // },
      // @function _nextStatus (private) [Move task to next column] @param e [event]
      nextStatus: function (e) {
        var el = this;
        e.preventDefault();
        e.stopPropagation();
        var next = el._getNextStatusId();
        var order = el.board.lists.data[next].tasks ? el.board.lists.data[next].tasks.length : 0;
        if (next) {
          task.list(el.task.id, next, order);
        }
      },
      // @function _getNextStatusId (private) [Get next list id for current task]
      getNextStatusId: function () {
        var el = this;
        var currentListOrder = el.board.lists.order.indexOf(el._getTaskListId());
        return el.board.lists.order[parseInt(currentListOrder) + 1];
      },
      // @function _checklist_create_marginBottom (private) [Create margin bottom to allow drop] @param checklistId @param order
      checklist_create_marginBottom: function (checklistId, order) {
        var el = this;
        var margin = document.createElement("div");
        margin.style.order = order;
        margin.setAttribute("order", order);
        margin.classList.add("task-dialog-checklist-margin-bottom");
        margin.addEventListener("drop", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklist") {
            var checklistId = el._misc.drag.checklistId;
            var newOrder = parseInt(this.style.order);
            var checklistOrder = el._misc.content[checklistId].style.order;
            if (newOrder > checklistOrder) {
              el._moveItem(checklistId, newOrder);
            } else if (newOrder < checklistOrder) {
              var nextOrder = el._getNextChecklistOrder(checklistId, newOrder);
              if (nextOrder) {
                el._moveItem(checklistId, nextOrder);
              }
            }
            this.classList.remove("task-dialog-checklist-dragover");
          }
        });
        margin.addEventListener("dragenter", function (event) {
          event.preventDefault();
          event.stopPropagation();
        });
        margin.addEventListener("dragover", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklist") {
            this.classList.add("task-dialog-checklist-dragover");
          }
        });
        margin.addEventListener("dragleave", function (e) {
          this.classList.remove("task-dialog-checklist-dragover");
        });
        if (checklistId) {
          el._misc.drop.checklist[checklistId] = margin;
        } else if (order === -1) {
          el._misc.drop.checklist["-1"] = margin;
        }
        return margin;
      },
      // @function _checklistItem_create_margin (private) [Create checklist item margin to allow drop] @param checklistId @param order
      checklistItem_create_margin: function (checklistId, order) {
        var el = this;
        var margin = document.createElement("div");
        margin.style.order = order;
        margin.setAttribute("order", order);
        margin.setAttribute("checklistId", checklistId);
        margin.classList.add("task-dialog-checklist-item-margin");
        margin.addEventListener("drop", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklistItem") {
            var checklistId = el._misc.drag.checklistId;
            var checklistGoalId = this.getAttribute("checklistId");
            var checklistItemId = el._misc.drag.checklistItemId;
            var newOrder = parseInt(this.style.order);
            var items = el._misc.content[checklistId].querySelector(".task-dialog-checklist-items")
              .querySelectorAll(
                ".task-dialog-checklist-row-item");
            var itemOrder;
            for (var i = 0; i < items.length; i++) {
              if (items[i].getAttribute("itemId") == checklistItemId) {
                itemOrder = items[i].style.order;
              }
            }
            if (checklistId === checklistGoalId) {
              if (newOrder > itemOrder) {
                el._moveChecklistItem(checklistId, checklistItemId, newOrder);
              } else if (newOrder < itemOrder) {
                newOrder++;
                el._moveChecklistItem(checklistId, checklistItemId, newOrder);
              }
            } else {
              newOrder++;
              el._moveChecklistItem(checklistGoalId, checklistItemId, newOrder);
            }
            this.classList.remove("task-dialog-checklist-dragover");
          }
        });
        margin.addEventListener("dragenter", function (event) {
          event.preventDefault();
          event.stopPropagation();
        });
        margin.addEventListener("dragover", function (e) {
          e.preventDefault();
          if (el._misc.drag.type == "checklistItem") {
            this.classList.add("task-dialog-checklist-dragover");
          }
        });
        margin.addEventListener("dragleave", function (e) {
          this.classList.remove("task-dialog-checklist-dragover");
        });
        if (checklistId) {
          if (!el._misc.drop.checklist_item[checklistId][order]) {
            el._misc.drop.checklist_item[checklistId][order] = margin;
          } else {
            var tOrder = 0;
            while (el._misc.drop.checklist_item[checklistId][tOrder]) {
              tOrder++;
            }
            el._misc.drop.checklist_item[checklistId][tOrder] = margin;
          }
        }
        return margin;
      },
      // @function _sortChecklistDrop (private) [Sort checklist drop spaces after move an item]
      sortChecklistDrop: function () {
        var el = this;
        for (var key in el._misc.drop.checklist) {
          if (el._misc.drop.checklist[key] && el._misc.drop.checklist[key].parentElement) {
            el._misc.drop.checklist[key].parentElement.appendChild(el._misc.drop.checklist[key]);
          }
        }
      },
      // @function _sortChecklistItemDrop (private) [Sort checklist item drop spaces after move an item] @param sort [Set again order attribute]
      sortChecklistItemDrop: function (sort) {
        var el = this;
        if (sort) {
          for (var checklistKey in el._misc.drop.checklist_item) {
            var order = -1;
            var newObject = {};
            for (var checklistItemKey in el._misc.drop.checklist_item[checklistKey]) {
              if (el._misc.drop.checklist_item[checklistKey][checklistItemKey]) {
                newObject[order] = el._misc.drop.checklist_item[checklistKey][checklistItemKey];
                newObject[order].style.order = order;
                order++;
              }
            }
            el._misc.drop.checklist_item[checklistKey] = newObject;
          }
        }
        for (var checklistKey in el._misc.drop.checklist_item) {
          for (var checklistItemKey in el._misc.drop.checklist_item[checklistKey]) {
            if (el._misc.drop.checklist_item[checklistKey][checklistItemKey] && el._misc.drop.checklist_item[
                checklistKey][checklistItemKey].parentElement) {
              el._misc.drop.checklist_item[checklistKey][checklistItemKey].parentElement.appendChild(el._misc.drop
                .checklist_item[checklistKey][checklistItemKey]);
            }
          }
        }
      },
      // @function _getNextChecklistOrder (private) [Get next checklist order, the checklist below the current one] @param checklistId @param newOrder
      getNextChecklistOrder: function (checklistId, newOrder) {
        var el = this;
        var next;
        for (var key in el._misc.content) {
          if (el._misc.content[key].style.order > newOrder && (!next ||
              el._misc.content[key].style.order < next)) {
            next = el._misc.content[key].style.order;
          }
        }
        return next;
      },
      // @function _getNextChecklistItemOrder (private) [Get next checklist item order, the item below the current one] @param checklistId @param checklistItemId @param newOrder
      getNextChecklistItemOrder: function (checklistId, checklistItemId, newOrder) {
        var el = this;
        var next;
        var items = el._misc.content[checklistId].querySelector(".task-dialog-checklist-items").querySelectorAll(
          ".task-dialog-checklist-row-item");
        var order;
        for (var i = 0; i < items.length; i++) {
          if (items[i].getAttribute("itemId") == checklistItemId) {
            order = parseInt(items[i].style.order);
          }
        }
        if (order) {
          for (var i = 0; i < items.length; i++) {
            if (items[i].style.order > newOrder && (!next ||
                items[i].style.order < next)) {
              next = parseInt(items[i].style.order);
            }
          }
        }
        return next;
      },
      // @function _setupWorkingContextmenu (private) [Set up values for working contextmenu]
      setupWorkingContextmenu: function () {
        var el = this;
        if (el.task.schedule && el.task.schedule.elapsed) {
          var elapsed = parseFloat(el.task.schedule.elapsed);
          if (el.task.schedule.running && el.task.schedule.startUTC) {
            elapsed += new Date().getTime() - parseFloat(el.task.schedule.startUTC);
          }
          var currentMoment = moment.duration(Number(elapsed), "milliseconds");
          var currentTime = currentMoment.format(
            "hh:mm:ss", {
              trim: false
            });
          var splitTime = currentTime.split(":");
          el._refs.worked_hours.value = splitTime[0];
          el._refs.worked_minutes.value = splitTime[1];
          el._refs.worked_seconds.value = splitTime[2];
          el._refs.worked_hours_mobile.value = splitTime[0];
          el._refs.worked_minutes_mobile.value = splitTime[1];
          el._refs.worked_seconds_mobile.value = splitTime[2];
        }
      },
      // @function _toggleWorking (private) [Toggle working on task] @param toggleTo
      toggleWorking: function (toggleTo) {
        var el = this;
        if (toggleTo) {
          el._refs.worked_play_animation.classList.remove("hide");
          el._refs.worked_play_animation_mobile.classList.remove("hide");
          el._refs.worked_play_button.classList.add("vicon-pause");
          el._refs.worked_play_button_mobile.classList.add("vicon-pause");
          el._refs.worked_play_button.classList.remove("vicon-play");
          el._refs.worked_play_button_mobile.classList.remove("vicon-play");
        } else {
          el._refs.worked_play_animation.classList.add("hide");
          el._refs.worked_play_animation_mobile.classList.add("hide");
          el._refs.worked_play_button.classList.remove("vicon-pause");
          el._refs.worked_play_button_mobile.classList.remove("vicon-pause");
          el._refs.worked_play_button.classList.add("vicon-play");
          el._refs.worked_play_button_mobile.classList.add("vicon-play");
        }
      }
    },

    onCreated: function () {
      var el = this;
      eon.createCallback("onClose", el);
      eon.createCallback("onOpen", el);
      eon.createCallback("onTaskUpdated", el);
      // eon.createCallback("onTaskDeleted", el);
      eon.createCallback("onLabelUpdated", el);
      // eon.createCallback("onLabelDeleted", el);
    },
    onRender: function () {
      var el = this;

      // TODO - Check bugs on first landing
      eon.onReady(function () {
        el._init();
      });
    },

  });
</script>