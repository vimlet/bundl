<template>
  <div class="form-rows">
    <div class="form-cols form-grow">
      <eon-variable class="form-label eon-fg0" bind="locale.from" global="true"></eon-variable>
      <div class="plan-range-start dateTimeWrapper form-marginright">
        <div class="form-rows">
          <eon-combo eon-ref="fromDay" filter="true"
            class="from-day plan-range-field day-combo form-marginright form-grow weekday-field" inline="false">
          </eon-combo>

          <eon-date eon-ref="fromTime" class="from-time plan-range-field form-marginright form-grow time-field"
            time="true" date="false" mask="DDMMYYYY" value-format="hh:mm" inline="false">
          </eon-date>
        </div>
      </div>
    </div>

    <div class="form-cols form-grow">
      <eon-variable class="form-label eon-fg0" bind="locale.to" global="true"></eon-variable>
      <div class="plan-range-end dateTimeWrapper form-marginright">
        <div class="form-rows">
          <eon-combo eon-ref="toDay" filter="true"
            class="to-day plan-range-field day-combo form-marginright form-grow weekday-field" inline="false">
          </eon-combo>

          <eon-date eon-ref="toTime" class="to-time plan-range-field form-marginright form-grow time-field" time="true"
            date="false" mask="DDMMYYYY" value-format="hh:mm" inline="false">
          </eon-date>
        </div>
      </div>
    </div>
  </div>

  <div class="plan-range-actions">
    <div eon-ref="delete" class="action-icon delete-icon vicon-bin clickable">
    </div>
  </div>

</template>

<script>
  eon.element("plan-range", {
    style: "plan-range.css",
    parse: true,

    dependencies: [
      "@ui/eon-combo",
      "@ui/eon-date"
    ],
    properties: {
      refs: {
        value: {}
      },
      entry: {
        value: "00:00"
      },
      exit: {
        value: "00:00"
      },
      entryDay: {
        value: 1
      },
      exitDay: {
        value: 1
      },
      dayNode: {
        value: {}
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function _getValue (private)
      getValue: function () {
        return {
          entryRAW: this._refs.fromTime.value,
          exitRAW: this._refs.toTime.value,
          entryWeekday: Number(this._refs.fromDay.value),
          exitWeekday: Number(this._refs.toDay.value)
        }
      },
      // @function clear (private)
      clear: function () {
        this._refs.fromTime.clear();
        this._refs.toTime.clear();
        this._refs.fromDay.clear();
        this._refs.toDay.clear();
      }
    },
    privateFunctions: {
      // @function _setInitialValues (private)
      setInitialValues: function () {
        this._refs.fromTime.value = this.entry ? this.entry : "";
        this._refs.toTime.value = this.exit ? this.exit : "";

        this._refs.fromDay.value = this.entryWeekday ? this.entryWeekday : "";
        this._refs.toDay.value = this.exitWeekday ? this.exitWeekday : "";
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        el._refs.delete.addEventListener("click", function (e) {
          el.dayNode.removeRange(el);
        }, false);
      },
      // @function _setupDateSelectors (private)
      setupDateSelectors: function () {
        var el = this;
        var dayCombos = el.querySelectorAll(".day-combo");
        var combos = el.querySelectorAll(".time-field");

        for (var i = 0; i < dayCombos.length; i++) {
          el._setDayCombo(dayCombos[i]);
        }
      },
      // @function _setDayCombo (private)
      setDayCombo: function (combo) {
        var el = this;
        combo.rangeNode = this;

        // Set constraints
        this._setDayConstraints(combo);
        this._dayConstraintsListener(combo);
      },
      // @function _setTimeField (private)
      setTimeField: function (field) {
        field.rangeNode = this;

        // Set constraints
        this.setTimeConstraints(field);
        // this._constraintsListener(field);
      },
      // @function _setConstraints (private)
      setDayConstraints: function (combo) {
        combo.clearItems();

        if (combo.classList.contains("from-day")) {
          // If from-day
          if (this.firstRange) {
            // Fill with days from the day it belongs to
            this._fillDays(combo, this.entryWeekday - 1, this.entryWeekday);
          } else {
            this._fillDays(combo);
          }
        } else {
          // If to-day
          this._fillDays(combo);
        }
      },
      // @function _setConstraints (private)
      setTimeConstraints: function (field) {
        // Clear field
        field.clear();

        // If from-time
        if (!this.firstRange && field.classList.contains("from-time")) {
          // Get last range "to" values
          var lastRange = this.previousSibling && this.previousSibling.tagName == "WORKDAY-RANGE" ? this.previousSibling : null;

          if (lastRange) {
            // If same weekday
            if (this._refs.fromDay.value == lastRange._refs.toDay.value) {
              // Get last range to-time value
              // Use it as minimum constraint


            } else {
              // Do nothing
            }
          }
        }

        // If to-time
        if (field.classList.contains("to-time")) {
          // If same weekday
          if (this._refs.fromDay.value == this._refs.toDay.value) {
            // Get from-time value
            // Use it as minimum constraint

            // var timeValues = this._getComboTimeValues(this._refs.fromTime.value);
            // this._fillTime(combo, timeValues.hour, timeValues.min);
            // if (this.nextSibling) {
            //   this._addSelectListener(combo, this.nextSibling._refs.fromTime);
            // }
          } else {
            // Do nothing

            // this._fillTime(combo);
            // if (this.nextSibling) {
            //   this._addSelectListener(combo, this.nextSibling._refs.fromTime);
            // }
          }
        }
      },
      // @function _fillDays(private)
      fillDays: function (combo, from, to) {
        var dayItem;

        from = !from ? 0 : from;
        to = !to ? config.weekDays.length : to;

        for (var i = from; i < to; i++) {
          dayItem = document.createElement("eon-item");
          dayItem.value = i + 1;
          dayItem.displayValue = eon.locale.global.weekdays[config.weekDays[i]];
          combo.addItem(dayItem);
        }
      },
      // @function addSelectListener(private)
      addSelectListener: function (combo, dependent) {
        var el = this;
        if (!combo.__onSelected[0]) {
          combo.onSelected(function (item) {
            //   var newValue;
            //   if (el._isLaterThan(item.value, dependent.value)) {
            //     newValue = el._getNextTime(item.value);
            //     if (newValue == "00:00") {
            //       // TODO - Increase day combo too
            //       // el._fillTime(dependent);
            //       // dependent.value = "00:00";
            //     } else {
            //       dependent.value = newValue;
            //     }
            //   }

          });
        }
      },
      // @function _dayConstraintsListener(private)
      dayConstraintsListener: function (combo) {
        var el = this;

        combo.onExpand(function () {
          el._setDayConstraints(combo);
        });
      },
      // @function _timeConstraintsListener(private)
      timeConstraintsListener: function (field) {
        var el = this;

      },
      // @function _isFirstRange(private)
      isFirstRange: function () {
        if (this.isEqualNode(this.dayNode.getFirstRange())) {
          return true;
        }
        return false;
      }
    },
    onTransformed: function () {
      var el = this;
      this._addListeners();

      eon.onReady(function () {
        el._setupDateSelectors();
        el._setInitialValues();
      });
    }
  });
</script>