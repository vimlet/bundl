<template>
  <div class="form-rows eon-sect3">
    <div eon-ref="label" class="plans-day-title form-grow"></div>
    <eon-button eon-ref="add" class="bar-button h1-button form-grow" bind:label="global locale.workspace.plans.add"
      icon="<i class='vicon vicon-add'></i>" design="filled"></eon-button>
  </div>
  <div eon-ref="ranges" class="plan-ranges">
    <eon-loading eon-ref="mask" class="mask plan-day-mask" format="descendant" display="false"></eon-loading>
  </div>
</template>

<script>
  eon.element("plan-day", {
    style: "plan-day.css",
    parse: true,

    dependencies: [
      "@ui/eon-loading",
      "@ui/eon-button",
      "../plan-range"
    ],
    properties: {
      label: {
        value: ""
      },
      idx: {
        value: 0
      },
      ranges: {
        value: 0
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function showMask
      showMask: function () {
        this._refs.mask.classList.add("expanded");
        this._refs.mask.classList.remove("eon-bg1");
        this._refs.mask.show();
      },
      // @function hideMask
      hideMask: function (cb) {
        var el = this;
        this._refs.mask.hide(cb);
      },
      // @function addRange
      addRange: function (range) {
        // Create single range element
        var rangeNode = document.createElement("plan-range");
        rangeNode.dayNode = this;

        rangeNode.entry = range ? range[0] : "09:00";
        rangeNode.exit = range ? range[1] : "17:00";
        rangeNode.entryWeekday = range && range[2] ? range[2] : rangeNode.dayNode.idx;
        rangeNode.exitWeekday = range && range[3] ? range[3] : rangeNode.dayNode.idx;

        this.ranges.push(rangeNode);

        return rangeNode;
      },
      // @function addRange
      addRanges: function (ranges, cb) {
        var el = this;
        var fragment = document.createDocumentFragment();

        for (var i = 0; i < ranges.length; i++) {
          fragment.appendChild(this.addRange(ranges[i]));
        }

        this._refs.ranges.appendChild(fragment);

        eon.onReady(function () {
          el.hideMask(function () {
            el._refs.mask.classList.remove("expanded");
            if (cb) {
              cb();
            }
          });
        });
      },
      // @function removeRange
      removeRange: function (rangeNode) {
        var el = this;
        var index;
        for (var i = 0; i < el.ranges.length; i++) {
          if (rangeNode.isEqualNode(el.ranges[i])) {
            // Remove reference
            index = el.ranges.indexOf(rangeNode);

            if (index > -1) {
              el.ranges.splice(index, 1);
            }

            if (rangeNode.nextSibling) {
              rangeNode.nextSibling.clear();
            }

            // Remove node
            this._refs.ranges.removeChild(rangeNode);
            break;
          }
        }
      },
      // @function getFirstRange
      getFirstRange: function () {
        return this.ranges[0];
      },
      // @function clearRanges (private)
      clearRanges: function () {
        while (this._refs.ranges.lastChild && this._refs.ranges.lastChild.tagName != "EON-LOADING") {
          this._refs.ranges.removeChild(this._refs.ranges.lastChild);
        }

        this.ranges = [];
      }
    },
    privateFunctions: {
      // @function _setupLabel (private)
      setupLabel: function () {
        this._refs.label.innerHTML = eon.locale.global.weekdays[this.label];
      },
      // @function _addRangeListeners (private)
      addRangeListeners: function () {
        var el = this;
        // Add range button listener
        el._refs.add.addEventListener("click", function (e) {
          // Get day values constrained
          var prevRange = el.ranges[el.ranges.length - 1];
          var prevRangeValues = prevRange ? prevRange.getValue() : "";

          if (prevRangeValues) {
            // Add range to day block
            el._refs.ranges.appendChild(el.addRange(["", "", prevRangeValues.exitWeekday, prevRangeValues
              .exitWeekday
            ]));
          } else {
            // Add range to day block
            el._refs.ranges.appendChild(el.addRange(["", ""]));
          }

        }, false);
      }
    },
    onCreated: function () {
      this._setupLabel();
      this._addRangeListeners();
    },
    onInit: function () {
      this.ranges = [];
    }
  });
</script>