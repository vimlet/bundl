<template>
  <div class="notification-row-row">
    <i class='vicon vicon-new-releases notification-row-new'></i>
    <app-avatar eon-ref="avatar"></app-avatar>
    <div class="notification-row-user-name no-selectable" eon-ref="userName"></div>
    <div class="notification-row-elements no-selectable" eon-ref="elements"></div>
    <div class="separator"></div>
    <div class="notification-row-date notification-row-date-pc no-selectable" eon-ref="date"></div>
    <div class="notification-row-date notification-row-date-mobile no-selectable" eon-ref="mobileDate"></div>
    <eon-button class="notification-view-button-hide-text-mobile notification-row-clear"
      icon="<i class='vicon ticon-enter'></i>" bind:label="global locale.notifications.archive" design="outlined"
      eon-ref="clear">
  </div>
  <div class="notification-row-row notification-row-row-mobile">
    <div class="notification-row-elements-mobile no-selectable" eon-ref="elementsMobile"></div>
  </div>
</template>

<script>
  eon.element("notification-row", {
    style: "notification-row.css",
    parse: true,

    dependencies: [
      "@ui/eon-button",
      "@custom/app-avatar",
      "@ui/eon-text"
    ],

    properties: {
      // @html-attribute notification
      notification: {
        value: "",
        observe: true
      },
      // @html-attribute notificationsView
      notificationsView: {
        value: ""
      },
      // @html-attribute taskId
      taskId: {
        value: "",
        observe: true
      }
    },

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function setData (public) [Print data to screen] @param-optional data [If not given previously stored data will be used]
      setData: function (data) {
        var el = this;
        el._refs.avatar.userName = el.notificationsView.workspaceData.members[data.dispatcher].alias;
        el._refs.avatar.image = "/rest/user/avatar/" + data.dispatcher;
        el._refs.avatar.hoverTitle = el.notificationsView.workspaceData.members[data.dispatcher].alias;
        el._refs.userName.innerHTML = el.notificationsView.workspaceData.members[data.dispatcher].alias;
        var fragment = document.createDocumentFragment();
        var fragmentMobile = document.createDocumentFragment();
        for (var i = 0; i < data.data.struct.length; i++) {
          if (data.data.content[data.data.struct[i]]) {
            var element = el._createElement(data.data.struct[i], data.data.content);
            fragment.appendChild(element);
            var elementMobile = el._createElement(data.data.struct[i], data.data.content);
            fragmentMobile.appendChild(elementMobile);
          }
        }
        el._refs.elements.appendChild(fragment);
        el._refs.elementsMobile.appendChild(fragmentMobile);
        var dayMoment = moment.parseZone(new Date(data.date), util.isoFormat);
        el._refs.mobileDate.innerText = dayMoment.format("MM/DD/YYYY");
        el._refs.date.innerText = dayMoment.format("MMMM D dddd hh:mm");
        if (data.status === "read") {
          el.classList.add("notification-row-read");
        } else if (data.status === "cleared") {
          el._refs.clear.classList.add("hide");
        }
      },
      // @function remove (public) [Remove notification from screen]
      remove: function () {
        var el = this;
        el.classList.add("notification-row-remove");
        setTimeout(() => {
          el.parentElement.removeChild(el);
        }, 300);
      }
    },
    privateFunctions: {
      // @function _init (private)
      init: function () {
        var el = this;
        el._setup();
        if (el.notification) {
          el.setData(el.notification);
        }
      },
      // @function _setup (private)
      setup: function () {
        var el = this;
        el.classList.add("grid-row");
        el._addListener();
      },
      // @function _addListener (private)
      addListener: function () {
        var el = this;
        el._refs.clear.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          el._clearNotification();
        });
        el.addEventListener("click", function () {
          if (el.notification.data.onclick) {
            switch (el.notification.type) {
              case "task":
                task.open(el.notification.data.taskId);
                break;
              case "board":
                var url = "/app/projects";
                url = setParameterByName("board", el.notification.data.boardId, url);
                window.location.href = url;
                break;
            }
          }
        });
      },
      // @function _clearNotification (private) [Clear a notification]
      clearNotification: function () {
        var el = this;
        var url = "/rest/notification/" + session.data.currentWorkspaceId + "/" + session.data.id + "/status/" +
          el.notification.id;
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify({
            status: "cleared"
          })
        }, function (error, data) {
          if (!error) {
            popup.displayToast(eon.locale.notifications.archiveSuccess);

            el.remove();
          } else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _createElement (private) [Create notification element] @param elementKey @param content
      createElement: function (elementKey, content) {
        var el = this;
        var element = document.createElement("div");
        element.classList.add("notification-row-element", "notification-row-element-" + content[elementKey].type);
        if (content[elementKey].color) {
          element.style.color = content[elementKey].color;
        }
        switch (content[elementKey].type) {
          case "action":
            element.innerText = eon.locale.notifications.actions[content[elementKey].content];
            break;
          case "user":
            var avi = '<app-avatar user-name="' + el.notificationsView.workspaceData.members[content[elementKey]
                .content]
              .alias + '" image="/rest/user/avatar/' + content[elementKey].content +
              '"></app-avatar><div class="notification-row-user-name no-selectable">' + el.notificationsView
              .workspaceData.members[content[elementKey].content].alias + '</div>';
            element.innerHTML = avi;
            break;
          case "group":
            if(content[elementKey].content) {
              var avi = '<app-avatar icon="ticon-users" user-name="' + el.notificationsView.workspaceData.groups[
                  content[elementKey].content]
                .name + '" image="/rest/user/avatar/' + content[elementKey].content +
                '"></app-avatar><div class="notification-row-user-name no-selectable">' + el.notificationsView
                .workspaceData.groups[content[elementKey].content].name + '</div>';
              element.innerHTML = avi;
            }
            break;
          case "reserved":
            if (content[elementKey].content) {
              switch (content[elementKey].content) {
                case "elapsed":                  
                  element.innerText = eon.locale.notifications.reserved[content[elementKey].content];
                  break;
                case "running":
                  if (content[elementKey].value) {
                    element.innerText = eon.locale.notifications.reserved.workingTrue;
                  } else {
                    element.innerText = eon.locale.notifications.reserved.workingFalse;
                  }
                  break;
                default:
                  element.innerText = eon.locale.notifications.reserved[content[elementKey].content];
                  break;
              }
            } else {
              element.innerText = eon.locale.notifications.reserved.none;
            }
            break;
          case "vicon":
            var icon = document.createElement("i");
            icon.classList.add("vicon", content[elementKey].content);
            element.appendChild(icon);
            break;
          default:
            element.innerText = content[elementKey].content;
            break;
        }
        return element;
      }
    },


    onTransformed: function () {
      var el = this;
      el._init();
    },
    onPropertyChanged: function (key, oldVal, newVal) {
      var el = this;
      switch (key) {
        case "notification":
          el.setData(newVal);
          break;
      }
    }



  });
</script>