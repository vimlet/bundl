<template>
  <!-- <form class="avatar-form" action="/rest/user/avatar/upload" method="post" enctype="multipart/form-data" eon-ref="form"> -->
  <form class="avatar-form" accept="image/jpg, image/png" eon-ref="form">
    <eon-variable class="form-grouptitle eon-fg-h2" bind="locale.user.avatarTitle" global="true"></eon-variable>
    <div class="avatar-form-group info-row">
      <div class="avatar-form-fileUpload form-marginright">
        <input type="file" class="avatar-form-input" name="avatar" eon-ref="fileInput" />
        <eon-button class="avatar-form-browseButton" bind:label="global locale.user.browseButton" design="filled"
          eon-ref="browseButton"></eon-button>
      </div>

      <eon-text class="avatar-form-avatarText" bind:placeholder="global locale.user.avatarPlaceholder" readonly="true"
        name="avatarText" label-anim="false" tooltip="(Max 5MB)" eon-ref="avatarText" inline="false"></eon-text>
    </div>
  </form>
</template>
<script>
  eon.element({
    name: "avatar-form",
    style: "avatar-form.css",
    parse: true,

    properties: {},

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },

    functions: {
      // @function submitAvatar
      submitAvatar: function () {
        if (this._refs.fileInput.value == "") {
          this._refs.avatarText.updateDescription("Required");
          this._refs.avatarText.classList.add("eon-text-error");
        } else {
          // this._refs.form.submit();
          this._sendAvatar();
        }

      },
    },

    privateFunctions: {
      // @function _setListeners (private)
      setListeners: function () {
        var el = this;

        el._refs.fileInput.addEventListener("mouseover", function () {
          el._refs.browseButton.classList.add("hover");
        });
        el._refs.fileInput.addEventListener("mouseleave", function () {
          el._refs.browseButton.classList.remove("hover");
        });
        el._refs.fileInput.addEventListener("mousedown", function () {
          el._refs.browseButton.classList.add("active");
        });
        el._refs.fileInput.addEventListener("mouseup", function () {
          el._refs.browseButton.classList.remove("active");
        });
        el._refs.fileInput.addEventListener("change", function () {
          el._setTextValue(el._refs.fileInput.value.replace(/C:\\fakepath\\/i, ''));
        });
      },

      // @function _setTextValue (private)
      setTextValue: function (value) {
        var el = this;

        el._refs.avatarText.classList.add("eon-text-focus");
        el._refs.avatarText.value = value;
      },

      // @function _sendAvatar (private)
      sendAvatar: function () {
        var el = this;
        var data = new FormData();
        var request = new XMLHttpRequest();

        // console.log(el._refs.fileInput.files[0]);
        data.append("avatar", el._refs.fileInput.files[0]);

        // AJAX request finished
        request.addEventListener('load', function (e) {
          if (request.status >= 200 && request.status < 400) {
            window.location.href = "/app/user";
          } else {
            showInfoDialog(eon.locale.user.alert.avatarFail);
          }
        });

        // If server is sending a JSON response then set JSON response type
        request.responseType = "json";

        // Send POST request to the server side script
        request.open("post", "/rest/user/avatar/upload");
        request.send(data);
      },

    },

    onTransformed: function () {
      this._setListeners();
    },
  });
</script>