<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Tobeio - Register</title>

  <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
  <link rel="manifest" href="manifest.json">
  <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#4b4b4b">
  <meta name="theme-color" content="#ffffff">

  <script>
    var eon = {
      theme: "login-claro",
      importCacheBusting: true,
      themeCacheBusting: true,
      pollyfillCacheBusting: true,
      build: <%= data.release ? true : false %>
    }
  </script>

  <!-- Import eon -->
  <script src="eon/eon-bundle<% data.release ? echo('.' + hash('eon-bundle')) : '' %>.js"></script>

  <script src="js/va-client.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="css/login.css">

  <script>
    var urlParams = new URLSearchParams(window.location.search);
    var inviteToken = urlParams.get("inviteToken");
    var inviteEmail = urlParams.get("inviteEmail");
    var validate = urlParams.get("validate");
    var token = urlParams.get("token");
    var alias = urlParams.get("alias");

    // Load locale
    window.locale = navigator.language.split("-")[0] == "es" ? "es" : "en";
    eon.createCallback("onLocaleLoaded", eon, "ready");
    eon.ajax("util/locale/" + window.locale + ".json", null, function (error, data) {
      if (!error) {
        eon.locale = JSON.parse(data.responseText);
        eon.triggerCallback("onLocaleLoaded", eon, eon, []);
      }
    });

    // Eon elements
    eon.importBuild("register-build<% data.release ? echo('.' + hash('register-build')) : '' %>.js");

    eon.import([
      "eon/ui/eon-form",
      "eon/ui/eon-text",
      "eon/ui/eon-button",
      "eon/ui/eon-dialog",
      "eon/ui/eon-check"
    ]);

    // Add dialog navigation listener
    window.addEventListener("popstate", function (e) {
      if (!e.state || !e.state.dialog) {
        // Close current dialog
        if(window.__privacyDialog) {
          window.__privacyDialog.close();
        }
      }
    });

    function showInfoDialog(content, cb) {
      var dialog = document.querySelector("#alert-dialog");
      eon.locale.alertMessage = content;
      dialog.onClose(function () {
        if (cb) {
          cb()
        }
      });
      dialog.open();
    }

    function showPrivacy() {
      if (!window.__privacyDialog) {
        var dialog = document.createElement("eon-dialog");
        dialog.modal = true;
        dialog.blur = true;
        dialog.closable = false;
        dialog.defaultStyle = false;
        dialog.classList.add("privacyDialog");
        setDialogContent(dialog);
        dialog.onClose(function () {
          document.body.removeChild(dialog);
        });
        // document.body.appendChild(dialog);
        window.__privacyDialog = dialog;
      } else {
        document.body.appendChild(window.__privacyDialog);
      }
      window.__privacyDialog.onReady(function () {
        window.__privacyDialog.open();
        // Push dialog state
        pushDialogState(window.__privacyDialog);
      });
    }

    function pushDialogState(dialog) {
      var url = window.location.href.split("#")[0];
      window.history.pushState({}, null, url + "#dialog");
    }

    function setDialogContent(dialog) {
      var path;
      window.locale = navigator.language.split("-")[0] == "es" ? "es" : "en";
      if (window.locale == "es") {
        path = "privacidad.html";
      } else {
        path = "privacy.html";
      }
      eon.ajax(path, {
        method: "GET",
        contentType: "application/text"
      }, function (error, data) {
        if (!error) {
          // Append content
          var fragment = eon.fragmentFromString(data.responseText);
          dialog.content.appendChild(fragment);
          document.body.appendChild(dialog);
        }
      });
    }

    function validateEmail(inviteEmail) {
      var re = /^(([^<>()\[\]\\.,;:\s@"À-ž]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(inviteEmail.trim()).toLowerCase());
    }

    function getPathParams(mail) {
      mail = mail || $1(".form").querySelector(".register-mail").value;

      var params = mail ? "?email=" + mail : "?";
      params += inviteToken ? "&inviteToken=" + inviteToken : "";
      params += inviteEmail ? "&inviteEmail=" + inviteEmail : "";

      return params;
    }

    function login(username, password) {
      var data = {
        username: username.toLowerCase(),
        password: password
      }

      eon.ajax("/login", {
        method: "POST",
        contentType: "application/json",
        payload: JSON.stringify(data)
      }, function (error, data) {
        if (!error) {
          window.location.href = JSON.parse(data.responseText).location + getPathParams();
        }
      });
    }

    function register() {
      var form = $1(".form");
      var formData = form.getData();
      var schema = {
        properties: {
          "name": {
            required: true
          },
          "username": {
            required: true
          },
          "password": {
            required: true
          },
          "confirmPassword": {
            required: true
          }
        }
      };
      form.validate(schema, null, function (error) {
        var alertText;
        var name = form.querySelector(".register-name");
        var mail = form.querySelector(".register-mail");
        var userPassword = form.querySelector(".register-password");
        var confirmPass = form.querySelector(".register-passwordConfirm");
        // Validate email syntax
        if (mail.value && !validateEmail(formData.username)) {
          error = true;
          mail.invalid = true;
          mail.updateDescription(eon.locale.register.invalidMail);
        } else if(validateEmail(formData.username)){
          mail.invalid = false;
          mail.updateDescription("");
        }
        // Validate password format
        if (formData.password.length < 8) {
          error = true;
          userPassword.invalid = true;
          userPassword.updateDescription(eon.locale.register.wrongPass);
        } else {
          userPassword.invalid = false;
          userPassword.updateDescription("");
        }

        if (formData.confirmPassword.length < 8) {
          error = true;
          confirmPass.invalid = true;
          confirmPass.updateDescription(eon.locale.register.wrongPass);
        } else {
          confirmPass.invalid = false;
          confirmPass.updateDescription("");
        }
        // Validate same passwords
        if (confirmPass.value != userPassword.value) {
          error = true;
          confirmPass.invalid = true;
          confirmPass.updateDescription(eon.locale.register.differentPass);
        }

        formData.userLanguage = window.locale;

        if (!error) {

          eon.ajax("/rest/user", {
            method: "POST",
            contentType: "application/json",
            payload: JSON.stringify(formData)
          }, function (error, data) {

            if (data.status >= 200 && data.status < 400) {

              va.sendEvent("Conversion", "Register", "User Registered");

              login(formData.username, formData.password);

              // TEMP - removed validation to make registration easier
              // var dialog = document.querySelector("#alert-dialog");
              // showInfoDialog(eon.locale.register.error);
              // dialog.onClose(function () {
              // window.location.href = "/app/login.html" + getPathParams(response.mail);
              // });
            } else {
              showInfoDialog(eon.locale.register.fail);
            }
          });
        }
      });
    }

    // INVITE
    eon.onReady(function () {
      var form = $1(".form");

      // Needed since eon element still not ready
      form.onReady(function () {

        if (inviteEmail) {
          var emailField = document.querySelector("[name='username']");
          emailField.value = inviteEmail;
        }
        if (alias) {
          var nameField = document.querySelector("[name='name']");
          nameField.value = alias;
        }
        if (inviteToken && emailField) {
          emailField.readonly = true;
        }

        var check = $1("#privacy-check");
        var button = $1(".register-button");

        check.onCheck(function () {
          button.disabled = false;
        });
        check.onUncheck(function () {
          button.disabled = true;
        });

        // Setup login link href to aware of path params
        var link = $1("#login-link");
        link.href += getPathParams();

        // Make container fit body height fixing MDPI screens issue
        var mainContainer = document.querySelector(".container");
        if (mainContainer.offsetHeight > window.innerHeight) {
          // Fill body height
          mainContainer.style.height = "100%";
          document.body.alignItems = "flex-start";
        }
      });

    });
  </script>
</head>

<body class="notranslate">
  <div class="container">
    <div class="logo"></div>
    <div class="title">
      <eon-variable bind="locale.register.title" global="true"></eon-variable>
    </div>
    <div class="column-wrapper">
      <eon-form class="form">
        <eon-text class="register-name" name="name" bind:placeholder="global locale.register.namePlaceHolder"
          bind:label="global locale.register.name" label-anim="false"></eon-text>
        <eon-text class="register-mail" name="username" bind:placeholder="global locale.login.mailPlaceHolder"
          bind:label="global locale.login.mail" label-anim="false"></eon-text>
        <!-- TODO <eon-text class="register-password" bind:tooltip="global locale.register.wrongPass" name="password" bind:placeholder="global locale.login.passwordPlaceHolder" -->
        <eon-text class="register-password" name="password" bind:placeholder="global locale.login.passwordPlaceHolder"
          bind:label="global locale.login.password" label-anim="false" type="password">
        </eon-text>
        <eon-text class="register-passwordConfirm" name="confirmPassword"
          bind:placeholder="global locale.login.passwordPlaceHolder" bind:label="global locale.register.passConfirm"
          label-anim="false" type="password">
        </eon-text>
        <div class="form-text">
          <eon-variable bind="locale.register.already" global="true"></eon-variable>
          <a id="login-link" href="/app/login.html">
            <eon-variable bind="locale.register.login" global="true"></eon-variable>
          </a>
        </div>
        <div id="privacy">
          <eon-check id="privacy-check"></eon-check>
          <div class="checkLabel">
            <eon-variable bind="locale.register.read" global="true"></eon-variable>
            <eon-variable class="privacyText" bind="locale.register.privacy" global="true" class="privacyPolicy"
              onclick="showPrivacy()">
            </eon-variable>
          </div>
        </div>
        <eon-button class="register-button" disabled="true" bind:label="global locale.register.register"
          onclick="register();"></eon-button>
      </eon-form>
      <div class="separator">
        <div class="separator-bar"></div>
      </div>
      <div class="social">
        <div class="form-text">
          <eon-variable bind="locale.login.social" global="true"></eon-variable>
        </div>
        <eon-button class="social-button"
          label="<span class='google-icon'></span></div><eon-variable bind='locale.login.social-google' global='true'></eon-variable>"
          href="/auth/google"></eon-button>
        <eon-button class="social-button"
          label="<span class='facebook-icon'></span><eon-variable bind='locale.login.social-facebook' global='true'></eon-variable>"
          href="/auth/facebook"></eon-button>
      </div>
    </div>
  </div>
  <eon-dialog id="alert-dialog" modal="true" class="alertDialog" blur="true" closable="false" default-style="false">
    <eon-section type="content">
      <eon-variable class="alert-text" bind="locale.alertMessage" global="true"></eon-variable>
    </eon-section>
    <eon-section type="footer" location="right">
      <eon-button label="OK" design="flat" onclick="document.querySelector('#alert-dialog').close()"></eon-button>
    </eon-section>
  </eon-dialog>
</body>

</html>