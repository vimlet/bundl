<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Tobeio - Change Password</title>

  <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
  <link rel="manifest" href="img/favicon/site.webmanifest">
  <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#4b4b4b">
  <meta name="theme-color" content="#ffffff">

  <script src="eon/eon-bundle.js"></script>
  <link rel="stylesheet" type="text/css" href="css/login.css">
  <script>
    eon.theme = "login-claro";

    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const token = urlParams.get('token');

    if (navigator.language.split("-")[0] == "es") {
      window.locale = "es";
    } else {
      window.locale = "en";
    }

    eon.createCallback("onLocaleLoaded", eon, "ready");

    eon.ajax("util/locale/" + window.locale + ".json", null, function (error, data) {
      if (!error) {
        eon.locale = JSON.parse(data.responseText);
        eon.triggerCallback("onLocaleLoaded", eon, eon, []);
      }
    });
    // Eon elements
    eon.import([
      "eon/ui/eon-form",
      "eon/ui/eon-text",
      "eon/ui/eon-dialog",
      "eon/ui/eon-button",
    ]);

    function showInfoDialog(content, cb) {
      var dialog = document.querySelector("#alert-dialog");

      eon.locale.alertMessage = content;

      dialog.onClose(function () {
        if (cb) {
          cb()
        }
      });

      dialog.open();
    }

    function validateEmail(email) {
      var re = /^(([^<>()\[\]\\.,;:\s@"À-ž]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    }

    function change() {
      var form = $1("#login-form");
      var formData = form.getData();
      var alertText, userName, userPassword, confirmPass;

      var schema = {
        properties: {
          "password": {
            required: true
          },
          "confirmPassword": {
            required: true
          }
        }
      };

      form.validate(schema, null, function (error) {

        userPassword = form.querySelector(".change-password");
        confirmPass = form.querySelector(".change-confirmPassword");

        if (formData.password.length < 8) {
          error = true;
          userPassword.invalid = true;
        } else {
          userPassword.invalid = false;
        }

        if (formData.confirmPassword.length < 8) {
          error = true;
          confirmPass.invalid = true;
        } else {
          confirmPass.invalid = false;
        }

        if (confirmPass.value != userPassword.value) {
          error = true;
          confirmPass.invalid = true;
        }

        if (!error) {

          var userData = {
            newPassword: formData.password
          }

          eon.ajax("/rest/user/recovery/change?email=" + email + "&token=" + token, {
            method: "POST",
            contentType: "application/json",
            payload: JSON.stringify(userData)
          }, function (error, data) {

            var message = (data.status >= 200 && data.status < 400) ? eon.locale.recovery.success : eon.locale.recovery.fail;
            showInfoDialog(message);

            if (!error) {
              window.location.href = "/app/login.html";
            }

          });

        }

      });
    }

  </script>

</head>

<!-- class notraslate necessary to avoid page translation -->

<body class="notranslate">
  <div class="main">
    <div class="loginWrapper register">
      <div class="logoWrapper">
        <div class="loginLogo"></div>
      </div>
      <div class="loginTitle">
        <eon-variable bind="locale.recovery.changeTitle" global="true"></eon-variable>
      </div>
      <eon-form id="login-form">

        <eon-text class="change-password marginRight" bind:label="global locale.register.password" type="password"
          bind:placeholder="global locale.register.passwordPlaceHolder" name="password" inline="false" label-anim="false"></eon-text>

        <eon-text class="change-confirmPassword" bind:label="global locale.register.passConfirm" type="password"
          bind:placeholder="global locale.register.passwordPlaceHolder" name="confirmPassword" inline="false"
          label-anim="false"></eon-text>

        <eon-button class="login-button" design="filled" bind:value="global locale.recovery.change" onclick="change();"
          inline="false"></eon-button>

      </eon-form>
    </div>
  </div>
  <eon-dialog id="alert-dialog" class="alertDialog" modal="true" blur="true" closable="false" default-style="false">
    <eon-section type="content">
      <eon-variable class="alert-text" bind="locale.alertMessage" global="true"></eon-variable>
    </eon-section>
    <eon-section type="footer" location="right">
      <eon-button label="OK" design="flat" onclick="document.querySelector('#alert-dialog').close()"></eon-button>
    </eon-section>
  </eon-dialog>
</body>

</html>