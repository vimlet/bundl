<style>
  app-payment .StripeElement {
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 40px;
    color: #444444;
    background-color: #f9f9f9;
    border-bottom: 1px solid black;
    padding: 10px;
    box-sizing: border-box;
  }

  app-payment .StripeElement--invalid {
    border-color: #fa755a;
  }

  app-payment .StripeElement--webkit-autofill {
    background-color: #fefde5 !important;
  }

  /* app-payment .app-payment-card-focus .app-payment-card-underline:before,
  app-payment .app-payment-card-focus .app-payment-card-underline:after {
    width: 50% !important;
  } */

  app-payment .app-payment-card-label {
    color: #9a1ae9;
    font-size: 15px;
    /* -webkit-transition: 0.3s ease all;
    -moz-transition: 0.3s ease all;
    transition: 0.3s ease all; */
  }

  /* app-payment .app-payment-card-focus .app-payment-card-label {
    color: #57cde3;
  } */

  app-payment .app-payment-card-underline {
    position: relative;
    display: block;
    width: auto;
  }

  app-payment .app-payment-card-underline:before,
  app-payment .app-payment-card-underline:after {
    position: absolute;
    background-color: #9a1ae9;
    bottom: 0px;
    width: 0;
    height: 2px;
    content: "";
    -webkit-transition: 0.5s ease all;
    -moz-transition: 0.5s ease all;
    transition: 0.5s ease all;
  }

  app-payment .app-payment-card-underline:before {
    left: 50%;
  }

  app-payment .app-payment-card-underline:after {
    right: 50%;
  }
</style>

<template>

  <div eon-ref="wrapper" class="app-payment-card">
    <!-- USE EON LOCALE -->
    <label eon-ref="label" class="app-payment-card-label"></label>
    <div eon-ref="element" class="app-payment-card-element"></div>
    <div class="app-payment-card-underline"></div>
    <div eon-ref="errors" class="app-payment-card-errors" role="alert"></div>
  </div>

</template>

<script>
  eon.element({
    name: "app-payment",
    properties: {
      "pk": "pk_test_ztQrY3Ces8qhqHtlBezu8Z3C00E34Kl5k8"
    },
    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function createPaymentMethod (public)
      createPaymentMethod: function (formData) {
        var el = this;
        // Make sure Stripe is ready
        app.stripeReady(function(){
          el._refs.stripe.createPaymentMethod("card", el._misc.card, {
            billing_details: {
              name: formData.name,
              email: formData.email
            },
          }).then(function (result) {
            if (result.error) {
              var errorElement = document.querySelector(".app-payment-card-errors");
              errorElement.textContent = result.error.message;
            } else {
              // TODO Send
              console.dir(result);
            }
          });
        });
      }
    },
    privateFunctions: {
      // @function refresh (private)
      setupStripeElements: function () {
        var el = this;

        el._refs.stripe = Stripe(el.pk);
        var elements = el._refs.stripe.elements();
        var card = elements.create("card");
        el._refs.label.innerHTML = eon.locale.workspace.fields.card;

        card.mount(el._refs.element);

        card.addEventListener("focus", function (event) {
          el._refs.wrapper.classList.add("app-payment-card-focus");
        });

        card.addEventListener("blur", function (event) {
          el._refs.wrapper.classList.remove("app-payment-card-focus");
        });

        card.addEventListener("change", function (event) {
          var displayError = el._refs.errors;
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = "";
          }
        });
        el._misc.card = card;
      }
    },
    onTransformed: function () {
      var el = this;
      
      app.stripeReady(function(){
        el._setupStripeElements();
      });

      // Import stripe API
      util.importStripeAPI();
    }
  });
</script>