<template>


</template>

<script>
  eon.element({
    name: "selector-groups",
    dependencies: [
    ],
    properties: {

    },
    privateProperties: {
      /*
        @property (private) {Object} _misc
        @description Object with useful information
      */
      misc: {
        value: {},
        reflect: false
      },
      /*
        @property (private) {Object} _refs
        @description Object with references to frequently queried nodes
      */
      refs: {
        value: {},
        reflect: false
      }
    },
    functions: {
      // @function refresh (public) [Create checkboxes for groups] @param workspace 
      refresh: function (data, checked) {
        var el = this;

        if (el._refs.selector.groupSelector && eon.util.isTrue(el._refs.selector.groupSelector)) {
          el.innerHTML = "";
          var groups = data.groups;
          var fragment = document.createDocumentFragment();
          checked = el._refs.selector._misc.groupsChecked && el._refs.selector._misc.groupsChecked.length > 0 ? el._refs.selector._misc.groupsChecked : checked;

          for (var key in groups) {
            var entry = groups[key];
            if (entry) {
              var checkbox = document.createElement("eon-check");
              checkbox.value = key;
              checkbox.label = entry.name;

              if ((checked && checked.indexOf(key) > -1 || el._refs.selector._refs.allGroupsCheckbox.checked) && !el._refs.selector._misc.allGroupsUncheck) {
                checkbox.checked = true;
              }

              checkbox.onCheck(function () {
                if (el._refs.selector._misc.set && !el._refs.selector._misc.clearing) {

                  for (var i = 0; i < el._refs.selector._misc.groupsChecked.length; i++) {
                    if (el._refs.selector._misc.groupsChecked[i] == this.value) {
                      el._misc.indexExit = true;
                    }
                  };

                  // Trigger check a single group
                  if (!el._refs.selector._refs.allGroupsCheckbox.checked && !el._misc.indexExit) {
                    el._refs.selector._misc.allGroupsUncheck = false;
                    eon.triggerCallback("onChange", el, el, [this]);
                  }

                  el._misc.indexExit = false;
                }
              });

              checkbox.onUncheck(function () {
                if (el._refs.selector._misc.set && !el._refs.selector._misc.clearing) {
                  // Trigger uncheck a single group functionality when all groups is toggle
                  if (el._refs.selector._refs.allGroupsCheckbox.checked) {
                    el._misc.uncheckedSingle = true;
                    el._refs.selector._misc.allGroupsUncheck = false;
                    el._refs.selector._refs.allGroupsCheckbox.checked = false;
                    eon.triggerCallback("onChange", el, el, [this]);
                  } else if (el._refs.selector._misc.allGroupsUncheck) {
                    // Do nothing. Triggers uncheck all groups but in app-user-selector

                    // Trigger uncheck a group functionality when all groups is NOT toggle
                  } else {
                    el._misc.uncheckedSingle = true;
                    el._refs.selector._misc.allGroupsUncheck = false;
                    eon.triggerCallback("onChange", el, el, [this]);
                  }
                }
              });

              el._refs.selector._misc.groupsChecks.push(checkbox);

              var block = document.createElement("div");
              block.classList.add("member-selector-form-userBlock")

              if (el._refs.selector.avatar && eon.util.isTrue(el._refs.selector.avatar)) {
                var avi = document.createElement("app-avatar");
                avi.userName = entry.name;
                avi.icon = "ticon-users";
                block.appendChild(avi);
              }

              block.appendChild(checkbox);
              fragment.appendChild(block);
            }
          }

          if (groups && Object.keys(groups).length === 0 || !groups) {
            if (!el._refs.placeHolder) {
              el._refs.placeHolder = createPlaceHolderText(eon.locale.global.emptyGroups);
            }
            el._refs.placeHolder.classList.remove("hide");
            fragment.appendChild(el._refs.placeHolder);
          } else if (el._refs.placeHolder) {
            // Remove place holder
            el._refs.placeHolder.classList.add("hide");
          }
          el.appendChild(fragment);
        }
      }
    },
    privateFunctions: {
      setupRefs: function () {
        var el = this;
        el._refs.scroll = el.getEnclosingComponent();
        el._refs.selector = el._refs.scroll.getEnclosingComponent();
      },
    },
    onCreated: function () {
      var el = this;
      eon.createCallback("onChange", el);
    },

    onTransformed: function () {
      var el = this;

      el._misc.uncheckedSingle = false;
      el._misc.indexExit = false;
      el._setupRefs();
    }
  });
</script>