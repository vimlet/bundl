<template>


</template>

<script>
  eon.element({
    name: "selector-users",
    dependencies: [
    ],
    properties: {

    },
    privateProperties: {
      /*
        @property (private) {Object} _misc
        @description Object with useful information
      */
      misc: {
        value: {},
        reflect: false
      },
      /*
        @property (private) {Object} _refs
        @description Object with references to frequently queried nodes
      */
      refs: {
        value: {},
        reflect: false
      }
    },
    functions: {
      // @function refresh (public) [Create checkboxes for members] @param workspace @param-optional checked [Members who should be checked] @param-optional groupsChecked [Groups who should be checked]
      refresh: function (data, checked) {
        var el = this;
        el.innerHTML = "";
        var members = data.members;
        var fragment = document.createDocumentFragment();
        checked = el._refs.selector._misc.membersChecked && el._refs.selector._misc.membersChecked.length > 0 ? el._refs.selector._misc.membersChecked : checked;

        for (var key in members) {
          var entry = members[key];
          if (entry) {
            var checkbox = document.createElement("eon-check");
            checkbox.value = key;
            checkbox.label = entry.alias;
            if (entry.owner) {
              // Owner
              checkbox.label += "<span class='owner-span position-reset'> (owner)</span>";
              checkbox.classList.add("owner-check");
            }
            if ((checked && checked.indexOf(key) > -1 || el._refs.selector._refs.allUsersCheckbox.checked) && !el._refs.selector._misc.allMembersUncheck) {
              checkbox.checked = true;
            }

            checkbox.onCheck(function () {
              if (el._refs.selector._misc.set && !el._refs.selector._misc.clearing) {

                for (var i = 0; i < el._refs.selector._misc.membersChecked.length; i++) {

                  if (el._refs.selector._misc.membersChecked[i] == this.value) {
                    el._misc.indexExit = true;
                  }
                };

                // Trigger check a single member
                if (!el._refs.selector._refs.allUsersCheckbox.checked && !el._misc.indexExit) {
                  el._refs.selector._misc.allMembersUncheck = false;
                  eon.triggerCallback("onChange", el, el, [this]);
                }
                el._misc.indexExit = false;
              }
            });
            checkbox.onUncheck(function () {
              if (el._refs.selector._misc.set && !el._refs.selector._misc.clearing) {
                // Trigger uncheck a single member functionality when all users is toggle
                if (el._refs.selector._refs.allUsersCheckbox.checked) {
                  el._misc.uncheckedSingle = true;
                  el._refs.selector._misc.allMembersUncheck = false;
                  el._refs.selector._refs.allUsersCheckbox.checked = false;
                  eon.triggerCallback("onChange", el, el, [this]);
                } else if (el._refs.selector._misc.allMembersUncheck && !el._refs.selector._refs.allUsersCheckbox.checked) {
                  // Do nothing. Triggers uncheck all members but in app-user-selector

                  // Trigger uncheck a member functionality when all users is NOT toggle
                } else {
                  el._misc.uncheckedSingle = true;
                  el._refs.selector._misc.allMembersUncheck = false;
                  eon.triggerCallback("onChange", el, el, [this]);
                }
              }
            });

            el._refs.selector._misc.usersChecks.push(checkbox);

            var block = document.createElement("div");
            block.classList.add("member-selector-form-userBlock")

            if (el._refs.selector.avatar && eon.util.isTrue(el._refs.selector.avatar)) {
              var avi = document.createElement("app-avatar");
              avi.userName = entry.alias;
              avi.image = "/rest/user/avatar/" + key;
              block.appendChild(avi);
            }
            block.appendChild(checkbox);
            fragment.appendChild(block);
          }
        }

        el.appendChild(fragment);


        setTimeout(function () {
          el._refs.selector._misc.set = true;
        }, 0);
      }
    },
    privateFunctions: {
      setupRefs: function () {
        var el = this;
        el._refs.scroll = el.getEnclosingComponent();
        el._refs.selector = el._refs.scroll.getEnclosingComponent();
      },
    },
    onCreated: function () {
      var el = this;
      eon.createCallback("onChange", el);
    },

    onTransformed: function () {
      var el = this;

      el._misc.uncheckedSingle = false;
      el._misc.indexExit = false;
      el._setupRefs();
    }
  });
</script>