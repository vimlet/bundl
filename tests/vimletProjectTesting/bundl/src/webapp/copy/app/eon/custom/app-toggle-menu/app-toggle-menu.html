<template>
  <div class="app-toggle-menu" eon-ref="container">
    <div class="app-toggle-menu-button" eon-ref="button">
      <div class="app-toggle-menu-title" eon-ref="label"></div>
      <div class="app-toggle-menu-separator hide" eon-ref="buttonSeparator"></div>
      <i class="app-toggle-menu-icon ticon eon-fg2-hoverable clickable" eon-ref="icon"></i>
    </div>

    <div class="app-toggle-menu-content app-toggle-menu-button-content-index" eon-ref="content">
      <div class="app-toggle-menu-no-scroll" eon-ref="noScrollContent"></div>
      <eon-scroll thickness="8" static="true" eon-ref="scroll">
        <div class="app-toggle-menu-content-padding" eon-ref="insertContent"></div>
      </eon-scroll>
    </div>

  </div>
  <div class="app-toggle-menu-overlay hide" eon-ref="overlay"></div>
</template>

<script>
  eon.element("app-toggle-menu", {
    style: "app-toggle-menu.css",
    themed: false,
    dependencies: ["@ui/eon-overlay", "@ui/eon-scroll"],

    properties: {
      // @html-attribute label
      label: {
        value: "",
        reflect: true
      },
      // @html-attribute icon
      icon: {
        value: "vicon-chevron-down",
      },
      // @html-attribute buttonFullWidth
      buttonFullWidth: {
        value: "true",
        reflect: true
      },
      // @html-attribute contentFullWidth
      contentFullWidth: {
        value: "true",
        reflect: true
      },
      // @html-attribute anchor [Top corner of expandable div position. It can be: "left" or "right", any other will anchor it to center]
      anchor: {
        value: "right",
        reflect: true
      },
      // @html-attribute anchor []
      position: {
        value: "bottom",
        reflect: true
      },
      // @html-attribute duration []
      duration: {
        value: 200
      },
      // @html-attribute hiddenMenu [Toggle menu has no button neither label. Default false]
      hiddenMenu: {
        value: "false"
      },
      // @html-attribute status [Status of the dropdown: opened/closed]
      status: {
        value: "closed"
      },
      // @html-attribute contentClass [Classes added to content separated by ","]
      contentClass: {
        value: "",
        reflect: true
      },
      // @html-attribute layout [element selector which must contain app-toggle-menu]
      layout: {
        value: "",
        observe: true
      },
      // @html-attribute layoutHeight [Element after which the menu should open]
      layoutHeight: {
        value: ""
      },
      // @html-attribute margin [Extra space to be applied when positioning the menu]
      margin: {
        value: 0
      }
    },

    privateProperties: {
      ref: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function setTitle (public) [Set up title] @param title
      setTitle: function (title) {
        var el = this;
        el._refs.label.innerText = title;
      },
      // @function addItem (public) [Add item to content] @param item
      addItem: function (item) {
        var el = this;
        el._refs.insertContent.appendChild(item);
      },
      // @function addFixedItem (public) [Add fixed item] @param item
      addFixedItem: function (item) {
        var el = this;
        el._refs.noScrollContent.appendChild(item);
      },
      // @function clear (public) [Empty content]
      clear: function () {
        var el = this;
        el._refs.insertContent.innerHTML = "";
      },
      // @function close (public) [Close if opened] @param event
      close: function (event) {
        var el = this;
        if (el.status === "opened") {
          // el._refs.content.classList.remove("app-toggle-menu-scroll");
          el._refs.content.classList.remove("app-toggle-menu-content-show");
          el._refs.content.style.top = "unset";
          el._refs.content.style.left = "unset";
          el._refs.content.style.right = "unset";
          el._refs.container.appendChild(el._refs.content);
          el._refs.eonOverlay.parentElement.removeChild(el._refs.eonOverlay);
          el.status = "closed";
          eon.triggerCallback("onClose", el, el);
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
        }
      },
      // @function open (public) [Open if closed]
      open: function () {
        var el = this;
        // el._refs.content.classList.add("app-toggle-menu-scroll");
        el._refs.content.classList.add("app-toggle-menu-content-show");
        el._setOverlay();
        el.status = "opened";
        eon.triggerCallback("onOpen", el, el);
      },
      // @function setContentClass (public) [Set classes of content]
      setContentClass: function (value) {
        var el = this;
        var classes = value.split(",");
        el._refs.content.classList.add(classes);
      }
    },

    privateFunctions: {
      // @function init (private)
      init: function () {
        var el = this;
        el._refs.icon.classList.add(el.icon);
        el._setUp();
      },
      // @function setUp (private)
      setUp: function (value) {
        var el = this;
        el._updateLayout(el.layout);

        el._addListeners();
        if (el.label && el.label != "") {
          el.setTitle(el.label);
        }
        if (el.contentClass && el.contentClass != "") {
          el.setContentClass(el.contentClass);
        }
        if (eon.util.isTrue(el.buttonFullWidth)) {
          el._refs.buttonSeparator.classList.remove("hide");
        }
        if (eon.util.isTrue(el.contentFullWidth)) {
          el._refs.content.classList.add("full-width");
        }
        if (eon.util.isTrue(el.hiddenMenu)) {
          el._hideMenu();
        }
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        el._refs.button.addEventListener("click", function (e) {
          if (el.status === "opened") {
            el.close(e);
          } else {
            el.open();
          }
          e.preventDefault();
          e.stopPropagation();
        });
        el._refs.content.addEventListener("click", function (event) {
          event.preventDefault();
          event.stopPropagation();
        });
      },
      // @function _setOverlay (private)
      setOverlay: function () {
        var el = this;
        eon.triggerCallback("onOpen", el, el);
        el._refs.eonOverlay = el.generateOverlayNode();
        el._refs.eonOverlay.classList.add("app-toggle-menu-eon-overlay");
        el._refs.eonOverlay.addEventListener("click", function (e) {
          el.close(e);
        });
        eon.triggerCallback("onEonOverlay", el, el, [el._refs.eonOverlay]);
        if (window.innerWidth <= eon.tabletWidth) {
          el._refs.content.style.top = "auto";
          el._refs.content.style.left = "auto";
          el._refs.content.classList.add("app-toggle-menu-content-mobile");
        } else {
          el._refs.content.classList.remove("app-toggle-menu-content-mobile");
          var buttonLayout = el.layoutHeight || el._refs.button;
          var buttonRect = buttonLayout.getBoundingClientRect();
          if (eon.util.isTrue(el.hiddenMenu)) {
            buttonRect = el.layoutHeight ? el.layoutHeight.getBoundingClientRect() : el.getBoundingClientRect();
          }
          var top = buttonRect.top + buttonLayout.clientHeight;
          el._refs.content.style.top = top + "px";
          setTimeout(() => {
            var bottomEdge = top + el._refs.content.offsetHeight;
            var screenHeight = document.documentElement.clientHeight || window.innerHeight;
            var overflowBottom = bottomEdge - screenHeight;
            if (overflowBottom > 0) {
              el._refs.content.style.top = top - overflowBottom + "px";
            }
          }, 0);
          var layout = el.layout ? el._ref.layout ? el._ref.layout : el.layout : el.parentElement;
          if (el.anchor === "left") {
            var left = buttonRect.left;
            setTimeout(function () {
              var space = layout.getBoundingClientRect().right - left;
              var extra = space - el._refs.content.offsetWidth;
              if (extra < 0) {
                left += extra;
              }
              el._refs.content.style.left = left + "px";
            }, 0);
          } else if (el.anchor === "right") {
            var right = window.innerWidth - buttonRect.right - (buttonRect.width / 2);
            var diff = layout.getBoundingClientRect().left - el._refs.content
              .getBoundingClientRect().left;
            if (diff > 0) {
              right -= diff;
            }
            el._refs.content.style.right = right + "px";
          }

          if (el.position == "top") {
            top = buttonRect.top - buttonLayout.clientHeight;
            top -= Number(el.margin);
            el._refs.content.style.top = top + "px";
          }
        }
        el._refs.eonOverlay.appendChild(el._refs.content);
        document.body.appendChild(el._refs.eonOverlay);
      },
      // @function _setContent (private) [Set content on start if any]
      setContent: function () {
        var el = this;
        var fixedFragment = document.createDocumentFragment();
        var fragment = document.createDocumentFragment();
        var srcNodes = el.getSourceElements();
        while (srcNodes.length) {
          var current = srcNodes.shift();
          if(current.classList.contains("app-toggle-menu-fixed")){
            fixedFragment.appendChild(current);
          }else{
          fragment.appendChild(current);
          }
        }
        el.addFixedItem(fixedFragment);
        el.addItem(fragment);
      },
      // @function _hideMenu (private) [Hide menu from toggle]
      hideMenu: function () {
        var el = this;
        el._refs.button.classList.add("hide");
        el._refs.content.classList.add("noTop");
      },
      // @function _updateLayout (private) []
      updateLayout: function (node) {
        var el = this;
        if (node && !node.nodeType) {
          el._ref.layout = document.querySelector(node);
        } else {
          el._ref.layout = node;
        }
      }
    },

    onCreated: function () {
      var el = this;
      eon.createCallback("onClose", el);
      eon.createCallback("onOpen", el);
      eon.createCallback("onEonOverlay", el);
    },
    onRender: function () {
      var el = this;
      el._setContent();
      el._init();
    },

    onPropertyChanged: function (key, oldVal, newVal) {
      var el = this;
      switch (key) {
        case "label":
          el.setTitle(newVal);
          break;
        case "contentClass":
          el.setContentClass(newVal);
          break;
        case "layout":
          el._updateLayout(newVal);
          break;
      }
    }

  });
</script>