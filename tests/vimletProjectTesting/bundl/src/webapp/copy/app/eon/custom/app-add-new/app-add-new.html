<template>
  <div class="app-add-new-title" eon-ref="label">
  </div>
  <div class="app-add-new-action app-add-new-hide" eon-ref="addAction">
    <eon-text label-anim="false" inline="false" eon-ref="addName">
    </eon-text>
    <div class="app-add-new-action-buttons">
      <eon-button bind:label="global locale.global.add" design="filled" eon-ref="addAccept">
      </eon-button>
      <eon-button bind:label="global locale.global.cancel" design="filled" eon-ref="addCancel">
      </eon-button>
    </div>
  </div>
</template>

<script>
  eon.element("app-add-new", {
    style: "app-add-new.css",
    dependencies: [
      "@ui/eon-button",
      "@ui/eon-text"
    ],

    properties: {
      // @html-attribute label (public) [Label if any]
      label: {
        value: "",
        reflect: true
      },
      // @html-attribute placeholder (public) [Placeholder if any]
      placeholder: {
        value: "",
        reflect: true
      },
      // @html-attribute expandable (public) [Element expands on click by default. Prevent this behavior will only trigger on click]
      expandable: {
        value: "true"
      },
      // @html-attribute closeOnEmpty (public) [If empty when accept close. Default false]
      closeOnEmpty: {
        value: "false"
      }
    },
    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function setLabel (public) [Set up label] @param label
      setLabel: function (label) {
        var el = this;        
        var fragment = document.createDocumentFragment();
        var icon = document.createElement("i");
        icon.classList.add("vicon", "vicon-add");
        fragment.appendChild(icon);
        var titleEl = document.createElement("eon-variable");
        titleEl.classList.add("title-row-title");
        titleEl.setAttribute("global", true);
        titleEl.setAttribute("bind", label);
        fragment.appendChild(titleEl);
        el._refs.label.innerHTML = "";
        el._refs.label.appendChild(fragment);
      },
      // @function expand (public) [Expand to add new]
      expand: function () {
        var el = this;
        if (eon.util.isTrue(el.expandable)) {
          el.clear();
          el.classList.add("app-add-new-extended");
          el._refs.label.classList.add("app-add-new-hide");
          el._refs.addAction.classList.remove("app-add-new-hide");
          el._refs.addName.focus();
        }
      },
      // @function closeNewList (public) [Close add new]
      close: function () {
        var el = this;
        el.classList.remove("app-add-new-extended");
        el._refs.label.classList.remove("app-add-new-hide");
        el._refs.addAction.classList.add("app-add-new-hide");
      },
      // @function focus (public) [Set focus]
      focus: function () {
        var el = this;
        setTimeout(function () {
          el.expand();
          setTimeout(function () {
            el._refs.addName.focus();
          }, 0);
        }, 100);
      },
      // @function clear (public) [Empty value]
      clear: function () {
        var el = this;
        el._refs.addName.invalid = false;
        el._refs.addName.value = "";
      }
    },

    privateFunctions: {
      // @function _init (private)
      init: function () {
        var el = this;
        el._setUp();
      },
      // @function setUp (private)
      setUp: function (value) {
        var el = this;
        if (el.placeholder && el.placeholder != "") {
          el._refs.addName.onReady(function () {
            el._refs.addName.placeholder = el.placeholder;
          });
        }
        if (el.label && el.label != "") {          
          el.setLabel(el.label);
        }
        el._addListeners();
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        el._refs.label.addEventListener("click", function () {
          el.expand();
        });
        el._refs.addAccept.addEventListener("click", function (e) {
          el._misc.triggerAddButton = true;
          setTimeout(function () {
            el._misc.triggerAddButton = false;
          }, 150);
          if (!el._refs.addName.value || el._refs.addName.value == "") {
            if (eon.util.isTrue(el.closeOnEmpty)) {
              el.close();
            } else {
              el._refs.addName.invalid = true;
              el._refs.addName.focus();
            }
          } else {
            eon.triggerCallback("onSubmit", el, el, [el._refs.addName.value]);
            el.close();
            e.stopPropagation();
          }
        });
        el._refs.addCancel.addEventListener("click", function (e) {
          el._misc.triggerAddButton = true;
          eon.triggerCallback("onClick", el, el);
          setTimeout(function () {
            el._misc.triggerAddButton = false;
          }, 150);
          el.close();
          e.stopPropagation();
        });
        el._refs.addName.onBlur(function () {
          setTimeout(function () {
            if (!el._misc.triggerAddButton) {
              if (!el._refs.addName.value || el._refs.addName
                .value ==
                "") {
                el.close();
              }
            }
          }, 100);
        });
        el._refs.addName.addEventListener("keydown", function (event) {
          if (event.isComposing || event.keyCode === 229) {
            return;
          } else if (event.keyCode === 13) {
            if (!el._refs.addName.value || el._refs.addName.value == "") {
              if (eon.util.isTrue(el.closeOnEmpty)) {
                el.close();
              } else {
                el._refs.addName.invalid = true;
                el._refs.addName.focus();
              }
            } else {
              eon.triggerCallback("onSubmit", el, el, [el._refs.addName.value]);
              el.close();
            }
          }
        });
      }
    },


    onCreated: function () {
      var el = this;
      eon.createCallback("onSubmit", el);
      eon.createCallback("onClick", el);
    },

    onRender: function () {
      var el = this;
      el._init();
    },
    onPropertyChanged: function (key, oldVal, newVal) {
      var el = this;
      switch (key) {
        case "label":
          el.setLabel(newVal);
          break;
      }
    }


  });
</script>