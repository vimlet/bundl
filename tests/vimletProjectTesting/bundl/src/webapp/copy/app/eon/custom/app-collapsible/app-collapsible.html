<template>

</template>

<script>
  eon.element("app-collapsible", {

    style: "app-collapsible.css",
    // themed: true,
    dependencies: [
      "@ui/eon-section"
    ],

    properties: {
      /*
        @property {String} heightGoal 
        @description Toggle animation size goal
      */
      heightGoal: {
        value: 100,
        reflect: true
      },
      /*
        @property {String} easing 
        @description Toggle animation type
      */
      easing: {
        value: "ease",
        reflect: true
      },
      /*
        @property {String} duration 
        @description 
      */
      duration: {
        value: 500,
        reflect: true
      },
      /*
        @property {String} headerClick 
        @description 
      */
      headerClick: {
        value: false,
        reflect: true
      },
      /*
        @property {String} preventClickNodes 
        @description 
      */
      preventClickNodes: {
        value: [],
        reflect: true
      },
      /*
        @property {String} content 
        @description 
      */
      content: {
        value: {},
        reflect: true
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function getChildrenHeight
      setChildrenBasedHeight: function (count, size, static) {
        static = !static ? 0 : static;
        this.heightGoal = (count * size) + static;
      },
      // @function setValues
      setValues: function (data) {
        // ** TEMP
        if (!data) {
          this._refs.total.innerHTML = "38 / 40";
          this._refs.average.innerHTML = "6 / 8";
          this._refs.extra.innerHTML = "12";
        }
      },
      // @function toggle
      toggle: function (data) {
        if (!this._misc.opened) {
          this._misc.reverse = false;
          this._refs.content.classList.add("collapsible-open");
          this._refs.collapsibleIcon.classList.remove("vicon-chevron-down");
          this._refs.collapsibleIcon.classList.add("vicon-chevron-up");
          // Cancel animation on mobile devices
          if (!eon.util.isTouchScreen()) {
            this._animate();
          } else {
            this._refs.content.style.height = this.heightGoal + "px";
          }
          this._misc.opened = true;
        } else {
          this._misc.reverse = true;
          this._refs.content.classList.remove("collapsible-open");
          this._refs.collapsibleIcon.classList.remove("vicon-chevron-up");
          this._refs.collapsibleIcon.classList.add("vicon-chevron-down");
          this._animate();
          // Cancel animation on mobile devices
          if (!eon.util.isTouchScreen()) {
            this._animate();
          } else {
            this._refs.content.style.height = 0 + "px";
          }
          this._misc.opened = false;
        }
      },
      // @function disableToggle
      disableToggle: function () {
        this._refs.collapsibleIcon.classList.add("app-collapsible-disabled");
      }
    },
    privateFunctions: {
      // @function _setupRefs (private)
      setupRefs: function () {
        this._refs.header = this.source.querySelector("[type='header']");
        this._refs.content = this.source.querySelector("[type='content']");
        this.content = this._refs.content;
      },
      // @function _setupFoldable (private)
      setupFoldable: function () {
        this.preventClickNodes = this._formatArrayProperty(this.preventClickNodes);
        this._createActionNodes();
        this._setupToggleAnimation();
        this._setupPointerListeners();
      },
      // @function _createActionNodes (private)
      createActionNodes: function () {
        this._refs.collapsibleIcon = document.createElement("div");
        this._refs.collapsibleIcon.classList.add("app-collapsible-expand", "vicon", "vicon-chevron-down", "eon-fg2-hoverable", "clickable");
        this._refs.header.appendChild(this._refs.collapsibleIcon);
      },
      // @function _setupToggleAnimation (private)
      setupToggleAnimation: function () {
        var el = this;
        var currentTime, remaining, rate;
        // Load animation function
        el._misc.animFunction = function () {
          // Get animation progress
          currentTime = +new Date();
          remaining = (el._misc.endTime - currentTime);
          // Get animation progress rate
          rate = el._runEffect(remaining / el.duration);
          // Get animation progress rate applying effects
          cancel = el._runAnimation(rate);
          if (!cancel) {
            window.requestAnimationFrame(el._misc.animFunction);
          }
        }
      },
      // @function _setupPointerListeners (private)
      setupPointerListeners: function () {
        var el = this;
        var clickable = el._refs.collapsibleIcon;
        var toggle = true;
        var elms;

        if (eon.util.isTrue(el.headerClick)) {
          clickable = el._refs.header;
        }

        clickable.addEventListener("click", function (e) {
          // Monitor nodes not able to toggle collapsible functionality
          for (var i = 0; i < el.preventClickNodes.length; i++) {
            elms = document.querySelectorAll(el.preventClickNodes[i]);
            if (elms[1]) {
              // Multiple selector result nodes
              for (var j = 0; j < elms.length; j++) {
                if (elms[j].isEqualNode(e.target)) {
                  toggle = false;
                  break;
                }
              }
            // Single selector result node
            } else if (elms[0] && elms[0].isEqualNode(e.target)) {
              toggle = false;
            }
          }

          if(toggle) {
            // Close menu
            if (el._refs.content.classList.contains("collapsible-open")) {
              eon.triggerCallback("onShrink", el, el);
              el.toggle();
            } else {
              // Open menu
              eon.triggerCallback("onExpand", el, el);
              el.toggle();
            }
          }

          toggle = true;
        });
      },
      // @function _animate (private)
      animate: function () {
        var cancel = false;
        // Stop previous running animations
        window.cancelAnimationFrame(this._misc.animFunction);
        // Increase proportionally the duration on partial animations
        this._misc.endTime = +new Date() + this.duration;
        // Start animation function loop
        this._misc.animFunction();
      },
      // @function _runAnimation (private)
      runAnimation: function (rate) {
        var goal = this._misc.reverse ? 0 : this.heightGoal;
        rate = this._misc.reverse ? 1 - rate : rate;
        var condition = this._misc.reverse ? this._refs.content.offsetHeight <= goal :
          this._refs.content.offsetHeight >= goal;
        // Check goal status            
        if (condition) {
          // Stop animation
          window.cancelAnimationFrame(this._misc.animFunction);
          // Make sure the specified height value has been reached
          this._refs.content.style.height = goal + "px";
          return "cancel";
        } else {
          // Continue animation
          this._refs.content.style.height = (rate * this.heightGoal) + "px";
        }
      },
      // @function _runEffect (private)
      runEffect: function (rate) {
        // Check loader selected effect
        switch (this.easing) {
          case "linear":
            // -- LINEAR FORMULA --
            rate = 1 - rate;
            break;
          case "ease":
            // -- EASING FORMULA --
            rate = 1 - Math.pow(rate, 4);
            break;
        }
        return rate;
      },
      /*
        @function {Array} (private) _formatArrayProperty
        @description Format array property
        @return {Array} [Property value as array]
      */
      formatArrayProperty: function (prop) {
        var el = this;
        // ** TODO - make it global (used on eon-drawer too)

        // Check preventClose property value
        if (typeof prop == "string") {
          // Convert value into an array
          prop = el._getValueAsArray(prop);
        }
        return prop;
      },
      /*
        @function {Array} (private) _getValueAsArray
        @description Get value as array
        @param value [Value to be checked]
        @return {Array} [Array resulted]
      */
      getValueAsArray: function (value) {
        var el = this;
         // ** TODO - make it global (used on eon-drawer too)

        var array = [];
        // Check preventClose property value
        if (typeof value == "string") {
          // Convert value into an array
          value = value.replace(/,\s/g, ',');
          array = value.split(",");
        }
        return array[0] ? array : [];
      }
    },
    onCreated: function () {
      this._setupRefs();
      eon.createCallback("onExpand", this);
      eon.createCallback("onShrink", this);
    },
    onInit: function () {
      this._setupFoldable();
    }
  });
</script>