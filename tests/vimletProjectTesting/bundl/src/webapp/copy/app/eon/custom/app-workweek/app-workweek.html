<template>
  <div class="app-workweek-header" eon-ref="header">
    <eon-text bind:label="global locale.workspace.plans.planLabel" eon-ref="planName" class="form-text" name="name"
      label-anim="false" inline="false" default-style="false"></eon-text>

    <eon-button class="app-workweek-buttonNew h1-button"  bind:label="global locale.workspace.plans.newWorkday" icon="<i class='vicon vicon-add'></i>"
      eon-ref="buttonNew" design="filled"></eon-button>
  </div>

  <div class="app-workweek-workweekWrapper" eon-ref="workweekWrapper"></div>


  <!-- NEW WORKDAY DIALOG -->
  <eon-dialog eon-ref="dialogNew" class="app-workweek-dialogNew interactDialog" blur="true" default-style="false">
    <eon-section type="content">
      <!-- Workweek range TITLE -->
      <div class="dialogNew-title">
        <i class="dialogNew-titleIcon vicon vicon-clock-outline"></i>
        <eon-variable class="dialogNew-titleText" bind="locale.registry.schedule" global="true"></eon-variable>
      </div>

      <!-- Workweek range -->
      <div class="workweekRange app-workweek-rows">
        <div class="app-workweek-cols">
          <eon-variable class="app-workweek-label" bind="locale.entry" global="true"></eon-variable>
          <div class="app-workweek-date app-workweek-marginright">
            <eon-combo eon-ref="fromDay" filter="true" class="app-workweek-dayCombo app-workweek-grow" inline="false">
            </eon-combo>

            <eon-date eon-ref="fromTime" class="app-workweek-grow app-workweek-time" time="true" date="false"
              value-format="hh:mm" inline="false">
            </eon-date>
          </div>
        </div>

        <div class="app-workweek-cols">
          <eon-variable class="app-workweek-label" bind="locale.exit" global="true"></eon-variable>
          <div class="app-workweek-date">
            <eon-combo eon-ref="toDay" filter="true" class="app-workweek-dayCombo app-workweek-grow" inline="false">
            </eon-combo>

            <eon-date eon-ref="toTime" class="app-workweek-grow app-workweek-time" time="true" date="false"
              value-format="hh:mm" inline="false">
            </eon-date>
          </div>
        </div>
      </div>

      <!-- Break TITLE -->
      <div class="dialogNew-title">
        <i class="dialogNew-titleIcon vicon vicon-clock-outline"></i>
        <eon-variable class="dialogNew-titleText" bind="locale.registry.breaks" global="true"></eon-variable>
        <eon-button class="app-workweek-addBreak" eon-ref="addBreakButton" bind:label="global locale.registry.addBreak"
          icon="<i class='vicon vicon-add'></i>" design="filled">
        </eon-button>
      </div>

      <div class="workweek-breaks" eon-ref="breaksWrapper"> </div>
    </eon-section>
    <eon-section type="footer" class="form-actions">
      <eon-button eon-ref="deleteButton" class="delete-button" design="delete" bind:label="global locale.global.delete">
      </eon-button>
      <eon-button class="addWorkday" eon-ref="addWorkdayButton" bind:label="global locale.global.add"></eon-button>
      <eon-button class="editWorkday" eon-ref="editWorkdayButton" bind:label="global locale.global.edit"></eon-button>
    </eon-section>
  </eon-dialog>
</template>

<script>
  eon.element({

    name: "app-workweek",
    style: "app-workweek.css",


    dependencies: [
      "@ui/eon-scroll",
      "@ui/eon-form",
      "@ui/eon-button",
      "@ui/eon-dialog",
      "@ui/eon-combo",
      "@ui/eon-date",
      "workweek-desktop",
      "workweek-device",
      "workweek-break"
    ],
    properties: {
      weekStart: {
        value: 1
      },
      workweekDay: {
        value: false
      },
      // workweek-combo
      workweekCombo: {
        value: false
      }
    },
    privateProperties: {
      /*
        @property (private) {String} _formElement 
        @description Necessary property for a form
      */
      formElement: {
        value: "workweek"
      },
      /*
        @property (private) {Object} _misc
        @description Object with useful information
      */
      misc: {
        value: {},
        reflect: false
      },
      /*
        @property (private) {Object} _refs
        @description Object with references to frequently queried nodes
      */
      refs: {
        value: {},
        reflect: false
      }
    },
    functions: {
      clear: function () {
        var el = this;

        el._handleRemoveAllBars();
        el._misc.workDays = [];
        el._refs.planName.value = "";
      },

      setData: function (data) {
        var el = this;
        var workday, workdayObj;
        var workdays;

        if (!eon.util.isTrue(el.workweekDay)) {
          for (var key in data.workdays) {
            workday = data.workdays[key];

            for (var i = 0; i < workday.length; i++) {
              workdayObj = workday[i];
              el._addDataWorkday(workdayObj);
            }
          }

          el.scrollTo();
        } else {
          for (var i = 0; i < data.length; i++) {
            workdayObj = data[i];
            el._addDataWorkday(workdayObj);
          }

          el.scrollTo();
        }

        if (eon.util.isTrue(el.workweekCombo)) {
          el._refs.planName.style.display = "none";
          el._setWorkweeksCombo(data.workweeks);
        }


        el._misc.srcData = data;

        el._setupDaySelectors();
      },

      scrollTo: function () {
        var el = this;
        var append = false;
        var bar = el.querySelector(".bar");
        var left, top;

        // TODO: change to set the scroll to half grid before if there is
        if (bar) {
          left = el._misc.desktop ? bar.offsetLeft - 50 : false;
          top = el._misc.desktop ? false : bar.offsetTop - 50;

          el.querySelector("eon-scroll").scrollTo(top, left, false);
        } else {
          el.onAppendBar(function (bar) {
            if (!append) {
              left = el._misc.desktop ? bar.offsetLeft - 50 : false;
              top = el._misc.desktop ? false : bar.offsetTop - 50;

              el.querySelector("eon-scroll").scrollTo(top, left, false);
              append = true;
            }
          });
        }


      },

      clearDialog: function () {
        var el = this;

        el._refs.fromDay.value = eon.util.isTrue(el.workweekDay) ? el._misc.srcData[0].entryWeekday : parseInt(el.weekStart);
        el._refs.toDay.value = eon.util.isTrue(el.workweekDay) ? el._misc.srcData[0].entryWeekday : parseInt(el.weekStart);

        el._refs.breaksWrapper.innerHTML = "";
        el._refs.fromTime.value = "09:00";
        el._refs.toTime.value = "18:00";

        el._misc.comboSelected = false;

        el._refs.addWorkdayButton.classList.remove("show");
        el._refs.editWorkdayButton.classList.remove("show");
        el._refs.deleteButton.classList.remove("show");

        el._refs.toDay.updateDescription("");
        el._refs.toTime.updateDescription("");
        el._refs.toDay.invalid = false;
        el._refs.toTime.invalid = false;
      },

      getData: function () {
        var el = this;
        var fromDay;
        var weekday;
        var workweek = {
          1: [],
          2: [],
          3: [],
          4: [],
          5: [],
          6: [],
          7: []
        };

        for (var i = 0; i < el._misc.workDays.length; i++) {
          fromDay = el._misc.workDays[i].entryWeekday;
          weekday = fromDay == 0 ? fromDay + 7 : fromDay;

          workweek[weekday].push(el._misc.workDays[i]);
        }

        for (var key in workweek) {
          workweek[key].sort(el._sortBars());
        }


        return workweek;
      }

    },
    privateFunctions: {

      /*
        @function (private) _sortBars
      */
      sortBars: function () {

        return function (a, b) {
          var entryHourA = moment.duration(moment(a.entryRAW, "HH:mm").diff(moment("00:00", "HH:mm"))).asMilliseconds();
          var exitHourB = moment.duration(moment(b.entryRAW, "HH:mm").diff(moment("00:00", "HH:mm"))).asMilliseconds();

          if (entryHourA < exitHourB) {
            return -1;
          } else if (!entryHourA > exitHourB) {
            return 1;
          }
          return 0;
        }
      },

      /*
        @function (private) _setupWorkweek
      */
      setupWorkweek: function () {
        var el = this;
        var fragment = document.createDocumentFragment();

        if (el._refs.workweekWrapper.hasChildNodes()) {
          el._refs.workweekWrapper.removeChild(el._refs.workweekWrapper.firstChild);
        }

        tagName = el._isDesktop() ? "workweek-desktop" : "workweek-device";

        el._refs.workweek = document.createElement(tagName);
        fragment.appendChild(el._refs.workweek);

        el._refs.workweekWrapper.appendChild(fragment);

        if (el._misc.workDays.length >= 1) {
          for (var i = 0; i < el._misc.workDays.length; i++) {
            el._drawWorkdayBar(el._misc.workDays[i]);
            el._drawBreaksBar(el._misc.workDays[i]);
          }
        }
      },
      // @function _isDesktop (private)
      isDesktop: function (entries) {
        if (window.innerWidth <= 700) {
          this._misc.desktop = false;
        } else {
          this._misc.desktop = true;
        }

        return this._misc.desktop;
      },
      /*
        @function (private) _weekdayName
        @description 
      */
      weekdayName: function (index) {
        var el = this;
        var weekDays = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];

        return weekDays[index];
      },
      /*
        @function (private) _setupButtonsListener
        @description 
      */
      setupButtonsListener: function () {
        var el = this;

        el._refs.buttonNew.onClick(function () {
          el.clearDialog();
          el._setBreaks();
          el._refs.addWorkdayButton.classList.add("show");
          el._refs.dialogNew.open();
          // Push dialog state
          pushDialogState(el._refs.dialogNew);
        });

        el._refs.addBreakButton.onClick(function () {
          el._setBreaks();
        });

        el._refs.addWorkdayButton.onClick(function () {
          el._validateData();

          if (!el._misc.invalid) {
            el._addNewWorkday();
          }
        });

        el._refs.editWorkdayButton.onClick(function () {
          el._validateData();
          if (!el._misc.invalid) {
            el._handleRemoveBar();
            el._addNewWorkday();
          }
        });

        el._refs.deleteButton.onClick(function () {
          el._handleRemoveBar();

          el._refs.dialogNew.close();
        });

      },
      /*
        @function (private) _handleRemoveBar
        @description 
      */
      handleRemoveBar: function (removeWorkDay) {
        var el = this;
        var i;

        for (i = 0; i < el._misc.allBars.length; i++) {
          el._removeBar(el._misc.allBars[i]);
          el._misc.allBars[i].parentNode.removeChild(el._misc.allBars[i]);
        }

        for (i = 0; i < el._misc.allBreaksBars.length; i++) {
          el._removeBar(el._misc.allBreaksBars[i]);
          el._misc.allBreaksBars[i].parentNode.removeChild(el._misc.allBreaksBars[i]);
        }

        for (i = 0; i < el._misc.workDays.length; i++) {
          if (el._misc.workDays[i].workdayId == el._misc.currentWorkday.workdayId) {
            el._misc.workDays.splice(i, 1);
          }
        }
      },
      /*
        @function (private) _handleRemoveAllBars
        @description 
      */
      handleRemoveAllBars: function () {
        var el = this;
        var allBars = el.$(".bar");
        var allBreakBars = el.$(".breakBar");


        for (i = 0; i < allBars.length; i++) {
          el._removeBar(allBars[i]);
          allBars[i].parentNode.removeChild(allBars[i]);
        }

        for (i = 0; i < allBreakBars.length; i++) {
          el._removeBar(allBreakBars[i]);
          allBreakBars[i].parentNode.removeChild(allBreakBars[i]);
        }
      },
      /*
        @function (private) _removeBar
        @description 
      */
      removeBar: function (bar) {
        var el = this;

        for (var j = 0; j < el._misc.workweekBars.length; j++) {
          if (el._misc.workweekBars[j].bar == bar) {
            el._misc.workweekBars.splice(j, 1);
          }
        }
      },
      /*
        @function (private) _setWorkweeksCombo
        @description 
      */
      setWorkweeksCombo: function (workweeks) {
        var el = this;
        if (el._refs.header.querySelector(".app-workweek-combo")) {
          el._refs.workweeksCombo = el._refs.header.querySelector(".app-workweek-combo");

        } else {
          el._refs.workweeksCombo = document.createElement("eon-combo");

          el._refs.workweeksCombo.inline = false;
          el._refs.workweeksCombo.labelAnim = false;
          el._refs.workweeksCombo.name = "name";
          el._refs.workweeksCombo.classList.add("form-combo", "app-workweek-combo");

          el._refs.header.insertBefore(el._refs.workweeksCombo, el._refs.buttonNew);
        }

        for (var key in workweeks) {
          if (workweeks[key]) {
            item = document.createElement("eon-item");
            item.value = key;
            item.displayValue = workweeks[key].name;
            el._refs.workweeksCombo.addItem(item);

            if (!el._refs.workweeksCombo.placeholder) {
              el._refs.workweeksCombo.placeholder = workweeks[key].name;
              el._refs.workweeksCombo.value = key;
              el._refs.workweeksCombo.displayValue = workweeks[key].name;
              el._refs.workweeksCombo.select(item);
            }

          }
        }

        el._refs.workweeksCombo.onSelected(function () {
          el._setWorkweekSelected(workweeks[el._refs.workweeksCombo.value]);
        });
      },
      /*
        @function (private) _setWorkweekSelected
        @description 
      */
      setWorkweekSelected: function (workweek) {
        var el = this;
        var workdays = workweek.workdays;

        el._handleRemoveAllBars();
        el._misc.workDays = [];

        for (var key in workdays) {
          workday = workdays[key];

          for (var i = 0; i < workday.length; i++) {
            workdayObj = workday[i];
            el._addDataWorkday(workdayObj);
          }
        }
      },
      /*
        @function (private) _setupDaySelectors
        @description 
      */
      setupDaySelectors: function () {
        var el = this;
        var dayCombos = el.querySelectorAll(".app-workweek-dayCombo");
        var day;

        for (var i = 0; i < dayCombos.length; i++) {
          day = dayCombos[i];

          if (eon.util.isTrue(el.workweekDay)) {
            el._fillDays(day, el._misc.srcData[0].entryWeekday, true);
          } else {
            el._fillDays(day);
          }
        }
        el._setCombosListeners();
      },

      // @function _fillDays(private)
      fillDays: function (combo, from, weekday) {
        var el = this;
        var dayItem;

        combo.clearItems();

        var to = weekday && el._refs.fromDay == combo ? from + 1 : 7;
        from = weekday && el._refs.fromDay == combo ? from : 0;

        for (var i = from; i < to; i++) {
          dayItem = document.createElement("eon-item");

          dayItem.value = weekday && el._refs.fromDay == combo ? i : (i + el.weekStart) % 7;
          dayItem.displayValue = eon.locale.workspace.plans[el._weekdayName(dayItem.value)];

          combo.addItem(dayItem);
        }
      },

      // @function _setCombosListeners (private)
      setCombosListeners: function () {
        var el = this;
        var item;
        var breaksCombos;

        el._refs.fromDay.onSelected(function () {
          if (!el._misc.comboSelected) {
            el._refs.toDay.value = el._refs.fromDay.value;

            breaksCombos = el._refs.breaksWrapper.$(".workweek-break-dayCombo");

            for (var i = 0; i < breaksCombos.length; i++) {
              breaksCombos[i].value = el._refs.fromDay.value;
            }

            el._misc.comboSelected = true;
          }
        });
      },

      // @function _setBreaks(private)
      setBreaks: function (oldBreak) {
        var el = this;
        var breakData;
        var breaksFragment = document.createDocumentFragment();

        if (!oldBreak) {
          breakData = {
            type: "break",
            entryDay: eon.util.isTrue(el.workweekDay) ? el._misc.srcData[0].entryWeekday : el.weekStart,
            exitDay: eon.util.isTrue(el.workweekDay) ? el._misc.srcData[0].entryWeekday : el.weekStart,
            entryHour: "14:00",
            exitHour: "15:00",
            weekStart: parseInt(el.weekStart),
            notes: "",
          }

        } else {
          breakData = {
            type: oldBreak.type,
            entryDay: oldBreak.entryDay,
            exitDay: oldBreak.exitDay,
            entryHour: oldBreak.entryHour,
            exitHour: oldBreak.exitHour,
            weekStart: parseInt(el.weekStart),
            notes: oldBreak.notes,
          }
        }


        breaksFragment.appendChild(el._createBreak(breakData));

        el._refs.breaksWrapper.appendChild(breaksFragment);

      },
      // @function _createBreak (private)
      createBreak: function (data) {
        var el = this;
        var breakRange;

        breakRange = document.createElement("workweek-break");
        // breakRange = document.createElement("break-range");

        breakRange.entryDay = data.entryDay;
        breakRange.exitDay = data.exitDay;
        breakRange.entryHour = data.entryHour;
        breakRange.exitHour = data.exitHour;
        breakRange.weekStart = data.weekStart;
        breakRange.type = data.type;
        breakRange.position = data.position;
        breakRange.notes = data.notes;
        breakRange.isBreak = ["break", "food", "absence"].indexOf(data.type) > -1;

        if (eon.util.isTrue(el.workweekDay)) {
          breakRange.constraint = el._misc.srcData[0].entryWeekday.toString();
        }
        return breakRange;
      },

      // @function _addDataWorkday (private)
      addDataWorkday: function (workday) {
        var el = this;
        var workDayBreaks = [];
        var newWorkday = {};
        var rangeValues;

        for (var i = 0; i < workday.breaks.length; i++) {
          rangeValues = workday.breaks[i];

          workDayBreaks.push({
            type: rangeValues.type,
            isBreak: rangeValues.isBreak,
            entryDay: rangeValues.entryDay,
            exitDay: rangeValues.exitDay,
            entryHour: rangeValues.entryHour,
            exitHour: rangeValues.exitHour
          })
        }

        newWorkday = {
          entryWeekday: Number(workday.entryWeekday),
          entryRAW: workday.entryRAW,
          exitWeekday: Number(workday.exitWeekday),
          exitRAW: workday.exitRAW,
          breaks: workDayBreaks,
          workdayId: workday.entryWeekday.toString() + workday.entryRAW
        }

        el._misc.workDays.push(newWorkday);
        el._drawWorkdayBar(newWorkday);
        el._drawBreaksBar(newWorkday);
      },

      // @function _addNewWorkday (private)
      addNewWorkday: function () {
        var el = this;
        var breaksArray = el._refs.breaksWrapper.querySelectorAll("workweek-break");
        var workDayBreaks = [];
        var newWorkday = {};
        var rangeValues;

        for (var i = 0; i < breaksArray.length; i++) {
          rangeValues = breaksArray[i].getValue();

          workDayBreaks.push({
            type: rangeValues.type,
            isBreak: rangeValues.isBreak,
            entryDay: rangeValues.entryDay,
            exitDay: rangeValues.exitDay,
            entryHour: rangeValues.entryHour,
            exitHour: rangeValues.exitHour
          })
        }

        newWorkday = {
          entryWeekday: Number(el._refs.fromDay.value),
          entryRAW: el._refs.fromTime.value,
          exitWeekday: Number(el._refs.toDay.value),
          exitRAW: el._refs.toTime.value,
          breaks: workDayBreaks,
          workdayId: el._refs.fromDay.value.toString() + el._refs.fromTime.value
        }

        el._checkRepeatWorkday();

        el._misc.workDays.push(newWorkday);
        el._drawWorkdayBar(newWorkday);
        el._drawBreaksBar(newWorkday);
        el._refs.dialogNew.close();
      },

      // @function _validateData (private)
      validateData: function () {
        var el = this;
        var fromDay = el._refs.fromDay.value;
        var toDay = el._refs.toDay.value;
        var fromTime = moment(el._refs.fromTime.value, "hhmm").valueOf();
        var toTime = moment(el._refs.toTime.value, "hhmm").valueOf();
        var breaksArray = el._refs.breaksWrapper.querySelectorAll("workweek-break");
        var rangeValues;
        var entryDay, exitDay, entryHour, exitHour;
        var invalid = false;

        // To time is lower than from time
        if (toTime < fromTime && toDay == fromDay) {
          el._setInvalid(el._refs.toTime);
          invalid = true;
        }

        for (var i = 0; i < breaksArray.length; i++) {
          rangeValues = breaksArray[i].getValue();
          entryDay = rangeValues.entryDay;
          exitDay = rangeValues.exitDay;
          entryHour = moment(rangeValues.entryHour, "hhmm").valueOf();
          exitHour = moment(rangeValues.exitHour, "hhmm").valueOf();

          // Start or end days match  
          if ((entryDay == fromDay || exitDay == toDay) && entryDay <= exitDay) {
            // SAME RAIL end hour lower than start hour
            if (exitHour < entryHour && entryDay == exitDay) {
              el._setInvalid(breaksArray[i]._refs.endHour);
              invalid = true;
            }

            // SAME RAIL invalid start hour
            if (entryDay == exitDay && (entryHour < fromTime || entryHour > toTime)) {
              el._setInvalid(breaksArray[i]._refs.startHour);
              invalid = true;
            }

            // SAME RAIL invalid end hour
            if (entryDay == exitDay && (exitHour < fromTime || exitHour > toTime)) {
              el._setInvalid(breaksArray[i]._refs.endHour);
              invalid = true;
            }

            // DIFFERENT RAIL invalid start hour
            if (entryDay != exitDay && entryHour < fromTime) {
              el._setInvalid(breaksArray[i]._refs.startHour);
              invalid = true;
            }

            // DIFFERENT RAIL invalid end hour
            if (entryDay != exitDay && exitHour > toTime) {
              el._setInvalid(breaksArray[i]._refs.endHour);
              invalid = true;
            }

          }

          // Invalid start day
          if (entryDay != fromDay && entryDay != toDay) {
            el._setInvalid(breaksArray[i]._refs.startDay);
            invalid = true;
          }

          // Invalid end day
          if (exitDay != fromDay && exitDay != toDay) {
            el._setInvalid(breaksArray[i]._refs.endDay);
            invalid = true;
          }

        }

        el._misc.invalid = invalid ? true : false;
      },
      // @function _setInvalid (private)
      setInvalid: function (invalidNode) {
        var el = this;

        invalidNode.updateDescription("Invalid");
        invalidNode.invalid = true;
      },

      // @function _checkRepeatWorkday (private)
      checkRepeatWorkday: function () {
        var el = this;
        var i, j;

        // newFromTime, newTotime, currentFromTime, currentToTime
        var nFt, nTt;
        var cFt, cTt;
        // newFromDay, newToDay, currentFromDay, currentToDay
        var nFd = el._refs.fromDay.value;
        var nTd = el._refs.toDay.value;
        var cFd, cTd;
        var workDate;
        var workDaysCopy = Array.prototype.slice.call(el._misc.workDays);

        var numberCurrentBars;
        var currentRail;

        for (i = 0; i < workDaysCopy.length; i++) {
          cFd = workDaysCopy[i].entryWeekday;
          cTd = workDaysCopy[i].exitWeekday;
          numberCurrentBars = cTd - cFd + 1;

          for (j = 0; j < numberCurrentBars; j++) {
            currentRail = cFd + j;

            // Check the start or end bar rails, if there is more than one bar or only one
            if (currentRail == nFd || currentRail == nTd) {
              // Start or end of new bar is the same of start or end of the current bar
              if (cFd == nFd || cTd == nTd || cFd == nTd || cTd == nFd) {
                nFt = moment(el._refs.fromTime.value, "hhmm").valueOf();
                nTt = moment(el._refs.toTime.value, "hhmm").valueOf();
                cFt = moment(workDaysCopy[i].entryRAW, "hhmm").valueOf();
                cTt = moment(workDaysCopy[i].exitRAW, "hhmm").valueOf();

                switch (true) {
                  // Start and end same day in a single rail day
                  case nFd == cFd && nTd == cTd && nFd == nTd:
                    if ((nFt >= cFt && nTt <= cTt) || (nFt <= cFt && nTt >= cTt) || (nFt >= cFt && nFt <= cTt) || (nTt >= cFt && nTt <= cTt)) {
                      el._setRemoveBar(workDaysCopy[i]);
                    }
                    break;

                  // New bar and current bar STARTS same day
                  case nFd == cFd && nTd != cTd:
                    if ((nFt >= cFt && nFd == nTd) || (nFt <= cFt && nFd < nTd) || (nFt <= cFt && nTt >= cFt && nFd == nTd) || (nFt >= cFt && nFt <= cTt && nFd < nTd)) {
                      el._setRemoveBar(workDaysCopy[i]);
                    }
                    break;

                  // New bar and current bar ENDS same day
                  case nFd == cTd && nFd != cFd:
                    if ((nFt <= cTt)) {
                      el._setRemoveBar(workDaysCopy[i]);
                    }
                    break;

                  // New bar ENDS same day than STARTS current bar
                  case nTd == cFd:
                    if ((nTt >= cFt)) {
                      el._setRemoveBar(workDaysCopy[i]);
                    }
                    break;

                  // New bar ENDS same day than ENDS current bar
                  case nTd == cTd && nTd != cFd:
                    el._setRemoveBar(workDaysCopy[i]);
                    break;
                }

                // When the current bar take more than two days, neither the start day nor the end day match, so the current bar will be deleted
              } else {
                el._setRemoveBar(workDaysCopy[i]);
              }

              // When there ir more than 2 bars
              // checks if new bar is overlapping to an exiting bar in the central rail
            } else if (nFd < cFd && nTd > cTd) {
              el._setRemoveBar(workDaysCopy[i]);
            }

          }
        }
      },
      // @function _setRemoveBar (private)
      setRemoveBar: function (currentWorkday) {
        var el = this;
        var workDate = currentWorkday.entryWeekday + currentWorkday.entryRAW.split(":")[0] + currentWorkday.entryRAW.split(":")[1];

        el._misc.allBars = el.$(".bar" + workDate);
        el._misc.allBreaksBars = el.$(".breakBar" + workDate);
        el._misc.currentWorkday = currentWorkday;
        el._handleRemoveBar(true);
      },
      // @function _drawWorkdayBar (private)
      drawWorkdayBar: function (workdayData) {
        var el = this;

        if (workdayData.exitWeekday < workdayData.entryWeekday) {
          var numberBars = 7 - (workdayData.entryWeekday - workdayData.exitWeekday) + 1;
        } else {
          var numberBars = workdayData.exitWeekday - workdayData.entryWeekday + 1;
        }

        var breaks = workdayData.breaks;
        var weekHour = el.$1(".weekHour0");
        var i, j;
        var currentDay;
        var currentDayRail;
        var fromTime, toTime;
        var fromGrid, toGrid;
        var bar;
        var hourDisplay;
        var timeMinutes;
        var workDate = workdayData.entryWeekday + workdayData.entryRAW.split(":")[0] + workdayData.entryRAW.split(":")[1];

        for (i = 0; i < numberBars; i++) {
          bar = document.createElement("div");
          hourDisplay = document.createElement("div");

          if (numberBars > 1) {
            currentDay = workdayData.entryWeekday + i;
            currentDay = currentDay >= 7 ? currentDay - 7 : currentDay;
            currentDayRail = el._refs.workweek._refs.hoursWrapper.$1(".day" + currentDay);
            
            switch (true) {
              case currentDay == workdayData.entryWeekday:
                fromTime = workdayData.entryRAW;
                fromGrid = el._getGrid(currentDayRail, fromTime);
                toGrid = currentDayRail.$1(".quarterto23");
                bar.style.backgroundColor = config.colors.workweek[workdayData.entryWeekday];
                bar.classList.add("bar", "startBar", "bar" + workdayData.entryWeekday, "bar" + workDate);

                break;

              case currentDay == workdayData.exitWeekday:
                toTime = workdayData.exitRAW;
                fromGrid = currentDayRail.$1(".oclock0");
                toGrid = el._getGrid(currentDayRail, toTime);
                timeMinutes = parseInt(toTime.split(":")[1]);
                bar.style.backgroundColor = config.colors.workweek[workdayData.entryWeekday];
                bar.classList.add("bar", "endBar", "bar" + workdayData.entryWeekday, "bar" + workDate);

                break;

              default:
                fromGrid = currentDayRail.$1(".oclock0");
                toGrid = currentDayRail.$1(".quarterto23");
                bar.style.backgroundColor = config.colors.workweek[workdayData.entryWeekday];
                bar.classList.add("bar", "centerBar", "bar" + workdayData.entryWeekday, "bar" + workDate);

                break;
            }
          } else {
            currentDay = workdayData.entryWeekday == 7 ? 0 : workdayData.entryWeekday;
            currentDayRail = el._refs.workweek._refs.hoursWrapper.$1(".day" + currentDay);

            fromTime = workdayData.entryRAW;
            fromGrid = el._getGrid(currentDayRail, fromTime);

            toTime = workdayData.exitRAW;
            toGrid = el._getGrid(currentDayRail, toTime);

            timeMinutes = parseInt(toTime.split(":")[1]);

            bar.style.backgroundColor = config.colors.workweek[workdayData.entryWeekday];
            bar.classList.add("bar", "completeBar", "bar" + workdayData.entryWeekday, "bar" + workDate);
          }
          el._setBarPosition(fromGrid, toGrid, bar, currentDayRail, timeMinutes);
          currentDayRail.appendChild(bar);

          el._misc.workweekBars.push({
            bar: bar,
            dayRail: currentDayRail,
            fromGrid: fromGrid,
            toGrid: toGrid,
            timeMinutes: timeMinutes
          });

          el._setBarListener(bar, workdayData);
        }
        el._misc.cellWidth = weekHour.offsetWidth;

        el._setWindowResizeListener();
        eon.triggerCallback("onAppendBar", el, el, [bar]);
      },

      // @function _setBarListener (private)
      setBarListener: function (bar, workdayData) {
        var el = this;

        bar.addEventListener("click", function (e) {
          var breaks = workdayData.breaks;
          var workDate = workdayData.entryWeekday + workdayData.entryRAW.split(":")[0] + workdayData.entryRAW.split(":")[1];

          el.clearDialog();
          el._refs.dialogNew.open();
          // Push dialog state
          pushDialogState(el._refs.dialogNew);
          el._refs.editWorkdayButton.classList.add("show");
          el._refs.deleteButton.classList.add("show");

          el._refs.fromDay.value = workdayData.entryWeekday;
          el._refs.toDay.value = workdayData.exitWeekday;
          el._refs.fromTime.value = workdayData.entryRAW;
          el._refs.toTime.value = workdayData.exitRAW;

          for (var i = 0; i < breaks.length; i++) {
            el._setBreaks(breaks[i]);
          }

          el._misc.allBars = el.$(".bar" + workDate);

          el._misc.allBreaksBars = el.$(".breakBar" + workDate);
          el._misc.currentWorkday = workdayData;
        });
      },
      // @function _drawBreaksBar (private)
      drawBreaksBar: function (workdayData) {
        var el = this;
        var i, j;
        var breaks = workdayData.breaks;
        var numberBreakBars;
        var currentDay;
        var currentDayRail;
        var fromTime, toTime;
        var fromGrid, toGrid;
        var breakBar;
        var timeMinutes;
        var workDate = workdayData.entryWeekday + workdayData.entryRAW.split(":")[0] + workdayData.entryRAW.split(":")[1];

        for (i = 0; i < breaks.length; i++) {
          if (breaks[i].exitDay < breaks[i].entryDay) {
            numberBreakBars = 7 - (breaks[i].entryDay - breaks[i].exitDay) + 1;
          } else {
            numberBreakBars = breaks[i].exitDay - breaks[i].entryDay + 1;
          }

          for (j = 0; j < numberBreakBars; j++) {
            breakBar = document.createElement("div");

            if (numberBreakBars > 1) {
              currentDay = breaks[i].entryDay + j;
              currentDay = currentDay >= 7 ? currentDay - 7 : currentDay;

              currentDayRail = el._refs.workweek._refs.hoursWrapper.$1(".day" + currentDay);

              switch (true) {
                case currentDay == breaks[i].entryDay:
                  fromTime = breaks[i].entryHour;
                  fromGrid = el._getGrid(currentDayRail, fromTime);
                  toGrid = currentDayRail.$1(".quarterto23");
                  timeMinutes = 59;

                  break;

                case currentDay == breaks[i].exitDay:
                  toTime = breaks[i].exitHour;
                  fromGrid = currentDayRail.$1(".oclock0");
                  toGrid = el._getGrid(currentDayRail, toTime);
                  timeMinutes = parseInt(toTime.split(":")[1]);

                  break;
              }
            } else {
              var currenDay = breaks[i].entryDay == 7 ? 0 : breaks[i].entryDay;
              currentDayRail = el._refs.workweek._refs.hoursWrapper.$1(".day" + currenDay);

              fromTime = breaks[i].entryHour;
              fromGrid = el._getGrid(currentDayRail, fromTime);

              toTime = breaks[i].exitHour;
              toGrid = el._getGrid(currentDayRail, toTime);
              timeMinutes = parseInt(toTime.split(":")[1]);
            }

            breakBar.classList.add("breakBar", "breakBar" + workdayData.entryWeekday, "breakBar" + workDate);

            el._setBarPosition(fromGrid, toGrid, breakBar, currentDayRail, timeMinutes);

            currentDayRail.appendChild(breakBar);

            el._misc.workweekBars.push({
              bar: breakBar,
              dayRail: currentDayRail,
              fromGrid: fromGrid,
              toGrid: toGrid,
              timeMinutes: timeMinutes
            });
          }

        }
      },
      // @function _setBarPosition (private)
      setBarPosition: function (fromGrid, toGrid, currentBar, currentDayRail, timeMinutes) {
        var el = this;

        if (el._misc.desktop) {
          var fromGridLeft = fromGrid.offsetLeft;
          var toGridLeft = toGrid.offsetLeft;

          currentBar.style.left = fromGridLeft + "px";

          if (timeMinutes == 0 || timeMinutes == 15 || timeMinutes == 30 || timeMinutes == 45) {
            currentBar.style.width = currentDayRail.offsetWidth - (currentDayRail.offsetWidth - toGridLeft) - fromGridLeft + "px";
          } else {
            currentBar.style.width = currentDayRail.offsetWidth - (currentDayRail.offsetWidth - toGridLeft) - fromGridLeft + toGrid.offsetWidth + "px";
          }
        } else {
          var fromGridTop = fromGrid.offsetTop;
          var toGridTop = toGrid.offsetTop;

          currentBar.style.top = fromGridTop + "px";

          if (timeMinutes == 0 || timeMinutes == 15 || timeMinutes == 30 || timeMinutes == 45) {
            currentBar.style.height = currentDayRail.offsetHeight - (currentDayRail.offsetHeight - toGridTop) - fromGridTop + "px";
          } else {
            currentBar.style.height = currentDayRail.offsetHeight - (currentDayRail.offsetHeight - toGridTop) - fromGridTop + toGrid.offsetHeight + "px";
          }
        }
      },
      // @function _getStartGrid (private)
      getGrid: function (fromDayRail, time) {
        var el = this;
        var timeHour = parseInt(time.split(":")[0]);
        var timeMinutes = parseInt(time.split(":")[1]);

        var weekHourNode = fromDayRail.$1(".weekHour" + timeHour);

        switch (true) {
          case timeMinutes < 15:
            return weekHourNode.$1(".oclock");
            break;
          case timeMinutes >= 45:
            return weekHourNode.$1(".quarterto");

            break;
          case timeMinutes >= 30:
            return weekHourNode.$1(".half");

            break;
          case timeMinutes >= 15:
            return weekHourNode.$1(".quarter");

            break;
        }
      },

      // @function _setWindowResizeListener (private)
      setWindowResizeListener: function () {
        var el = this;
        var bar;
        var dayRail;
        var fromGrid, toGrid;
        var weekHour = el.$1(".weekHour0");

        window.onresize = function (e) {
          if (weekHour.offsetWidth != el._misc.cellWidth) {

            for (var i = 0; i < el._misc.workweekBars.length; i++) {
              bar = el._misc.workweekBars[i].bar;
              dayRail = el._misc.workweekBars[i].dayRail;
              fromGrid = el._misc.workweekBars[i].fromGrid;
              toGrid = el._misc.workweekBars[i].toGrid;
              timeMinutes = el._misc.workweekBars[i].timeMinutes;

              el._setBarPosition(fromGrid, toGrid, bar, dayRail, timeMinutes);
            }
            el._misc.cellWidth = weekHour.offsetWidth;
          }
        }
      },
    },
    onCreated: function () {
      var el = this;

      this._misc.srcData;
      el._misc.startBar = false;
      el._misc.comboSelected = false;
      el._misc.invalid = false;
      el._misc.workDays = [];
      el._misc.workweekBars = [];
      el._misc.allBars = [];
      el._misc.allBreaksBars = [];
      el._misc.cellWidth;
      el._misc.weekDays = {};
      el._misc.currentWorkday;

      eon.createCallback("onAppendBar", this);

      el._setupWorkweek();

      el.weekStart = parseInt(el.weekStart);
    },

    onTransformed: function () {
      var el = this;

    },
    onReady: function () {
      var el = this;

      el._setupButtonsListener();

      if (!eon.util.isTrue(el.workweekDay)) {
        el._setupDaySelectors();
      } else {
        el._refs.header.classList.add("workday");
      }

    },

    onWindowResize: function () {
      var el = this;
      var throttled = false;
      var delay = 10;

      // Decrease resize calls
      if (!throttled) {
        throttled = true;

        // Check resolution
        var isDesktop = window.innerWidth <= 700 ? false : true;

        if (isDesktop && !el._misc.desktop) {
          el._misc.desktop = false;
          el._setupWorkweek();
        } else if (!isDesktop && el._misc.desktop) {
          el._misc.desktop = true;
          el._setupWorkweek();
        }

        // Set a timeout to un-throttle
        setTimeout(function () {
          throttled = false;
        }, delay);
      }
    }
  });
</script>