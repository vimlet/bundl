<style>
  app-pagination {
    margin-top: 20px;
  }

  app-pagination .app-pagination-content {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  app-pagination .app-pagination-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }

  app-pagination .app-pagination-actions>span {
    min-width: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  app-pagination .app-pagination-separation {
    min-width: auto !important;
  }

  app-pagination .app-pagination-left-clickable,
  app-pagination .app-pagination-right-clickable {
    position: absolute;
    height: calc(100% + 20px);
    width: calc(100% + 20px);
    cursor: pointer;
  }

  @media (max-width: 640px) {
    app-pagination .app-pagination-actions {
      margin-top: 10px;
    }
  }
</style>

<template>
  <div class="app-pagination-content">
    <!-- <div class="box" eon-ref="search">
      <eon-text></eon-text>

      <span class="search vicon vicon-search">
        <span class="search-clickable" eon-ref="searchClick"></span>
      </span>
    </div> -->
    <div class="app-pagination-actions" eon-ref="pagination">
      <span class="app-pagination-left vicon vicon-chevron-left eon-fg1-hoverable" eon-ref="backward">
        <span class="app-pagination-left-clickable" eon-ref="backwardClick"></span>
      </span>

      <span class="app-pagination-from" eon-ref="from"></span>
      <span class="app-pagination-separation">-</span>
      <span class="app-pagination-to" eon-ref="to"></span>
      <span eon-ref="slash">/</span>
      <span class="app-pagination-total" eon-ref="total"></span>

      <span class="app-pagination-right vicon vicon-chevron-right eon-fg1-hoverable" eon-ref="forward">
        <span class="app-pagination-right-clickable" eon-ref="forwardClick"></span>
      </span>
    </div>
  </div>
</template>

<script>
  eon.element({
    name: "app-pagination",

    dependencies: [
      "@ui/eon-text"
    ],
    properties: {
      to: {
        value: "true",
        reflect: true
      },
      count: {
        value: "10",
        reflect: true
      },
      container: {
        value: "",
        reflect: true
      },
    },
    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function getPaginationItems
      setPaginationItems: function (data, currentKey, checks) {
        var el = this;
        var items = {};
        var itemKey;
        el._misc.currentKey = currentKey;
        el._misc.checks = checks;
        el._misc.workspaceData = JSON.parse(JSON.stringify(data));

        el._initOptions();
        el._setPagination();
        el._sendCurrentItems();
      },

      refresh: function (checks, all) {
        var el = this;

        el._misc.checks = checks;
        if (all) {
          el._refs.container.refresh(el._misc.workspaceData, el._misc.checks);
        }
      }
    },
    privateFunctions: {
      // @function _setupRefs (private)
      setupRefs: function () {
        var el = this;
        el._refs.enclosingComponent = el.getEnclosingComponent();
        el._refs.container = el._refs.enclosingComponent.querySelector("#" + el.container);
      },

      // @function _setCount (private)
      setCount: function () {
        var el = this;
        el._misc.count = parseInt(el.count);
      },

      // @function _initOptions (private)
      initOptions: function () {
        var el = this;
        var total = 0;
        var from = 0;
        var to = from + el._misc.count;
        var itemObject = {};
        var itemData = el._misc.workspaceData ? el._misc.workspaceData[el._misc.currentKey] : {};

        for (var itemKey in itemData) {
          if (itemData[itemKey] && itemKey !== "flexible") {
            total = total + 1;
            itemObject[itemKey] = itemData[itemKey];
          }
        }
        el._misc.itemObject = itemObject;

        to = to > total ? total : to;

        el._misc.options = {
          from: from,
          to: to,
          count: el._misc.count,
          total: total
        }
      },
      // @function _setPagination (private)
      setPagination: function () {
        var el = this;
        el._refs.total.innerHTML = el._misc.options.total;
        el._refs.from.innerHTML = el._misc.options.from + 1;
        el._refs.to.innerHTML = el._misc.options.to;

        // Disabled navigation button
        if (el._misc.options.to == el._misc.options.total) {
          el._refs.forward.classList.add("nav-disabled");
        } else {
          el._refs.forward.classList.remove("nav-disabled");
        }

        if (el._misc.options.from <= 1) {
          el._refs.backward.classList.add("nav-disabled");
        } else {
          el._refs.backward.classList.remove("nav-disabled");
        }

        if (el._misc.options.total == 0) {
          el._refs.from.innerHTML = 0;
          el._refs.to.innerHTML = 0;
          el._refs.forward.classList.add("nav-disabled");
          el._refs.backward.classList.add("nav-disabled");
        }
      },

      // @function _sendCurrentItems (private)
      sendCurrentItems: function () {
        var el = this;

        if (el._misc.itemObject) {
          var dataKeys = Object.keys(el._misc.itemObject);
          var sentData = el._misc.workspaceData;
          var items = {};

          for (var i = el._misc.options.from; i < el._misc.options.to; i++) {
            items[dataKeys[i]] = el._misc.itemObject[dataKeys[i]];
          };

          sentData[el._misc.currentKey] = items;
          el._refs.container.refresh(sentData, el._misc.checks);
        }
      },

      // @function _setPaginingListener (private)
      setPaginingListener: function () {
        var el = this;
        var options, date;

        el._refs.backwardClick.addEventListener("click", function (e) {
          // Refresh container if no limit pages have been reached
          if (!el._hasReachedLimits()) {
            eon.triggerCallback("onPaging", el, el);

            el._misc.options.from = el._misc.options.from - el._misc.options.count;
            el._misc.options.from = el._misc.options.from < 0 ? 0 : el._misc.options.from;

            el._misc.options.to = el._misc.options.from + el._misc.options.count;
            el._misc.options.to = el._misc.options.to > el._misc.options.total ? el._misc.options.total : el._misc.options.to;

            el._setPagination();
            el._sendCurrentItems();
          }

        }, false);

        el._refs.forwardClick.addEventListener("click", function (e) {

          // Refresh container if no limit pages have been reached
          if (!el._hasReachedLimits(true)) {
            eon.triggerCallback("onPaging", el, el);

            el._misc.options.from = el._misc.options.to;

            el._misc.options.to = el._misc.options.from + el._misc.options.count;
            el._misc.options.to = el._misc.options.to > el._misc.options.total ? el._misc.options.total : el._misc.options.to;

            el._setPagination();
            el._sendCurrentItems();
          }
        }, false);
      },


      // @function _hasReachedLimits (private)
      hasReachedLimits: function (forward) {
        var el = this;
        var reached;

        // Check paging direction
        if (forward) {
          reached = el._misc.options.to >= el._misc.options.total ? true : false;
        } else {
          // Check the lower entry limit
          reached = el._misc.options.from - el._misc.options.count < 0 ? true : false;
        }
        return reached;
      },
    },
    onCreated: function () {
      var el = this;

      el._misc.options = {};
      el._misc.firstTime = true;

      eon.createCallback("onPagining", this);
      eon.createCallback("onPaginated", this);
    },
    onReady: function () {
      var el = this;

      el._setupRefs();
      el._setCount();
      el._initOptions();
      el._setPagination();
      el._setPaginingListener();
    },

    onPropertyChanged: function (attrName, oldVal, newVal) {
      switch (attrName) {
        case "count":
          this._setCount();
          break;
      }
    }
  });
</script>