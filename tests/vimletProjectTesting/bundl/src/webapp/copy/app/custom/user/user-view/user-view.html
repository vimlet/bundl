<style>
  user-view .form-swiper eon-swiper-slide {
    align-items: inherit;
    padding: 0;
    box-sizing: border-box;
  }

  user-view .form-swiper .swipeButtons {
    margin: 0 0 15px 0;
  }

  user-view eon-form {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    padding: 0;
  }

  user-view .swipeButtons {
    align-self: flex-start;
  }

  user-view .toPassButton {
    margin: 20px 0 !important;
  }
</style>
<template>
  <!-- USER SETTINGS -->
  <div class="title-row workspace-node">
    <eon-variable class="section-title eon-fg-h1" bind="locale.user.title" global="true"></eon-variable>
  </div>

  <div>
    <eon-swiper eon-ref="swiper" class="form-swiper" transition="500" external-slide="true">
      <!-- Main settings -->
      <eon-swiper-slide>
        <eon-form class="form user-form" eon-ref="formProfile" default-style="false">
          <eon-variable class="form-grouptitle eon-fg-h2" bind="locale.user.profileTitle" global="true">
          </eon-variable>
          <div class="form-group form-cols info-row form-marginbottom-description">
            <eon-text bind:label="global locale.user.name" class="form-text" name="name"
              label-anim="false" inline="false"></eon-text>
            <eon-combo id="combo-lan" bind:label="global locale.user.language"
              class="form-combo form-marginbottom hide-description" name="language" label-anim="false"
              inline="false">
              <eon-item value="es" display-value="EspaÃ±ol"></eon-item>
              <eon-item value="en" display-value="English"></eon-item>
            </eon-combo>
            <eon-combo bind:label="global locale.user.weekStart" class="form-combo form-marginbottom hide-description"
              name="weekStart" label-anim="false" inline="false">
              <eon-item value="1" bind:display-value="global locale.global.weekdays.monday"></eon-item>
              <eon-item value="2" bind:display-value="global locale.global.weekdays.tuesday"></eon-item>
              <eon-item value="3" bind:display-value="global locale.global.weekdays.wednesday"></eon-item>
              <eon-item value="4" bind:display-value="global locale.global.weekdays.thursday"></eon-item>
              <eon-item value="5" bind:display-value="global locale.global.weekdays.friday"></eon-item>
              <eon-item value="6" bind:display-value="global locale.global.weekdays.saturday"></eon-item>
              <eon-item value="7" bind:display-value="global locale.global.weekdays.sunday"></eon-item>
            </eon-combo>
          </div>
          <avatar-form eon-ref="avatarForm"></avatar-form>

          <div class="swipeButtons eon-fg0 toPassButton" eon-ref="toPass">
            <i class="vicon vicon-arrow-forward"></i>
            <eon-variable bind="locale.user.passTitle" global="true"></eon-variable>
          </div>

          <div class="form-actions">
            <eon-button class="delete-button" design="delete" bind:value="global locale.user.deleteTitle"
              eon-ref="deleteButton">
            </eon-button>
            <eon-button bind:value="global locale.user.saveButton" eon-ref="applyProfile"></eon-button>
          </div>
        </eon-form>
      </eon-swiper-slide>
      <!-- Change password -->
      <eon-swiper-slide>
        <div class="swipeButtons eon-fg0" eon-ref="toBack">
          <i class="vicon vicon-arrow-back"></i>
          <eon-variable bind="locale.registry.editBack" global="true"></eon-variable>
        </div>
        <eon-form class="form user-formPassword" eon-ref="formPassword" default-style="false">
          <eon-variable class="form-grouptitle eon-fg-h2" bind="locale.user.passTitle" global="true">
          </eon-variable>
          <div class="form-group form-cols info-row form-marginbottom">
            <eon-text bind:label="global locale.user.newPass" class="form-text form-marginbottom" type="password"
              name="newPassword" label-anim="false" inline="false" eon-ref="newPassword"
              bind:tooltip="global locale.user.minPass">
            </eon-text>
            <eon-text bind:label="global locale.user.confirmPass" class="form-text" type="password"
              name="confirmPassword" label-anim="false" inline="false" eon-ref="confirmNewPassword">
            </eon-text>
          </div>
          <div class="form-actions">
            <eon-button bind:value="global locale.user.saveButton" eon-ref="applyPassword"></eon-button>
          </div>
        </eon-form>
      </eon-swiper-slide>
    </eon-swiper>

    <!-- Password edit confirmation dialog -->
    <eon-dialog id="confirmationDialog" class="alertDialog confirmAlertDialog" eon-ref="confirmationDialog"
      closable="false" modal="true" default-style="false">
      <eon-section type="content">
        <eon-variable class="edit-title" bind="locale.user.alertPassword" global="true"></eon-variable>
        <eon-form class="form-confirmation" eon-ref="dialogForm" default-style="false">
          <div>
            <eon-text class="editPassword form-text" bind:label="global locale.user.password" name="password"
              type="password" label-anim="false" inline="false">
            </eon-text>
          </div>
          <div class="form-actions">
            <eon-button eon-ref="confirmationButton" bind:value="global locale.user.apply"></eon-button>
            <eon-button bind:label="global locale.user.cancel"
              onclick="document.querySelector('#confirmationDialog').close()"></eon-button>
          </div>
        </eon-form>
      </eon-section>
    </eon-dialog>
  </div>

  <!-- MASK -->
  <eon-mask>
    <div class="mask-title-row">
      <div class="mask-title eon-mask-background1"></div>
    </div>

    <div class="mask-text mask-text-large eon-mask-background1"></div>

    <div class="mask-form">
      <div class="mask-row settings-mask-row">
        <div class="mask-field">
          <div class="mask-text eon-mask-background1"></div>
          <div class="mask-field-text eon-mask-background1"></div>
        </div>
        <div class="mask-field">
          <div class="mask-text eon-mask-background1"></div>
          <div class="mask-field-text eon-mask-background1"></div>
        </div>
      </div>

      <div class="mask-field mask-margin-top">
        <div class="mask-text eon-mask-background1"></div>
        <div class="mask-field-text eon-mask-background1"></div>
      </div>
    </div>

    <div class="mask-text mask-text-large mask-margin-top eon-mask-background1"></div>

    <div class="mask-row settings-mask-row mask-margin-top">
      <div class="mask-button-rect mask-margin-top eon-mask-background1"></div>
      <div class="mask-field-text mask-margin-top eon-mask-background1"></div>
    </div>

    <div class="mask-text mask-margin-top eon-mask-background1"></div>

    <div class="mask-row settings-mask-row workspace-mask-actions-row mask-margin-top">
      <div class="mask-button-rect eon-mask-background1"></div>
      <div class="mask-button-rect eon-mask-background1"></div>
    </div>
  </eon-mask>
</template>
<script>
  eon.element({
    name: "user-view",
    parse: true,

    dependencies: [
      "@ui/eon-dialog",
      "@ui/eon-combo",
      "@ui/eon-form",
      "@ui/eon-text",
      "@ui/eon-button",
      "@ui/eon-swiper",
      "avatar-form"
    ],

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      refresh: function () {
        var el = this;

        // CHECK
        if (app.isInWizard && app.isFirstVisit) {
          app.wizard.close();
        }

        var profileData = {
          name: session.data.name,
          language: session.data.language,
          weekStart: !session.data.weekStart ? "1" : session.data.weekStart
        };
        this._refs.formProfile.setData(profileData);
      }
    },
    privateFunctions: {
      // @function _drawStatic (private)
      drawStatic: function () {
        var el = this;

        // Hide view mask after language loaded at least
        eon.onLocaleLoaded(function () {
          // Minimun mask time to avoid flickering
          setTimeout(function () {
            // Hide home mask
            mask.hideViewMask("user");
            el.hideEonMask();
          }, 100);
        });
      },
      // @function _addUserListeners(private)
      addUserListeners: function () {
        var el = this;
        // Apply changes
        el._refs.applyProfile.addEventListener("click", function (e) {
          el._refs.avatarForm.submitAvatar();
          el._submitProfile();
        });
        // Apply password changes
        el._refs.applyPassword.addEventListener("click", function (e) {
          el._validatePassword();
        });
        // Delete user
        el._refs.deleteButton.addEventListener("click", function (e) {

          getOwnWorkspaces(function (error, data) {
            if (!error) {
              var workspaces = JSON.parse(data.responseText);
              if (workspaces.length > 0) {
                var cmp = "";
                workspaces.forEach(function (element) {
                  cmp += element + "\n";
                });
                showDeleteAlert(eon.locale.user.alert.warningUserWorkspaces +
                  cmp, false, el._submitDelete);
              } else {
                showDeleteAlert(eon.locale.user.alert.warningUser, false, el._submitDelete);
              }
            } else {
              showInfoDialog(eon.locale.user.alert.deleteFail);
            }
          });
        });
      },
      // @function _submitProfile (private) [Submit profile data]
      submitProfile: function () {
        formData = this._refs.formProfile.getData();

        updateUser(formData, function (error, data) {
          if (!error) {
            window.location.href = "/app/user";
          } else {
            showInfoDialog(eon.locale.user.alert.userFail);
          }
        });
      },
      // @function validatePassword (private) [Validate new Password]
      validatePassword: function () {
        var el = this;
        formData = el._refs.formPassword.getData();


        var schema = {
          properties: {
            "newPassword": {
              required: true,
              minLength: 8,
              errorMessage: eon.locale.user.minPass,
              type: "string"
            },
            "confirmPassword": {
              required: true
            }
          }
        };

        el._refs.formPassword.validate(schema, formData, function (error) {
          if (el._refs.confirmNewPassword.value != el._refs.newPassword.value) {
            el._refs.confirmNewPassword.invalid = true;
            error = true;
          }
          if (el._refs.newPassword.value.length < 8) {
            error = true;
            el._refs.newPassword.invalid = true;
          }
          if (!error) {
            el._showEditDialog(el._submitPassword);
          }
        })
      },
      // @function submitPassword (private) [Submit password data]
      submitPassword: function () {
        var el = this;
        var formPassword = document.querySelector(".user-formPassword");
        var formConfirmation = document.querySelector(".form-confirmation");

        formData = formPassword.getData();
        formData.password = formConfirmation.getData().password;
        var schema = {
          properties: {
            "password": {
              required: true
            },
          }
        };

        formConfirmation.validate(schema, null, function (error) {
          if (!error) {
            updatePassword(formData, function (error, data) {
              if (!error) {
                session.logout();
              } else {
                showInfoDialog(eon.locale.user.alert.passFail);
              }
            });
          }
        });
      },

      // @function _submitDelete (private) [Delete account]
      submitDelete: function () {
        var el = this;
        var alertForm = document.querySelector("#deleteAlert eon-form");
        formData = alertForm.getData();
        var schema = {
          properties: {
            "deletePassword": {
              required: true
            }
          }
        };

        alertForm.validate(schema, null, function (error) {
          if (!error) {
            deleteAccount(formData, function (error, data) {
              if (!error) {
                session.logout();
              } else if (error == 401) {
                showInfoDialog(eon.locale.user.alert.wrongPass);
              } else {
                showInfoDialog(eon.locale.user.alert.deleteFail);
              }
            });
          }
        });
      },
      // @function showEditDialog (public) [Edit confirmation]
      showEditDialog: function (clickFn, cb) {
        var el = this;

        el._refs.dialogForm.clear()
        if (el._refs.confirmationButton._editFn) {
          el._refs.confirmationButton.removeEventListener("click", el._refs.confirmationButton._editFn);
        }

        el._refs.confirmationButton._editFn = clickFn;

        el._refs.confirmationButton.setAttribute("onclick", "");
        el._refs.confirmationButton.addEventListener("click", el._refs.confirmationButton._editFn);

        el._refs.confirmationDialog.open();
        // Push dialog state
        pushDialogState(el._refs.confirmationDialog);
        
        el._refs.confirmationDialog.onClose(function () {
          if (cb) {
            cb();
          }
        });
      },
      // @function _setSwiperListeners(private)
      setSwiperListeners: function () {
        var el = this;

        el._refs.toPass.addEventListener("click", function () {
          el._refs.swiper.slideTo(1);
        });

        el._refs.toBack.addEventListener("click", function () {
          el._refs.swiper.slideTo(0);
        });
      }
    },
    onTransformed: function () {
      // Draw static content
      this._drawStatic();
      this._setSwiperListeners();
      this._addUserListeners();
    },
    onRender: function () {
      var el = this;

      session.onReady(function () {
        // Hide to password button for social users
        if (session.data.social) {
          el._refs.toPass.classList.add("hide");
        }
        el.refresh();
      });

      session.onWorkspaceChanged(function () {
        el.refresh();
      });
    }
  });
</script>