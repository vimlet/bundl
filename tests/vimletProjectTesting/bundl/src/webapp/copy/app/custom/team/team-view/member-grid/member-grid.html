<template>
  <div eon-ref="titles" class="grid-titles eon-sect3">

    <eon-variable bind="locale.grid.alias" global="true"></eon-variable>
    <eon-variable bind="locale.grid.role" global="true"></eon-variable>
    <!-- <eon-variable bind="locale.grid.remote" global="true"></eon-variable>
    <eon-variable bind="locale.grid.workweek" global="true"></eon-variable> -->

    <div class="cell-empty"></div>
    <div class="cell-empty"></div>

  </div>
  <div class="grid-entries" eon-ref="entries">
    <!-- MASK -->
    <div class="member-grid-mask" eon-ref="mask">
      <div class="mask-row eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>
      <div class="mask-row eon-mask-background1"></div>
    </div>
  </div>
</template>

<script>
  eon.element("member-grid", {

    style: "member-grid.css",
    parse: true,

    dependencies: [
      "@ui/eon-loading",
      "member-entry",
      "member-card"
    ],

    properties: {
      refs: {
        value: {}
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function refresh
      refresh: function (data) {
        var el = this;

        if (!el._refreshing) {
          el._refreshing = true;
          
          el.data = data;

          el.clean();

          if (el.data) {
            el._createEntries(el.data.members, el.data.workweeks);
          }
        }
      },
      // @function repaint
      repaint: function (data) {
        var el = this;
        el.clean();

        if (data) {
          el._createEntries(data.members, data.workweeks);
        }
      },
      // @function clean
      clean: function () {
        this._refs.entries.innerHTML = "";
        this._refs.entries.appendChild(this._refs.mask);
      }
    },
    privateFunctions: {
      // @function _setupRefs (private)
      setupRefs: function () {
        // this._refs.workspaceView = this.getEnclosingComponent().getEnclosingComponent();
        this._misc.entries = {};
        this._misc.srcEntries = [];
      },
      // @function _createEntries (private)
      createEntries: function (entries, workweeks) {
        var el = this;
        var fragment = document.createDocumentFragment();
        this._misc.srcEntries = entries;

        // Check device version
        var tagName = this._isDesktop() ? "member-entry" : "member-card";

        for (var key in entries) {
          var entry = entries[key];

          if (entry) {
            // Create member entry
            var entryEl = document.createElement(tagName);
            entryEl.classList.add("grid-row");

            entryEl.setValues(entry, key, workweeks[entry.workweek]);

            this._misc.entries[key] = entryEl;

            entryEl.onEdit(function () {
              eon.triggerCallback("onEditMember", el, el, [this]);
            });
            entryEl.onReinvite(function () {
              eon.triggerCallback("onReinviteMember", el, el, [this]);
            });

            fragment.appendChild(entryEl);
          }
        }

        var entriesKeys = entries ? Object.keys(entries) : [];
        // Show no entries message if needed
        if (entriesKeys && entriesKeys.length < 1) {
          if (!this._refs.placeHolder) {
            this._refs.placeHolder = createPlaceHolderText(eon.locale.global.noContent);
          }
          fragment.appendChild(this._refs.placeHolder);

          this._refs.entries.classList.add("grid-empty");
        } else {
          this._refs.entries.classList.remove("grid-empty");
        }

        mask.hideViewMask("member-grid");

        this._refs.entries.appendChild(fragment);
        el._refreshing = false;
      },
      // @function _isDesktop (private)
      isDesktop: function (entries) {
        if (eon.util.isTouchScreen() || window.innerWidth <= 1024) {
          this._misc.desktop = false;
        } else {
          this._misc.desktop = true;
        }

        return this._misc.desktop;
      }
    },
    onCreated: function () {
      var el = this;
      eon.createCallback("onEditMember", el);
      eon.createCallback("onReinviteMember", el);
    },
    onTransformed: function () {
      var el = this;
      el._setupRefs();

      // STUDY Triggers twice!
      // session.onReady(function() {
      //   el.refresh();
      // });
      // session.onWorkspaceChanged(function () {
      //   el.refresh();
      // });
    },

    onWindowResize: function () {
      var throttled = false;
      var delay = 10;

      // Decrease resize calls
      if (!throttled) {
        throttled = true;
        // Check resolution
        var isDesktop = eon.util.isTouchScreen() || window.innerWidth <= 1024 ? false : true;

        if (isDesktop && !this._misc.desktop) {
          this._misc.desktop = false;
          this.repaint(this.data);
        } else if (!isDesktop && this._misc.desktop) {
          this._misc.desktop = true;
          this.repaint(this.data);
        }

        // Set a timeout to un-throttle
        setTimeout(function () {
          throttled = false;
        }, delay);
      }
    }
  });
</script>