<template>
  <app-collapsible eon-ref="collapsible" height-goal="587" header-click="true"
    prevent-click-nodes=".cell-action .clickable">

    <eon-section type="header" class="row-header eon-unselectable">
      <div eon-ref="alias" class="cell-alias"></div>
      <div eon-ref="entry"></div>
      <div eon-ref="exit"></div>
      <div eon-ref="total"></div>
      <div eon-ref="extra"></div>

      <div eon-ref="edit" class="cell-action cell-edit vicon ticon-edit clickable">
      </div>
    </eon-section>

    <eon-section type="content" class="row-content eon-unselectable">
      <eon-loading eon-ref="mask" duration="1000" class="entry-mask" format="descendant" display="false"></eon-loading>

      <eon-variable class="card-events-title eon-fg0" bind="locale.events.events" global="true"></eon-variable>
      <eon-scroll fill="false" class="card-timeline-scroll" thickness="8">
        <div eon-ref="timeline" class="card-timeline"></div>
      </eon-scroll>

      <div eon-ref="map" class="card-map"></div>

      <eon-variable class="card-notes-title" bind="locale.events.notes" global="true"></eon-variable>
      <eon-scroll fill="false" class="card-notes-scroll" thickness="8">
        <div eon-ref="notes" class="card-notes"></div>
      </eon-scroll>
    </eon-section>

  </app-collapsible>

</template>

<script>
  eon.element("registry-entry", {

    dependencies: [
      "@custom/app-collapsible",
      "@custom/app-avatar",
      "../registry-event"
    ],

    properties: {
      refs: {
        value: {}
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function setValues
      setValues: function (data) {
        this.misc = data;

        var entryMoment, exitValue, total, extras;

        entryMoment = moment.parseZone(data.entryISO, util.isoFormat);
        exitValue = !data.exitISO ? eon.locale.registry.pending : moment.parseZone(data.exitISO, util.isoFormat);

        this._refs.entry.innerHTML = "<span class='imp'>" + entryMoment.format("HH:mm") + "&nbsp;</span>" + "<span class='sec'>&nbsp;- " + entryMoment.format("DD/MM/YY") + "</span>";

        if (exitValue.constructor === String) {
          this._refs.exit.innerHTML = "<span class='imp'>" + exitValue + "&nbsp;</span>";
        } else {
          this._refs.exit.innerHTML = "<span class='imp'>" + exitValue.format("HH:mm") + "&nbsp;</span>" + "<span class='sec'>&nbsp;- " + exitValue.format("DD/MM/YY") + "</span>";
        }

        // Set to 0 the values lower than a minute
        data.total = !data.worked || data.extra < 60000 ? 0 : data.worked;
        data.extra = !data.extra || data.extra < 60000 ? 0 : data.extra;

        total = !data.worked ? "--" : moment.duration(data.worked, "milliseconds").format("hh[h] mm[m]", { trim: false });
        extras = !data.extra ? "--" : moment.duration(data.extra, "milliseconds").format("hh[h] mm[m]", { trim: false });

        // TODO backend total based on events timings
        this._refs.total.innerHTML = "<span class='imp'>" + total + "</span>";
        this._refs.extra.innerHTML = "<span class='sec'>" + extras + "</span>";

        this._setAlias(data);
      }
    },
    privateFunctions: {
      // @function _setupAdvRefs (private)
      setupAdvRefs: function () {
        this._refs.grid = document.querySelector("registry-grid");
        this._refs.editDialog = document.querySelector("#registry-edit-dialog");
        this._refs.registryView = document.querySelector("registry-view");
      },
      // @function _setupAdminUI (private)
      setupAdminUI: function () {
        if (session.isAdmin()) {
          this._refs.edit.classList.add("visible");
          this._setupEdition();
        }
      },
      // @function _setupEdition (private)
      setupEdition: function () {
        this._editListener();
      },
      // @function _setupActions (private)
      setupActions: function () {
        var el = this;
        var data = el.misc;
        el.misc.contentLoaded = false;

        // Create content on demand
        el._refs.collapsible.onExpand(function () {
          // Collapse current expanded
          if (el._refs.grid._currentExpanded && !el.isEqualNode(el._refs.grid._currentExpanded) && el._refs.grid._currentExpanded._refs.collapsible._misc.opened) {
            // TODO make collapsible public
            el._refs.grid._currentExpanded._refs.collapsible.toggle();
          }

          el._refs.grid._currentExpanded = el;

          if (!el.misc.contentLoaded) {
            el._refs.mask.show();

            setTimeout(function () {
              el._setupTimeline(el.misc);

              el._setupNotes(el.misc);

              el._setupMaps(el.misc, function () {
                eon.onReady(function () {
                  el.misc.contentLoaded = true;
                  el._refs.mask.hide();
                });
              });
            }, 500);
          }
        });
      },
      // TODO:
      // @function _editListener (private)
      editListener: function () {
        var el = this;

        el._refs.edit.addEventListener("click", function (event) {
          event.stopPropagation();
          el._refs.editDialog._misc.data = el.misc;
          el._refs.editDialog.open();
          // Push dialog state
          pushDialogState(el._refs.editDialog);
        }, false);
      },
      // @function _setAlias (private)
      setAlias: function (data) {
        var fragment = document.createDocumentFragment();
        var text = document.createElement("span");
        text.classList.add("cell-alias-label");
        var mail = data.mail || data.userId;

        var avatar = document.createElement("app-avatar");
        avatar.userName = data.alias;
        avatar.image = "/rest/user/avatar/" + mail;

        text.innerHTML = "<span>" + data.alias + "</span>";
        text.setAttribute("title", data.alias);

        if (data.owner) {
          // Owner
          text.innerHTML += "<span class='owner-span'> (owner)</span>";
        }

        fragment.appendChild(avatar);
        fragment.appendChild(text);

        this._refs.alias.appendChild(fragment);
      },

      // @function _setupTimeline (private)
      setupTimeline: function (data) {
        var el = this;

        var pending = eon.locale.registry.pending;
        var fragment = document.createDocumentFragment();

        // Create entry event bubble
        var entryEvtNode = document.createElement("registry-event");
        entryEvtNode.name = "first";

        var entryEvtObj = el._buildEntryEvtData(data);

        entryEvtNode.setValues(entryEvtObj, el);

        entryEvtNode.onActive(function () {
          // Set event notes
          el._refs.notes.innerHTML = !this.misc.notes ? "" : this.misc.notes;
          // Set event position on the map
          el._updateMarker(this.misc);
        });
        fragment.appendChild(entryEvtNode);

        if (!isEmpty(data.events)) {

          for (var key in data.events) {
            var evtObj = data.events[key];
            // evtObj.userId = data.userId;
            // evtObj.registryId = data.id;
            var evtNode = document.createElement("registry-event");

            evtNode.setValues(evtObj, el);

            evtNode.onActive(function () {
              // Set event notes
              el._refs.notes.innerHTML = !this.misc.notes ? "" : this.misc.notes;
              // Set event position on the map
              el._updateMarker(this.misc.position);
            });

            fragment.appendChild(evtNode);
          }
        }

        // Create exit event bubble
        var exitEvtNode = document.createElement("registry-event");
        var exitEvtObj = el._buildExitEvtData(data);
        exitEvtNode.setValues(exitEvtObj, el);

        exitEvtNode.onActive(function () {
          // Set event notes
          el._refs.notes.innerHTML = !this.misc.notes ? "" : this.misc.notes;
          // Set event position on the map
          el._updateMarker(this.misc);
        });
        fragment.appendChild(exitEvtNode);
        var shadow = document.createElement("span");
        shadow.classList.add("timeline-shadow");

        fragment.appendChild(shadow);
        fragment.appendChild(shadow.cloneNode());

        el._refs.timeline.appendChild(fragment);
      },

      // @function _setupMaps (private)
      setupMaps: function (data, cb) {
        var el = this;

        // AMD Maps API import
        util.importMapsAPI();

        if (data.startLatitude && data.startLongitude) {
          // Wait until maps is ready
          app.mapsReady(function(){
            util.initGoogleMap(el._refs.map, data.startLatitude, data.startLongitude, el.misc.contentLoaded, function (map, marker) {
              el._refs.map._marker = marker;
              el._refs.map.instance = map;
  
              if (cb) {
                cb();
              }
            });
          });
        } else {
          if (cb) {
            cb();
          }
        }
      },
      // @function _updateMarker(private)
      updateMarker: function (data, cb) {
        var el = this;

        if (data) {
          data.latitude = !data.latitude ? el.misc.startLatitude : data.latitude;
          data.longitude = !data.longitude ? el.misc.startLongitude : data.longitude;

          if (data.latitude && data.longitude) {
            var latLng = new google.maps.LatLng(data.latitude, data.longitude);
            el._refs.map._marker.setPosition(latLng);
            el._refs.map.instance.panTo(el._refs.map._marker.position);
          }
        }
      },
      // @function _setupNotes(private)
      setupNotes: function (data) {
        this._refs.notes.innerHTML = !data.notes ? "" : data.notes;
      },
      // @function _buildEntryData(private)
      buildEntryEvtData: function (data) {
        var evtObj = Object.assign({}, data);
        evtObj.type = "entry";
        evtObj.latitude = evtObj.startLatitude;
        evtObj.longitude = evtObj.startLongitude;
        delete evtObj.exitUTC;
        delete evtObj.exitISO;
        delete evtObj.endLatitude;
        delete evtObj.endLongitude;

        return evtObj;
      },
      buildExitEvtData: function (data) {
        var evtObj = Object.assign({}, data);
        evtObj.type = "exit";
        evtObj.latitude = evtObj.endLatitude;
        evtObj.longitude = evtObj.endLongitude;
        delete evtObj.entryUTC;
        delete evtObj.entryISO;
        delete evtObj.startLatitude;
        delete evtObj.startLongitude;

        return evtObj;
      }
    },
    onTransformed: function () {
      var el = this;
      el._setupAdvRefs();

      session.onReady(function () {
        el._setupAdminUI();
        el._setupActions();
      });
    }

  });
</script>