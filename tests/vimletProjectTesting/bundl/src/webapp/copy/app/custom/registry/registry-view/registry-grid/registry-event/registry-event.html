<template>

  <div eon-ref="line" class="event-line eon-bg1-border"></div>

  <div eon-ref="content" class="event-content">
    <div eon-ref="bubble" class="event-bubble">
      <div eon-ref="badge" class="event-badge"></div>
    </div>
    <div eon-ref="type" class="event-type"></div>
    <div eon-ref="time" class="event-time"></div>
    <div eon-ref="date" class="event-date"></div>
  </div>

</template>

<script>
  eon.element("registry-event", {

    properties: {
      refs: {
        value: {}
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function setValues
      setValues: function (data, entryNode) {
        this.misc = data;
        this._setupBubble(data, entryNode);
        this._setupTimes(data);
        this._setupDates(data);
      },
      // @function activate
      activate: function () {
        this._refs.bubble.classList.add("active-event");
        this._refs.bubble.classList.add("eon-bg1");
        eon.triggerCallback("onActive", this, this);
      },
      // @function deactivate
      deactivate: function () {
        this._refs.bubble.classList.remove("active-event");
        this._refs.bubble.classList.remove("eon-bg1");
      }
    },
    privateFunctions: {
      // @function _setupBubble (private)
      setupBubble: function (data, entryNode) {
        var el = this;
        var icon = getEventTypeIcon(data.type);
        var iconEl = document.createElement("span");

        iconEl.classList.add("vicon", icon); 
        this._refs.bubble.appendChild(iconEl);

        // Default entry bubble active
        if(data.type == "entry") {
          this.activate();
          entryNode.activeEvent = this;
        }
        
        // Event select listener
        this._refs.bubble.addEventListener("click", function(e) {
          // Deactivate current
          if(entryNode.activeEvent) {
            entryNode.activeEvent.deactivate();
          }
          // Activate current
          entryNode.activeEvent = el;
          el.activate();
        }, false);
      },
      // @function _setupTimes (private)
      setupTimes: function (data) {
        var value = document.createElement("span");
        var entryMoment, exitValue, entryHTML, exitHTML;

        if(data.entryISO) {
          entryMoment = moment.parseZone(data.entryISO, util.isoFormat);
          entryHTML = entryMoment.format("HH:mm");
          this._refs.time.innerHTML = "<span class='imp'>" + entryHTML + "</span>";
        }
        
        if(data.exitISO) { 
          exitHTML = moment.parseZone(data.exitISO, util.isoFormat).format("HH:mm");
          this._refs.time.innerHTML +=  "&nbsp;-&nbsp;<span class='imp'>" + exitHTML + "&nbsp;</span>";
        } else {
          exitHTML = eon.locale.registry.pending;
        }

        if(data.type == "exit") {
          this._refs.time.innerHTML = "<span class='imp'>" + exitHTML + "</span>";
        }
      },
      // @function _setupDates (private)
      setupDates: function (data) {
        var dateMoment = data.entryISO ? moment.parseZone(data.entryISO, util.isoFormat) : moment.parseZone(data.exitISO, util.isoFormat);
        var dateValue = dateMoment.format("DD/MM/YY");

        if(dateValue && dateValue != "Invalid date") {
          this._refs.date.innerHTML = "<span class='sec'>&nbsp;" + dateValue + "</span>";
        }
      }
    },
    onCreated: function () {
      eon.createCallback("onActive", this);
    }

  });
</script>