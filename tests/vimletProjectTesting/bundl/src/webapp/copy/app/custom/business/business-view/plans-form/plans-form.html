<template>
  <eon-form class="plans-form" eon-ref="form" default-style="false">
    <eon-swiper eon-ref="swiper" class="form-swiper" transition="500" external-slide="true">
      <eon-swiper-slide>
        <!-- <eon-text bind:label="global locale.workspace.plans.planLabel" eon-ref="planName" class="form-text plan-field" name="name"
          label-anim="false" inline="false"></eon-text> -->

        <!-- Apply members -->
        <div eon-ref="toApplyMembers" class="swipeButtons eon-fg0">
          <i class='vicon vicon-arrow-forward'></i>
          <eon-variable bind="locale.workspace.plans.applyMember" global="true"></eon-variable>
        </div>

        <div class="form-group">
          <app-workweek eon-ref="formWorkweek"></app-workweek>
        </div>
      </eon-swiper-slide>

      <eon-swiper-slide>
        <div eon-ref="toBack" class="swipeButtons eon-fg0">
          <i class='vicon vicon-arrow-back'></i>
          <eon-variable bind="locale.workspace.plans.back" global="true"></eon-variable>
        </div>

        <div class="form-group">
          <app-user-selector class="userSelector" eon-ref="userSelector" group-selector="false" pagination="20">
          </app-user-selector>
        </div>
      </eon-swiper-slide>
    </eon-swiper>
  </eon-form>
</template>

<script>
  eon.element("plans-form", {
    style: "plans-form.css",
    parse: true,

    dependencies: [
      "@ui/eon-form",
      "@ui/eon-combo",
      "@ui/eon-swiper",
      "@ui/eon-scroll",
      "@ui/eon-check",
      "plan-day",
      "@custom/app-workweek",
      "@custom/app-user-selector"
    ],
    properties: {
      refs: {
        value: {}
      },
      // @html-attribute applyMembers (public) [Show/Hide apply to members button. Default show]
      applyMembers: {
        value: "true",
        reflect: true
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      clear: function () {
        var el = this;

        el._refs.formWorkweek.clear();
        el._refs.swiper.slideTo(0);
      },
      getData: function () {
        var formData = this._refs.form.getData();
        // Get wworkdays
        formData.name = this._refs.formWorkweek._refs.planName.value;
        formData.workdays = this._refs.formWorkweek.getData();
        formData.workweekMembers = this._refs.userSelector.getData().members.checked;

        return formData;
      },
      setData: function (data, workweekId) {
        var el = this;

        if (workweekId) {
          el._refs.form.setData({
            name: data.workweeks[workweekId].name
          });
          el._misc.workweek = workweekId;
        }

        if (data) {
          // Set workweek plans
          el._refs.formWorkweek.setData(data.workweeks[workweekId]);
        }
      },
      onSubmit: function (cb) {
        this._submitCallback = cb;
      },
      // @function setReadOnly
      setReadOnly: function () {
        this._refs.mail.readonly = true;
      },
      validate: function (schema) {
        this._refs.mail.readonly = true;
      },
      validateApply: function () {
        var el = this;
        var formData = el.getData();
        // Validate
        el._refs.form.validate(el._refs.schema, formData, function (error) {
          error = formData.workdays ? error : true;
          if (!error) {
            // Trigger submit
            el._submitCallback(error, formData);
          }
        });
      },
      // @function validateGen (public) [Validate form] @param callback [Callback called (error,data)]
      validateGen: function (callback) {
        var el = this;
        var formData = el.getData();
        el._refs.form.validate(el._refs.schema, null, function (error) {
          if (callback) {
            callback(error, formData);
          }
        });
      },
      validateDelete: function () {
        var el = this;

        openDeleteConfirmation(function () {
          // Submit delete 
          var formData = el.getData();
          formData.delete = true;

          // Trigger submit
          el._submitCallback(false, formData);
        });
      }

    },
    privateFunctions: {
      // @function _setupAdvRefs (private)
      setupAdvRefs: function () {
        this._refs.days = this.querySelectorAll("plan-day");
        this._refs.workspaceView = document.querySelector("workspace-view");
        this._refs.registryView = document.querySelector("registry-view");
        this._refs.registryView = document.querySelector("registry-view");
      },
      // @function _setupForm (private)
      setupForm: function () {
        var el = this;
        el._refs.section = this.getEnclosingComponent();
        el._refs.dialog = el._refs.section.getEnclosingComponent();
        el._refs.delete = el._refs.dialog.$1("#plans-delete");
        el._refs.apply = el._refs.dialog.$1("#plans-apply");
        el._refs.createApply = el._refs.dialog.$1("#plans-create-apply");

        el.data.workweeks = {};
        el._refs.schema = {
          properties: {
            "name": {
              required: true
            }
          }
        };

        if (el._refs.apply) {
          // Edit registry
          el._refs.apply.addEventListener("click", function (e) {
            // Submit edition
            el.validateApply();
          });
          // Delete registry
          el._refs.delete.addEventListener("click", function (e) {
            el.validateDelete();
          });
        }

        if (el._refs.createApply) {
          // Delete registry
          el._refs.createApply.addEventListener("click", function (e) {
            // Submit creation
            el.validateApply();
          });
        }
        if (!eon.util.isTrue(el.applyMembers)) {
          el._refs.toApplyMembers.classList.add("hide");
        }
      },

      // @function _getRanges (private)
      getRanges: function () {
        var el = this;
        var workweek = {
          1: [],
          2: [],
          3: [],
          4: [],
          5: [],
          6: [],
          7: []
        };
        var workday;

        var days = this._refs.days;

        for (var i = 0; i < days.length; i++) {
          var day = days[i];

          workday = workweek[i + 1];

          for (var j = 0; j < day.ranges.length; j++) {
            workday.push(day.ranges[j].getValue());
          }
        }
        return workweek;
      },
      // @function _setSwipeListeners (private)
      setSwipeListeners: function () {
        var el = this;

        el._refs.toApplyMembers.addEventListener("click", function () {
          el._refs.swiper.slideTo(1);
          el._setMembers();
        });

        el._refs.toBack.addEventListener("click", function () {
          el._refs.swiper.slideTo(0);

        });
      },
      // @function _setMembers (private)
      setMembers: function (filters) {
        var el = this;

        var workspaceId = session.data.currentWorkspaceId;
        var url = "/rest/workspace/" + workspaceId;

        eon.ajax(url, {
          params: filters,
          contentType: "application/json"
        }, function (error, data) {
          if (!error) {
            el._misc.data = JSON.parse(data.responseText);

            var checkeds = el._getChecked(el._misc.data.members);
            el._refs.userSelector.setData(el._misc.data, checkeds);
          } else if (data.status == 401) {
            session.logout();
          }
        });

      },

      // @function _getChecked (private)
      getChecked: function (members) {
        var el = this;
        var checkedMembers = [];

        for (var key in members) {
          var entry = members[key];
          if (entry) {
            if (el._refs.dialog.id == "plans-edit-dialog" && entry.workweek == el._misc.workweek) {
              checkedMembers.push(key);
            }
          }
        }
        return checkedMembers;
      },
      // @function _isDesktop (private)
      isDesktop: function () {
        if (window.innerWidth <= 600) {
          this._misc.desktop = false;
        } else {
          this._misc.desktop = true;
        }

        return this._misc.desktop;
      }

    },
    onTransformed: function () {
      var el = this;
      var pagination = el._isDesktop() ? 20 : 10;
      el._refs.userSelector.pagination = pagination;

      this._setupAdvRefs();
      this._setupForm();
      this._setSwipeListeners();
    },

    onWindowResize: function () {
      var el = this;
      var throttled = false;
      var delay = 10;
      // Decrease resize calls
      if (!throttled) {
        throttled = true;
        // Check resolution
        var isDesktop = window.innerWidth <= 600 ? false : true;

        if (isDesktop && !el._misc.desktop) {
          el._misc.desktop = true;
          el._refs.userSelector.pagination = 20;
          el._setMembers();

        } else if (!isDesktop && el._misc.desktop) {
          el._misc.desktop = false;
          el._refs.userSelector.pagination = 10;
          el._setMembers();
        }

        // Set a timeout to un-throttle
        setTimeout(function () {
          throttled = false;
        }, delay);
      }
    }
  });
</script>