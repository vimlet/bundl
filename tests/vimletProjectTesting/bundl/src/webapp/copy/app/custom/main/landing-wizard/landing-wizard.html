<template>
  <eon-dialog id="wizardDialog" data-step="init" allow-scroll="false" class="wizardDialog" modal="true" closable="false"
    default-style="false" eon-ref="wizardDialog">

    <!-- STEPS VIEWS -->
    <eon-section type="content" class="wizard-content">
      <eon-swiper eon-ref="swiper" class="form-swiper" transition="500" external-slide="true">
        <!-- WELCOME SCREEN-->
        <eon-swiper-slide eon-ref="welcomeScreen" class="main-wizard-screen">
          <eon-scroll thickness="10">
            <!-- Header -->
            <div class="wizard-column wizard-header">
              <div class="wizard-title">
                <eon-variable bind="locale.wizard.welcome" global="true"></eon-variable>
                <eon-variable class="wizard-highlight" bind="locale.wizard.workspace" global="true"></eon-variable>
              </div>
              <!-- Description -->
              <div class="wizard-description-container">
                <eon-variable class="wizard-description" bind="locale.wizard.workspaceDescription" global="true">
                </eon-variable>
              </div>
              <div class="wizard-image-container">
                <div class="wizard-image"></div>
                <div class="wizard-image-mask">
                  <div class="hexagon eon-mask-background1"></div>
                </div>
              </div>
            </div>

            <!-- Workspace form  -->
            <div class="wizard-column wizard-form wizard-margin-bottom">
              <eon-form eon-ref="form" default-style="false">
                <div class="wizard-workspace-info">
                  <eon-text eon-ref="name" bind:label="global locale.global.name"
                    bind:placeholder="global locale.wizard.workspaceNamePlaceholder" class="form-text form-marginbottom"
                    name="name" label-anim="false" inline="false">
                  </eon-text>

                  <app-color bind:label="global locale.global.color" icon="ticon-color" button="false"
                    eon-ref="colorPicker"></app-color>
                </div>
              </eon-form>
            </div>
            <!-- Resume  -->
            <div class="wizard-column wizard-resume">
              <span id="wizard-selected-color" eon-ref="resumeIcon"></span>
              <span id="wizard-selected-name" eon-ref="resumeName"></span>
            </div>
          </eon-scroll>
        </eon-swiper-slide>
        <!-- INVITE SCREEN -->
        <eon-swiper-slide eon-ref="inviteScreen" class="main-wizard-screen">
          <eon-scroll thickness="10">
            <!-- Header -->
            <div class="wizard-column wizard-header wizard-row-reverse">
              <div class="wizard-title">
                <eon-variable bind="locale.wizard.invite" global="true"></eon-variable>
                <eon-variable class="wizard-highlight" bind="locale.wizard.team" global="true"></eon-variable>
              </div>
              <div class="wizard-image-container">
                <div class="wizard-image"></div>
                <div class="wizard-image-mask">
                  <div class="hexagon eon-mask-background1"></div>
                </div>
              </div>
              <!-- Description -->
              <div class="wizard-description-container">
                <eon-variable class="wizard-description" bind="locale.wizard.inviteDescription" global="true">
                </eon-variable>
              </div>
            </div>

            <!-- Invite members form  -->
            <div class="wizard-column wizard-form wizard-invite-form">
              <eon-form eon-ref="invite-form" default-style="false">
                <eon-text eon-ref="email" bind:label="global locale.global.member"
                  bind:placeholder="global locale.wizard.inviteEmail" class="form-text" name="email" label-anim="false"
                  inline="false">
                </eon-text>
                <eon-button id="wizard-invite-button" design="filled" bind:value="global locale.global.invite"
                  eon-ref="inviteButton">
                </eon-button>
              </eon-form>
              <!-- Invitation link -->
              <div id="member-link" class="form-rows info-row invite-field" eon-ref="inviteFields">
                <div id="member-link-button" eon-ref="createLinkButton"
                  class="eon-fg2-hoverable form-marginbottom clickable">
                  <i class="vicon vicon-link"></i>
                  <eon-variable bind="locale.member.createLink" global="true"></eon-variable>
                </div>
                <div eon-ref="linkFields" id="member-link-fields" class="hide">
                  <eon-text eon-ref="linkInput" class="form-text" readonly="true" label-anim="false" inline="false">
                  </eon-text>
                  <eon-button eon-ref="copyLink" design="filled" bind:value="global locale.global.copy"></eon-button>
                </div>
                <eon-variable id="member-link-disable" class="eon-fg2-hoverable clickable hide"
                  eon-ref="disableLinkButton" bind="locale.member.disableLink" global="true"></eon-variable>
              </div>
            </div>

            <div eon-ref="members" id="wizard-members" class="wizard-column">
              <eon-scroll thickness="10">
              </eon-scroll>
            </div>

          </eon-scroll>
        </eon-swiper-slide>

      </eon-swiper>
    </eon-section>

    <!-- FOOTER NAVIGATION -->
    <eon-section type="footer" class="form-actions">
      <div class="wizard-footer">
        <eon-variable id="wizard-skip" class="hide" bind="locale.global.skip" global="true" eon-ref="skipButton">
        </eon-variable>

        <div id="wizard-nav">
          <eon-button design="filled" class="hide" bind:value="global locale.global.back" eon-ref="backButton">
          </eon-button>
          <eon-button design="filled" class="hide" bind:value="global locale.global.next" eon-ref="nextButton">
          </eon-button>
          <eon-button design="filled" class="hide done-button" bind:value="global locale.global.done"
            eon-ref="doneButton"></eon-button>
        </div>
      </div>
    </eon-section>

    <!-- <eon-loading eon-ref="mask" duration="10000" class="form-mask" format="descendant" display="false"></eon-loading> -->
  </eon-dialog>
</template>
<script>
  eon.element("landing-wizard", {
    style: "landing-wizard.css",
    parse: true,
    dependencies: [
      "@custom/app-color",
      "@ui/eon-loading"
    ],

    properties: {
      refs: {
        value: {}
      },
      // @html-attribute step (public) [Current wizard step]
      step: {
        value: "1"
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      },
      // @html-property animation (private) [Duration of animation fade]
      animation: {
        value: "200"
      }
    },
    functions: {
      // @function validateForm (private) [Initialize]
      validateForm: function (cb) {
        var el = this;
        this._refs.form.validate({
          properties: {
            "name": {
              required: true
            }
          }
        }, null, function (error) {
          if (!error) {
            if (cb) {
              cb(el._refs.form.getData());
            }
          }
        });
      }
    },
    privateFunctions: {
      // @function _init (private) [Initialize]
      init: function () {
        this._misc.currentStep = "welcome";

        app.wizard = this._refs.wizardDialog;
        this._misc.members = {};

        this._setup();
      },
      // @function _setup (private) [Setup components]
      setup: function () {
        var el = this;
        el._addListeners();
        el._setupInvListeners();
        el._stepper("welcome");
        el._refs.colorPicker.predefined = config.colors.generic.join(",");
        el._refs.colorPicker.value = config.colors.generic[Math.floor(Math.random() *
          config.colors.generic.length)];
        el._refs.resumeIcon.style.backgroundColor = el._refs.colorPicker.value;
        // el._enableNext();
      },
      // @function _addListeners (private) [Add event listeners]
      addListeners: function () {
        var el = this;
        var wImg, iImg;

        // Navigation buttons
        el._refs.skipButton.addEventListener("click", function () {
          el._done();
        });
        el._refs.backButton.addEventListener("click", function () {
          el._back();
        });
        el._refs.nextButton.addEventListener("click", function () {
          el._next();
        });
        el._refs.doneButton.addEventListener("click", function () {
          el._done();
        });

        // Load images only on opened
        this._refs.wizardDialog.onOpen(function(){
          // el._refs.mask.show();
        });
        this._refs.wizardDialog.onOpened(function(){
          wImg = document.createElement("img");
          iImg = document.createElement("img");

          wImg.src = "/app/img/wizard/wizard-landing.png";
          iImg.src = "/app/img/wizard/wizard-invite.png";

          wImg.onload = function() {
            // Set image and hide mask
            el._refs.welcomeScreen.$1(".wizard-image").classList.add("wizard-image-landing");
            el._refs.welcomeScreen.$1(".wizard-image-mask").style.opacity = 0;
          };
          iImg.onload = function() {
            // Set image and hide mask
            el._refs.inviteScreen.$1(".wizard-image").classList.add("wizard-image-invite");
            el._refs.inviteScreen.$1(".wizard-image-mask").style.opacity = 0;
          };
        });

        // Welcome listeners
        el._refs.name.addEventListener("input", function () {
          // Update resume workspace name
          el._refs.resumeName.innerHTML = this.value;
        });
        el._refs.colorPicker.onSelected(function (color) {
          el._refs.resumeIcon.style.backgroundColor = color;
        });

        // Invite listeners
        el._refs.email.addEventListener("keydown", function () {
          if (event.isComposing || event.keyCode === 229) {
            return;
          } else if (event.keyCode === 13) {
            // Submit if email is valid
            el._invite(el._refs.email.value);
          }
        })
        el._refs.inviteButton.addEventListener("click", function () {
          // Submit if email is valid
          el._invite(el._refs.email.value);
        });
      },
      // @function _invite (private) []
      invite: function (email) {
        var el = this;
        // Submit if email is valid
        if (emailIsValid(email) && !el._misc.members[email]) {
          el._refs.email.invalid = false;
          // Invite member
          inviteMember(el._misc.workspaceId, email, {}, function (error, invitation) {
            if (!error) {
              el._createMemberCard(invitation);
            } else {
              showInfoDialog(eon.locale.member.inviteSelfError);
            }
          });
        } else {
          el._refs.email.invalid = true;
        }
      },
      // @function _next (private) []
      next: function () {
        switch (this._misc.currentStep) {
          case "welcome":
            this._refs.swiper.next();
            this._stepper("invite");
            break;
          default:
            break
        }
      },
      // @function _back (private) []
      back: function () {
        switch (this._misc.currentStep) {
          case "invite":
            this._refs.swiper.prev();
            this._stepper("welcome");
            break;
          default:
            break
        }
      },
      // @function _done (private) []
      done: function () {
        app.isInWizard = false;
        this._refs.swiper.slideTo(0);
        this._refs.wizardDialog.close();
        util.deactivateFirstStepsMode();
        session.toggleAdminItems();
      },
      // @function _stepper (private) []
      stepper: function (step) {
        var el = this;
        this._misc.currentStep = step;
        var prev = this._misc.prev;

        switch (step) {
          case "welcome":

            // Toggle buttons
            this._refs.nextButton.classList.remove("hide");
            this._refs.backButton.classList.add("hide");
            this._refs.skipButton.classList.add("hide");
            this._refs.doneButton.classList.add("hide");
            break;
          case "invite":

            if (!this._misc.workspaceId) {
              // Wait for swiper translate animation
              setTimeout(function () {
                // Create a workspace
                el.validateForm(function (formData) {
                  // Get color picker value
                  formData.color = el._refs.colorPicker.value;

                  createWorkspace(formData, function (error, workspaceData) {
                    if (!error) {
                      var currentWorkspaceId = workspaceData.id;
                      el._misc.workspaceId = workspaceData.id;
                      app.isFirstVisit = false;
                      session.getSession();

                      session.data.currentWorkspaceId = currentWorkspaceId;
                      eon.triggerCallback("onWorkspaceChanged", session, session, [session.data.currentWorkspaceId]);
                    }
                  });
                });
              }, 200);
            } else {
              // Wait for swiper translate animation
              setTimeout(function () {
                // TODO - getDirty
                // Create a workspace
                el.validateForm(function (formData) {
                  // Get color picker value
                  formData.color = el._refs.colorPicker.value;

                  updateWorkspace(el._misc.workspaceId, formData, function (error, workspaceData) {
                    if (error) {
                      showInfoDialog(eon.locale.workspace.alert.editFail);
                    }
                  });
                });
              }, 200);
            }

            // Toggle buttons
            this._refs.nextButton.classList.add("hide");
            this._refs.backButton.classList.remove("hide");
            this._refs.doneButton.classList.remove("hide");
            this._refs.skipButton.classList.remove("hide");
            break
        }
      },
      // @function _createMemberCardcreateMemberCard (private) []
      createMemberCard: function (invitation) {
        var el = this;
        el._misc.members = el._misc.members || {};
        var fragment = document.createDocumentFragment();
        // Show mail and alias
        var card = document.createElement("div");
        card.classList.add("card", "wizard-member-card");

        var icon = document.createElement("span");
        var email = document.createElement("span");
        var remove = document.createElement("span");

        icon.classList.add("ticon", "vicon-contact", "wizard-member-icon");
        remove.classList.add("wizard-member-remove", "ticon", "ticon-garbage");

        remove.addEventListener("click", function () {
          el._cancelInvitation(card, invitation);
        });

        email.innerHTML = invitation.mail;

        fragment.appendChild(icon);
        fragment.appendChild(email);
        fragment.appendChild(remove);

        card.appendChild(fragment);
        this._refs.members.appendChild(card);
        el._misc.members[invitation.mail] = card;
      },
      // @function _cancelInvitation (private) []
      cancelInvitation: function (node, invitation) {
        var el = this;
        // TODO

        cancelInviteMember(invitation.workspaceId, invitation.id, function (error, data) {
          if (!error) {
            node.parentNode.removeChild(node);

            if (el._misc.members[data.mail]) {
              delete el._misc.members[data.mail];
            }
          }
        });
      },
      // @function _setFormData (private) []
      setFormData: function () {
        this._refs.name.value = eon.locale.workspace.default;
        this._refs.resumeName.innerHTML = eon.locale.workspace.default;
      },
      // @function _setupInvListeners (private)
      setupInvListeners: function () {
        var el = this;

        this._refs.createLinkButton.addEventListener("click", function (e) {
          // Create link
          if (!el._misc.linkCreated) {
            createInvitation(session.data.currentWorkspaceId, function (error, data) {
              if (!error) {
                el._misc.invitationId = data.token;
                // Show link
                el._refs.linkInput.value = data.link;
                el._refs.linkFields.classList.remove("hide");

                // Disable any other link creation
                el._disableLinkCreation();

                // Show disable current link action
                el._refs.disableLinkButton.classList.remove("hide");
              }
            });
          }
        });

        // Copy link
        this._refs.copyLink.addEventListener("click", function () {
          el._refs.linkInput._refs.input.select();
          document.execCommand("copy");
        });

        // TODO Disable created link
        this._refs.disableLinkButton.addEventListener("click", function (e) {

          deleteInvitation(session.data.currentWorkspaceId, el._misc.invitationId, function (error, data) {
            if (!error) {
              // Hide current link related field
              el._refs.disableLinkButton.classList.add("hide");
              el._refs.linkFields.classList.add("hide");

              // Enable link creation
              el._enableLinkCreation();
            }
          });
        });
      },
      // @function _disableLinkCreation (private)
      disableLinkCreation: function () {
        this._misc.linkCreated = true;

        this._refs.createLinkButton.classList.remove("eon-fg2-hoverable");
        this._refs.createLinkButton.classList.add("eon-fg2-disabled");
      },
      // @function _enableLinkCreation (private)
      enableLinkCreation: function () {
        this._misc.linkCreated = false;

        this._refs.createLinkButton.classList.add("eon-fg2-hoverable");
        this._refs.createLinkButton.classList.remove("eon-fg2-disabled");
      }
    },
    onTransformed: function () {
      var el = this;
      el._init();

      session.onReady(function () {
        el._setFormData();
      });
    }
  });
</script>