<template>
  <div class="grid-titles" eon-ref="titles">
    <div class="grid-placeholder"></div>

    <eon-variable bind="locale.registry.user" global="true"></eon-variable>
    <eon-variable bind="locale.registry.entry" global="true"></eon-variable>
    <eon-variable bind="locale.registry.exit" global="true"></eon-variable>
    <eon-variable bind="locale.registry.worked" global="true"></eon-variable>
    <eon-variable bind="locale.registry.extras" global="true"></eon-variable>

    <div class="cell-empty" eon-ref="edit"></div>
    <div class="cell-empty"></div>
  </div>

  <div class="grid-entries" eon-ref="entries">
    <!-- MASK -->
    <div class="registry-grid-mask" eon-ref="mask">
      <div class="registry-day-mask-title">
        <div class="registry-day-mask-title-placeholder eon-mask-background1"></div>
      </div>
      <div class="registry-day-mask-entry eon-mask-background1"></div>
      <div class="registry-day-mask-entry eon-mask-background1"></div>

      <div class="registry-grid-day">
        <div class="registry-day-mask-title">
          <div class="registry-day-mask-title-placeholder eon-mask-background1"></div>
        </div>
        <div class="registry-day-mask-entry eon-mask-background1"></div>
        <div class="registry-day-mask-entry eon-mask-background1"></div>
      </div>
    </div>
  </div>
</template>

<script>
  eon.element("registry-grid", {

    style: "registry-grid.css",
    parse: true,

    dependencies: [
      "@ui/eon-loading",
      "registry-day"
    ],

    properties: {
      refs: {
        value: {}
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function refresh
      refresh: function (filters, cb) {
        var el = this;
        if (!el._refreshing && !this._refs.registry._refreshing) {
          el._refreshing = true;

          mask.showViewMask("registry-grid");

          el.clean();

          var workspaceId = session.data.currentWorkspaceId;
          var userId = session.isAdmin() ? filters.user : session.data.id;
          delete filters.user;

          readRegistry(workspaceId, userId, filters, function (error, data) {
            if (!error) {
              el._refs.registry.setCurrent(data);
              // :: Grid element API 
              el._createEntries(data);
              el._refs.registry.setPaging(data);

              if (cb) {
                cb();
              }
            }
          });
        }
      },
      // @function repaint
      repaint: function (data) {
        var el = this;
        el.clean();

        if (data) {
          el._createEntries(data);
        }
      },
      // @function clean
      clean: function () {
        this._refs.entries.innerHTML = "";
        this._refs.entries.appendChild(this._refs.mask);
      }
    },
    privateFunctions: {
      // @function _setupRefs (private)
      setupRefs: function () {
        this._refs.registry = this.getEnclosingComponent();
        this._misc.entries = {};
        this._misc.srcData = [];
      },
      // @function _setupAdminUI (private)
      setupAdminUI: function () {
        if (session.isAdmin()) {
          // Display edit column
          this._refs.edit.classList.add("visible");
        }
      },
      // @function _createEntries (private)
      createEntries: function (data) {
        this._misc.srcData = data;
        data = this._groupByDay(data);
      },
      // @function _groupByDay (private)
      groupByDay: function (data) {
        var days = {};
        var fragment = document.createDocumentFragment();
        var day, dayNode, dayTitle;
        var tagName = this._isDesktop() ? "registry-entry" : "registry-card";
        var momentEs; 

        for (var i = 0; i < data.entries.length; i++) {
          var reg = data.entries[i];

          // Currently deleted users registries are not displayed
          // TODO: Control when a user has been deleted, to show their registries
          if (reg && data.members[reg.userId]) {

            dayMoment = moment.parseZone(reg.entryISO, util.isoFormat);
            day = dayMoment.format("MMMMD");

            if (!days[day]) {
              // Create day block
              dayNode = document.createElement("registry-day");

              dayNode.head = dayMoment.format("MMMM D dddd");
              days[day] = dayNode;
              fragment.appendChild(dayNode);
            }

            // Create entry
            var entryEl = document.createElement(tagName);
            entryEl.classList.add("grid-row");
            // Inject member alias
            reg.alias = data.members[reg.userId].alias;
            reg.owner = data.members[reg.userId].owner;

            entryEl.setValues(reg);

            // Append entry to day block
            this._misc.entries[reg.registryId] = entryEl;
            days[day].appendChild(entryEl);
          }
        }
        // Show no entries message if needed
        if (data.entries.length < 1) {
          if (!this._refs.placeHolder) {
            this._refs.placeHolder = createPlaceHolder(eon.locale.global.noContent, "img/no-content/no-content.svg", eon.locale.global.noContentTitle);
          
            // Go to clockin veiw
            var goToClockin = document.createElement("div");
            goToClockin.classList.add("add-new", "eon-fg0");
            goToClockin.addEventListener("click", function () {
              // TODO - Open new project dialog at projects view
              showView("home", {sub: "clockin"});
            });
            goToClockin.innerText = eon.locale.home.goToClockin;
            this._refs.placeHolder.appendChild(goToClockin);
          }
          this._refs.entries.classList.add("grid-empty");
          fragment.appendChild(this._refs.placeHolder);
        } else {
          this._refs.entries.classList.remove("grid-empty");
        }

        // For each entry, create day block
        this._refs.entries.appendChild(fragment);

        mask.hideViewMask("registry-grid");
        // Create and insert before header entry
        return data;
      },
      // @function _isDesktop (private)
      isDesktop: function (entries) {
        if (eon.util.isTouchScreen() || window.innerWidth <= 1024) {
          this._misc.desktop = false;
        } else {
          this._misc.desktop = true;
        }

        return this._misc.desktop;
      }
    },
    onCreated: function () {
      var el = this;
      this._setupRefs();

      session.onReady(function () {
        el._setupAdminUI();
      });
    },
    onWindowResize: function () {
      var throttled = false;
      var delay = 10;

      // Decrease resize calls
      if (!throttled) {
        throttled = true;
        // Check resolution
        var isDesktop = eon.util.isTouchScreen() || window.innerWidth <= 1024 ? false : true;

        if (isDesktop && !this._misc.desktop) {
          this._misc.desktop = false;
          this.repaint(this._misc.srcData)
        } else if (!isDesktop && this._misc.desktop) {
          this._misc.desktop = true;
          this.repaint(this._misc.srcData)
        }

        // Set a timeout to un-throttle
        setTimeout(function () {
          throttled = false;
        }, delay);
      }
    }
  });
</script>