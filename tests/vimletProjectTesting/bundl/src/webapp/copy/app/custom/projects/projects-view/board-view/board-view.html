<template>
  <eon-scroll thickness="10" static="true" type="horizontal">
    <div class="board-view-content">
      <div class="board-view-content-columns" eon-ref="columns">
      </div>
      <app-add-new label="locale.projects.board.addList" bind:placeholder="global locale.global.typeName"
        class="board-view-add-list" eon-ref="addList"></app-add-new>
    </div>
  </eon-scroll>

  <!-- MASK -->
  <eon-mask class="section expanded">
    <div class="mask-row-container">
      <div class="mask-column eon-mask-background1"></div>
      <div class="mask-column eon-mask-background1"></div>
      <div class="mask-column eon-mask-background1"></div>
      <div class="mask-column eon-mask-background1"></div>
    </div>
  </eon-mask>
</template>

<script>
  eon.element("board-view", {
    style: "board-view.css",
    dependencies: [
      "@ui/eon-button",
      "@ui/eon-label",
      "@ui/eon-text",
      "@ui/eon-combo",
      "@custom/app-toggle-menu",
      "@ui/eon-scroll",
      "@ui/eon-contextmenu",
      "@custom/app-add-new",
      "@custom/app-editable-text",
      "@custom/app-color",
      "task-block"
    ],

    properties: {
      // @html-property board (public)
      board: {
        value: "",
        observe: true
      }
    },

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function refresh (public) [Refresh data]
      refresh: function () {
        var el = this;
      },
      // @function setData (public) [Set boar data]
      setData: function (data, callback) {
        var el = this;
        el._setList(data.lists);
        eon.triggerCallback("onDataShown", el, el);
        if (callback) {
          callback();
        }
      },
      // @function setTasks (public) [Set tasks in board]
      setTasks: function (data) {
        var el = this;
        for (var key in el._misc.columns) {
          el._misc.columns[key].querySelector(".board-view-list-content").innerHTML = "";
        }
        for (var boardKey in el.board.lists.data) {
          // if (el.board.lists.data[boardKey].tasks) {
          if (!isEmpty(el.board.lists.data[boardKey].tasks)) {
            el.printTasksAsync(data, boardKey);
          } else {
            el._misc.columns[boardKey].querySelector("app-add-new").style.opacity = 1;
          }
        }
      },
      // @function printTasksAsync (public) [Print all task for a given list async] @param data @param boardKey
      printTasksAsync: function (data, boardKey) {
        var el = this;
        var length = el.board.lists.data[boardKey].tasks.length;
        var currentTask;

        function __printTask(taskData, index) {
          currentTask = el._addTask(taskData, boardKey, index);
          el._misc.columns[boardKey].querySelector(".board-view-list-content").appendChild(currentTask);
          index++;
          currentTask.onReady(function () {
            if (index == length) {
              el._misc.columns[boardKey].querySelector("app-add-new").style.opacity = 1;
            }
            if (index < length) {
              __printTask(data[el.board.lists.data[boardKey].tasks[index]], index);
            }
          });
        }
        __printTask(data[el.board.lists.data[boardKey].tasks[0]], 0);
      },
      // @function focusAddNew (public) [Focus add new task]
      focusAddNew: function (listId) {
        var el = this;
        el._misc.columns[listId].querySelector("app-add-new").focus();
      },
      // // @function wsTaskAdded (public) [Create a new task when it is added by socket] @param task @param listId @param order @param board
      // wsTaskAdded: function (task, listId, order, board) {
      //   var el = this;
      //   el.board.lists = board.lists;
      //   if (el._misc.columns[listId]) {
      //     el._misc.columns[listId].querySelector(".board-view-list-content").appendChild(el._addTask(task, listId,
      //       order));
      //     if (el.parentElement.board.tasks) {
      //       el.parentElement.board.tasks[task.id] = task;
      //     }
      //   }
      // },
      // @function listOrderChanged (public) [Update lists order] @param listsOrder
      listOrderChanged: function (listsOrder) {
        var el = this;
        for (var i = 0; i < listsOrder.length; i++) {
          el._misc.columns[listsOrder[i]].style.order = i;
          el._misc.columns[listsOrder[i]].setAttribute("listOrder", i);
        }
        for (var key in el._misc.dropColumns) {
          if (el._misc.dropColumns[key] && el._misc.dropColumns[key].parentElement) {
            el._misc.dropColumns[key].parentElement.appendChild(el._misc.dropColumns[key]);
          }
        }
      },
      // @function listDataChanged (public) [Update list data] @param data
      listDataChanged: function (data) {
        var el = this;
        for (var listId in data) {
          if (el._misc.columns[listId]) {
            if (data[listId] != null) {
              for (var key in data[listId]) {
                switch (key) {
                  case "name":
                    el._misc.columns[listId].querySelector(".board-view-list-menu-name").setValue(data[listId]
                      .name);
                    break;
                  case "color":
                    var colorHeader = el._misc.columns[listId].querySelector(".board-view-list-header-color");
                    colorHeader.style.backgroundColor = data[listId].color;
                    break;
                  case "type":
                    el._showListType(listId, data[listId].type);
                    break;
                }
              }
            } else {
              el._misc.columns[listId].parentElement.removeChild(el._misc.columns[listId]);
              var biggestIndex = 0;
              for (var key in el._misc.dropColumns) {
                key = parseInt(key);
                if (key > biggestIndex) {
                  biggestIndex = key;
                }
              }
              biggestIndex = "" + biggestIndex;
              if (el._misc.dropColumns[biggestIndex].parentElement) {
                el._misc.dropColumns[biggestIndex].parentElement.removeChild(el._misc.dropColumns[biggestIndex]);
              }
              delete el._misc.dropColumns[biggestIndex];
            }
          } else {
            el._createList(el.board.lists, listId, true);
          }
        }
      }
    },

    privateFunctions: {
      // @function _init (private)
      init: function () {
        var el = this;
        el._misc.columns = {};
        el._misc.tasks = {};
        el._misc.dropColumns = {};
        el._misc.drag = {};
        el._misc.gradients = {
          0: "linear-gradient(90deg, rgba(165,26,209,1) 0%, rgba(65,75,209,1) 100%)",
          1: "linear-gradient(90deg, rgba(0,191,205,1) 0%, rgba(0,116,38,1) 100%)",
          2: "linear-gradient(90deg, rgba(255,146,21,1) 0%, rgba(200,48,0,1) 100%)"
        }
        el._setUp();
      },
      // @function _setUp (private)
      setUp: function (value) {
        var el = this;
        el._addListeners();
        el._misc.img = {};
        el._misc.img.list = document.createElement("img");
        el._misc.img.list.src = "img/projects/list-ghost.png";
        el._misc.img.task = document.createElement("img");
        el._misc.img.task.src = "img/projects/task-ghost.png";
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        el._refs.addList.onSubmit(function (name) {
          el._addList(name);
        });
        el._socketListeners();
      },
      // @function _socketListeners (private)
      socketListeners: function () {
        var el = this;
        socket.onSocketTask(function (task) {
          el._onTaskUpdated(task);
        });
      },
      // @function _addList (private) [Add a new list] @param name
      addList: function (name) {
        var el = this;
        if (name != "") {
          eon.triggerCallback("onAddList", el, el, [name]);
        }
      },
      // @function _setList (private) [Set up lists in screen] @param lists [Lists data]
      setList: function (lists) {
        var el = this;
        el._refs.columns.innerHTML = "";
        el._misc.gradientCounter = 0;
        var firstDropColumn = document.createElement("div");
        firstDropColumn.setAttribute("listOrder", -1);
        firstDropColumn.style.order = -1;
        firstDropColumn.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        firstDropColumn.addEventListener("dragover", function (e) {
          e.preventDefault();
          el._dragover(e, this);
        });
        firstDropColumn.addEventListener("dragleave", function (e) {
          el._dragleaveList();
        });
        firstDropColumn.classList.add("board-view-content-first-drop");
        firstDropColumn.setAttribute("fixedTarget", true);
        el._misc.dropColumns[-1] = firstDropColumn;
        el._refs.columns.appendChild(firstDropColumn);
        if (lists && Object.keys(lists).length > 0) {
          el.onReady(function () {
            el._printListsAsync(lists);
          });
        }
      },
      // @function _printListsAsync (private) [Print lists to screen async] @param lists
      printListsAsync: function (lists) {
        var el = this;
        var length = lists.order.length;
        (function __printList(i) {
          if (lists.order[i]) {
            el._createList(lists, lists.order[i]);
          }
          if (i < length) {
            setTimeout(function () {
              __printList(i + 1);
            }, 1);
          } else {
            el._misc.allowTaskPainting = true;
            eon.triggerCallback("onListsShown", el, el);
          }
        }(0));
      },
      // @function _createList (private) [Set up a list in screen] @param lists [Lists data] @param key [Current list key] @param preventPlaceholder
      createList: function (lists, key, preventPlaceholder) {
        var el = this;
        var listData = lists.data[key];
        var list = document.createElement("div");
        list.classList.add("board-view-list");
        list.id = key;
        var order = lists.order.indexOf(key);
        list.style.order = order;
        list.setAttribute("listOrder", order);
        list.setAttribute("listId", listData.id);
        var coloredHeader = document.createElement("div");
        coloredHeader.setAttribute("draggable", "true");
        coloredHeader.addEventListener("dragstart", function (event) {
          event.dataTransfer.setDragImage(el._misc.img.list, 0, 0);
          el._listDragStart(event);
        });
        coloredHeader.addEventListener("dragenter", function (event) {
          event.preventDefault();
          event.stopPropagation();
        });
        coloredHeader.classList.add("board-view-list-header-color");
        coloredHeader.style.backgroundColor = listData.color || "#8c27cf";
        list.appendChild(coloredHeader);
        var menu = document.createElement("div");



        // menu.style.height = "50px";
        // menu.style.backgroundColor= "red";
        // var menuChild = document.createElement("div");
        // menuChild.innerHTML = "TEST";
        // menu.appendChild(menuChild);



        menu.setAttribute("draggable", "true");
        menu.addEventListener("dragstart", function (event) {
          event.dataTransfer.setDragImage(el._misc.img.list, 0, 0);
          el._listDragStart(event);
        });
        menu.addEventListener("dragenter", function (event) {
          event.preventDefault();
          event.stopPropagation();
        });

        menu.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        menu.addEventListener("dragover", function (e) {
          e.preventDefault();
          el._dragover(e, this);
        });
        menu.addEventListener("dragleave", function (e) {
          el._dragleaveList();
          el._dragleaveTask();
        });

        menu.classList.add("board-view-list-menu");
        menu.setAttribute("listId", list.id);
        menu.setAttribute("listMenu", list.id);
        var title = document.createElement("app-editable-text");
        title.classList.add("board-view-list-menu-name");
        title.fixedWidth = "true";
        title.setAttribute("listMenu", list.id);
        title._refs.content.setAttribute("listMenu", list.id);
        title.id = key;
        title.value = listData.name;
        title.doubleClick = true;
        title.onReady(function () {
          title.editable = "false";
        });
        title.saveOnBlur = "true";
        title.onEdit(function (value) {
          title.editable = "false";
          el._editListTitle(el._getListId(this), value);
        });
        title.onBlur(function () {
          title.editable = "false";
        });
        menu.appendChild(title);
        var type = document.createElement("div");
        type.setAttribute("fixedTarget", true);
        type.classList.add("board-view-list-menu-type");
        type.setAttribute("listMenu", list.id);
        var typeSelected = document.createElement("i");
        typeSelected.setAttribute("listMenu", list.id);
        typeSelected.setAttribute("fixedTarget", true);
        setTimeout(function () {
          el._showListType(key, listData.type);
        }, 0);
        type.appendChild(typeSelected);
        type.addEventListener("click", function () {
          typeSelector.open();
        });
        menu.appendChild(type);
        var typeSelector = document.createElement("app-toggle-menu");
        type.appendChild(typeSelector);
        typeSelector.layout = type;
        typeSelector.layoutHeight = type;
        typeSelector.childClose = true;
        typeSelector.anchor = "left";
        typeSelector.hiddenMenu = true;
        typeSelector.contentClass = "board-view-list-menu-type-content";
        var typeLabel = document.createElement("div");
        typeLabel.classList.add("app-toggle-menu-label", "eon-fg-h4");
        typeLabel.innerText = eon.locale.projects.board.type.type;
        typeSelector.addItem(typeLabel);
        var typePending = document.createElement("div");
        typePending.setAttribute("key", key);
        var typePendingTitle = document.createElement("span");
        typePendingTitle.innerText = eon.locale.projects.board.type.pending;
        var typePendingIcon = document.createElement("i");
        typePendingIcon.classList.add("vicon", "ticon-pending");
        typePending.appendChild(typePendingIcon);
        typePending.appendChild(typePendingTitle);
        typePending.classList.add("app-toggle-menu-item");
        typePending.parent = typeSelector;
        typePending.addEventListener("click", function () {
          el._editListType(this.getAttribute("key"), "pending");
          this.parent.close();
        });
        typeSelector.addItem(typePending);
        var typeInProgress = document.createElement("div");
        typeInProgress.setAttribute("key", key);
        var typeInProgressTitle = document.createElement("span");
        typeInProgressTitle.innerText = eon.locale.projects.board.type.inProgress;
        var typeInProgressIcon = document.createElement("i");
        typeInProgressIcon.classList.add("vicon", "ticon-wip");
        typeInProgress.appendChild(typeInProgressIcon);
        typeInProgress.appendChild(typeInProgressTitle);
        typeInProgress.classList.add("app-toggle-menu-item");
        typeInProgress.parent = typeSelector;
        typeInProgress.addEventListener("click", function () {
          el._editListType(this.getAttribute("key"), "inProgress");
          this.parent.close();
        });
        typeSelector.addItem(typeInProgress);
        var typeDone = document.createElement("div");
        typeDone.setAttribute("key", key);
        var typeDoneTitle = document.createElement("span");
        typeDoneTitle.innerText = eon.locale.projects.board.type.done;
        var typeDoneIcon = document.createElement("i");
        typeDoneIcon.classList.add("vicon", "ticon-done");
        typeDone.appendChild(typeDoneIcon);
        typeDone.appendChild(typeDoneTitle);
        typeDone.classList.add("app-toggle-menu-item");
        typeDone.parent = typeSelector;
        typeDone.addEventListener("click", function () {
          el._editListType(this.getAttribute("key"), "done");
          this.parent.close();
        });
        typeSelector.addItem(typeDone);
        var typeArchived = document.createElement("div");
        typeArchived.setAttribute("key", key);
        var typeArchivedTitle = document.createElement("span");
        typeArchivedTitle.innerText = eon.locale.projects.board.type.archived;
        var typeArchivedIcon = document.createElement("i");
        typeArchivedIcon.classList.add("vicon", "ticon-archived");
        typeArchived.appendChild(typeArchivedIcon);
        typeArchived.appendChild(typeArchivedTitle);
        typeArchived.classList.add("app-toggle-menu-item");
        typeArchived.parent = typeSelector;
        typeArchived.addEventListener("click", function () {
          el._editListType(this.getAttribute("key"), "archived");
          this.parent.close();
        });
        typeSelector.addItem(typeArchived);
        var combo = el._createList_options(lists, key, title);
        menu.appendChild(combo);
        list.appendChild(menu);
        var topMarginDrop = document.createElement("div");
        topMarginDrop.classList.add("board-view-list-top-margin-drop");
        topMarginDrop.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        topMarginDrop.addEventListener("dragover", function (e) {
          e.preventDefault();
          el._dragover(e, this);
        });
        topMarginDrop.addEventListener("dragleave", function (e) {
          el._dragleaveTask();
        });
        var content = document.createElement("div");
        content.classList.add("board-view-list-content");
        var scroll = document.createElement("eon-scroll");
        scroll.thickness = 5;
        scroll.static = true;
        scroll.appendChild(topMarginDrop);
        scroll.appendChild(content);
        list.appendChild(scroll);
        var addTask = document.createElement("app-add-new");
        if (!preventPlaceholder) {
          var contentLoading = document.createElement("div");
          contentLoading.classList.add("board-view-list-content-mask");
          content.appendChild(contentLoading);
        } else {
          addTask.style.opacity = 1;
        }
        addTask.setLabel("locale.projects.board.task.addTask");
        addTask.placeholder = eon.locale.global.typeName;
        addTask.closeOnEmpty = true;
        addTask.classList.add("add-task");
        addTask.setAttribute("addTask", "true");
        addTask._refs.label.setAttribute("addTask", "true");
        addTask.setAttribute("listId", listData.id);
        addTask.onSubmit(function (name) {
          eon.triggerCallback("onTaskCreated", el, el, [name, {
            listId: this.getAttribute("listId")
          }]);
        });
        addTask.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        addTask.addEventListener("dragover", function (e) {
          e.preventDefault();
          el._dragover(e, this);
        });
        addTask.addEventListener("dragleave", function (e) {
          el._dragleaveTask();
        });
        list.appendChild(addTask);
        var bottomMarginDrop = document.createElement("div");
        bottomMarginDrop.classList.add("board-view-list-bottom-margin-drop");
        // bottomMarginDrop.setAttribute("listId", list.id);
        bottomMarginDrop.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        bottomMarginDrop.addEventListener("dragover", function (e) {
          e.preventDefault();
          el._dragover(e, this);
        });
        bottomMarginDrop.addEventListener("dragleave", function (e) {
          el._dragleaveTask();
        });
        list.appendChild(addTask);
        list.appendChild(bottomMarginDrop);
        el._misc.columns[key] = list;
        el._refs.columns.appendChild(list);
        var listDrop = document.createElement("div");
        listDrop.classList.add("board-view-list-drop");
        listDrop.setAttribute("fixedTarget", true);
        el._misc.dropColumns[order] = listDrop;
        listDrop.setAttribute("listOrder", order);
        listDrop.style.order = order;
        listDrop.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        listDrop.addEventListener("dragover", function (e) {
          e.preventDefault();
        });
        listDrop.addEventListener("dragleave", function (e) {
          el._dragleaveList();
        });
        el._refs.columns.appendChild(listDrop);
      },
      // @function _createList_options (private) [Create options menu for a list] @param lists @param key
      createList_options: function (lists, key, title) {
        var el = this;
        var listData = lists.data[key];
        var combo = document.createElement("app-toggle-menu");
        combo.childClose = true;
        combo.classList.add("board-view-list-menu-combo");
        combo.setAttribute("listMenu", key);
        combo._refs.icon.setAttribute("listMenu", key);
        combo._refs.button.setAttribute("listMenu", key);
        combo.anchor = "left";
        combo.icon = "vicon-more";
        combo.contentClass = "board-view-list-menu-combo-content";
        combo.setAttribute("fixedTarget", true);
        combo._refs.icon.setAttribute("fixedTarget", true);
        combo._refs.button.setAttribute("fixedTarget", true);
        var color = document.createElement("app-toggle-menu");
        color.style.padding = "0px";
        color.childClose = true;
        color.anchor = "left";
        color.icon = "vicon-more";
        color.hiddenMenu = true;
        color.layout = el._refs.columns;
        color.contentClass = "board-view-list-menu-color-content";
        var colorPicker = document.createElement("app-color");
        colorPicker.icon = "ticon-color";
        colorPicker.setAttribute("listId", key);
        colorPicker.value = listData.color;
        colorPicker.predefined = config.colors.generic.join(",");
        // colorPicker.predefined = "#ff540d,#f81c07,#ff00df,#7b68ee,#50e3c2,#08adff,#ffcf00,#333333";
        colorPicker.button = false;
        colorPicker.onSelected(function (value) {
          combo.close();
          color.close();
          el._editListColor(this.getAttribute("listId"), value);
        });
        color.onEonOverlay(function (overlay) {
          overlay.addEventListener("click", function (event) {
            var parentRect = combo._refs.content.getBoundingClientRect();
            if (event.clientX >= parentRect.x && event.clientX <= parentRect.x + parentRect.width && event
              .clientY >= parentRect.y && event.clientY <= parentRect.y + parentRect.height) {} else {
              combo.close();
            }
          });
        });
        color.addItem(colorPicker);
        combo.addItem(color);
        var colorShow = document.createElement("div");
        colorShow.classList.add("board-view-list-menu-color");
        var colorIcon = document.createElement("i");
        colorIcon.classList.add("vicon", "ticon-color");
        colorShow.appendChild(colorIcon);
        var colorLabel = document.createElement("div");
        colorLabel.innerText = eon.locale.global.color;
        colorShow.appendChild(colorLabel);
        colorShow.classList.add("app-toggle-menu-item");
        colorShow.addEventListener("click", function () {
          color.open();
        });
        colorSeparator = document.createElement("div");
        colorSeparator.classList.add("separator");
        colorShow.appendChild(colorSeparator);
        colorAnchor = document.createElement("div");
        colorAnchor.classList.add("board-view-list-menu-color-anchor");
        colorShow.appendChild(colorAnchor);
        color.layoutHeight = colorAnchor;
        combo.addItem(colorShow);
        var editList = document.createElement("div");
        editList.setAttribute("listId", key);
        var editListTitle = document.createElement("span");
        editListTitle.innerText = eon.locale.global.edit;
        var editListIcon = document.createElement("i");
        editListIcon.classList.add("vicon", "ticon-edit");
        editList.appendChild(editListIcon);
        editList.appendChild(editListTitle);
        editList.classList.add("app-toggle-menu-item");
        editList.parent = combo;
        editList.addEventListener("click", function () {
          combo.close();
          title.editable = "true";
          title.focus();
          el._setCursorToEnd(title._refs.content);
        });
        combo.addItem(editList);
        var moveRight = document.createElement("div");
        var moveRightTitle = document.createElement("span");
        moveRightTitle.innerText = eon.locale.projects.board.moveRight;
        var moveRightIcon = document.createElement("i");
        moveRightIcon.classList.add("vicon", "vicon-arrow-forward");
        moveRight.appendChild(moveRightIcon);
        moveRight.appendChild(moveRightTitle);
        moveRight.classList.add("app-toggle-menu-item");
        moveRight.parent = combo;
        moveRight.addEventListener("click", function () {
          combo.close();
          var listOrder = el._getListOrder(this);
          var listId = el._getListId(this);
          var nextOrder = parseInt(listOrder) + 1;
          if (el.board.lists.order[nextOrder]) {
            var nextId = el.board.lists.order[nextOrder];
            var newOrder = JSON.parse(JSON.stringify(el.board.lists.order));
            newOrder[listOrder] = nextId;
            newOrder[nextOrder] = listId;
            eon.triggerCallback("onListMove", el, el, [newOrder]);
          }
        });
        combo.addItem(moveRight);
        var moveLeft = document.createElement("div");
        var moveLeftTitle = document.createElement("span");
        moveLeftTitle.innerText = eon.locale.projects.board.moveLeft;
        var moveLeftIcon = document.createElement("i");
        moveLeftIcon.classList.add("vicon", "vicon-arrow-back");
        moveLeft.appendChild(moveLeftIcon);
        moveLeft.appendChild(moveLeftTitle);
        moveLeft.parent = combo;
        moveLeft.classList.add("app-toggle-menu-item");
        moveLeft.addEventListener("click", function () {
          combo.close();
          var listOrder = el._getListOrder(this);
          var listId = el._getListId(this);
          var prevOrder = parseInt(listOrder) - 1;
          if (prevOrder > -1) {
            var prevId = el.board.lists.order[prevOrder];
            var newOrder = JSON.parse(JSON.stringify(el.board.lists.order));
            newOrder[listOrder] = prevId;
            newOrder[prevOrder] = listId;
            eon.triggerCallback("onListMove", el, el, [newOrder]);
          }
        });
        combo.addItem(moveLeft);
        var deleteList = document.createElement("div");
        deleteList.setAttribute("key", key);
        deleteList.classList.add("app-toggle-menu-item");
        deleteList.setAttribute("type", "delete");
        var deleteListTitle = document.createElement("span");
        deleteListTitle.innerText = eon.locale.global.delete;
        var deleteListIcon = document.createElement("i");
        deleteListIcon.classList.add("vicon", "vicon-bin");
        deleteList.appendChild(deleteListIcon);
        deleteList.appendChild(deleteListTitle);
        deleteList.parent = combo;
        deleteList.addEventListener("click", function () {
          combo.close();
          var listId = this.getAttribute("key");
          openDeleteConfirmation(function () {
            el._deleteList(listId);
          });
        });
        combo.addItem(deleteList);
        return combo;
      },
      // @function _editListTitle (private) [Change a list title]
      editListTitle: function (id, value) {
        var el = this;
        if (value != "" && id != value) {
          eon.triggerCallback("onEditList", el, el, [id, {
            name: value
          }]);
        }
      },
      // @function _editListType (private) [Change a list type]
      editListType: function (id, value) {
        var el = this;
        if (value != "" && id != value) {
          var icon = el._misc.columns[id].querySelector(".board-view-list-menu-type").querySelector("i");
          icon.className = "vicon";
          switch (value) {
            case "pending":
              icon.classList.add("ticon-pending");
              break;
            case "inProgress":
              icon.classList.add("ticon-wip");
              break;
            case "done":
              icon.classList.add("ticon-done");
              break;
            case "archived":
              icon.classList.add("ticon-archived");
              break;
          }
          eon.triggerCallback("onEditList", el, el, [id, {
            type: value
          }]);
        }
      },
      // @function _editListColor (private) [Change a list color]
      editListColor: function (id, value) {
        var el = this;
        if (value != "" && id != value) {
          eon.triggerCallback("onEditList", el, el, [id, {
            color: value
          }]);
        }
      },
      // @function _deleteList (private) [Delete a list]
      deleteList: function (id) {
        var el = this;
        eon.triggerCallback("onDeleteList", el, el, [id]);
      },
      // @function _addTask (private) [Create a single task and return it] @param data @param listId @param order
      addTask: function (data, listId, order) {
        var el = this;
        var taskBlock = document.createElement("task-block");
        taskBlock.setAttribute("listId", listId);
        taskBlock.order = order;
        taskBlock.workspaceData = el._misc.workspaceData;
        taskBlock.board = el.board;
        taskBlock.task = data;
        taskBlock.onClick(function (taskId) {
          eon.triggerCallback("onTaskOpen", el, el, [taskId, el.board, el._misc.workspaceData]);
        });
        taskBlock.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
          e.stopPropagation();
        });
        taskBlock.addEventListener("dragover", function (e) {
          e.preventDefault();
          el._dragover(e, this);
          e.stopPropagation();
        });
        taskBlock.addEventListener("dragleave", function (e) {
          el._dragleaveTask();
        });
        taskBlock.onMoveUp(function (taskId, listId) {
          var newOrder = el.board.lists.data[listId].tasks.indexOf(taskId) - 1;
          if (newOrder > -1) {
            task.list(taskId, listId, newOrder);
          }
        });
        taskBlock.onMoveDown(function (taskId, listId) {
          var newOrder = el.board.lists.data[listId].tasks.indexOf(taskId) + 1;
          if (newOrder < el.board.lists.data[listId].tasks.length) {
            task.list(taskId, listId, newOrder);
          }
        });
        taskBlock.onDragstart(function (event) {
          el._misc.drag.taskId = event.target.task.id;
          el._misc.drag.type = "task";
          event.dataTransfer.setDragImage(el._misc.img.task, 0, 0);
        });
        // taskBlock.onTouchstart(function (event) {
        //   el._misc.drag.taskId = event.target.task.id;
        //   el._misc.drag.type = "task";
        // });    
        taskBlock.onReady(function () {
          this.style.opacity = 1;
        });
        el._misc.tasks[taskBlock.task.id] = taskBlock;
        return taskBlock;
      },
      // @function _drop (private) [Trigger when drop anything and distribute it]
      drop: function (e, target) {
        var el = this;
        // if (e.dataTransfer.getData("Type") === "list") {
        if (el._misc.drag.type === "list") {
          el._dragleaveList();
          el._dropList(e, target);
        } else {
          el._dropTask(e, target);
        }
      },
      // @function _dropTask (private) [Drop event triggered on list] @param e [event] @param target [Target list]
      dropTask: function (e, target) {
        var el = this;
        var taskId = el._misc.drag.taskId;
        if (!target.classList.contains("board-view-list-drop") && !target.classList.contains(
            "board-view-content-first-drop")) {
          if (target.getAttribute("addTask") || target.classList.contains("board-view-list-bottom-margin-drop")) {
            var order = el.board.lists.data[el._getListId(target)].tasks ? el.board.lists.data[el._getListId(
              target)].tasks.length : 0;
            task.list(taskId, el._getListId(target), order);
          } else if (target.classList.contains("board-view-list-menu") || target.classList.contains(
              "board-view-list-top-margin-drop")) {                 
            task.list(taskId, el._getListId(target), 0);
          } else {                        
            var oldOrder = parseInt(el._misc.tasks[el._misc.drag.taskId].order);
            var order;
            if (target.task.id && target.task.id != taskId) {
              var order = target.order + 1;
              var rect = target.getBoundingClientRect();
              var y = e.clientY - rect.top;
              if (y < (rect.height / 2)) {
                order--;
              }
              var targetList = el._getListId(target);              
              if (oldOrder < order && targetList === el._getListId(el._misc.tasks[el._misc.drag.taskId])) {
                order--;
              }
              task.list(taskId, targetList, order);
            }
          }
          el._dragleaveTask();
        }
      },
      // @function _dropList (private) [Drop event triggered on list] @param e [event] @param target [Target list] 
      dropList: function (e, target) {
        var el = this;
        var currentList = el._misc.drag.list;
        var targetPosition = parseInt(el._getListOrder(target));
        if (!target.getAttribute("fixedTarget")) {
          var rect = e.target.getBoundingClientRect();
          var x = e.clientX - rect.left;
          if (x < (rect.width / 2)) {
            targetPosition = targetPosition - 1;
          }
        }
        var currentListOrder = el.board.lists.order.indexOf(currentList);
        if (currentListOrder != targetPosition && currentListOrder != parseInt(targetPosition) + 1) {
          if (targetPosition < currentListOrder) {
            targetPosition = targetPosition + 1;
          }
          var newOrder = JSON.parse(JSON.stringify(el.board.lists.order));
          var currentListIndex = newOrder.indexOf(currentList);
          newOrder.splice(currentListIndex, 1);
          newOrder.splice(targetPosition, 0, currentList);
          if (newOrder != el.board.lists.order) {
            eon.triggerCallback("onListMove", el, el, [newOrder]);
          }
        }
      },
      // @function _getListOrder (private) [Get order for current element]
      getListOrder: function (target) {
        var el = this;
        var listOrder = target.getAttribute("listOrder");
        while (!listOrder) {
          target = target.parentElement;
          listOrder = target.getAttribute("listOrder");
        }
        return listOrder;
      },
      // @function _getListId (private) [Get id for current element]
      getListId: function (target) {
        var el = this;
        var listId = target.getAttribute("listId");
        while (!listId) {
          target = target.parentElement;
          listId = target.getAttribute("listId");
        }
        return listId;
      },
      // @function _isOrderChanging (private) [Check if order is changing for a dropped element]
      isOrderChanging: function (taskId, target) {
        var el = this;
        if (el.parentElement.board.tasks[taskId] && el.parentElement.board.tasks[taskId].order - 1 != target
          .order) {
          return true;
        }
        return false;
      },
      // @function _onTaskMoved (private) [Actions when a task is moved to another list] @param taskId @param listId @param newVal
      onTaskMoved: function (taskId, listId, newVal) {
        var el = this;
        el._misc.columns[listId].querySelector(".board-view-list-content")
          .appendChild(el._misc.tasks[taskId]);
        el._misc.tasks[taskId].setAttribute("listId", listId);
        for (var boardKey in newVal.lists.data) {
          if (newVal.lists.data[boardKey].tasks) {
            for (var i = 0; i < newVal.lists.data[boardKey].tasks.length; i++) {
              if (el._misc.tasks[newVal.lists.data[boardKey].tasks[i]]) {
                el._misc.tasks[newVal.lists.data[boardKey].tasks[i]].style
                  .order = i;
                el._misc.tasks[newVal.lists.data[boardKey].tasks[i]]
                  .setAttribute("order", i);
              }
            }
          }
        }
      },
      // @function _onTaskUpdated (private) [Actions when a task is updated] @param task
      onTaskUpdated: function (task) {
        var el = this;
        // task.board = el.board; // TODO 
        if (el._misc.tasks[task.id]) {
          el._misc.tasks[task.id].task = task;
        }
        if (el.parentElement.board.tasks && el.parentElement.board.tasks[task.id]) {
          el.parentElement.board.tasks[task.id] = task;
        }
      },
      // @function _onTaskDeleted (private) [Actions when a task is deleted] @param taskId
      onTaskDeleted: function (taskId) {
        var el = this;
        if (el._misc.tasks[taskId] && el._misc.tasks[taskId].parentElement) {
          el._misc.tasks[taskId].parentElement.removeChild(el._misc.tasks[taskId]);
        }
      },
      // @function _onLabelUpdated (private) [Actions when a label is updated] @param board
      onLabelUpdated: function (board) {
        var el = this;
        for (var key in el._misc.tasks) {
          el._misc.tasks[key].board = board;
        }
      },
      // @function _setCursorToEnd (private) [Set cursor position at the end] @param el
      setCursorToEnd: function (el) {
        // el.focus();
        if (typeof window.getSelection != "undefined" &&
          typeof document.createRange != "undefined") {
          var range = document.createRange();
          range.selectNodeContents(el);
          range.collapse(false);
          var sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        } else if (typeof document.body.createTextRange != "undefined") {
          var textRange = document.body.createTextRange();
          textRange.moveToElementText(el);
          textRange.collapse(false);
          textRange.select();
        }
      },
      // @function _listDragStart (private) [Set up onDragStart for lists] @param event
      listDragStart: function (event) {
        var el = this;
        el._misc.drag.list = event.target.parentElement.getAttribute("listId");
        el._misc.drag.type = "list";
      },
      // @function _dragover (private) [Reflect dragover effect] @param e [Event] @param target
      dragover: function (e, target) {
        var el = this;
        if (el._misc.drag.type === "list") {
          el._dragoverList(e, target);
        } else if (el._misc.drag.type === "task") {
          el._dragoverTask(e, target);
        }
      },
      // @function _dragoverTask (private) [Reflect dragover for tasks] @param e [Event] @param target
      dragoverTask: function (e, target) {
        var el = this;
        el._dragleaveTask();
        var taskBlock = el._getTaskBlock(e);
        if (taskBlock) {
          taskBlock.classList.add("task-view-dragover");
          el._misc.taskOver = taskBlock;
        }
      },
      // @function _dragleaveTask (private) [Remove drag over effect]
      dragleaveTask: function () {
        var el = this;
        if (el._misc.taskOver) {
          el._misc.taskOver.classList.remove("task-view-dragover");
        }
      },
      // @function _getTaskBlock (private) [Get task block from any child] @param e
      getTaskBlock: function (e) {
        var el = this;
        var target = e.target;
        if (target.classList.contains("board-view-list-top-margin-drop")) {
          return target;
        } else if (target.classList.contains("board-view-list-bottom-margin-drop")) {
          return el._getLastOrderTask(el._getListId(target));
        } else if (target.getAttribute("addTask") || target.parentElement.getAttribute("addTask")) {
          if (!target.getAttribute("addTask")) {
            target = target.parentElement;
          }
          return el._getLastOrderTask(el._getListId(target));
        } else if (target.getAttribute("listMenu") || (target.nodeName === "INPUT" && target.parentElement
            .parentElement.getAttribute("listMenu"))) {
          var listId;
          if (target.getAttribute("listMenu")) {
            listId = target.getAttribute("listMenu");
          } else {
            listId = target.parentElement.parentElement.getAttribute("listMenu");
          }
          return el._misc.columns[listId].querySelector(
            ".board-view-list-top-margin-drop");
        } else {
          while (target && target.nodeName != "TASK-BLOCK") {
            target = target.parentElement;
          }
          if (target) {
            var rect = target.getBoundingClientRect();
            var y = e.clientY - rect.top;
            if (y < (rect.height / 2)) {
              target = el._getPreviousOrderTask(target.getAttribute("listId"), target.order);
            }
          }
        }
        return target;
      },
      // @function _getPreviousOrderTask (private) [Return task-block with previous order] @param listId @param givenOrder
      getPreviousOrderTask: function (listId, givenOrder) {
        var el = this;
        var current;
        for (var key in el._misc.tasks) {
          if (el._misc.tasks[key].getAttribute("listId") === listId) {
            if (!current && el._misc.tasks[key].order < givenOrder) {
              current = el._misc.tasks[key];
            } else if (current) {
              if (el._misc.tasks[key].order > current.order && el._misc.tasks[key].order < givenOrder) {
                current = el._misc.tasks[key];
              }
            }
          }
        }
        if (!current) {
          current = el._misc.columns[listId].querySelector(".board-view-list-top-margin-drop");
        }
        return current;
      },
      // @function _getLastOrderTask (private) [Return task-block with higher order] @param listId
      getLastOrderTask: function (listId) {
        var el = this;
        var current;
        for (var key in el._misc.tasks) {
          if (el._misc.tasks[key].getAttribute("listId") === listId) {
            if (!current) {
              current = el._misc.tasks[key];
            } else {
              if (el._misc.tasks[key].order > current.order) {
                current = el._misc.tasks[key];
              }
            }
          }
        }
        if (!current) {
          current = el._misc.columns[listId].querySelector(
            ".board-view-list-top-margin-drop");
        }
        return current;
      },
      // @function _dragoverList (private) [Reflect dragover for lists] @param e [Event] @param target
      dragoverList: function (e, target) {
        var el = this;
        var targetPosition = el._getListOrder(target);
        if (!e.target.getAttribute("fixedTarget")) {
          var rect = e.target.getBoundingClientRect();
          var x = e.clientX - rect.left;
          if (x < (rect.width / 2)) {
            targetPosition = "" + (parseInt(targetPosition) - 1);
          }
        }
        el._dragleaveList();
        el._misc.dropColumns[targetPosition].classList.add("board-view-dragover");
      },
      // @function _dragleaveList (private) [Remove drag over effect]
      dragleaveList: function () {
        var el = this;
        for (var key in el._misc.dropColumns) {
          el._misc.dropColumns[key].classList.remove("board-view-dragover");
        }
      },
      // @function _showListType (private) [Show list type on screen]
      showListType: function (listId, type) {
        var el = this;
        var typeMenu = el._misc.columns[listId].querySelector(".board-view-list-menu-type").querySelector("i");
        typeMenu.className = "vicon";
        switch (type) {
          case "pending":
            typeMenu.classList.add("ticon-pending");
            break;
          case "inProgress":
            typeMenu.classList.add("ticon-wip");
            break;
          case "done":
            typeMenu.classList.add("ticon-done");
            break;
          case "archived":
            typeMenu.classList.add("ticon-archived");
            break;
        }
      },
      // @function _getColumnOrder (private) [Get column order given a list id]
      getColumnOrder: function (listId) {
        var el = this;
        // var columnOrder;
        // for (var key in el.board.lists) {
        //   if (el.board.lists[key].id == listId) {
        //     columnOrder = key;
        //   }
        // }
        // return columnOrder;
        return el.board.lists.order.indexOf(listId);
      },
      // @function _printNewTask (private) [Print new task to screen] @param taskData @param order
      printNewTask: function (taskData, order) {
        var el = this;
        el._misc.columns[taskData.listId].querySelector(".board-view-list-content").appendChild(el._addTask(
          taskData, taskData.listId, order));
      }
    },


    onCreated: function () {
      var el = this;
      eon.createCallback("onTaskOpen", el);
      eon.createCallback("onTaskCreated", el);
      eon.createCallback("onListMove", el);
      eon.createCallback("onDataShown", el);
      eon.createCallback("onListsShown", el);
      eon.createCallback("onAddList", el);
      eon.createCallback("onDeleteList", el);
      eon.createCallback("onEditList", el);
    },

    onRender: function () {
      var el = this;
      el._init();
    },

    onPropertyChanged: function (key, oldVal, newVal) {
      var el = this;
      switch (key) {
        case "board":
          if (oldVal.id != newVal.id) {
            el._refs.columns.innerHTML = "";
            if (el.parentElement.id) {
              setTimeout(function () {
                el.setData(newVal, function () {
                  setTimeout(function () {
                    el.onListsShown(function () {
                      if (el._misc.allowTaskPainting) {
                        el.setTasks(el.parentElement.board.tasks);
                        el._misc.allowTaskPainting = false;
                      }
                    });
                  }, 0);
                });
              }, 0);
            }
          } else {

            eon.triggerCallback("onDataShown", el, el);

            // var oldValClean = {};
            // for(var key in oldVal){              
            //   if(key.substring(0,2) != "__"){
            //     oldValClean[key] = oldVal[key];
            //   }
            // }
            // var diffs = differ.compare(oldValClean, newVal, {

            var diffs = differ.compare(oldVal, newVal, {
              arrayOrder: true
            });
            if (Object.keys(diffs).length > 0) {
              for (var key in diffs) {
                switch (key) {
                  case "users":
                    // TODO
                    break;
                  case "groups":
                    // TODO
                    break;
                  case "labels":
                    setTimeout(function () {
                      for (var key in diffs.labels) {
                        if (diffs.labels[key] != null) {
                          el.board.labels[key] = el.board.labels[key] || {}
                          for (var labelKey in diffs.labels[key]) {
                            el.board.labels[key][labelKey] = diffs.labels[key][labelKey];
                          }
                        } else {
                          delete el.board.labels[key];
                        }
                      }
                      el._onLabelUpdated(el.board);
                    }, 0);
                    break;
                  case "lists":
                    // Set data first
                    if (diffs.lists.data) {
                      for (var listId in diffs.lists.data) {
                        if (diffs.lists.data[listId] != null) {
                          if (el.board.lists.data[listId]) {
                            for (var key in diffs.lists.data[listId]) {
                              switch (key) {
                                case "tasks":
                                  if (newVal.lists.data[listId][key]) {
                                    for (var taskIndex = 0; taskIndex < newVal.lists.data[listId][key]
                                      .length; taskIndex++) {
                                      // New task
                                      if (!el._misc.tasks[newVal.lists.data[listId][key][taskIndex]]) {
                                        task.get(newVal.lists.data[listId][key][taskIndex], function (error,
                                          taskData) {
                                          if (!error) {
                                            var order = newVal.lists.data[listId][key].indexOf(taskData.id);
                                            el._printNewTask(taskData, order);
                                          }
                                        })
                                      } else {
                                        if (el._misc.tasks[newVal.lists.data[listId][key][taskIndex]]
                                          .getAttribute(
                                            "listId") != listId) {
                                          el._onTaskMoved(newVal.lists.data[listId][key][taskIndex], listId,
                                            newVal);
                                        } else {
                                          el._misc.tasks[newVal.lists.data[listId][key][taskIndex]].style.order =
                                            taskIndex;
                                          el._misc.tasks[newVal.lists.data[listId][key][taskIndex]].setAttribute(
                                            "order", taskIndex);
                                        }
                                      }
                                    }
                                  }
                                  if (el.board.lists.data[listId][key]) { // Check if an old task was deleted
                                    for (var taskIndex = 0; taskIndex < el.board.lists.data[listId][key]
                                      .length; taskIndex++) {
                                      if (newVal.lists.data[listId][key].indexOf(el.board.lists.data[listId][key][
                                          taskIndex
                                        ]) < 0) {
                                        var exists;
                                        for (var newValList in newVal.lists.data) {
                                          if (newVal.lists.data[newValList].tasks) {
                                            if (newVal.lists.data[newValList].tasks.indexOf(el.board.lists.data[
                                                  listId]
                                                .tasks[
                                                  taskIndex
                                                ]) > -1) {
                                              exists = true;
                                              break;
                                            }
                                          }
                                        }
                                        if (!exists) {
                                          if (task.status == "open" && task.id == el.board.lists.data[listId][key]
                                            [
                                              taskIndex
                                            ]) {
                                            task.close();
                                          }
                                          el._onTaskDeleted(el.board.lists.data[listId][key][taskIndex]);
                                        }
                                      }
                                    }
                                  }
                                  break;
                              }
                            }
                          } else {
                            el._createList(newVal.lists, listId, true);
                          }
                        } else {
                          el._misc.columns[listId].parentElement.removeChild(el._misc.columns[listId]);
                          var biggestIndex = 0;
                          for (var key in el._misc.dropColumns) {
                            key = parseInt(key);
                            if (key > biggestIndex) {
                              biggestIndex = key;
                            }
                          }
                          biggestIndex = "" + biggestIndex;
                          if (el._misc.dropColumns[biggestIndex].parentElement) {
                            el._misc.dropColumns[biggestIndex].parentElement.removeChild(el._misc.dropColumns[
                              biggestIndex]);
                          }
                          delete el._misc.dropColumns[biggestIndex];
                        }
                      }
                    }
                    if (diffs.lists.order) {
                      // el.board.lists.order = diffs.lists.order;
                      el.listOrderChanged(diffs.lists.order);
                    }
                    // Paint data then
                    // if (diffs.lists.data) {
                    //   el.listDataChanged(diffs.lists.data);
                    // }
                    // Order matters, first check lists.data to add/remove lists before sort them
                    // if (diffs.lists.order) {
                    //   el.listOrderChanged(diffs.lists.order);
                    // }
                    break;
                }
              }
            }
          }
          break;
      }
    }


  });
</script>