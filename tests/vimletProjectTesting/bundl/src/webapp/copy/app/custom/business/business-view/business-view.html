<style>
  /* GRID */
  business-view>.card {
    border: none !important;
  }

  business-view .grid-titles {
    margin: 20px 0px 0px 0px !important;
  }

  business-view .grid-entries {
    padding: 0 0px 10px 0px !important
  }

  /* FORM */
  business-view .info-box {
    width: 100%;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    padding: 20px 5px 0 5px;
  }

  #user-edit-dialog .form-rows {
    align-items: flex-end;
  }

  @media (max-width: 500px) {
    business-view .form-actions {
      margin-bottom: 20px;
      padding: 0 10px;
    }
  }
</style>
<template>
  <div>
    <app-generic-bar title="locale.workspace.plans.plansTitle" button="global locale.workspace.buttons.plans"
      eon-ref="plansBar">
    </app-generic-bar>
    <app-pagination eon-ref="plansPagination" container="plans-grid"></app-pagination>
    <plans-grid id="plans-grid" class="grid" eon-ref="plansGrid"></plans-grid>
  </div>

  <div>
    <app-generic-bar title="locale.workspace.userTitle" eon-ref="usersBar"></app-generic-bar>
    <app-pagination eon-ref="usersPagination" container="users-grid"></app-pagination>
    <business-user id="users-grid" class="grid" eon-ref="usersGrid"></business-user>
  </div>

  <div>
    <eon-variable class="section-title eon-fg-h1" bind="locale.business.optionsTitle" global="true"></eon-variable>
    <business-form class="info-box" eon-ref="form"></business-form>

    <div class="form-actions">
      <eon-button class="admin-info" bind:value="global locale.user.saveButton" eon-ref="saveButton"></eon-button>
    </div>
  </div>

  <!-- Edit user dialog -->
  <eon-dialog id="user-edit-dialog" class="dialog-form interactDialog"
    bind:heading="global locale.workspace.dialogTitles.editMember" modal="true" blur="true" default-style="false"
    eon-ref="editUserDialog">
    <eon-section type="content">
      <business-user-form eon-ref="userFormEdit"></business-user-form>
      <eon-loading eon-ref="userEditMask" duration="10000" class="form-mask" format="descendant" display="false">
      </eon-loading>
    </eon-section>
    <eon-section type="footer" class="form-actions">
      <eon-button id="user-apply" eon-ref="userApply" class="" bind:value="global locale.workspace.buttons.apply">
      </eon-button>
    </eon-section>
  </eon-dialog>

  <!-- Add Manage Workweek dialog -->
  <eon-dialog id="plans-add-dialog" eon-ref="managePlansDialog" class="dialog-form interactDialog" allow-scroll="false"
    default-style="false" bind:heading="global locale.business.createPlans" modal="true" blur="true">
    <eon-section type="content">
      <plans-form eon-ref="plansFormAdd"></plans-form>
    </eon-section>
    <eon-section type="footer" class="form-actions">
      <eon-button id="plans-create-apply" eon-ref="plansCreateApply" class="dialog-button"
        bind:value="global locale.global.apply">
      </eon-button>
    </eon-section>
  </eon-dialog>

  <!-- Edit Manage Workweek dialog -->
  <eon-dialog id="plans-edit-dialog" eon-ref="editPlansDialog" class="dialog-form interactDialog" allow-scroll="false"
    default-style="false" bind:heading="global locale.business.managePlans" modal="true" blur="true">
    <eon-section type="content">
      <plans-form eon-ref="plansFormEdit"></plans-form>
      <eon-loading eon-ref="workweekMask" duration="10000" class="form-mask" format="descendant" display="false">
      </eon-loading>
    </eon-section>
    <eon-section type="footer" class="form-actions">
      <eon-button id="plans-delete" eon-ref="plansDelete" design="delete" class="dialog-button delete-button"
        bind:value="global locale.global.delete"></eon-button>
      <eon-button id="plans-apply" eon-ref="plansApply" class="dialog-button" bind:value="global locale.global.apply">
      </eon-button>
    </eon-section>
  </eon-dialog>

  <!-- MASK -->
  <eon-mask>
    <div class="mask-title-row">
      <div class="mask-title eon-mask-background1"></div>
      <div class="mask-button eon-mask-background1"></div>
    </div>

    <div class="mask-row mask-grid-titles eon-mask-background1"></div>

    <div class="mask-grid-content">
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
    </div>

    <div class="mask-title-row">
      <div class="mask-title eon-mask-background1"></div>
    </div>

    <div class="mask-text eon-mask-background1"></div>
    <div class="mask-row settings-mask-row">
      <div class="mask-field-text eon-mask-background1"></div>
      <div class="mask-field-text eon-mask-background1"></div>
    </div>

    <div class="mask-row settings-mask-row workspace-mask-actions-row">
      <div class="mask-button-rect eon-mask-background1"></div>
      <div class="mask-button-rect eon-mask-background1"></div>
    </div>
  </eon-mask>

</template>
<script>
  eon.element({
    name: "business-view",
    dependencies: [
      "plans-grid",
      "plans-form",
      "business-form",
      "business-user",
      "business-user-form",
      "@custom/app-generic-bar",
      "@custom/app-pagination"
    ],
    parse: true,

    privateProperties: {
      misc: {
        value: {}
      }
    },

    functions: {
      // @function refresh (public)
      refresh: function () {
        var el = this;

        mask.showViewMask("plans-grid");
        mask.showViewMask("business-user-grid");

        el._refs.usersGrid.clean();
        el._refs.plansGrid.clean();

        if (session.isAdmin()) {
          el._loadData(null, function (error, data) {
            if (!error) {
              el._misc.data = data;
              el._refs.usersPagination.setPaginationItems(el._misc.data, "members");
              el._refs.plansPagination.setPaginationItems(el._misc.data, "workweeks");

              // Set business form data
              el._refs.form.setData(data);
            }
          });
        } else {
          // Redirect to home view
          if (document.body.dataset.view == "business") {
            showView("home");
          }
        }
      },
      // @function enableActions
      enableActions: function (applyBtn, deleteBtn) {
        // TODO
        if (applyBtn) {
          applyBtn.classList.add("enable");
        }
        if (deleteBtn) {
          deleteBtn.classList.add("enable");
        }
      },
      // @function disableActions
      disableActions: function (applyBtn, deleteBtn) {
        // TODO
        if (applyBtn) {
          applyBtn.classList.remove("enable");
        }
        if (deleteBtn) {
          deleteBtn.classList.remove("enable");
        }
      }
    },
    privateFunctions: {
      // @function _drawStatic (private)
      drawStatic: function () {
        var el = this;

        // Hide view mask after language loaded at least
        eon.onLocaleLoaded(function () {
          // Minimun mask time to avoid flickering
          setTimeout(function () {
            // Hide home mask
            mask.hideViewMask("business");
            el.hideEonMask();
          }, 100);
        });
      },
      // @function _loadData (private) [Load data from database] @param filters @param callback
      loadData: function (filters, callback) {
        var el = this;
        readWorkspace(session.data.currentWorkspaceId, function (error, data) {
          if (!error) {
            session.data.currentWorkspace = data;
            callback(null, data);
          }
        });
      },
      // @function _addListener (private)
      addListener: function () {
        var el = this;

        el._refs.usersGrid.onEditUser(function (userEntry) {
          el._refs.editUserDialog._misc.userEntry = userEntry;
          el._refs.editUserDialog.open();
          // Push dialog state
          pushDialogState(el._refs.editUserDialog);
        });

        el._userListener();


        el._refs.saveButton.addEventListener("click", function (e) {
          el._submitSettings();
        });

        el._plansListener();
      },

      // @function _userListener (private) [Manage users listeners]
      userListener: function () {
        var el = this;

        el._refs.editUserDialog.onClose(function () {
          el._refs.userEditMask.hide();
        });
        el._refs.editUserDialog.onOpen(function () {
          el._refs.userEditMask.show();
        });
        el._refs.editUserDialog.onOpened(function () {
          el._refs.userFormEdit.clear();

          readWorkspace(session.data.currentWorkspaceId, function (error, data) {
            if (!error) {
              session.data.currentWorkspace = data;
              el._refs.userFormEdit.setData(data, el._refs.editUserDialog._misc.userEntry._misc.data);

              el._refs.userEditMask.hide();
            }
          });
        });

        el._refs.userFormEdit.onSubmit(function (error, data) {
          // Inject user user id
          data.userId = el._refs.editUserDialog._misc.userEntry._misc.data.userId;

          if (!error) {
            updateMember(session.data.currentWorkspaceId, data, function (error, data) {
              if (!error) {
                el._refs.usersGrid.refresh(data);
              } else {
                showInfoDialog(eon.locale.workspace.alert.error);
              }
            });

            el._refs.editUserDialog.close();
          }
        });
      },

      // @function _plansListener (private)
      plansListener: function () {
        var el = this;

        // CREATE PLAN
        el._refs.plansBar.onButtonClick(function () {
          el._refs.managePlansDialog.open();
          // Push dialog state
          pushDialogState(el._refs.managePlansDialog);
        });
        el._refs.managePlansDialog.onClose(function () {
          document.body.classList.remove("hideScroll");
        });

        el._refs.managePlansDialog.onOpened(function () {
          el._refs.plansFormAdd.clear();
          el._refs.plansFormAdd.setData();

          el._refs.plansFormAdd._refs.formWorkweek.querySelector("eon-scroll").update();
          el.enableActions(el._refs.plansCreateApply);
        });

        el._refs.plansFormAdd.onSubmit(function (error, data) {
          if (!error) {
            createWorkweek(session.data.currentWorkspaceId, data, function (error, data) {
              if (!error) {
                var currentWorkspaceId = session.data.currentWorkspaceId;
                session.getSession(currentWorkspaceId);
                el._refs.usersGrid.refresh(data);
                el._refs.plansPagination.setPaginationItems(data, "workweeks");
              } else {
                showInfoDialog(eon.locale.workspace.alert.workweekCreationFail, function () { });
              }
            });
          }
          el._refs.managePlansDialog.close();
        });

        // EDIT PLAN
        el._refs.plansGrid.onEditPlan(function (workweekId) {
          el._refs.editPlansDialog._misc.workweekId = workweekId;
          el._refs.editPlansDialog.open();
          // Push dialog state
          pushDialogState(el._refs.editPlansDialog);
        });
        el._refs.editPlansDialog.onClose(function () {
          el._refs.workweekMask.hide();
          document.body.classList.remove("hideScroll");
        });
        el._refs.editPlansDialog.onOpen(function () {
          el._refs.workweekMask.show();
        });

        el._refs.editPlansDialog.onOpened(function () {
          el._refs.plansFormEdit.clear();
          el.disableActions(el._refs.plansApply, el._refs.plansDelete);

          readWorkspace(session.data.currentWorkspaceId, function (error, data) {
            if (!error) {
              // Update session
              session.data.currentWorkspace = data;
              el._refs.plansFormEdit.setData(data, el._refs.editPlansDialog._misc.workweekId);
              el._refs.plansFormEdit._refs.formWorkweek.querySelector("eon-scroll").update();
              el._refs.workweekMask.hide();
            }
          });
        });

        el._refs.plansFormEdit.onSubmit(function (error, data) {
          if (!error) {
            var sendData = {};
            // Check submit type
            if (data.delete) {
              delete sendData.delete;

              deleteWorkweek(session.data.currentWorkspaceId, el._refs.editPlansDialog._misc.workweekId, function (error,
                data) {
                if (!error) {
                  // Refresh plans grid
                  // TODO:
                  el._refs.usersGrid.refresh(data);
                  el._refs.plansPagination.setPaginationItems(data, "workweeks");
                } else {
                  showInfoDialog(eon.locale.workspace.alert.error);
                }
              });
            } else {
              sendData.name = data.name;
              sendData.workdays = data.workdays;
              sendData.workweekMembers = data.workweekMembers;

              updateWorkweek(session.data.currentWorkspaceId, el._refs.editPlansDialog._misc.workweekId, sendData,
                function (error, data) {
                  if (!error) {
                    // Refresh plans grid
                    el._refs.usersGrid.refresh(data);
                    el._refs.plansGrid.refresh(data);
                  } else {
                    showInfoDialog(eon.locale.workspace.alert.workweekEditFail, function () { });
                  }
                });
            }
          }
          el._refs.editPlansDialog.close();
        });
      },
      // @function _submitSettings (private)
      submitSettings: function () {
        var el = this;

        this._refs.form.validateGen(function (error, formData) {
          if (!error) {
            updateWorkspace(el._misc.data.id, formData, function (error, data) {
              if (error) {
                showInfoDialog(eon.locale.business.editFail);
              }
            });
          }
        });
      }
    },
    onTransformed: function () {
      // Draw static content
      this._drawStatic();
      this._addListener();
    },
    onReady: function () {
      var el = this;

      session.onReady(function () {
        el.refresh();
      });
      session.onWorkspaceChanged(function () {
        el.refresh();
      });
    }
  });
</script>