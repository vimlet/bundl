<template>
  <div class="wip-overlay">
    <div></div>
    <eon-variable bind="locale.global.coming" global="true"></eon-variable>
  </div>

  <eon-scroll thickness="10">
    <div class="list-view-layout">
      <div class="list-view-content" eon-ref="content">
      </div>
      <app-add-new label="locale.projects.list.addList" bind:placeholder="global locale.global.typeName"
        class="list-view-add-list" eon-ref="addList"></app-add-new>
    </div>
  </eon-scroll>
</template>

<script>
  eon.element("list-view", {
    style: "list-view.css",
    dependencies: [
      "@ui/eon-button",
      "@ui/eon-label",
      "@ui/eon-text",
      "@ui/eon-combo",
      "@custom/app-toggle-menu",
      "@ui/eon-scroll",
      "@custom/app-editable-text",
      "@ui/eon-contextmenu",
      "@custom/app-add-new"
    ],

    properties: {
      // @html-property board (public)
      board: {
        value: "",
        observe: true
      },
      // @html-property tasks (public)
      tasks: {
        value: "",
        observe: true
      }
    },

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function refresh (public) [Refresh data]
      refresh: function () {
        var el = this;
      },
      // @function setData (public) [Set boar data]
      setData: function (data, callback) {
        var el = this;
        el.setLists(data.lists);
        if (callback) {
          callback();
        }
      },
      // @function setLists (public) [Set up lists in screen] @param lists [Lists data]
      setLists: function (lists) {
        var el = this;
        el._refs.content.innerHTML = "";
        el._misc.gradientCounter = 0;
        if (lists && Object.keys(lists).length > 0) {
          el.onReady(function () {
            for (var key in lists) {
              el._createList(lists, key);
            }
          });
        }
      },
      // @function setTasks (public) [Set tasks in list]
      setTasks: function (data) {
        var el = this;
        var container = {};
        for (var key in el._misc.columns) {
          container[key] = document.createDocumentFragment();
        }
        for (var i = 0; i < data.length; i++) {
          if (data[i].list && data[i].list != "") {
            container[data[i].list].appendChild(el._addTask(data[i]));
          }
        }
        for (var key in el._misc.columns) {
          el._misc.columns[key].querySelector(".list-view-list-content").innerHTML = "";
        }
        for (var key in el._misc.columns) {
          el._misc.columns[key].querySelector(".list-view-list-content").appendChild(container[
            key]);
        }
        eon.triggerCallback("onDataShown", el, el);
      }
    },

    privateFunctions: {
      // @function _init (private)
      init: function () {
        var el = this;
        el._misc.columns = {};
        el._misc.tasks = {};
        el._misc.gradients = {
          0: "linear-gradient(90deg, rgba(165,26,209,1) 0%, rgba(65,75,209,1) 100%)",
          1: "linear-gradient(90deg, rgba(0,191,205,1) 0%, rgba(0,116,38,1) 100%)",
          2: "linear-gradient(90deg, rgba(255,146,21,1) 0%, rgba(200,48,0,1) 100%)"
        }
        el._setUp();
      },
      // @function _setUp (private)
      setUp: function (value) {
        var el = this;
        el._addListeners();
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        el._refs.addList.onSubmit(function (name) {
          el._addList(name);
        });
      },
      // @function _createList (private) [Set up a list in screen] @param lists [Lists data] @param key [Current list key]
      createList: function (lists, key) {
        var el = this;
        var listData = lists[key];
        // console.log("CREATE",listData);

        var list = document.createElement("div");
        list.classList.add("list-view-list");
        list.id = key;
        var coloredHeader = document.createElement("div");
        coloredHeader.classList.add("list-view-list-header-color");
        coloredHeader.style.background = el._misc.gradients[el._misc.gradientCounter];
        el._misc.gradientCounter = el._misc.gradientCounter + 1;
        if (el._misc.gradientCounter >= Object.keys(el._misc.gradients).length) {
          el._misc.gradientCounter = 0;
        }
        list.appendChild(coloredHeader);
        var menu = document.createElement("div");
        menu.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        menu.addEventListener("dragover", function (e) {
          e.preventDefault();
        });
        menu.classList.add("list-view-list-menu");
        menu.setAttribute("listId", list.id);
        var title = document.createElement("app-editable-text");
        title.id = key;
        title.value = listData.name;
        title.onReady(function () {
          title.editable = "false";
        });
        title.saveOnBlur = "true";
        title.onEdit(function (value) {
          title.editable = "false";
          el._editListTitle(this.id, value);
        });
        menu.appendChild(title);
        var combo = document.createElement("app-toggle-menu");
        combo.childClose = true;
        combo.classList.add("list-view-list-menu-combo");
        combo.anchor = "left";
        combo.icon = "vicon-more";
        var deleteList = document.createElement("eon-button");
        deleteList.setAttribute("key", key);
        deleteList.design = "flat";
        deleteList.icon = "<i class='vicon vicon-bin'></i>";
        deleteList.label = eon.locale.global.delete;
        deleteList.parent = combo;
        deleteList.addEventListener("click", function () {
          combo.close();
          el._deleteList(this.getAttribute("key"));
        });
        combo.addItem(deleteList);
        var editList = document.createElement("eon-button");
        editList.setAttribute("listId", key);
        editList.design = "flat";
        editList.icon = "<i class='vicon ticon-edit'></i>";
        editList.label = eon.locale.global.edit;
        editList.parent = combo;
        editList.addEventListener("click", function () {
          combo.close();
          title.editable = "true";
          title.focus();
          el._setCursorToEnd(title._refs.content);
        });
        combo.addItem(editList);
        menu.appendChild(combo);
        list.appendChild(menu);
        var topMarginDrop = document.createElement("div");
        topMarginDrop.classList.add("list-view-list-top-margin-drop");
        topMarginDrop.setAttribute("listId", list.id);
        topMarginDrop.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        topMarginDrop.addEventListener("dragover", function (e) {
          e.preventDefault();
        });
        var content = document.createElement("div");
        content.classList.add("list-view-list-content");
        var scroll = document.createElement("eon-scroll");
        scroll.thickness = 5;
        scroll.static = true;
        scroll.appendChild(topMarginDrop);
        scroll.appendChild(content);
        list.appendChild(scroll);
        var addTask = document.createElement("app-add-new");
        addTask.setLabel("locale.projects.list.task.addTask");
        addTask.placeholder = eon.locale.global.typeName;
        addTask.id = key;
        addTask.classList.add("add-task");
        addTask.setAttribute("listId", list.id);
        addTask.onSubmit(function (name) {
          el._createTask(this.id, name);
        });
        addTask.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        addTask.addEventListener("dragover", function (e) {
          e.preventDefault();
        });
        list.appendChild(addTask);
        var bottomMarginDrop = document.createElement("div");
        bottomMarginDrop.classList.add("list-view-list-bottom-margin-drop");
        bottomMarginDrop.setAttribute("listId", list.id);
        bottomMarginDrop.addEventListener("drop", function (e) {
          e.preventDefault();
          el._drop(e, this);
        });
        bottomMarginDrop.addEventListener("dragover", function (e) {
          e.preventDefault();
        });
        list.appendChild(addTask);
        list.appendChild(bottomMarginDrop);
        el._misc.columns[key] = list;
        // el._refs.content.appendChild(list);   // TODO uncomment when working
      },
      // @function _addTask (private) [Create a single task and return it] @param data
      addTask: function (data) {
        var el = this;
        var task = document.createElement("div");
        task.style.height = "50px";
        task.style.width = "100%";
        task.style.backgroundColor = "red";
        return task;
      },
    },


    onCreated: function () {
      var el = this;
      eon.createCallback("onTaskOpen", el);
      eon.createCallback("onBoardUpdated", el);
      eon.createCallback("onDataShown", el);
    },

    onRender: function () {
      var el = this;
      el._init();
    },

    onPropertyChanged: function (key, oldVal, newVal) {
      var el = this;
      switch (key) {
        case "board":
          el._refs.content.innerHTML = "";
          setTimeout(function () {
            el.setData(newVal, function () {
              el.setTasks(el.tasks);
            });
          }, 0);
          break;
      }
    }


  });
</script>