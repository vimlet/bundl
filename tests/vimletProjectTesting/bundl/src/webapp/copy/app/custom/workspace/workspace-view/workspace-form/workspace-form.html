<style>
  workspace-form {
    display: flex;
    width: 100%;
  }

  .workspace-form {
    width: 100%;
    box-sizing: border-box;
  }

  workspace-form app-places.visible-flex {
    display: block !important;
  }

  workspace-form .permissions-column {
    display: flex;
    flex-wrap: wrap;
    width: 100%;
  }

  workspace-form .default-field {
    display: flex;
    flex-direction: column;
    /* Until fields descriptions size y determined */
    height: 87px;
  }

  workspace-form app-color {
    margin-bottom: 20px;
  }
</style>
<template>
  <eon-form class="workspace-form" eon-ref="form" default-style="false">
    <!-- Workspace information -->
    <eon-variable class="form-grouptitle eon-fg-h2" bind="locale.workspace.infoTitle" global="true"></eon-variable>
    <div class="form-group">
      <div class="form-rows info-row">
        <eon-text class="form-marginbottom-description form-grow form-text" bind:label="global locale.workspace.fields.name"
          bind:placeholder="global locale.workspace.fields.namePlaceHolder" name="name" label-anim="false"
          inline="false" eon-ref="name">
        </eon-text>

        <!-- <div class="form-rows default-field">
          <eon-variable class="form-grouptitle eon-fg-h3" bind="locale.global.default" global="true"></eon-variable>
          <eon-toggle bind:label="global locale.global.default" eon-ref="default"
            class="form-marginright" name="default" label-anim="false" inline="false">
          </eon-toggle>
        </div> -->
        <!-- - *vat (CIF/NIF) -->
        <!-- <eon-text class="form-grow" bind:label="global locale.workspace.fields.VATNumber"
          bind:placeholder="global locale.workspace.fields.VATNumber" name="billing.vat" label-anim="false" inline="false"
          eon-ref="VAT">
        </eon-text> -->
      </div>
      <div class="form-rows info-row">
        <app-color value="#000000" icon="ticon-color" button="false"
          eon-ref="colorPicker"></app-color>
      </div>
    </div>
  </eon-form>
</template>

<script>
  eon.element("workspace-form", {
    parse: true,
    dependencies: [
      "@ui/eon-text",
      "@ui/eon-toggle",
      "@ui/eon-form",
      "@custom/app-places",
      "@custom/app-color"
    ],
    properties: {
      standalone: {
        value: true
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      clear: function () {
        this._refs.form.clear();
      },
      getData: function (data) {
        var formData = this._refs.form.getData();
        return formData;
      },
      setData: function (data) {
        if(data) {
          this._refs.colorPicker.value = data.color;
  
          // Make info read only if the user is not admin
          if (data.role == "user") {
            this._refs.name.onReady(function () {
              this.readonly = true;
            });
            // TODO Make color picker readonly as well
            this._refs.colorPicker.onReady(function () {
              this.readonly = true;
            });
          } else {
            this._refs.name.onReady(function () {
              this.readonly = false
            });

            // TODO Make color picker editable as well
            this._refs.colorPicker.onReady(function () {
              this.readonly = false;
            });
          }
  
          this._refs.form.setData(data);
          // console.log("SET", session.data.currentWorkspaceId, session.data.defaultWorkspace);
          // this._refs.default.checked = session.data.currentWorkspaceId == session.data.defaultWorkspace;
        }
      },
      onSubmit: function (cb) {
        this._submitCallback = cb;
      },
      validate: function () {
        var el = this;
        // Submit edition
        var formData = this.getData();

        formData.color = this._refs.colorPicker.value;

        // Validate
        el._refs.form.validate(el._refs.schema, null, function (error) {
          // Trigger submit
          el._submitCallback(error, formData);
        });
      },
      // @function validateGen (public) [Validate form] @param callback [Callback called (error,data)]
      validateGen: function (callback) {
        var el = this;
        var formData = this.getData();

        formData.color = this._refs.colorPicker.value;
        
        el._refs.form.validate(el._refs.schema, null, function (error) {
          if (callback) {
            callback(error, formData);
          }
        });
      },
      validateDelete: function () {
        var el = this;


      }
    },
    privateFunctions: {
      // @function _setupForm (private)
      setupForm: function () {
        var el = this;
        el._refs.colorPicker.predefined = config.colors.generic.join(",");
        this._refs.colorPicker.label = eon.locale.global.color;

        if (!eon.util.isTrue(el.standalone)) {
          el._refs.section = this.getEnclosingComponent();
          el._refs.scroll = el._refs.section.getEnclosingComponent();
          el._refs.dialog = el._refs.scroll.getEnclosingComponent();
          el._refs.apply = el._refs.dialog.$1("#workspace-apply");
          el._refs.createApply = el._refs.dialog.$1("#workspace-create-apply");
        }

        el._refs.schema = {
          properties: {
            "name": {
              required: true
            },
            "color": {
              required: false
            },
            "default": {
              required: false
            }
          }
        };

        if (el._refs.apply) {
          // Edit workspace
          el._refs.apply.addEventListener("click", function (e) {
            // Submit edition
            el.validate();
          });
        }

        if (el._refs.createApply) {
          // Create workspace
          el._refs.createApply.addEventListener("click", function (e) {
            // Submit creation
            el.validate();
          });
        }
      }
    },
    onTransformed: function () {      
      this._setupForm();
    }
  });
</script>