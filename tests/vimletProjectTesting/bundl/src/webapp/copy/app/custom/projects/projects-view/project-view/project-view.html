<template>
  <div class="title-row">
    <!-- Breadcrumb -->
    <div class="breadcrumb-menu">
      <span eon-ref="back"
        class="breadcrumb-back eon-fg-h1 eon-fg-h1-hoverable ticon vicon-arrow-back clickable"></span>
      <eon-variable eon-ref="breadcrumbPrev" class="breadcrumb-prev eon-fg-h1-breadcrumb eon-fg-h1-hoverable"
        bind="locale.projects.title" global="true"></eon-variable>
      <span class="breadcrumb-slash eon-fg-h1-breadcrumb">/</span>
      <span eon-ref="breadcrumbCurrent" class="breadcrumb-current eon-fg-h1-breadcrumb"></span>
    </div>
    <div class="separator"></div>
    <div class="project-view-selector box tab-selector">
      <div class="tab-node eon-fg1-hoverable" eon-ref="view_list">
        <i class="tab-icon ticon ticon-list"></i>
        <eon-variable class="tab-label eon-unselectable" bind="locale.projects.view.list" global="true"></eon-variable>
      </div>

      <div class="tab-spacer"></div>

      <div class="tab-node eon-fg1-hoverable eon-fg1-active" eon-ref="view_board">
        <i class="tab-icon ticon ticon-board"></i>
        <eon-variable class="tab-label eon-unselectable" bind="locale.projects.view.board" global="true"></eon-variable>
      </div>

      <div class="tab-spacer"></div>

      <div class="tab-node eon-fg1-hoverable eon-fg1-active" eon-ref="view_timeline">
        <i class="tab-icon ticon ticon-timeline"></i>
        <eon-variable class="tab-label eon-unselectable" bind="locale.projects.view.timeline" global="true"></eon-variable>
      </div>

      <div class="tab-spacer"></div>

      <div class="tab-node eon-fg1-hoverable eon-fg1-active" eon-ref="view_calendar">
        <i class="tab-icon ticon ticon-calendar"></i>
        <eon-variable class="tab-label eon-unselectable" bind="locale.projects.view.calendar" global="true"></eon-variable>
      </div>
    </div>
    <eon-toggle class="project-view-default" label-position="left" bind:label="global locale.projects.view.default"
      eon-ref="toggleDefault"></eon-toggle>
    <div class="separator project-view-adjust-settings"></div>
    <div class="action-buttons">
      <div class="tab-menu-button project-view-selector-mobile box eon-fg2-hoverable" eon-ref="open_view_mobile">
        <i class="ticon ticon-board"></i>
        <eon-variable class="tab-menu-label eon-unselectable" bind="locale.projects.view.board" global="true"></eon-variable>
        <i class='vicon vicon-chevron-down'></i>
      </div>

      <!-- <eon-button class="tab-menu-button h1-button project-view-selector-mobile" icon-position="right"
        bind:label="global locale.projects.view.board" icon="<i class='vicon vicon-chevron-down'></i>" design="filled"
        eon-ref="open_view_mobile"></eon-button> -->
      <eon-button class="bar-button h1-button hide" bind:label="global locale.global.settings"
        icon="<i class='vicon vicon-cog'></i>" design="filled" eon-ref="settings"></eon-button>
    </div>
  </div>

  <app-toggle-menu hidden-menu="true" content-full-width="false" class="project-view-selector-mobile"
    content-class="project-view-selector-mobile-content" anchor="right" eon-ref="view_mobile">
    <div class="app-toggle-menu-label eon-fg-h4">
      <eon-variable bind="locale.global.views" global="true"></eon-variable>
      <div class="separator"></div>
      <!-- <eon-variable bind="locale.projects.view.default" global="true"></eon-variable> -->
    </div>
    <div class="project-view-selector-mobile-content-item app-toggle-menu-item">
      <eon-variable bind="locale.projects.view.list" global="true" eon-ref="view_list_mobile" class="clickable">
      </eon-variable>
      <!-- <eon-radio eon-ref="default_view_list"></eon-radio> -->
    </div>
    <div class="project-view-selector-mobile-content-item app-toggle-menu-item">
      <eon-variable bind="locale.projects.view.board" global="true" eon-ref="view_board_mobile" class="clickable">
      </eon-variable>
      <!-- <eon-radio eon-ref="default_view_board"></eon-radio> -->
    </div>
    <div class="project-view-selector-mobile-content-item app-toggle-menu-item">
      <eon-variable bind="locale.projects.view.timeline" global="true" eon-ref="view_timeline_mobile" class="clickable">
      </eon-variable>
      <!-- <eon-radio eon-ref="default_view_timeline"></eon-radio> -->
    </div>
    <div class="project-view-selector-mobile-content-item app-toggle-menu-item">
      <eon-variable bind="locale.projects.view.calendar" global="true" eon-ref="view_calendar_mobile" class="clickable">
      </eon-variable>
      <!-- <eon-radio eon-ref="default_view_calendar"></eon-radio> -->
    </div>

  </app-toggle-menu>


  <!-- <app-bubble eon-ref="openViewBubble" class="project-view-mobile-button-open eon-bg1 eon-fg1-tobeio" scroll-selector="body">
    <i class="vicon vicon-visibility bubble-views-icon"></i>
  </app-bubble> -->

  <board-view eon-ref="board"></board-view>
  <list-view class="hide" eon-ref="list"></list-view>
  <div class="timeline-view" eon-ref="timeline">
    <div class="wip-overlay">
      <div></div>
      <eon-variable bind="locale.global.coming" global="true"></eon-variable>
    </div>
  </div>
  <div class="calendar-view" eon-ref="calendar">
    <div class="wip-overlay">
      <div></div>
      <eon-variable bind="locale.global.coming" global="true"></eon-variable>
    </div>
  </div>
</template>

<script>
  eon.element("project-view", {
    style: "project-view.css",
    dependencies: [
      "@ui/eon-button",
      "@ui/eon-label",
      "@ui/eon-text",
      "@ui/eon-combo",
      "@ui/eon-toggle",
      "@custom/app-toggle-menu",
      "@ui/eon-scroll",
      "@ui/eon-radio",
      "@ui/eon-contextmenu",
      "@custom/app-add-new",
      "../board-view",
      "../list-view"
    ],

    properties: {
      // @html-property id (public)
      id: {
        value: "",
        observe: true
      },
      // @html-property board (public)
      board: {
        value: "",
        observe: true
      },
      // @html-property tasks (public)
      tasks: {
        value: "",
        observe: true
      },
      // // @html-property projectsView (public)
      // projectsView: {
      //   value: "",
      //   observe: true
      // },
      // @html-property view (public)
      view: {
        value: "",
        observe: true
      }
    },

    privateProperties: {
      misc: {
        value: {}
      }
    },
    functions: {
      // @function showMask (public) []
      showMask: function () {
        // * Check section to be displayed
        if (this._refs.board) {
          this._refs.board.showEonMask();
        }
      },
      // @function hideMask (public) []
      hideMask: function () {
        // * Check section to be displayed
        if (this._refs.board) {
          this._refs.board.hideEonMask();
        }
      },
      // @function refresh (public) [Refresh data]
      refresh: function () {
        var el = this;
        el.onDataLoaded(function () {
          el.view = el.board.defaultView ? el.board.defaultView[session.data.id] || "board" : "board";
          switch (el.view) {
            case "board":
              el._refs.board._misc.workspaceData = el._misc.workspaceData;
              break;
          }
        });
      },
      // @function loadData (public) [Load project data] @param id
      loadData: function (id, callback) {
        var el = this;
        if (id) {
          var url = "/rest/board/" + session.data.currentWorkspaceId + "/" + id;
          eon.ajax(url, {
            contentType: "application/json"
          }, function (error, data) {
            if (!error) {
              el.board = data.response;
              el._refs.breadcrumbCurrent.innerHTML = data.response.name;
              if (callback) {
                callback(data.response);
              }
              eon.triggerCallback("onDataLoaded", el, el);
            } else if (data.status == 401) {
              session.logout();
            } else if (data.status == 500) {
              showInfoDialog(eon.locale.projects.project.notFound, function () {});
              eon.triggerCallback("onBack", el, el);
            }
          });
        }
      },
      // // @function loadTasks (public) [Load tasks data] @param callback
      // loadTasks: function (callback) {
      //   var el = this;
      //   var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + boardId;
      //   eon.ajax(url, {}, function (error, data) {
      //     if (!error) {
      //       if (callback) {
      //         callback(JSON.parse(data.responseText));
      //       }
      //     } else if (data.status == 401) {
      //       session.logout();
      //     }
      //   });
      // }
    },

    privateFunctions: {
      // @function _init (private)
      init: function () {
        var el = this;
        session.onReady(function () {
          if (session.isAdmin()) {
            el._refs.settings.classList.remove("hide");
          }
        });
        el._misc.columns = {};
        el._misc.tasks = {};
        el._misc.gradients = {
          0: "linear-gradient(90deg, rgba(165,26,209,1) 0%, rgba(65,75,209,1) 100%)",
          1: "linear-gradient(90deg, rgba(0,191,205,1) 0%, rgba(0,116,38,1) 100%)",
          2: "linear-gradient(90deg, rgba(255,146,21,1) 0%, rgba(200,48,0,1) 100%)"
        }
        el._setUp();
      },
      // @function _setUp (private)
      setUp: function (value) {
        var el = this;
        el._addListeners();
        el._socketListeners();
        el._refs.view_mobile.layout = el;
        el._refs.view_mobile.layoutHeight = el._refs.open_view_mobile;
      },
      // @function _addListeners (private)
      addListeners: function () {
        var el = this;
        // Back to calendars view
        el._refs.back.addEventListener("click", function (e) {
          eon.triggerCallback("onBack", el, el);
        }, false);
        el._refs.breadcrumbPrev.addEventListener("click", function (e) {
          eon.triggerCallback("onBack", el, el);
        }, false);
        el._refs.settings.addEventListener("click", function () {
          eon.triggerCallback("onEditProject", el, el, [el.board]);
        });
        el._refs.view_board.addEventListener("click", function () {
          el._onClickView("board");
        });
        el._refs.view_list.addEventListener("click", function () {
          el._onClickView("list");
        });
        el._refs.view_timeline.addEventListener("click", function () {
          el._onClickView("timeline");
        });
        el._refs.view_calendar.addEventListener("click", function () {
          el._onClickView("calendar");
        });
        // el._refs.view_mobile.onSelect(function (item) {
        //   el.view = item.value;
        // });
        el._refs.open_view_mobile.addEventListener("click", function () {
          el._refs.view_mobile.open();
          // Push dialog state
          pushDialogState(el._refs.view_mobile);
        });
        // el._refs.openViewBubble.addEventListener("click", function () {
        //   el._refs.view_mobile.open();
        // });
        el._addListeners_task();
        el._addListeners_board();
        el._refs.toggleDefault.onCheck(function () {
          if (!el._misc.defaultViewDisabled && el.board && el.board.defaultView && el.board.defaultView[
              session.data.id] && el.board.defaultView[session.data.id] != el.view) {
            // if (!el._misc.defaultViewDisabled) {            
            board.defaultView(el.board.id, el.view);
          }
        });
        el._refs.toggleDefault.onUncheck(function () {

          if (!el._misc.defaultViewDisabled && el.board && el.board.defaultView && el.board.defaultView[
              session.data.id] && el.board.defaultView[session.data.id] != el.view) {
            // if (!el._misc.defaultViewDisabled) {                  
            board.defaultView(el.board.id, null);
          }
        });
        el._addListeners_viewMobile();
      },
      // @function _addListeners_viewMobile (private) [Listeners for mobile view menu]
      addListeners_viewMobile: function () {
        var el = this;
        el._refs.view_list_mobile.addEventListener("click", function (e) {
          el._onClickView("list");
          el._refs.view_mobile.close();
          e.preventDefault();
          e.stopPropagation();
        });
        el._refs.view_board_mobile.addEventListener("click", function () {
          el._onClickView("board");
          el._refs.view_mobile.close();
        });
        el._refs.view_timeline_mobile.addEventListener("click", function () {
          el._onClickView("timeline");
          el._refs.view_mobile.close();
        });
        el._refs.view_calendar_mobile.addEventListener("click", function () {
          el._onClickView("calendar");
          el._refs.view_mobile.close();
        });
        // el._refs.default_view_list.addEventListener("click", function (e) {
        //   e.preventDefault();
        //   e.stopPropagation();

        //   el._defaultBoard("list", function(error, view){
        //     if(!error) {
        //       el._setMobileViewDefault();
        //     } else {
        //       // TODO
        //       // showInfoDialog();
        //     }
        //   });
        // });
        // el._refs.default_view_board.addEventListener("click", function (e) {
        //   e.preventDefault();
        //   e.stopPropagation();
        //   el._defaultBoard("board", function(error, view){
        //     if(!error) {
        //       el._setMobileViewDefault();
        //     } else {
        //       // TODO
        //       // showInfoDialog();
        //     }
        //   });
        // });
        // el._refs.default_view_timeline.addEventListener("click", function (e) {
        //   e.preventDefault();
        //   e.stopPropagation();
        //   el._defaultBoard("timeline", function(error, view){
        //     if(!error) {
        //       el._setMobileViewDefault();
        //     } else {
        //       // TODO
        //       // showInfoDialog();
        //     }
        //   });
        // });
        // el._refs.default_view_calendar.addEventListener("click", function (e) {
        //   e.preventDefault();
        //   e.stopPropagation();
        //   el._defaultBoard("calendar", function(error, view){
        //     if(!error) {
        //       el._setMobileViewDefault();
        //     } else {
        //       // TODO
        //       // showInfoDialog();
        //     }
        //   });
        // });
      },
      // @function _addListeners_task (private) [Add event listeners for task dialog view]
      addListeners_task: function () {
        var el = this;
        task.onTask_close(function () {});
        // task.onTask_updated(function (task) {
        //   if (document.body.dataset.view === "projects") {
        //     el._onTaskUpdated(task);
        //   }
        // });
        // task.onTask_deleted(function (taskId) {
        //   if (document.body.dataset.view === "projects") {
        //     el._onTaskDeleted(taskId);
        //   }
        // });
        // task.onTask_labelDeleted(function (labelId) {
        //   if (document.body.dataset.view === "projects") {
        //     el._onLabelDeleted(labelId);
        //   }
        // });
        // task.onTask_labelUpdated(function (labels) {
        //   if (document.body.dataset.view === "projects") {
        //     el._onLabelUpdated(labels);
        //   }
        // });
      },
      // @function _addListeners_board (private) [Add event listeners for board view]
      addListeners_board: function () {
        var el = this;
        el._refs.board.onTaskOpen(function (taskId, board, workspaceData) {          
          task.open(taskId, {
            workspace: workspaceData || el._misc.workspaceData,
            board: el.board
          });
        });
        el._refs.board.onDataShown(function () {
          eon.triggerCallback("onDataShown", el, el);
        });
        el._refs.board.onAddList(function (name) {
          el._onAddList(name);
        });
        el._refs.board.onEditList(function (listId, options) {
          el._onEditList(listId, options);
        });
        el._refs.board.onDeleteList(function (listId) {
          el._onDeleteList(listId);
        });
        el._refs.board.onTaskCreated(function (taskName, options) {
          el._createTask(taskName, options);
        });
        // el._refs.board.onListMove(function (currentList, targetPosition) {
        //   el._moveList(currentList, targetPosition);
        // });
        el._refs.board.onListMove(function (newOrder) {
          el._moveList(newOrder);
        });
      },
      // // @function _defaultBoard (private) [Set board as default] @param view @param cb
      // defaultBoard: function (view, cb) {
      //   var el = this;
      //   var url = "/rest/board/" + session.data.currentWorkspaceId + "/default/" + el.board.id;
      //   eon.ajax(url, {
      //     contentType: "application/json",
      //     method: "PUT",
      //     payload: JSON.stringify({
      //       defaultView: view
      //     })
      //   }, function (error, data) {
      //     if (!error) {
      //       el.board.defaultView = JSON.parse(data.responseText).defaultView;
      //       if(cb) {
      //         cb(null, view);
      //       }
      //     } else if (data.status == 401) {
      //       session.logout();
      //     } else {
      //       if(cb) {
      //         cb(true);
      //       }
      //     }
      //   });
      // },
      // @function _onAddList (private) [Actions when a list is added]
      onAddList: function (name) {
        var el = this;
        var url = "/rest/board/" + session.data.currentWorkspaceId + "/list/" + el.board.id;
        eon.ajax(url, {
          contentType: "application/json",
          method: "POST",
          payload: JSON.stringify({
            list: name
          })
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // // @function _updateBoardLists (private) [Update stored board data] @param lists
      // updateBoardLists: function (lists) {
      //   var el = this;
      //   for (var i = 0; i < el.projectsView.boards.length; i++) {
      //     if (el.board.id === el.projectsView.boards[i].id) {
      //       el.projectsView.boards[i].lists = lists;
      //     }
      //   }
      // },

      // @function  _onEditList (private) [Actions when a list is updated]
      onEditList: function (listId, options) {
        var el = this;
        var url = "/rest/board/" + session.data.currentWorkspaceId + "/list/" + el.board.id;
        var payload = {
          listId: listId
        };
        for (var key in options) {
          payload[key] = options[key];
        }
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify(payload)
        }, function (error, data) {
          if (!error) {
            // for (var key in options) {
            //   el.board.lists[listId][key] = options[key];
            // }
            eon.triggerCallback("onProjectUpdated", el, el, [el.board, options]);
          } else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function  _onDeleteList (private) [Actions when a list is updated]
      onDeleteList: function (listId) {
        var el = this;
        var url = "/rest/board/" + session.data.currentWorkspaceId + "/list/" + el.board.id;
        eon.ajax(url, {
          contentType: "application/json",
          method: "DELETE",
          payload: JSON.stringify({
            listId: listId
          })
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _onTaskMoved (private) [Actions when a task is moved to another list] @param taskId @param listId @param order @param board
      onTaskMoved: function (taskId, listId, order, board) {
        var el = this;
        if (el._getCurrentView()) {
          el._getCurrentView()._onTaskMoved(taskId, listId, order, board);
        }
      },
      // // @function _onTaskUpdated (private) [Actions when a task is updated] @param task
      // onTaskUpdated: function (task) {
      //   var el = this;
      //   if (el._getCurrentView()) {
      //     el._getCurrentView()._onTaskUpdated(task);
      //   }
      // },
      // @function _onTaskDeleted (private) [Actions when a task is deleted] @param taskId
      onTaskDeleted: function (taskId) {
        var el = this;
        var index = -1;
        // if (el.id) {         // TODO board data should be updated by doing a request to the server when board data is changed
        //   delete el.projectsView.tasks[el.id][taskId];
        //   eon.triggerCallback("onTaskDeleted", el, el);
        //   if (el._getCurrentView()) {
        //     el._getCurrentView()._onTaskDeleted(taskId);
        //   }
        // }
        if (el._getCurrentView()) {
          el._getCurrentView()._onTaskDeleted(taskId);
        }
      },
      // @function _socketListeners (private)
      socketListeners: function () {
        var el = this;
        socket.onSocketBoard(function (board) {
          if (el.view) {
            el.board = board;
          }
        });
      },
      // @function _initBoard (private) [Initialize board view]
      initBoard: function (tasks, board, workspaceData) {
        var el = this;
        // if (tasks) {
        //   el._refs.board.tasks = tasks;
        // }        
        el._refs.board.board = board;
        el._refs.board._misc.workspaceData = workspaceData;
      },
      // @function _initList (private) [Initialize list view]
      initList: function (tasks, board, workspaceData) {
        var el = this;
        if (tasks) {
          el._refs.list.tasks = tasks;
        }
        el._refs.list.board = board;
        el._refs.list._misc.workspaceData = workspaceData;
      },
      // @function _getCurrentView (private) 
      getCurrentView: function () {
        var el = this;
        switch (el.view) {
          case "board":
            return el._refs.board;
            break;
          case "list":
            return el._refs.list;
            break;
        }
      },
      // @function _createTask (private) [Create a new task in the database] @param taskName @param options
      createTask: function (taskName, options) {
        var el = this;
        var payload = {
          name: taskName
        };
        for (var key in options) {
          payload[key] = options[key];
        }
        var url = "/rest/task/" + session.data.currentWorkspaceId + "/" + el.board.id;
        eon.ajax(url, {
          contentType: "application/json",
          method: "POST",
          payload: JSON.stringify(payload)
        }, function (error, data) {
          if (!error) {
            popup.displayToast(eon.locale.projects.tasks.createSuccess);

            el._getCurrentView().focusAddNew(JSON.parse(data.responseText).listId);
          } else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _moveList (private) [Move a list] @param taskId @param newOrder
      moveList: function (newOrder) {
        var el = this;
        var url = "/rest/board/" + session.data.currentWorkspaceId + "/move/" + el.board.id;
        var payload = {
          order: newOrder
        };
        eon.ajax(url, {
          contentType: "application/json",
          method: "PUT",
          payload: JSON.stringify(payload)
        }, function (error, data) {
          if (!error) {} else if (data.status == 401) {
            session.logout();
          }
        });
      },
      // @function _showView (private) [Reflect current view at menu] @param view
      showView: function (view) {
        var el = this;
        el._refs.board.classList.add("hide");
        el._refs.list.classList.add("hide");
        el._refs.timeline.classList.add("hide");
        el._refs.calendar.classList.add("hide");
        el._refs[view].classList.remove("hide");
        el._updateViewMenu(view);
        el._updateDefaultView(view);
      },
      // @function _updateDefaultView (private) [Update toggle default view status]
      updateDefaultView: function (view) {
        var el = this;
        el._misc.defaultViewDisabled = true;
        if ((!el.board.defaultView && view === "board") || (el.board.defaultView && !el.board.defaultView[session
            .data.id] && view === "board") || (el.board.defaultView && el.board.defaultView[session.data.id] &&
            view == el.board.defaultView[session.data.id])) {
          el._refs.toggleDefault.checked = true;
        } else {
          el._refs.toggleDefault.checked = false;
        }
        // el._setMobileViewDefault();
        setTimeout(function () {
          el._misc.defaultViewDisabled = false;
        }, 0);
      },
      // @function _updateViewMenu (private) [Update view menu selection] @param view
      updateViewMenu: function (view) {
        var el = this;
        el._refs.view_list.classList.remove("eon-fg1-active");
        el._refs.view_board.classList.remove("eon-fg1-active");
        el._refs.view_timeline.classList.remove("eon-fg1-active");
        el._refs.view_calendar.classList.remove("eon-fg1-active");

        // Show view mask
        if (this._refs[view].showEonMask) {
          this._refs[view].showEonMask();
        }

        this._refs.open_view_mobile.$1(".tab-menu-label").innerHTML = eon.locale.projects.view[view];
        this._refs.open_view_mobile.$1(":first-child").className = "ticon " + "ticon-" + view;

        switch (view) {
          case "board":
            el._refs.view_board.classList.add("eon-fg1-active");
            break;
          case "list":
            el._refs.view_list.classList.add("eon-fg1-active");
            break;
          case "timeline":
            el._refs.view_timeline.classList.add("eon-fg1-active");
            break;
          case "calendar":
            el._refs.view_calendar.classList.add("eon-fg1-active");
            break;
        }
      },
      // @function _onClickView (private) [Onclick action for view selector]
      onClickView: function (view) {
        var el = this;
        if (el.view != view) {
          el.view = view;
          // el._refs.view_mobile.value = view;
        }
        this._refs.open_view_mobile.$1(".tab-menu-label").innerHTML = eon.locale.projects.view[view];
        this._refs.open_view_mobile.$1(":first-child").className = "ticon " + "ticon-" + view;
      },
      // // @function _setMobileViewDefault (private) [Deselect all default view for mobile menu]
      // setMobileViewDefault: function () {
      //   var el = this;
      //   el._refs.default_view_list.checked = false;
      //   el._refs.default_view_board.checked = false;
      //   el._refs.default_view_timeline.checked = false;
      //   el._refs.default_view_calendar.checked = false;

      //   if (el.board.defaultView) {
      //     switch (el.board.defaultView[session.data.id]) {
      //       case "list":
      //         el._refs.default_view_list.checked = true;
      //         break;
      //       case "board":
      //         el._refs.default_view_board.checked = true;
      //         break;
      //       case "timeline":
      //         el._refs.default_view_timeline.checked = true;
      //         break;
      //       case "calendar":
      //         el._refs.default_view_calendar.checked = true;
      //         break;
      //     }
      //   } else {
      //     el._refs.default_view_board.checked = true;
      //   }
      // }
    },

    onCreated: function () {
      var el = this;
      eon.createCallback("onBack", el);
      eon.createCallback("onProjectUpdated", el);
      eon.createCallback("onEditProject", el);
      eon.createCallback("onDataShown", el);
      eon.createCallback("onDataLoaded", el, "ready");
      eon.createCallback("onTaskCreated", el);
      eon.createCallback("onTaskDeleted", el);
    },

    onRender: function () {
      var el = this;
      el._init();
    },

    onPropertyChanged: function (key, oldVal, newVal) {
      var el = this;
      switch (key) {
        case "view":
          if (el.id) {
            switch (newVal) {
              case "board":
                // el._initBoard(el.projectsView.tasks[el.id], el.board, el._misc.workspaceData);
                el._initBoard(el.tasks[el.id], el.board, el._misc.workspaceData);
                break;
              case "list":
                // el._initList(el.projectsView.tasks[el.id], el.board, el._misc.workspaceData);
                el._initList(el.tasks[el.id], el.board, el._misc.workspaceData);
                break;
              case "timeline":

                break;
              case "calendar":

                break;
            }
            el._showView(newVal);
          }
          break;
        case "id":
          el._refs.board.id = newVal;
          el.loadData(newVal, function (data) {
            // el.loadTasks(function (tasks) {

            switch (el.view) {
              case "board":
                // el._initBoard(el.projectsView.tasks[el.id], data, el._misc.workspaceData);
                el._initBoard(el.tasks[el.id], data, el._misc.workspaceData);
                break;
              case "list":
                // el._initList(el.projectsView.tasks[el.id], data, el._misc.workspaceData);
                el._initList(el.tasks[el.id], data, el._misc.workspaceData);
                // el._initList(tasks, data, el._misc.workspaceData);
                break;
              case "timeline":

                break;
            }
            // });
          });
          break;
        case "board":
          var diffs = differ.compare(oldVal, newVal, {
            arrayOrder: true
          });
          if (diffs.defaultView) {
            if (newVal.defaultView && newVal.defaultView[session.data.id]) {
              if (el.view === newVal.defaultView[session.data.id]) {
                el._refs.toggleDefault.checked = true;
                el._refs.toggleDefault.value = true;
              } else {
                el._refs.toggleDefault.checked = false;
                el._refs.toggleDefault.value = false;
              }
            }
          }
          el._refs.breadcrumbCurrent.innerHTML = newVal.name;
          if (oldVal.id != newVal.id) {
            el.view = newVal.defaultView ? newVal.defaultView[session.data.id] || "board" : "board";
          }
          el._refs.open_view_mobile.$1(".tab-menu-label").innerHTML = eon.locale.projects.view[el.view];
          el._refs.open_view_mobile.$1(":first-child").className = "ticon " + "ticon-" + el.view;
          
          switch (el.view) {
            case "board":
              el._initBoard(null, newVal, el._misc.workspaceData);
              break;
            case "list":
              el._initList(null, newVal, el._misc.workspaceData);
              break;
            case "timeline":

              break;
          }
          break;
      }
    }


  });
</script>