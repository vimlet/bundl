<style>
  report-grid {
    position: relative;
    min-height: 100%;
  }
</style>
<template>
  <div eon-ref="titles" class="grid-titles">
    <eon-variable bind="locale.report.alias" global="true"></eon-variable>
    <eon-variable bind="locale.report.user" global="true"></eon-variable>
    <eon-variable bind="locale.report.total" global="true"></eon-variable>
    <eon-variable bind="locale.report.extra" global="true"></eon-variable>
    <div class="cell-empty"></div>
    <div class="cell-empty"></div>
  </div>
  <div class="grid-entries" eon-ref="entries">
    <!-- MASK -->
    <div class="report-grid-mask" eon-ref="mask">
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
      <div class="mask-card eon-mask-background1"></div>
    </div>
  </div>

</template>

<script>
  eon.element("report-grid", {
    parse: true,

    dependencies: [
      "@ui/eon-loading",
      "report-entry",
      "report-card"
    ],

    properties: {
      refs: {
        value: {}
      }
    },

    privateProperties: {
      refs: {
        value: {}
      },
      misc: {
        value: {}
      }
    },
    functions: {
      // @function refresh
      refresh: function (filters, cb) {
        var el = this;

        if (!el._refreshing) {
          el._refreshing = true;

          mask.showViewMask("report-grid");

          el.clean();

          // ** TEMP Store in the global session scope
          var workspaceId = session.data.currentWorkspaceId;

          var url = "/rest/report/" + workspaceId;

          if (session.data.workspaces[session.data.currentWorkspaceId].role != "admin") {
            url += "/" + session.data.id;
          }

          eon.ajax(url, { params: filters, contentType: "application/json" }, function (error, data) {
            if (!error) {
              el._refs.report._misc.data = JSON.parse(data.responseText);
              // :: Grid element API 
              el._createEntries(el._refs.report._misc.data.entries);
              el._refs.report.setPaging(el._refs.report._misc.data);

              if(cb) {
                cb(el._refs.report._misc.data);
              }
            } else if (data.status == 401) {
              session.logout();
            }
            el._refreshing = false;
          });
        }
      },
      // @function repaint
      repaint: function (data) {
        var el = this;

        el.clean();
        el._createEntries(el._refs.report._misc.data.entries);
      },
      // @function clean
      clean: function () {
        this._refs.entries.innerHTML = "";
        this._refs.entries.appendChild(this._refs.mask);
      }
    },
    privateFunctions: {
      // @function _setupRefs (private)
      setupRefs: function () {
        this._refs.report = this.getEnclosingComponent();
        this._misc.entries = {};
        this._misc.srcEntries = [];
      },
      // @function _createEntries (private)
      createEntries: function (entries) {
        var fragment = document.createDocumentFragment();
        this._misc.srcEntries = entries.slice(0);
        // Check device version
        var tagName = this._isDesktop() ? "report-entry" : "report-card";

        for (var i = 0; i < entries.length; i++) {
          var entry = entries[i];

          if (entry) {
            // Create a report entry
            var entryEl = document.createElement(tagName);
            entryEl.classList.add("grid-row");

            entryEl.setValues(entry);

            this._misc.entries[entry.reportId] = entryEl;

            fragment.appendChild(entryEl);
          }
        }

        // Show no entries message if needed
        if(entries && entries.length < 1) {
          if(!this._refs.placeHolder) {
            this._refs.placeHolder = createPlaceHolder(eon.locale.global.noContent, "img/no-content/no-content.svg", eon.locale.global.noContentTitle);
          }
          fragment.appendChild(this._refs.placeHolder);

          this._refs.entries.classList.add("grid-empty");
        } else {
          this._refs.entries.classList.remove("grid-empty");
        }

        mask.hideViewMask("report-grid");
        this._refs.entries.appendChild(fragment);
      },
      // @function _isDesktop (private)
      isDesktop: function () {
        if (eon.util.isTouchScreen() || window.innerWidth <= 1024) {
          this._misc.desktop = false;
        } else {
          this._misc.desktop = true;
        }

        return this._misc.desktop;
      },

    },
    onCreated: function () {
      this._setupRefs();
    },

    onWindowResize: function () {
      var throttled = false;
      var delay = 10;

      // Decrease resize calls
      if (!throttled) {
        throttled = true;
        // Check resolution
        var isDesktop = eon.util.isTouchScreen() || window.innerWidth <= 1024 ? false : true;

        if (isDesktop && !this._misc.desktop) {
          this._misc.desktop = false;
          this.repaint(this._misc.srcEntries)
        } else if (!isDesktop && this._misc.desktop) {
          this._misc.desktop = true;
          this.repaint(this._misc.srcEntries)
        }

        // Set a timeout to un-throttle
        setTimeout(function () {
          throttled = false;
        }, delay);
      }
    }
  });
</script>