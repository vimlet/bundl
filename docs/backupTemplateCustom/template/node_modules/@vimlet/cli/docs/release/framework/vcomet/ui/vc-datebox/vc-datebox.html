<template>

  <div class="vc-datebox-data">
    <label class="vc-datebox-label"></label>
  </div>

  <div class="vc-datebox-main vc-bg4 vc-fg1-border vc-unselectable">

    <div class="vc-datebox-input">
      <div class="vc-datebox-wrapper">
        <div class="vc-datebox-subInputs vc-fg1-border">
          <div class="vc-datebox-subInput first">
            <input placeholder="" type="number" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></input>
          </div>
          <div class="vc-datebox-separator"></div>
          <div class="vc-datebox-subInput second">
            <input placeholder="" type="number" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></input>
          </div>
          <div class="vc-datebox-separator"></div>
          <div class="vc-datebox-subInput third">
            <input placeholder="" type="number" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></input>
          </div>
        </div>
        <i class="material-icons vc-datebox-button vc-fg2 vc-fg1-hoverable">today</i>
      </div>
      <span class="vc-datebox-underline"></span>
    </div>

  </div>

</template>

<script>
  vcomet.element("vc-datebox", "vc-datebox.css", {
    themed: true,
    privateProperties: {
      /*
      @property (private) {object} _subInputs
      @description Object that contains the different subinputs
      */
      subInputs: {
        value: {},
        reflect: false
      },
      /*
      @property (private) {object} _misc
      @description Object with usefull information
      */
      misc: {
        value: {},
        reflect: false
      },
      /*
      @property (private) {object} _refs
      @description Object with usefull information
      */
      refs: {
        value: {},
        reflect: false
      },
      /*
      @property (private) {string} _formelement 
      @description Necessary property for a form
      */
      formelement: {
        value: "date"
      },
    },

    properties: {
      /*
      @property {string} name
      @description Name to identify the element in a form
      */
      name: {
        value: "",
        reflect: true
      },
      /*
      @property {string} value
      @description Value of the element
      */
      value: {
        value: "",
        reflect: false
      },
      /*
      @property {string} label
      @description Label for the element
      */
      label: {
        value: "",
        reflect: true
      },
      /*
      @property {string} locale
      @description Locale to be used in the datebox
      */
      locale: {
        value: "",
        reflect: true
      },
      /*
      @property {string} mask
      @description Date format of the input
      */
      mask: {
        value: "YYYYMMDD",
        reflect: true
      },
      /*
      @property {string} separator
      @description Indicates the separator for the date
      */
      separator: {
        value: "-",
        reflect: true
      },
      /*
      @property {string} min
      @description Indicates the inferior limit of the date
      */
      min: {
        value: "",
        reflect: true
      },
      /*
      @property {string} max
      @description Indicates the superior limit of the date
      */
      max: {
        value: "",
        reflect: true
      },
      /*
      @property {string} width
      @description Indicates the width of the datebox
      */
      width: {
        value: 200,
        reflect: true
      },
      /*
      @property {string} pickerWidth
      @description Indicates the width of the datepicker
      */
      pickerWidth: {
        value: 500,
        reflect: true
      },
      /*
      @property {string} pickerHeight
      @description Indicates the height of the datepicker
      */
      pickerHeight: {
        value: 360,
        reflect: true
      },
      /*
      @property {string} pickerFontSize
      @description Indicates the font size of the datepicker
      */
      pickerFontSize: {
        value: 16,
        reflect: true
      },
      /*
      @property {string} pickerSelectable
      @description Indicates the selectable values of the datepicker (day, month and year)
      */
      pickerSelectable: {
        value: "dmy",
        reflect: true
      },
      /*
      @property {string} weekStart
      @description Indicates the first day of the week for the datepicker
      */
      weekStart: {
        value: "monday",
        reflect: true
      },
      /*
      @property {string} weekDaysFormat
      @description Indicates the format of the weekdays header
      */
      weekDaysFormat: {
        value: "short",
        reflect: true
      },
      /*
      @property {string} valueFormat
      @description Indicates the format of the value
      */
      valueFormat: {
        value: "YYYY-MM-DD",
        reflect: true
      },
      /*
      @property {string} toolbar
      @description Indicates whether its in toolbar mode or not
      */
      toolbar: {
        value: "false",
        reflect: true
      },
    },
    privateFunctions: {
      /*
      @function (private) _setup
      @description Here we setup everything we need for the element
      */
      setup: function () {

        var el = this;

        el.locale = (el.locale != undefined && el.locale != "") ? el.locale : navigator.language;

        el._setupMisc();
        el._setupDatePicker();
        el._setupRefs();
        el._setupMask();
        el._setupEvents();
        el._updateLabel();

        if (el.min != "" && el.min != undefined) el._setupMinDate();
        if (el.max != "" && el.max != undefined) el._setupMaxDate();
        if (el.toolbar == "true") el._setupToolbarMode();

        if (vcomet.util.isTouchScreen()) {
          el.dataset.touch = "true";
        }

        el._refs.datePicker.onSelected(function (obj) {
          el._onDatePickerSelection(obj)
        });

        el.setAttribute("valid", "false");

        vcomet.registerPathListener(el, "datebox");

        el.style.width = el.width + "px";

      },
      /*
      @function (private) _setupDatePicker
      @description Sets up the datePicker and appends it to the datebox
      */
      setupDatePicker: function () {

        var el = this;
        var datePickerElement = document.createElement("vc-datepicker");

        datePickerElement.classList.add("vc-datebox-picker");
        datePickerElement.classList.add("hidden");
        datePickerElement.setAttribute("locale", el.locale);
        datePickerElement.setAttribute("week-days-format", el.weekDaysFormat);
        datePickerElement.setAttribute("week-start", el.weekStart);
        datePickerElement.setAttribute("closable", "true");
        datePickerElement.setAttribute("min", el.min);
        datePickerElement.setAttribute("max", el.max);
        datePickerElement.setAttribute("width", el.pickerWidth);
        datePickerElement.setAttribute("height", el.pickerHeight);
        datePickerElement.setAttribute("picker-font-size", el.pickerFontSize);
        datePickerElement.setAttribute("selectable", el.pickerSelectable);

        vcomet.registerPathListener(datePickerElement, "datepicker");

        el.querySelector(".vc-datebox-main").appendChild(datePickerElement);

        el._refs.datePicker = datePickerElement;
      },
      /*
      @function (private) _setupMisc
      @description Sets up basic properties for the data object
      */
      setupMisc: function () {

        var el = this;

        el._misc.current = {};
        el._misc.mask = {};
        el._misc.min = {};
        el._misc.min.active = false;
        el._misc.max = {};
        el._misc.max.active = false;

      },
      /*
      @function (private) _setupRefs
      @description Creates some fast access elements so that theres no need for calling the QuerySelector all the time.
      */
      setupRefs: function () {

        var el = this;

        el._refs.subInputs = {};

        el._refs.subInputs.first = el.querySelector(".vc-datebox-subInputs .first input");
        el._refs.subInputs.second = el.querySelector(".vc-datebox-subInputs .second input");
        el._refs.subInputs.third = el.querySelector(".vc-datebox-subInputs .third input");

        el._refs.underline = el.querySelector(".vc-datebox-underline")

      },
      /*
      @function (private) _setupMask
      @description Sets up the mask and the subinputs to be used for the user input
      */
      setupMask: function () {

        var el = this;

        el._misc.mask.order = [];

        var dayFormat = el.mask.match(/[d|D]{1,2}/)[0];
        var monthFormat = el.mask.match(/[M]{1,4}/)[0];
        var yearFormat = el.mask.match(/[y|Y]{2,4}/)[0];

        el._misc.mask["day"] = {};
        el._misc.mask["month"] = {};
        el._misc.mask["year"] = {};

        if (dayFormat && monthFormat && yearFormat) {

          var yearOrder = el.mask.indexOf(yearFormat);

          el._misc.mask.day.format = dayFormat;
          el._misc.mask.month.format = monthFormat;
          el._misc.mask.year.format = yearFormat;

          if (el.mask.indexOf(dayFormat) < el.mask.indexOf(monthFormat)) {

            el._misc.mask.order[0] = "day";
            el._misc.mask.order[1] = "month";

          } else {

            el._misc.mask.order[0] = "month";
            el._misc.mask.order[1] = "day";
          }

          if (el.mask.indexOf(yearFormat) < el.mask.indexOf(dayFormat)) {
            el._misc.mask.order.splice(0, 0, "year");
          } else if (el.mask.indexOf(yearFormat) < el.mask.indexOf(monthFormat)) {
            el._misc.mask.order.splice(1, 0, "year");
          } else {
            el._misc.mask.order[2] = "year";
          }

          el.mask = el._misc.mask[el._misc.mask.order[0]].format + el._misc.mask[el._misc.mask.order[1]].format + el._misc.mask[el._misc.mask.order[2]].format;

          el._refs.subInputs.first.placeholder = el._misc.mask[el._misc.mask.order[0]].format;
          el._refs.subInputs.second.placeholder = el._misc.mask[el._misc.mask.order[1]].format;
          el._refs.subInputs.third.placeholder = el._misc.mask[el._misc.mask.order[2]].format;

        } else {

          el._misc.mask.order = ["day", "month", "year"];

          el._misc.mask.day.format = "DD";
          el._misc.mask.month.format = "MM";
          el._misc.mask.year.format = "YYYY";

          el.mask = "DDMMYYYY";

          el._refs.subInputs.first.placeholder = "DD";
          el._refs.subInputs.second.placeholder = "MM";
          el._refs.subInputs.third.placeholder = "YYYY";
        }

        var firstSection = el._misc.mask[el._misc.mask.order[0]];
        var secondSection = el._misc.mask[el._misc.mask.order[1]];
        var thirdSection = el._misc.mask[el._misc.mask.order[2]];

        firstSection.start = 0;
        firstSection.end = el._misc.mask[el._misc.mask.order[0]].format.length;

        secondSection.start = firstSection.end + el.separator.length;
        secondSection.end = secondSection.start + el._misc.mask[el._misc.mask.order[1]].format.length;

        thirdSection.start = secondSection.end + el.separator.length;
        thirdSection.end = thirdSection.start + el._misc.mask[el._misc.mask.order[2]].format.length;

        el._refs.subInputs.first.parentNode.dataset.field = el._misc.mask.order[0];
        el._refs.subInputs.first.parentNode.dataset.order = "0";

        el._refs.subInputs.second.parentNode.dataset.field = el._misc.mask.order[1];
        el._refs.subInputs.second.parentNode.dataset.order = "1";

        el._refs.subInputs.third.parentNode.dataset.field = el._misc.mask.order[2];
        el._refs.subInputs.third.parentNode.dataset.order = "2";

        var separators = el.querySelectorAll(".vc-datebox-subInputs .vc-datebox-separator");

        for (var i = 0; i < separators.length; i++) {
          separators[i].innerHTML = el.separator;
        }

      },
      /*
      @function (private) _setupEvents
      @description Sets up the events for the subinputs
      */
      setupEvents: function () {

        var el = this;

        el._setupFocusEvents();
        el._setupBlurEvents();
        el._setupOnKeyDownEvents();
        el._setupOnKeyUpEvents();
        el._setupPasteEvents();

        el._setupDatePickerTrigger();

      },
      /*
      @function (private) _setupFocusEvents
      @description Sets up the focus events for the subinputs
      */
      setupFocusEvents: function () {

        var el = this;
        el._labelNode = el.querySelector(".vc-datebox-label");

        el._refs.subInputs.first.addEventListener("focus", function (e) {
          el._handleFocus(this);
          el._refs.underline.classList.add("animate");
          el.classList.add("focus");
          el._labelNode.classList.add("vc-fg1");
        }, true);

        el._refs.subInputs.second.addEventListener("focus", function (e) {
          el._handleFocus(el._refs.subInputs.second);
          el._refs.underline.classList.add("animate");
          el.classList.add("focus");
          el._labelNode.classList.add("vc-fg1");
        }, true);

        el._refs.subInputs.third.addEventListener("focus", function (e) {
          el._handleFocus(el._refs.subInputs.third);
          el._refs.underline.classList.add("animate");
          el.classList.add("focus");
          el._labelNode.classList.add("vc-fg1");
        }, true);

      },
      /*
      @function (private) _setupBlurEvents
      @description Sets up the blur events for the subinputs
      */
      setupBlurEvents: function () {

        var el = this;

        el._refs.subInputs.first.addEventListener("blur", function () {

          if ((el._refs.subInputs.first.dataset.field == "day" || el._refs.subInputs.first.dataset.field == "month") && el._refs.subInputs.first.textContent.length == 1 && el._refs.subInputs.first.textContent.length < el._misc.mask[el._misc.mask.order[0]].format.length) {
            el._refs.subInputs.first.textContent = "0" + el._refs.subInputs.first.textContent;
          }

          el._refs.underline.classList.remove("animate");
          el.classList.remove("focus");
          el._labelNode.classList.remove("vc-fg1");

        }, true);

        el._refs.subInputs.second.addEventListener("blur", function () {

          if ((el._refs.subInputs.second.dataset.field == "day" || el._refs.subInputs.second.dataset.field == "month") && el._refs.subInputs.second.textContent.length == 1 && el._refs.subInputs.second.textContent.length < el._misc.mask[el._misc.mask.order[0]].format.length) {
            el._refs.subInputs.second.textContent = "0" + el._refs.subInputs.second.textContent;
          }

          el._refs.underline.classList.remove("animate");
          el.classList.remove("focus");
          el._labelNode.classList.remove("vc-fg1");

        }, true);

        el._refs.subInputs.third.addEventListener("blur", function () {

          if ((el._refs.subInputs.third.dataset.field == "day" || el._refs.subInputs.third.dataset.field == "month") && el._refs.subInputs.third.textContent.length == 1 && el._refs.subInputs.third.textContent.length < el._misc.mask[el._misc.mask.order[0]].format.length) {
            el._refs.subInputs.third.textContent = "0" + el._refs.subInputs.third.textContent;
          }

          el._refs.underline.classList.remove("animate");
          el.classList.remove("focus");
          el._labelNode.classList.remove("vc-fg1");

        }, true);

      },
      /*
      @function (private) _setupOnKeyDownEvents
      @description Sets up the keydown events for the subinputs
      */
      setupOnKeyDownEvents: function () {

        var el = this;

        el._refs.subInputs.first.addEventListener("keydown", function (e) {
          el._handleKeyDown(el._refs.subInputs.first, e);
        }, true);

        el._refs.subInputs.second.addEventListener("keydown", function (e) {
          el._handleKeyDown(el._refs.subInputs.second, e);
        }, true);

        el._refs.subInputs.third.addEventListener("keydown", function (e) {
          el._handleKeyDown(el._refs.subInputs.third, e);
        }, true);

      },
      /*
      @function (private) _setupOnKeyUpEvents
      @description Sets up the keyup events for the subinputs
      */
      setupOnKeyUpEvents: function () {

        var el = this;

        el._refs.subInputs.first.addEventListener("keyup", function (e) {
          el._handleKeyUp(el._refs.subInputs.first, e);
        }, true);

        el._refs.subInputs.second.addEventListener("keyup", function (e) {
          el._handleKeyUp(el._refs.subInputs.second, e);
        }, true);

        el._refs.subInputs.third.addEventListener("keyup", function (e) {
          el._handleKeyUp(el._refs.subInputs.third, e);
        }, true);

      },
      /*
      @function (private) _setupPasteEvents
      @description Sets up the events for the subinputs to prevent paste
      */
      setupPasteEvents: function () {

        var el = this;

        el._refs.subInputs.first.addEventListener("paste", function (e) {
          e.preventDefault;
          return false;
        }, true);

        el._refs.subInputs.second.addEventListener("paste", function (e) {
          e.preventDefault;
          return false;
        }, true);

        el._refs.subInputs.third.addEventListener("paste", function (e) {
          e.preventDefault;
          return false;
        }, true);

      },
      /*
      @function (private) _setupMinDate
      @description Sets up the inferior limit of the date
      */
      setupMinDate: function () {

        var el = this;

        if (el.min.indexOf('/') > -1) {

          var splittedMin = el.min.split("/");

          el._misc.min.day = parseInt(splittedMin[0]);
          el._misc.min.month = parseInt(splittedMin[1]) - 1;
          el._misc.min.year = parseInt(splittedMin[2]);

        } else {

          var date = new Date(parseInt(el.min));

          el._misc.min.day = date.toLocaleString([], {
            day: "numeric"
          });

          el._misc.min.month = date.toLocaleString([], {
            month: "numeric"
          });

          el._misc.min.year = date.toLocaleString([], {
            year: "numeric"
          });
        }

        el._misc.min.active = true;
      },
      /*
      @function (private) _setupMinDate
      @description Sets up the superior limit of the date
      */
      setupMaxDate: function () {

        var el = this;

        if (el.max.indexOf('/') > -1) {

          var splittedMax = el.max.split("/");

          el._misc.max.day = parseInt(splittedMax[0]);
          el._misc.max.month = parseInt(splittedMax[1]) - 1;
          el._misc.max.year = parseInt(splittedMax[2]);

        } else {

          var date = new Date(parseInt(el.max));

          el._misc.max.day = date.toLocaleString([], {
            day: "numeric"
          });

          el._misc.max.month = date.toLocaleString([], {
            month: "numeric"
          });

          el._misc.max.year = date.toLocaleString([], {
            year: "numeric"
          });
        }

        el._misc.max.active = true;
      },
      /*
      @function (private) _setupDatePickerTrigger
      @description Sets up the triggers to display/hide the datepicker
      */
      setupDatePickerTrigger: function () {

        var el = this;
        var blurTrigger = vcomet.util.isTouchScreen() ? "touchend" : "click";

        el.querySelector(".vc-datebox-button").onclick = function (e) {
          el._toggleDatePicker();
        };

        document.body.addEventListener(blurTrigger, function (e) {
          el._customBlur(e, el);
        });

      },
      /*
      @function (private) _setupToolbarMode
      @description Adds whats needed to overwrite the default style
      */
      setupToolbarMode: function () {
        this.querySelector(".vc-datebox-main").classList.add("toolbar");
      },
      /*
      @function (private) _toggleDatePicker
      @description Shows/Hides the picker depending on its state
      */
      toggleDatePicker: function () {

        var el = this;

        if (el._refs.datePicker.classList.contains("hidden")) {
          el._showDatePicker();
        } else {
          el._hideDatePicker();
        }

      },
      /*
      @function (private) _showDatePicker
      @description Shows the picker
      */
      showDatePicker: function () {

        var el = this;

        el._refs.datePicker.style.top = el.offsetTop + el.offsetHeight + 2 + "px";
        el._refs.datePicker.style.left = el.offsetLeft + "px";
        el._refs.datePicker.style.width = el.offsetWidth + "px";

        el._refs.datePicker._refresh();

        document.body.appendChild(el._refs.datePicker);

        el._refs.datePicker.classList.remove("hidden");

        el._refs.datePicker._handleAutoHeight();

      },
      /*
      @function (private) _hideDatePicker
      @description Hides the picker
      */
      hideDatePicker: function () {

        var el = this;

        el._refs.datePicker._hide();
        el.querySelector(".vc-datebox-main").appendChild(el._refs.datePicker);

      },
      /*
      @function (private) _customBlur
      @description Hides the datepicker if its not being targeted
      @param {object} e
      @param {object} el
      */
      customBlur: function (e, el) {
        if (!el.isOnPath && !el._refs.datePicker.isOnPath) {
          el._hideDatePicker();
        }
      },
      /*
      @function (private) _onDatePickerSelection
      @description Triggered when the user selects a day on the datePicker
      @param {object} obj
      */
      onDatePickerSelection: function (obj) {

        var el = this;

        el.setAttribute("value", el._getFormattedValue(obj, el.valueFormat));
        el.value = el._getFormattedValue(obj, el.valueFormat);
        el.setAttribute("valid", true);

        el._misc.current.day = obj.day;
        el._misc.current.month = obj.month;
        el._misc.current.year = obj.year;

        el._refs.subInputs.first.value = obj[el._misc.mask.order[0]];
        el._refs.subInputs.second.value = obj[el._misc.mask.order[1]];
        el._refs.subInputs.third.value = obj[el._misc.mask.order[2]];

        el._refs.datePicker._hide();
      },
      /*
      @function (private) _validateDate
      @description Validates if what the user typed is a valid date
      */
      validateDate: function () {

        var el = this;

        var inputs = el.querySelectorAll(".vc-datebox-subInputs .vc-datebox-subInput input");

        var day = inputs[el._misc.mask.order.indexOf("day")].value;
        var month = inputs[el._misc.mask.order.indexOf("month")].value;
        var year = inputs[el._misc.mask.order.indexOf("year")].value;

        var validDate = false;
        var date;

        var obj = {

          day: day,
          month: month,
          year: year

        }

        //If all the three fields have text typed in and their content is valid we set the boolean to true
        if (year != "") {
          if (month != "" && parseInt(month) > 0 && parseInt(month) <= 12) {
            if (day != "" && day > 0 && day <= vcomet.time.getDaysInMonth(year, parseInt(month) - 1)) {
              validDate = true;
            }
          }
        }

        //If its valid we remove the error classes, and update everything according to the new date
        if (validDate) {

          el.querySelector(".vc-datebox-input").classList.remove("noMatches");
          el._refs.underline.classList.remove("noMatches");

          el._misc.current.day = parseInt(day);
          el._misc.current.month = parseInt(month) - 1;
          el._misc.current.year = parseInt(year);

          el._refs.datePicker._misc.current.day = parseInt(day);
          el._refs.datePicker._misc.current.month = parseInt(month) - 1;
          el._refs.datePicker._misc.current.year = parseInt(year);

          el._refs.datePicker._misc.selected.day = parseInt(day);
          el._refs.datePicker._misc.selected.month = parseInt(month) - 1;
          el._refs.datePicker._misc.selected.year = parseInt(year);

          el.setAttribute("value", el._getFormattedValue(obj, el.valueFormat));
          el.value = el._getFormattedValue(obj, el.valueFormat);
          el.setAttribute("valid", "true");

        } else {

          el.querySelector(".vc-datebox-input").classList.add("noMatches");
          el._refs.underline.classList.add("noMatches");

          el.setAttribute("value", "");
          el.value = el._getFormattedValue(obj, el.valueFormat);
          el.setAttribute("valid", "false");
        }

      },
      /*
      @function (private) _updateLabel
      @description Updates the label node with the new label
      */
      updateLabel: function () {

        var el = this;

        if (el.label != "") {
          el.querySelector(".vc-datebox-label").innerHTML = el.label;
        }

      },
      /*
      @function (private) {String} _getFormattedValue
      @description We replace the format with the given data, in case the field's length is lower than its format then we add 0 as needed
      @param {Object} obj
      @param {String} format
      */
      getFormattedValue: function (obj, format) {

        var dayFormat = (format.match(/[d|D]{1,2}/)) ? format.match(/[d|D]{1,2}/)[0] : undefined;
        var monthFormat = (format.match(/[M]{1,4}/)) ? format.match(/[M]{1,4}/)[0] : undefined;
        var yearFormat = (format.match(/[y|Y]{2,4}/)) ? format.match(/[y|Y]{2,4}/)[0] : undefined;

        if (obj.day) {

          var day = obj.day;

          if (obj.day.length < dayFormat.length) {
            for (var i = 0; i < (dayFormat.length - obj.day.length); i++) {
              day = "0" + day;
            }
          }

          format = format.replace(dayFormat, day);
        }

        if (obj.month) {

          var month = obj.month;

          if (obj.month.length < monthFormat.length) {
            for (var i = 0; i < (monthFormat.length - obj.month.length); i++) {
              month = "0" + month;
            }
          }

          format = format.replace(monthFormat, month);
        }

        if (obj.year) {

          var year = obj.year;

          if (obj.year.length < yearFormat.length) {
            for (var i = 0; i < (yearFormat.length - obj.year.length); i++) {
              year = "0" + year;
            }
          }

          format = format.replace(yearFormat, year);
        }

        return format;
      },
      /*
      @function (private) {Boolean} _isMinMonth
      @description Returns true if the month is equal/lower than the min month
      @param {Number} year
      @param {Number} month
      */
      isMinMonth: function (year, month) {
        return (year == this._misc.min.year && month <= this._misc.min.month || year < this._misc.min.year);
      },
      /*
      @function (private) {Boolean} _isMaxMonth
      @description Returns true if the month is equal/higher than the max month
      @param {Number} year
      @param {Number} month
      */
      isMaxMonth: function (year, month) {
        return (year == this._misc.max.year && month >= this._misc.max.month || year > this._misc.max.year);
      },
      /*
      @function (private) _handleFocus
      @description Moves the cursor to the right when a subinput is being focused
      @param {Object} subInput
      */
      handleFocus: function (subInput) {
        if (subInput.firstChild) {
          var range = document.createRange();
          var sel = window.getSelection();

          range.selectNodeContents(subInput);

          sel.removeAllRanges();
          sel.addRange(range);

        }
      },
      /*
      @function (private) {Number}  _getCaretPosition
      @description function_description
      @param {object} editableDiv
      */
      getCaretPosition: function (editableDiv) {
        var caretPos = 0,
          sel, range;
        if (window.getSelection) {
          sel = window.getSelection();
          if (sel.rangeCount) {
            range = sel.getRangeAt(0);
            if (range.commonAncestorContainer.parentNode == editableDiv) {
              caretPos = range.endOffset;
            }
          }
        } else if (document.selection && document.selection.createRange) {
          range = document.selection.createRange();
          if (range.parentElement() == editableDiv) {
            var tempEl = document.createElement("span");
            editableDiv.insertBefore(tempEl, editableDiv.firstChild);
            var tempRange = range.duplicate();
            tempRange.moveToElementText(tempEl);
            tempRange.setEndPoint("EndToEnd", range);
            caretPos = tempRange.text.length;
          }
        }
        return caretPos;
      },
      /*
      @function (private) {Boolean} _isNumeric
      @description Whether the recieved key event has a numeric value or not
      @param {object} e
      */
      isNumeric: function (e) {
        return (e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105);
      },
      /*
      @function (private) _handleKeyDown
      @description Handles the typing and the date correction, if the subinput reaches its limit it jumpes to the next one
      @param {object} subInput
      @param {object} e
      */
      handleKeyDown: function (subInput, e) {

        var el = this;
        var selection = window.getSelection();

        if (!el._isNumeric(e)) {

          if (e.keyCode != "9" && e.keyCode != "46" && e.keyCode != "8" && e.keyCode != "37" && e.keyCode != "39") {

            e.preventDefault();
            e.stopPropagation();

          } else {

            if (e.keyCode == "8") {

              var subInputs = el.querySelector(".vc-datebox-subInputs");
              var previousSubInputOrder = parseInt(subInput.parentNode.dataset.order) - 1;
              var previousSubInput = subInputs.querySelector('[data-order="' + previousSubInputOrder + '"] input');
              var caretPosition = subInput.selectionStart;

              if (!(selection.anchorNode === subInput && selection.extentOffset > 0 && selection.type == "Range")) {
                if (caretPosition == 0 && previousSubInput) {
                  previousSubInput.focus();
                }

              }

            }

          }
        } else {

          var subInputs = el.querySelector(".vc-datebox-subInputs");

          var nextSubInputOrder = parseInt(subInput.dataset.order) + 1;
          var nextSubInput = subInputs.querySelector('[data-order="' + nextSubInputOrder + '"] input');

          var aux = subInput.value;

          if (!(selection.anchorNode === subInput && selection.extentOffset > 0 && selection.type == "Range")) {

            if (!(aux.length >= el._misc.mask[subInput.parentNode.dataset.field].format.length)) {

              subInput.value = aux + String.fromCharCode(e.keyCode);
              e.preventDefault();
              e.stopPropagation();
            }


          }

        }

        // Checks if the key press corresponds to ENTER
        if (e.keyCode == 13) {
          vcomet.triggerCallback("onEnter", el)
        }

      },
      /*
      @function (private) _handleKeyUp
      @description Handles the key up event
      @param {object} subInput 
      @param {object} e [event]
      */
      handleKeyUp: function (subInput, e) {

        var el = this;

        if (!(document.activeElement.isEqualNode(subInput) && el._getSelectionText().length == subInput.value.length)) {

          if (el._isNumeric(e) || e.keyCode == "8" || e.keyCode == "46") {

            var subInputs = el.querySelector(".vc-datebox-subInputs");

            var nextSubInputOrder = parseInt(subInput.parentNode.dataset.order) + 1;
            var nextSubInput = subInputs.querySelector('[data-order="' + nextSubInputOrder + '"] input');

            if ((subInput.value.length >= el._misc.mask[subInput.parentNode.dataset.field].format.length)) {

              if (nextSubInput) {
                nextSubInput.focus();
              }

              el._handleCorrection();
            }

            el._validateDate();

          }

        }

      },
      /*
      @function (private) {string} _getSelectionText
      @description Gets the selected text
      */
      getSelectionText: function () {
        var text = "";
        var activeEl = document.activeElement;
        var activeElTagName = activeEl ? activeEl.tagName.toLowerCase() : null;
        if (
          (activeElTagName == "textarea") || (activeElTagName == "input" &&
            /^(?:text|search|password|tel|url)$/i.test(activeEl.type)) &&
          (typeof activeEl.selectionStart == "number")
        ) {
          text = activeEl.value.slice(activeEl.selectionStart, activeEl.selectionEnd);
        } else if (window.getSelection) {
          text = window.getSelection().toString();
        }
        return text;
      },
      /*
      @function (private) _handleCorrection
      @description Handles the date correction for months and days
      */
      handleCorrection: function () {

        var el = this;

        var subInputs = el.querySelector(".vc-datebox-subInputs");

        var dayInput = subInputs.querySelector('[data-field="day"] input');
        var monthInput = subInputs.querySelector('[data-field="month"] input');
        var yearInput = subInputs.querySelector('[data-field="year"] input');

        if (dayInput.value != "" && parseInt(dayInput.value) > 31) {
          dayInput.value = "31";
        } else if (dayInput.value.length == 2 && parseInt(dayInput.value) == 0) {
          dayInput.value = "1";
        }

        if (monthInput.value != "" && parseInt(monthInput.value) > 12) {
          monthInput.value = "12";
        } else if (monthInput.value.length == 2 && parseInt(monthInput.value) == 0) {
          monthInput.value = "1";
        }

        if (yearInput.value != "" && parseInt(yearInput.value) > 9999) {
          yearInput.value = "9999";
        } else if (parseInt(yearInput.value) == 0) {
          yearInput.value = "1";
        }

        if (dayInput.value != "" && monthInput.value != "" && yearInput.value != "" && (yearInput.value.length == el._misc.mask.year.format.length)) {
          if (parseInt(dayInput.value) > vcomet.time.getDaysInMonth(parseInt(yearInput.value), parseInt(monthInput.value) - 1)) {
            dayInput.value = vcomet.time.getDaysInMonth(parseInt(yearInput.value), parseInt(monthInput.value) - 1);
          }
        }

        el._handleLimits(dayInput, monthInput, yearInput);
      },
      /*
      @function (private) _handleLimits
      @description Handles the limits such as min/max date
      @param {object} dayInput
      @param {object} monthInput
      @param {object} yearInput
      */
      handleLimits: function (dayInput, monthInput, yearInput) {

        var el = this;

        if (dayInput.value != "" && monthInput.value != "" && yearInput.value != "" && yearInput.value.length == el._misc.mask.year.format.length) {

          var dayInputValue = parseInt(dayInput.value);
          var monthInputValue = parseInt(monthInput.value);
          var yearInputValue = parseInt(yearInput.value);

          if ((dayInputValue < el._misc.min.day && monthInputValue <= el._misc.min.month && yearInputValue == el._misc.min.year) || (monthInputValue < el._misc.min.month && yearInputValue == el._misc.min.year) || yearInputValue < el._misc.min.year) {

            dayInput.value = el._misc.min.day;
            monthInput.value = parseInt(el._misc.min.month) + 1;
            yearInput.value = el._misc.min.year;

          } else if ((dayInputValue > el._misc.max.day && monthInputValue >= el._misc.max.month && yearInputValue == el._misc.max.year) || (monthInputValue > el._misc.max.month && yearInputValue == el._misc.max.year) || yearInputValue > el._misc.max.year) {

            dayInput.value = el._misc.max.day;
            monthInput.value = parseInt(el._misc.max.month) + 1;
            yearInput.value = el._misc.max.year;
          }
        }
      }
    },
    functions: {
      /*
      @function setValue
      @description Allows the user tu set a new value to the element
      @param {object} date
      */
      setValue: function (date) {

        var el = this;
        var subInputs = el.querySelector(".vc-datebox-subInputs");
        var dayInput = subInputs.querySelector('[data-field="day"] input');
        var monthInput = subInputs.querySelector('[data-field="month"] input');
        var yearInput = subInputs.querySelector('[data-field="year"] input');
        var day, month, year;

        day = date.toLocaleString([], {
          day: "numeric"
        });

        month = date.toLocaleString([], {
          month: "numeric"
        });

        year = date.toLocaleString([], {
          year: "numeric"
        });

        el._misc.current.day = day;
        el._misc.current.month = month;
        el._misc.current.year = year;

        if (el._refs.datePicker) {

          el._refs.datePicker._misc.current.day = day;
          el._refs.datePicker._misc.current.month = month;
          el._refs.datePicker._misc.current.year = year;

        }

        dayInput.value = day;
        monthInput.value = month;
        yearInput.value = year;

        el._handleLimits(dayInput, monthInput, yearInput);
        el._validateDate();

      }
    },
    onCreated: function () {
      vcomet.createCallback("onEnter", this);
    },
    onRender: function () {
      this._setup();
    },
    onPropertyChanged: function (key, oldVal, newVal) {
      switch (key) {
        case "label":
          this._updateLabel();
          break;
      }
    }
  });

</script>