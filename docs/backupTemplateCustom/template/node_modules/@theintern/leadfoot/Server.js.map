{"version":3,"file":"Server.js","sourceRoot":"","sources":["../../src/Server.ts"],"names":[],"mappings":"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","sourcesContent":["import keys from './keys';\n\nimport {\n  Task,\n  CancellablePromise,\n  request,\n  RequestOptions,\n  RequestMethod,\n  Response\n} from '@theintern/common';\nimport Session, { WebDriverTimeouts } from './Session';\nimport Element from './Element';\nimport statusCodes from './lib/statusCodes';\nimport { format, parse, resolve, Url } from 'url';\nimport { sleep, trimStack } from './lib/util';\nimport { Capabilities, LeadfootURL, LeadfootError } from './interfaces';\n\nexport default class Server {\n  url: string;\n\n  requestOptions: RequestOptions;\n\n  /**\n   * An alternative session constructor. Defaults to the standard [[Session]]\n   * constructor if one is not provided.\n   */\n  sessionConstructor = Session;\n\n  /**\n   * Whether or not to detect and/or correct environment capabilities when\n   * creating a new Server. If the value is \"no-detect\", capabilities will be\n   * updated with already-known features and defects based on the platform, but\n   * no tests will be run.\n   */\n  fixSessionCapabilities: boolean | 'no-detect' = true;\n\n  /**\n   * The Server class represents a remote HTTP server implementing the\n   * WebDriver wire protocol that can be used to generate new remote control\n   * sessions.\n   *\n   * @param url The fully qualified URL to the JsonWireProtocol endpoint on\n   * the server. The default endpoint for a JsonWireProtocol HTTP server is\n   * http://localhost:4444/wd/hub. You may also pass a parsed URL object\n   * which will be converted to a string.\n   * @param options Additional request options to be used for requests to the\n   * server.\n   */\n  // TODO: NodeRequestOptions doesn't take a type in dojo-core alpha 20\n  constructor(url: string | LeadfootURL, options?: RequestOptions) {\n    if (typeof url === 'object') {\n      url = <URL>{ ...url };\n      if (url.username || url.password || url.accessKey) {\n        url.auth =\n          encodeURIComponent(url.username || '') +\n          ':' +\n          encodeURIComponent(url.password || url.accessKey || '');\n      }\n    }\n\n    this.url = format(<Url>url).replace(/\\/*$/, '/');\n    this.requestOptions = options || {};\n  }\n\n  /**\n   * A function that performs an HTTP request to a JsonWireProtocol endpoint\n   * and normalises response status and data.\n   *\n   * @param method The HTTP method to fix\n   *\n   * @param path The path-part of the JsonWireProtocol URL. May contain\n   * placeholders in the form `/\\$\\d/` that will be replaced by entries in\n   * the `pathParts` argument.\n   *\n   * @param requestData The payload for the request.\n   *\n   * @param pathParts Optional placeholder values to inject into the path of\n   * the URL.\n   */\n  private _sendRequest<T>(\n    method: RequestMethod,\n    path: string,\n    requestData: any,\n    pathParts?: string[]\n  ): CancellablePromise<T> {\n    const url =\n      this.url +\n      path.replace(/\\$(\\d)/, function(_, index) {\n        return encodeURIComponent(pathParts![index]);\n      });\n\n    const defaultRequestHeaders: { [key: string]: string } = {\n      // At least FirefoxDriver on Selenium 2.40.0 will throw a\n      // NullPointerException when retrieving session capabilities if an\n      // Accept header is not provided. (It is a good idea to provide one\n      // anyway)\n      Accept: 'application/json,text/plain;q=0.9'\n    };\n\n    const headers = { ...defaultRequestHeaders };\n\n    const kwArgs: RequestOptions = {\n      ...this.requestOptions,\n      followRedirects: false,\n      handleAs: 'text',\n      headers,\n      method\n    };\n\n    if (requestData) {\n      kwArgs.data = JSON.stringify(requestData);\n      headers['Content-Type'] = 'application/json;charset=UTF-8';\n      // At least ChromeDriver 2.9.248307 will not process request data\n      // if the length of the data is not provided. (It is a good idea to\n      // provide one anyway)\n      headers['Content-Length'] = String(\n        Buffer.byteLength(kwArgs.data, 'utf8')\n      );\n    } else {\n      // At least Selenium 2.41.0 - 2.42.2 running as a grid hub will\n      // throw an exception and drop the current session if a\n      // Content-Length header is not provided with a DELETE or POST\n      // request, regardless of whether the request actually contains any\n      // request data.\n      headers['Content-Length'] = '0';\n    }\n\n    const trace: any = {};\n    Error.captureStackTrace(trace, this._sendRequest);\n\n    return new Task((resolve, reject) => {\n      request(url, kwArgs)\n        .then(resolve, reject)\n        .finally(() => {\n          const error = new Error('Canceled');\n          error.name = 'CancelError';\n          reject(error);\n        });\n    })\n      .then(function handleResponse(\n        response: Response\n      ): ResponseData | CancellablePromise<ResponseData> {\n        // The JsonWireProtocol specification prior to June 2013 stated\n        // that creating a new session should perform a 3xx redirect to\n        // the session capabilities URL, instead of simply returning\n        // the returning data about the session; as a result, we need\n        // to follow all redirects to get consistent data\n        if (\n          response.status >= 300 &&\n          response.status < 400 &&\n          response.headers.get('Location')\n        ) {\n          let redirectUrl = response.headers.get('Location')!;\n\n          // If redirectUrl isn't an absolute URL, resolve it based\n          // on the orignal URL used to create the session\n          if (!/^\\w+:/.test(redirectUrl)) {\n            redirectUrl = resolve(url, redirectUrl);\n          }\n\n          return request(redirectUrl, {\n            headers: defaultRequestHeaders\n          }).then(handleResponse);\n        }\n\n        return response.text().then(data => {\n          return { response, data };\n        });\n      })\n      .then((responseData: ResponseData) => {\n        const response = responseData.response;\n        const responseType = response.headers.get('Content-Type');\n        let data: any;\n\n        if (\n          responseType &&\n          responseType.indexOf('application/json') === 0 &&\n          responseData.data\n        ) {\n          data = JSON.parse(responseData.data);\n        }\n\n        // Some drivers will respond to a DELETE request with 204; in\n        // this case, we know the operation completed successfully, so\n        // just create an expected response data structure for a\n        // successful operation to avoid any special conditions\n        // elsewhere in the code caused by different HTTP return values\n        if (response.status === 204) {\n          data = {\n            status: 0,\n            sessionId: null,\n            value: null\n          };\n        } else if (response.status >= 400 || (data && data.status > 0)) {\n          const error: any = new Error();\n\n          // \"The client should interpret a 404 Not Found response\n          // from the server as an \"Unknown command\" response. All\n          // other 4xx and 5xx responses from the server that do not\n          // define a status field should be interpreted as \"Unknown\n          // error\" responses.\" -\n          // http://code.google.com/p/selenium/wiki/JsonWireProtocol#Response_Status_Codes\n          if (!data) {\n            data = {\n              status:\n                response.status === 404 || response.status === 501 ? 9 : 13,\n              value: {\n                message: responseData.data\n              }\n            };\n          } else if (!data.value && 'message' in data) {\n            // ios-driver 0.6.6-SNAPSHOT April 2014 incorrectly\n            // implements the specification: does not return error\n            // data on the `value` key, and does not return the\n            // correct HTTP status for unknown commands\n            data = {\n              status:\n                response.status === 404 ||\n                response.status === 501 ||\n                data.message.indexOf('cannot find command') > -1\n                  ? 9\n                  : 13,\n              value: data\n            };\n          }\n\n          // At least Appium April 2014 responds with the HTTP status\n          // Not Implemented but a Selenium status UnknownError for\n          // commands that are not implemented; these errors are more\n          // properly represented to end-users using the Selenium\n          // status UnknownCommand, so we make the appropriate\n          // coercion here\n          if (response.status === 501 && data.status === 13) {\n            data.status = 9;\n          }\n\n          // At least BrowserStack in May 2016 responds with HTTP 500\n          // and a message value of \"Invalid Command\" for at least\n          // some unknown commands. These errors are more properly\n          // represented to end-users using the Selenium status\n          // UnknownCommand, so we make the appropriate coercion here\n          if (\n            response.status === 500 &&\n            data.value &&\n            data.value.message === 'Invalid Command'\n          ) {\n            data.status = 9;\n          }\n\n          // At least FirefoxDriver 2.40.0 responds with HTTP status\n          // codes other than Not Implemented and a Selenium status\n          // UnknownError for commands that are not implemented;\n          // however, it provides a reliable indicator that the\n          // operation was unsupported by the type of the exception\n          // that was thrown, so also coerce this back into an\n          // UnknownCommand response for end-user code\n          if (\n            data.status === 13 &&\n            data.value &&\n            data.value.class &&\n            (data.value.class.indexOf('UnsupportedOperationException') > -1 ||\n              data.value.class.indexOf('UnsupportedCommandException') > -1)\n          ) {\n            data.status = 9;\n          }\n\n          // At least InternetExplorerDriver 2.41.0 & SafariDriver\n          // 2.41.0 respond with HTTP status codes other than Not\n          // Implemented and a Selenium status UnknownError for\n          // commands that are not implemented; like FirefoxDriver\n          // they provide a reliable indicator of unsupported\n          // commands\n          if (\n            response.status === 500 &&\n            data.value &&\n            data.value.message &&\n            (data.value.message.indexOf('Command not found') > -1 ||\n              data.value.message.indexOf('Unknown command') > -1)\n          ) {\n            data.status = 9;\n          }\n\n          // At least GhostDriver 1.1.0 incorrectly responds with\n          // HTTP 405 instead of HTTP 501 for unimplemented commands\n          if (\n            response.status === 405 &&\n            data.value &&\n            data.value.message &&\n            data.value.message.indexOf('Invalid Command Method') > -1\n          ) {\n            data.status = 9;\n          }\n\n          const statusCode = statusCodes[<keyof typeof statusCodes>data.status];\n          if (statusCode) {\n            const [name, message] = statusCode;\n            if (name && message) {\n              error.name = name;\n              error.message = message;\n            }\n          }\n\n          if (data.value && data.value.message) {\n            error.message = data.value.message;\n          }\n\n          if (data.value && data.value.screen) {\n            data.value.screen = Buffer.from(data.value.screen, 'base64');\n          }\n\n          error.status = data.status;\n          error.detail = data.value;\n          error.name = getErrorName(error);\n\n          error.request = {\n            url: url,\n            method: method,\n            data: requestData\n          };\n          error.response = response;\n\n          const sanitizedUrl = (function() {\n            const parsedUrl = parse(url);\n            if (parsedUrl.auth) {\n              parsedUrl.auth = '(redacted)';\n            }\n\n            return format(parsedUrl);\n          })();\n\n          error.message =\n            `[${method} ${sanitizedUrl}` +\n            (requestData ? ` / ${JSON.stringify(requestData)}` : '') +\n            `] ${error.message}`;\n          error.stack = error.message + trimStack(trace.stack);\n\n          throw error;\n        }\n\n        return data;\n      })\n      .catch(function(error) {\n        error.stack = error.message + trimStack(trace.stack);\n        throw error;\n      });\n  }\n\n  get<T>(\n    path: string,\n    requestData?: Object,\n    pathParts?: string[]\n  ): CancellablePromise<T> {\n    return this._sendRequest<T>('GET', path, requestData, pathParts);\n  }\n\n  post<T>(\n    path: string,\n    requestData?: Object,\n    pathParts?: string[]\n  ): CancellablePromise<T> {\n    return this._sendRequest<T>('POST', path, requestData, pathParts);\n  }\n\n  delete<T>(\n    path: string,\n    requestData?: Object,\n    pathParts?: string[]\n  ): CancellablePromise<T> {\n    return this._sendRequest<T>('DELETE', path, requestData, pathParts);\n  }\n\n  /**\n   * Gets the status of the remote server.\n   *\n   * @returns An object containing arbitrary properties describing the status\n   * of the remote server.\n   */\n  getStatus() {\n    return this.get('status').then(returnValue);\n  }\n\n  /**\n   * Creates a new remote control session on the remote server.\n   *\n   * @param desiredCapabilities A hash map of desired capabilities of the\n   * remote environment. The server may return an environment that does not\n   * match all the desired capabilities if one is not available.\n   *\n   * @param requiredCapabilities A hash map of required capabilities of the\n   * remote environment. The server will not return an environment that does\n   * not match all the required capabilities if one is not available.\n   */\n  createSession<S extends Session = Session>(\n    desiredCapabilities: Capabilities,\n    requiredCapabilities?: Capabilities\n  ): CancellablePromise<S> {\n    let fixSessionCapabilities = this.fixSessionCapabilities;\n    if (desiredCapabilities.fixSessionCapabilities != null) {\n      fixSessionCapabilities = desiredCapabilities.fixSessionCapabilities;\n\n      // Dont send `fixSessionCapabilities` to the server\n      desiredCapabilities = { ...desiredCapabilities };\n      desiredCapabilities.fixSessionCapabilities = undefined;\n    }\n\n    return this.post<any>('session', {\n      desiredCapabilities,\n      requiredCapabilities\n    }).then(response => {\n      let responseData: object;\n      let sessionId: string;\n\n      if (response.value.sessionId && response.value.capabilities) {\n        // At least geckodriver 0.16 - 0.19 return the sessionId and\n        // capabilities as value.sessionId and value.capabilities.\n        responseData = response.value.capabilities;\n        sessionId = response.value.sessionId;\n      } else if (response.value.value && response.value.sessionId) {\n        // At least geckodriver 0.15.0 returns the sessionId and\n        // capabilities as value.sessionId and value.value.\n        responseData = response.value.value;\n        sessionId = response.value.sessionId;\n      } else {\n        // Selenium and chromedriver return the sessionId as a top\n        // level property in the response, and the capabilities in a\n        // 'value' property.\n        responseData = response.value;\n        sessionId = response.sessionId;\n      }\n\n      const session = new this.sessionConstructor(\n        sessionId,\n        this,\n        responseData\n      );\n\n      // Add any desired capabilities that were originally specified but aren't\n      // present in the capabilities returned by the server. This will allow\n      // for feature flags to be manually set.\n      const userKeys = Object.keys(desiredCapabilities).filter(\n        key => !(key in session.capabilities)\n      );\n      for (const key of userKeys) {\n        session.capabilities[key] = desiredCapabilities[key];\n      }\n\n      if (fixSessionCapabilities) {\n        return this._fillCapabilities(\n          <S>session,\n          fixSessionCapabilities !== 'no-detect'\n        )\n          .catch(error =>\n            // The session was started on the server, but we did\n            // not resolve the Task yet. If a failure occurs during\n            // capabilities filling, we should quit the session on\n            // the server too since the caller will not be aware\n            // that it ever got that far and will have no access to\n            // the session to quit itself.\n            session.quit().finally(() => {\n              throw error;\n            })\n          )\n          .then(() => <S>session);\n      } else {\n        return <S>session;\n      }\n    });\n  }\n\n  /**\n   * Fill in known capabilities/defects and optionally run tests to detect\n   * more\n   */\n  private _fillCapabilities<S extends Session>(\n    session: S,\n    detectCapabilities = true\n  ): CancellablePromise<S> {\n    Object.assign(session.capabilities, this._getKnownCapabilities(session));\n    return (detectCapabilities\n      ? this._detectCapabilities(session)\n      : Task.resolve(session)\n    ).then(() => {\n      Object.defineProperty(session.capabilities, '_filled', {\n        value: true,\n        configurable: true\n      });\n      return session;\n    });\n  }\n\n  /**\n   * Return capabilities and defects that don't require running tests\n   */\n  private _getKnownCapabilities(session: Session) {\n    const capabilities = session.capabilities;\n    const updates: Capabilities = {};\n\n    // Safari 10 and 11 report their versions on a 'version' property using\n    // non-contiguous version numbers. Versions < 10 use standard numbers on\n    // a 'version' property, while versions >= 12 use standard numbers on a\n    // browserVersion property.\n    if (\n      isSafari(session.capabilities) &&\n      !session.capabilities.browserVersion\n    ) {\n      const { version } = session.capabilities;\n      const versionNum = parseFloat(version!);\n      if (versionNum > 12000 && versionNum < 13000) {\n        session.capabilities.browserVersion = '10';\n      } else if (versionNum > 13000) {\n        session.capabilities.browserVersion = '11';\n      }\n    }\n\n    // At least geckodriver 0.15.0 only returns platformName (not platform)\n    // and browserVersion (not version) in its capabilities.\n    if (capabilities.platform && !capabilities.platformName) {\n      capabilities.platformName = capabilities.platform;\n    }\n    if (capabilities.version && !capabilities.browserVersion) {\n      capabilities.browserVersion = capabilities.version;\n    }\n\n    // At least SafariDriver 2.41.0 fails to allow stand-alone feature\n    // testing because it does not inject user scripts for URLs that are\n    // not http/https\n    if (isSafari(capabilities)) {\n      if (isMac(capabilities)) {\n        if (isValidVersion(capabilities, 0, 11)) {\n          Object.assign(updates, {\n            nativeEvents: false,\n            rotatable: false,\n            locationContextEnabled: false,\n            webStorageEnabled: false,\n            applicationCacheEnabled: false,\n            supportsNavigationDataUris: true,\n            supportsCssTransforms: true,\n            supportsExecuteAsync: true,\n            mouseEnabled: true,\n            touchEnabled: false,\n            dynamicViewport: true,\n            shortcutKey: keys.COMMAND,\n\n            // This must be set; running it as a server test will cause\n            // SafariDriver to emit errors with the text \"undefined is not\n            // an object (evaluating 'a.postMessage')\", and the session\n            // will become unresponsive\n            returnsFromClickImmediately: false,\n\n            brokenDeleteCookie: false,\n            brokenExecuteElementReturn: false,\n            brokenExecuteUndefinedReturn: false,\n            brokenElementDisplayedOpacity: false,\n            brokenElementDisplayedOffscreen: false,\n            brokenSubmitElement: true,\n            brokenWindowSwitch: true,\n            brokenDoubleClick: false,\n            brokenCssTransformedSize: true,\n            fixedLogTypes: false as false,\n            brokenHtmlTagName: false,\n            brokenNullGetSpecAttribute: false\n          });\n        }\n\n        if (isValidVersion(capabilities, 0, 10)) {\n          Object.assign(updates, {\n            // SafariDriver, which shows versions up to 9.x, doesn't support file\n            // uploads\n            remoteFiles: false,\n\n            brokenActiveElement: true,\n            brokenExecuteForNonHttpUrl: true,\n            brokenMouseEvents: true,\n            brokenNavigation: true,\n            brokenOptionSelect: false,\n            brokenSendKeys: true,\n            brokenWindowPosition: true,\n            brokenWindowSize: true,\n\n            // SafariDriver 2.41.0 cannot delete cookies, at all, ever\n            brokenCookies: true\n          });\n        }\n\n        if (isValidVersion(capabilities, 10, 12)) {\n          Object.assign(updates, {\n            brokenLinkTextLocator: true,\n            // At least Safari 11 will hang on the brokenOptionSelect test\n            brokenOptionSelect: true,\n            brokenWhitespaceNormalization: true,\n            brokenMouseEvents: true,\n            brokenWindowClose: true,\n            usesWebDriverActiveElement: true\n          });\n        }\n\n        if (isValidVersion(capabilities, 12)) {\n          Object.assign(updates, {\n            // At least Safari 12 uses W3C webdriver standard, including\n            // /attribute/:attr\n            usesWebDriverElementAttribute: true,\n            // At least Safari 12 will sometimes close a tab or window other\n            // than the current top-level browsing context when using DELETE\n            // /window\n            brokenDeleteWindow: true\n          });\n        }\n      }\n\n      // At least ios-driver 0.6.6-SNAPSHOT April 2014 corrupts its\n      // internal state when performing window switches and gets\n      // permanently stuck; we cannot feature detect, so platform\n      // sniffing it is\n      if (isIos(capabilities)) {\n        updates.brokenWindowSwitch = true;\n      }\n\n      return updates;\n    }\n\n    if (isFirefox(capabilities)) {\n      if (isValidVersion(capabilities, 49, Infinity)) {\n        // The W3C WebDriver standard does not support the session-level\n        // /keys command, but JsonWireProtocol does.\n        updates.noKeysCommand = true;\n\n        // Firefox 49+ (via geckodriver) only supports W3C locator\n        // strategies\n        updates.usesWebDriverLocators = true;\n\n        // Non-W3C Firefox 49+ (via geckodriver) requires keys sent to an element\n        // to be a flat array\n        updates.usesFlatKeysArray = true;\n\n        // At least Firefox 49 + geckodriver can't POST empty data\n        updates.brokenEmptyPost = true;\n\n        // At least geckodriver 0.11 and Firefox 49 don't implement mouse\n        // control, so everything will need to be simulated.\n        updates.brokenMouseEvents = true;\n\n        // Firefox 49+ (via geckodriver) doesn't support retrieving logs or\n        // log types, and may hang the session.\n        updates.fixedLogTypes = [];\n      }\n\n      if (isValidVersion(capabilities, 49, 53)) {\n        // At least geckodriver 0.15.0 and Firefox 51 will stop responding\n        // to commands when performing window switches.\n        updates.brokenWindowSwitch = true;\n      }\n\n      // Using mouse services such as doubleclick will hang Firefox 49+\n      // session on the Mac.\n      if (\n        capabilities.mouseEnabled == null &&\n        isValidVersion(capabilities, 49, Infinity) &&\n        isMac(capabilities)\n      ) {\n        updates.mouseEnabled = true;\n      }\n    }\n\n    if (isMsEdge(capabilities)) {\n      // At least MS Edge 14316 returns immediately from a click request\n      // immediately rather than waiting for default action to occur.\n      updates.returnsFromClickImmediately = true;\n\n      // At least MS Edge before 44.17763 may return an 'element is obscured'\n      // error when trying to click on visible elements.\n      if (isValidVersion(capabilities, 0, 44.17763)) {\n        updates.brokenClick = true;\n      }\n\n      // File uploads don't work on Edge as of May 2017\n      updates.remoteFiles = false;\n\n      // At least MS Edge 10586 becomes unresponsive after calling DELETE\n      // window, and window.close() requires user interaction. This\n      // capability is distinct from brokenDeleteWindow as this capability\n      // indicates that there is no way to close a Window.\n      if (isValidVersion(capabilities, 25.10586)) {\n        updates.brokenWindowClose = true;\n      }\n\n      // At least MS Edge Driver 14316 doesn't support sending keys to a file\n      // input. See\n      // https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/7194303/\n      //\n      // The existing feature test for this caused some browsers to hang, so\n      // just flag it for Edge for now.\n      if (isValidVersion(capabilities, 38.14366)) {\n        updates.brokenFileSendKeys = true;\n      }\n\n      // At least MS Edge 14316 supports alerts but does not specify the\n      // capability\n      if (\n        isValidVersion(capabilities, 37.14316) &&\n        !('handlesAlerts' in capabilities)\n      ) {\n        updates.handlesAlerts = true;\n      }\n\n      // MS Edge 17763+ do not support the JWP execute commands. However, they\n      // return a JavaScriptError rather than something indicating that the\n      // command isn't supported.\n      if (isValidVersion(capabilities, 44.17763)) {\n        if (capabilities.usesWebDriverExecuteSync == null) {\n          updates.usesWebDriverExecuteSync = true;\n        }\n\n        if (capabilities.usesWebDriverExecuteAsync == null) {\n          updates.usesWebDriverExecuteAsync = true;\n        }\n      }\n\n      // MS Edge < 18 (44.17763) doesn't properly support cookie deletion\n      if (isValidVersion(capabilities, 0, 43)) {\n        updates.brokenDeleteCookie = true;\n      }\n    }\n\n    if (isInternetExplorer(capabilities)) {\n      if (isValidVersion(capabilities, 11)) {\n        // IE11 will take screenshots, but it's very slow\n        updates.takesScreenshot = true;\n\n        // IE11 will hang during this check if nativeEvents are enabled\n        updates.brokenSubmitElement = true;\n      }\n\n      if (isValidVersion(capabilities, 11, Infinity)) {\n        // At least IE11 will hang during this check, although option\n        // selection does work with it\n        updates.brokenOptionSelect = false;\n      }\n\n      // It is not possible to test this since the feature tests runs in\n      // quirks-mode on IE<10, but we know that IE9 supports CSS transforms\n      if (isValidVersion(capabilities, 9)) {\n        updates.supportsCssTransforms = true;\n      }\n\n      // Internet Explorer 8 and earlier will simply crash the server if we\n      // attempt to return the parent frame via script, so never even attempt\n      // to do so\n      updates.scriptedParentFrameCrashesBrowser = isValidVersion(\n        capabilities,\n        0,\n        9\n      );\n    }\n\n    // Don't check for touch support if the environment reports that no\n    // touchscreen is available. Also, ChromeDriver\n    // 2.19 claims that it supports touch but it does not implement all of\n    //   the touch endpoints from JsonWireProtocol\n    if (capabilities.hasTouchScreen === false || isChrome(capabilities)) {\n      updates.touchEnabled = false;\n    }\n\n    updates.shortcutKey = (function() {\n      if (isIos(capabilities)) {\n        return null;\n      }\n\n      if (isMac(capabilities)) {\n        return keys.COMMAND;\n      }\n\n      return keys.CONTROL;\n    })();\n\n    // At least selendroid 0.12.0-SNAPSHOT doesn't support switching to the\n    // parent frame\n    if (isAndroid(capabilities) && isAndroidEmulator(capabilities)) {\n      updates.brokenParentFrameSwitch = true;\n    }\n\n    return updates;\n  }\n\n  /**\n   * Run tests to detect capabilities/defects\n   */\n  private _detectCapabilities(\n    session: Session\n  ): CancellablePromise<void | Session> {\n    const capabilities = session.capabilities;\n    const supported = () => true;\n    const unsupported = () => false;\n    const maybeSupported = (error: Error) => {\n      if (error.name === 'UnknownCommand') {\n        return false;\n      }\n      if (/\\bunimplemented command\\b/.test(error.message)) {\n        return false;\n      }\n      if (/The command .* not found/.test(error.message)) {\n        return false;\n      }\n      return true;\n    };\n    const broken = supported;\n    const works = unsupported;\n\n    /**\n     * Adds the capabilities listed in the `testedCapabilities` object to\n     * the hash of capabilities for the current session. If a tested\n     * capability value is a function, it is assumed that it still needs to\n     * be executed serially in order to resolve the correct value of that\n     * particular capability.\n     */\n    const addCapabilities = (\n      testedCapabilities: Capabilities\n    ): CancellablePromise<void> =>\n      Object.keys(testedCapabilities).reduce(\n        (previous: CancellablePromise<void>, key: keyof Capabilities) =>\n          previous.then(() => {\n            const value = testedCapabilities[key];\n            const task =\n              typeof value === 'function' ? value() : Task.resolve(value);\n            return task.then((value: any) => {\n              capabilities[key] = value;\n            });\n          }),\n        Task.resolve()\n      );\n\n    const get = (page: string) => {\n      if (capabilities.supportsNavigationDataUris !== false) {\n        return session.get(\n          'data:text/html;charset=utf-8,' + encodeURIComponent(page)\n        );\n      }\n\n      // Internet Explorer 9 and earlier, and Microsoft Edge build 10240\n      // and earlier, hang when attempting to do navigate after a\n      // `document.write` is performed to reset the tab content; we can\n      // still do some limited testing in these browsers by using the\n      // initial browser URL page and injecting some content through\n      // innerHTML, though it is unfortunately a quirks-mode file so\n      // testing is limited\n      if (isInternetExplorer(capabilities, 0, 10) || isMsEdge(capabilities)) {\n        // Edge driver doesn't provide an initialBrowserUrl\n        let initialUrl = 'about:blank';\n\n        // As of version 3.3.0.1, IEDriverServer provides IE-specific\n        // options, including the initialBrowserUrl, under an\n        // 'se:ieOptions' property rather than directly on\n        // capabilities.\n        // https://github.com/SeleniumHQ/selenium/blob/e60b607a97b9b7588d59e0c26ef9a6d1d1350911/cpp/iedriverserver/CHANGELOG\n        if (isInternetExplorer(capabilities) && capabilities['se:ieOptions']) {\n          initialUrl = capabilities['se:ieOptions'].initialBrowserUrl;\n        } else if (capabilities.initialBrowserUrl) {\n          initialUrl = capabilities.initialBrowserUrl;\n        }\n\n        return session.get(initialUrl).then(function() {\n          return session.execute<void>(\n            'document.body.innerHTML = arguments[0];',\n            [\n              // The DOCTYPE does not apply, for obvious reasons, but\n              // also old IE will discard invisible elements like\n              // `<script>` and `<style>` if they are the first\n              // elements injected with `innerHTML`, so an extra text\n              // node is added before the rest of the content instead\n              page.replace('<!DOCTYPE html>', 'x')\n            ]\n          );\n        });\n      }\n\n      return session.get('about:blank').then(function() {\n        return session.execute<void>('document.write(arguments[0]);', [page]);\n      });\n    };\n\n    const discoverServerFeatures = () => {\n      const testedCapabilities: any = {};\n\n      // Check that the remote server will accept file uploads. There is\n      // a secondary test in discoverDefects that checks whether the\n      // server allows typing into file inputs.\n      if (capabilities.remoteFiles == null) {\n        testedCapabilities.remoteFiles = () =>\n          // TODO: _post probably shouldn't be private\n          session\n            .serverPost<string>('file', {\n              file:\n                'UEsDBAoAAAAAAD0etkYAAAAAAAAAAAAA' +\n                'AAAIABwAdGVzdC50eHRVVAkAA2WnXlVl' +\n                'p15VdXgLAAEE8gMAAATyAwAAUEsBAh4D' +\n                'CgAAAAAAPR62RgAAAAAAAAAAAAAAAAgA' +\n                'GAAAAAAAAAAAAKSBAAAAAHRlc3QudHh0' +\n                'VVQFAANlp15VdXgLAAEE8gMAAATyAwAA' +\n                'UEsFBgAAAAABAAEATgAAAEIAAAAAAA=='\n            })\n            .then(filename => filename && filename.indexOf('test.txt') > -1)\n            .catch(unsupported);\n      }\n\n      if (capabilities.supportsSessionCommand == null) {\n        testedCapabilities.supportsSessionCommands = () =>\n          this.get('session/$0', undefined, [session.sessionId]).then(\n            supported,\n            unsupported\n          );\n      }\n\n      if (capabilities.supportsGetTimeouts == null) {\n        testedCapabilities.supportsGetTimeouts = () => {\n          return session.serverGet('timeouts').then(supported, unsupported);\n        };\n      }\n\n      if (capabilities.usesWebDriverTimeouts == null) {\n        testedCapabilities.usesWebDriverTimeouts = () => {\n          return (\n            session\n              // Try to set a timeout using W3C semantics\n              .serverPost<void>('timeouts', { implicit: 1234 })\n              .then(() => {\n                // Verify that the timeout was set\n                return session\n                  .serverGet<WebDriverTimeouts>('timeouts')\n                  .then(timeouts => {\n                    return timeouts.implicit === 1234;\n                  })\n                  .catch(unsupported);\n              }, unsupported)\n          );\n        };\n      }\n\n      if (capabilities.usesWebDriverWindowCommands == null) {\n        testedCapabilities.usesWebDriverWindowCommands = () =>\n          session.serverGet('window/rect').then(supported, unsupported);\n      }\n\n      // The W3C standard says window commands should take a 'handle'\n      // parameter, while the JsonWireProtocol used a 'name' parameter.\n      if (capabilities.usesHandleParameter == null) {\n        testedCapabilities.usesHandleParameter = () =>\n          session\n            .switchToWindow('current')\n            .then(\n              unsupported,\n              error =>\n                error.name === 'InvalidArgument' ||\n                /missing .*handle/i.test(error.message)\n            );\n      }\n\n      // Sauce Labs will not return a list of sessions at least as of May\n      // 2017\n      if (capabilities.brokenSessionList == null) {\n        testedCapabilities.brokenSessionList = () =>\n          this.getSessions().then(works, broken);\n      }\n\n      if (capabilities.usesWebDriverFrameId == null) {\n        testedCapabilities.usesWebDriverFrameId = () =>\n          get(\n            '<!DOCTYPE html><html><body><iframe id=\"inlineFrame\"></iframe></body></html>'\n          ).then(() =>\n            session.serverPost<void>('frame', { id: 'inlineFrame' }).then(\n              unsupported,\n              error =>\n                error.name === 'NoSuchFrame' ||\n                // At least geckodriver 0.24.0 throws an Unknown Command error\n                // with a message about an invalid tag name rather than a NoSuchFrame error\n                // (see https://github.com/mozilla/geckodriver/issues/1456)\n                /any variant of untagged/.test(error.message)\n            )\n          );\n      }\n\n      if (capabilities.returnsFromClickImmediately == null) {\n        testedCapabilities.returnsFromClickImmediately = () => {\n          function assertSelected(expected: any) {\n            return function(actual: any) {\n              if (expected !== actual) {\n                throw new Error('unexpected selection state');\n              }\n            };\n          }\n\n          return get('<!DOCTYPE html><input type=\"checkbox\" id=\"c\">')\n            .then(() => session.findById('c'))\n            .then(element =>\n              element\n                .click()\n                .then(() => element.isSelected())\n                .then(assertSelected(true))\n                .then(() => element.click().then(() => element.isSelected()))\n                .then(assertSelected(false))\n                .then(() => element.click().then(() => element.isSelected()))\n                .then(assertSelected(true))\n            )\n            .then(works, broken);\n        };\n      }\n\n      // The W3C WebDriver standard does not support the session-level\n      // /keys command, but JsonWireProtocol does.\n      if (capabilities.noKeysCommand == null) {\n        testedCapabilities.noKeysCommand = () =>\n          session\n            .serverPost('keys', { value: ['a'] })\n            .then(() => false, () => true);\n      }\n\n      // The W3C WebDriver standard does not support the /displayed endpoint\n      if (capabilities.noElementDisplayed == null) {\n        testedCapabilities.noElementDisplayed = () =>\n          session\n            .findByCssSelector('html')\n            .then(element => element.isDisplayed())\n            .then(() => false, () => true);\n      }\n\n      return Task.all(\n        Object.keys(testedCapabilities).map(key => testedCapabilities[key])\n      ).then(() => testedCapabilities);\n    };\n\n    const discoverFeatures = () => {\n      const testedCapabilities: any = {};\n\n      // At least SafariDriver 2.41.0 fails to allow stand-alone feature\n      // testing because it does not inject user scripts for URLs that\n      // are not http/https\n      if (isSafari(capabilities, 0, 10) && isMac(capabilities)) {\n        return Task.resolve({});\n      }\n\n      // Appium iOS as of April 2014 supports rotation but does not\n      // specify the capability\n      if (capabilities.rotatable == null) {\n        testedCapabilities.rotatable = () =>\n          session.getOrientation().then(supported, unsupported);\n      }\n\n      if (capabilities.locationContextEnabled) {\n        testedCapabilities.locationContextEnabled = () =>\n          session.getGeolocation().then(supported, function(error) {\n            // At least FirefoxDriver 2.40.0 and ios-driver 0.6.0\n            // claim they support geolocation in their returned\n            // capabilities map, when they do not\n            if (error.message.indexOf('not mapped : GET_LOCATION') !== -1) {\n              return false;\n            }\n\n            // At least chromedriver 2.25 requires the location to\n            // be set first. At least chromedriver 2.25 will throw\n            // a CastClassException while trying to retrieve a\n            // geolocation.\n            if (error.message.indexOf('Location must be set') !== -1) {\n              return session\n                .setGeolocation({\n                  latitude: 12.1,\n                  longitude: -22.33,\n                  altitude: 1000.2\n                })\n                .then(() => session.getGeolocation())\n                .then(supported, unsupported);\n            }\n\n            return false;\n          });\n      }\n\n      // At least FirefoxDriver 2.40.0 claims it supports web storage in\n      // the returned capabilities map, when it does not\n      if (capabilities.webStorageEnabled) {\n        testedCapabilities.webStorageEnabled = () =>\n          session.getLocalStorageLength().then(supported, maybeSupported);\n      }\n\n      // At least FirefoxDriver 2.40.0 claims it supports application\n      // cache in the returned capabilities map, when it does not\n      if (capabilities.applicationCacheEnabled) {\n        testedCapabilities.applicationCacheEnabled = () =>\n          session.getApplicationCacheStatus().then(supported, maybeSupported);\n      }\n\n      if (capabilities.takesScreenshot == null) {\n        // At least Selendroid 0.9.0 will fail to take screenshots in\n        // certain device configurations, usually emulators with\n        // hardware acceleration enabled\n        testedCapabilities.takesScreenshot = () =>\n          session.takeScreenshot().then(supported, unsupported);\n      }\n\n      // At least ios-driver 0.6.6-SNAPSHOT April 2014 does not support\n      // execute_async\n      if (capabilities.supportsExecuteAsync == null) {\n        testedCapabilities.supportsExecuteAsync = () =>\n          session.executeAsync('arguments[0](true);').catch(unsupported);\n      }\n\n      // Using mouse services such as doubleclick will hang Firefox 49+\n      // session on the Mac.\n      if (\n        capabilities.mouseEnabled == null &&\n        !(isFirefox(capabilities, 49, Infinity) && isMac(capabilities))\n      ) {\n        testedCapabilities.mouseEnabled = () =>\n          get('<!DOCTYPE html><button id=\"clicker\">Click me</button>')\n            .then(() => session.findById('clicker'))\n            .then(button => button.click().then(supported, maybeSupported))\n            .catch(unsupported);\n      }\n\n      if (capabilities.touchEnabled == null) {\n        testedCapabilities.touchEnabled = () =>\n          get('<!DOCTYPE html><button id=\"clicker\">Click me</button>')\n            .then(() => session.findById('clicker'))\n            .then(button =>\n              session.doubleTap(button).then(supported, maybeSupported)\n            )\n            .catch(unsupported);\n      }\n\n      if (capabilities.dynamicViewport == null) {\n        testedCapabilities.dynamicViewport = () =>\n          session\n            .getWindowSize()\n            .then(originalSize =>\n              // At least Firefox 53 will hang if the target size is\n              // the same as the current size\n              session.setWindowSize(\n                originalSize.width - 2,\n                originalSize.height - 2\n              )\n            )\n            .then(supported, unsupported);\n      }\n\n      // At least Internet Explorer 11 and earlier do not allow data URIs\n      // to be used for navigation\n      if (capabilities.supportsNavigationDataUris == null) {\n        testedCapabilities.supportsNavigationDataUris = () =>\n          get('<!DOCTYPE html><title>a</title>')\n            .then(() => session.getPageTitle())\n            .then(pageTitle => pageTitle === 'a')\n            .catch(unsupported);\n      }\n\n      if (capabilities.supportsCssTransforms == null) {\n        testedCapabilities.supportsCssTransforms = () =>\n          get(\n            '<!DOCTYPE html><style>' +\n              '#a{width:8px;height:8px;-ms-transform:scale(0.5);' +\n              '-moz-transform:scale(0.5);-webkit-transform:scale(0.5);' +\n              'transform:scale(0.5);}</style><div id=\"a\"></div>'\n          )\n            .then(() =>\n              session.execute(\n                /* istanbul ignore next */ () => {\n                  const bbox = document\n                    .getElementById('a')!\n                    .getBoundingClientRect();\n                  return bbox.right - bbox.left === 4;\n                }\n              )\n            )\n            .catch(unsupported);\n      }\n\n      return Task.all(\n        Object.keys(testedCapabilities).map(key => testedCapabilities[key])\n      ).then(() => testedCapabilities);\n    };\n\n    const discoverDefects = (): CancellablePromise<Capabilities> => {\n      const testedCapabilities: any = {};\n\n      // At least SafariDriver 2.41.0 fails to allow stand-alone feature\n      // testing because it does not inject user scripts for URLs that\n      // are not http/https\n      if (isSafari(capabilities, 0, 10) && isMac(capabilities)) {\n        return Task.resolve({});\n      }\n\n      // At least ChromeDriver 2.9 and MS Edge 10240 does not implement\n      // /element/active\n      if (capabilities.brokenActiveElement == null) {\n        testedCapabilities.brokenActiveElement = () =>\n          session\n            .getActiveElement()\n            .then(works, error => error.name === 'UnknownCommand');\n      }\n\n      if (capabilities.brokenDeleteCookie == null) {\n        if (capabilities.browserName === 'selendroid') {\n          // At least Selendroid 0.9.0 has broken cookie deletion.\n          // This test is very hard to get working properly in other\n          // environments so only test when Selendroid is the browser\n          testedCapabilities.brokenDeleteCookie = () =>\n            session\n              .get('about:blank')\n              .then(() => session.clearCookies())\n              .then(() =>\n                session.setCookie({\n                  name: 'foo',\n                  value: 'foo'\n                })\n              )\n              .then(() => session.deleteCookie('foo'))\n              .then(() => session.getCookies())\n              .then(cookies => cookies.length > 0)\n              .catch(() => true)\n              .then(isBroken =>\n                session.clearCookies().then(() => isBroken, () => isBroken)\n              );\n        } else {\n          // At least MS Edge < 18 doesn't support cookie deletion\n          testedCapabilities.brokenDeleteCookie = () =>\n            session\n              .get('about:blank')\n              .then(() => session.clearCookies())\n              .then(works, broken);\n        }\n      }\n\n      // At least Selendroid 0.9.0 incorrectly returns HTML tag names in\n      // uppercase, which is a violation of the JsonWireProtocol spec\n      if (capabilities.brokenHtmlTagName == null) {\n        testedCapabilities.brokenHtmlTagName = () =>\n          session\n            .findByTagName('html')\n            .then(element => element.getTagName())\n            .then(tagName => tagName !== 'html')\n            .catch(broken);\n      }\n\n      // At least ios-driver 0.6.6-SNAPSHOT incorrectly returns empty\n      // string instead of null for attributes that do not exist\n      if (capabilities.brokenNullGetSpecAttribute == null) {\n        testedCapabilities.brokenNullGetSpecAttribute = () =>\n          session\n            .findByTagName('html')\n            .then(element => element.getSpecAttribute('nonexisting'))\n            .then(value => value !== null)\n            .catch(broken);\n      }\n\n      // At least MS Edge 10240 doesn't properly deserialize web elements\n      // passed as `execute` arguments\n      if (capabilities.brokenElementSerialization == null) {\n        testedCapabilities.brokenElementSerialization = () =>\n          get('<!DOCTYPE html><div id=\"a\"></div>')\n            .then(() => session.findById('a'))\n            .then(element =>\n              session.execute(\n                /* istanbul ignore next */\n                (element: Element) => element.getAttribute('id'),\n                [element]\n              )\n            )\n            .then(attribute => attribute !== 'a')\n            .catch(broken);\n      }\n\n      // At least Selendroid 0.16.0 incorrectly returns `undefined`\n      // instead of `null` when an undefined value is returned by an\n      // `execute` call\n      if (capabilities.brokenExecuteUndefinedReturn == null) {\n        testedCapabilities.brokenExecuteUndefinedReturn = () =>\n          session\n            .execute('return undefined;')\n            .then(value => value !== null, broken);\n      }\n\n      // At least Selendroid 0.9.0 always returns invalid element handles\n      // from JavaScript\n      if (capabilities.brokenExecuteElementReturn == null) {\n        testedCapabilities.brokenExecuteElementReturn = () =>\n          get('<!DOCTYPE html><div id=\"a\"></div>')\n            .then(() =>\n              session.execute<Element>('return document.getElementById(\"a\");')\n            )\n            .then(element => element && element.getTagName())\n            .then(works, broken);\n      }\n\n      // At least Selendroid 0.9.0 treats fully transparent elements as\n      // displayed, but all others do not\n      if (capabilities.brokenElementDisplayedOpacity == null) {\n        testedCapabilities.brokenElementDisplayedOpacity = () =>\n          get('<!DOCTYPE html><div id=\"a\" style=\"opacity: .1;\">a</div>')\n            .then(() =>\n              // IE<9 do not support CSS opacity so should not be\n              // involved in this test\n              session.execute(\n                'var o = document.getElementById(\"a\").style.opacity; return o && o.charAt(0) === \"0\";'\n              )\n            )\n            .then(supportsOpacity => {\n              if (!supportsOpacity) {\n                return works();\n              } else {\n                return session\n                  .execute('document.getElementById(\"a\").style.opacity = \"0\";')\n                  .then(() => session.findById('a'))\n                  .then(element => element.isDisplayed());\n              }\n            })\n            .catch(broken);\n      }\n\n      // At least ChromeDriver 2.9 treats elements that are offscreen as\n      // displayed, but others do not\n      if (capabilities.brokenElementDisplayedOffscreen == null) {\n        testedCapabilities.brokenElementDisplayedOffscreen = () => {\n          const pageText =\n            '<!DOCTYPE html><div id=\"a\" style=\"left: 0; position: absolute; top: -1000px;\">a</div>';\n          return get(pageText)\n            .then(() => session.findById('a'))\n            .then(element => element.isDisplayed())\n            .catch(broken);\n        };\n      }\n\n      // The feature test for this causes some browsers to hang, so it's\n      // just flagged directly for Edge for now.\n      // testedCapabilities.brokenFileSendKeys = function () {\n      // \treturn get('<!DOCTYPE html><input type=\"file\" id=\"i1\">').then(function () {\n      // \t\tvar element;\n      // \t\treturn session.findById('i1')\n      // \t\t\t.then(function (element) {\n      // \t\t\t\treturn element.type('./Server.js');\n      // \t\t\t}).then(function () {\n      // \t\t\t\treturn session.execute(function () {\n      // \t\t\t\t\treturn document.getElementById('i1').value;\n      // \t\t\t\t});\n      // \t\t\t}).then(function (text) {\n      // \t\t\t\tif (!/Server.js$/.test(text)) {\n      // \t\t\t\t\tthrow new Error('mismatch');\n      // \t\t\t\t}\n      // \t\t\t});\n      // \t}).then(works, broken);\n      // };\n\n      // At least Safari 11-12 include non-rendered text when retrieving\n      // \"visible\" text.\n      if (capabilities.brokenVisibleText == null) {\n        testedCapabilities.brokenVisibleText = () =>\n          get(\n            '<!DOCTYPE html><div id=\"d\">This is<span style=\"display:none\"> really</span> great</div>'\n          )\n            .then(() =>\n              session\n                .findById('d')\n                .then(element => element.getVisibleText())\n                .then(text => {\n                  if (text !== 'This is great') {\n                    throw new Error('Incorrect text');\n                  }\n                })\n            )\n            .then(works, broken);\n      }\n\n      // At least MS Edge Driver 14316 doesn't normalize whitespace\n      // properly when retrieving text. Text may contain \"\\r\\n\" pairs\n      // rather than \"\\n\", and there may be extraneous whitespace\n      // adjacent to \"\\r\\n\" pairs and at the start and end of the text.\n      if (capabilities.brokenWhitespaceNormalization == null) {\n        testedCapabilities.brokenWhitespaceNormalization = () =>\n          get('<!DOCTYPE html><div id=\"d\">This is\\n<br>a test\\n</div>')\n            .then(() =>\n              session\n                .findById('d')\n                .then(element => element.getVisibleText())\n                .then(text => {\n                  if (/\\r\\n/.test(text) || /\\s+$/.test(text)) {\n                    throw new Error('invalid whitespace');\n                  }\n                })\n            )\n            .then(works, broken);\n      }\n\n      // At least geckodriver 0.15.0 and Firefox 51.0.1 don't properly\n      // normalize link text when using the 'link text' locator strategy.\n      if (capabilities.brokenLinkTextLocator == null) {\n        testedCapabilities.brokenLinkTextLocator = () =>\n          get(\n            '<!DOCTYPE html><a id=\"d\">What a cute<span style=\"display:none\">, ' +\n              'yellow</span> backpack</a><a id=\"e\">What a cute, yellow backpack</a>'\n          )\n            .then(() =>\n              session\n                .findByLinkText('What a cute, yellow backpack')\n                .then(element => element.getAttribute('id'))\n                .then(attr => {\n                  if (attr !== 'e') {\n                    throw new Error('incorrect link was found');\n                  }\n                })\n            )\n            .then(works, broken);\n      }\n\n      // At least MS Edge Driver 14316 doesn't return elements' computed\n      // styles\n      if (capabilities.brokenComputedStyles == null) {\n        testedCapabilities.brokenComputedStyles = () => {\n          const pageText =\n            '<!DOCTYPE html><style>a { background: purple }</style><a id=\"a1\">foo</a>';\n          return get(pageText)\n            .then(() => session.findById('a1'))\n            .then(element => element.getComputedStyle('background-color'))\n            .then(value => {\n              if (!value) {\n                throw new Error('empty style');\n              }\n            })\n            .then(works, broken);\n        };\n      }\n\n      if (capabilities.brokenOptionSelect == null) {\n        // At least MS Edge Driver 14316 doesn't allow selection\n        // option elements to be clicked.\n        testedCapabilities.brokenOptionSelect = () =>\n          get(\n            '<!DOCTYPE html><select id=\"d\"><option id=\"o1\" value=\"foo\">foo</option>' +\n              '<option id=\"o2\" value=\"bar\" selected>bar</option></select>'\n          )\n            .then(() => session.findById('d'))\n            .then(element => element.click())\n            .then(() => session.findById('o1'))\n            .then(element => element.click())\n            .then(works, broken);\n      }\n\n      // At least MS Edge driver 10240 doesn't support getting the page\n      // source\n      if (capabilities.brokenPageSource == null) {\n        testedCapabilities.brokenPageSource = () =>\n          session.getPageSource().then(works, broken);\n      }\n\n      if (capabilities.brokenSubmitElement == null) {\n        // There is inconsistency across all drivers as to whether or\n        // not submitting a form button should cause the form button to\n        // be submitted along with the rest of the form; it seems most\n        // likely that tests do want the specified button to act as\n        // though someone clicked it when it is submitted, so the\n        // behaviour needs to be normalised\n        testedCapabilities.brokenSubmitElement = () =>\n          get(\n            '<!DOCTYPE html><form method=\"get\" action=\"about:blank\">' +\n              '<input id=\"a\" type=\"submit\" name=\"a\" value=\"a\"></form>'\n          )\n            .then(() => session.findById('a'))\n            .then(element => element.submit())\n            .then(() => session.getCurrentUrl())\n            .then(url => url.indexOf('a=a') === -1)\n            .catch(broken);\n      }\n\n      // At least MS Edge driver 10240 doesn't support window sizing\n      // commands\n      if (capabilities.brokenWindowSize == null) {\n        testedCapabilities.brokenWindowSize = () =>\n          session.getWindowSize().then(works, broken);\n      }\n\n      // At least Chrome on Mac doesn't properly maximize. See\n      // https://bugs.chromium.org/p/chromedriver/issues/detail?id=985\n      if (capabilities.brokenWindowMaximize == null) {\n        testedCapabilities.brokenWindowMaximize = () => {\n          let originalSize: { width: number; height: number };\n          return session\n            .getWindowSize()\n            .then(size => {\n              originalSize = size;\n              return session.setWindowSize(size.width - 10, size.height - 10);\n            })\n            .then(() => session.maximizeWindow())\n            .then(() => session.getWindowSize())\n            .then(size => {\n              return (\n                size.width > originalSize.width &&\n                size.height > originalSize.height\n              );\n            })\n            .catch(broken);\n        };\n      }\n\n      // At least Selendroid 0.9.0 has a bug where it catastrophically\n      // fails to retrieve available types; they have tried to hardcode\n      // the available log types in this version so we can just return\n      // the same hardcoded list ourselves.\n      // At least InternetExplorerDriver 2.41.0 also fails to provide log\n      // types. Firefox 49+ (via geckodriver) doesn't support retrieving\n      // logs or log types, and may hang the session.\n      if (capabilities.fixedLogTypes == null) {\n        testedCapabilities.fixedLogTypes = () =>\n          session\n            .getAvailableLogTypes()\n            .then(unsupported, (error: LeadfootError) => {\n              if (\n                capabilities.browserName === 'selendroid' &&\n                error.response!.text.length === 0\n              ) {\n                return ['logcat'];\n              }\n\n              return [];\n            });\n      }\n\n      // At least Microsoft Edge 10240 doesn't support timeout values of\n      // 0.\n      if (capabilities.brokenZeroTimeout == null) {\n        testedCapabilities.brokenZeroTimeout = () =>\n          session.setTimeout('implicit', 0).then(works, broken);\n      }\n\n      if (capabilities.brokenWindowSwitch == null) {\n        testedCapabilities.brokenWindowSwitch = () =>\n          session\n            .getCurrentWindowHandle()\n            .then(handle => session.switchToWindow(handle))\n            .then(works, broken);\n      }\n\n      if (capabilities.brokenParentFrameSwitch == null) {\n        testedCapabilities.brokenParentFrameSwitch = () =>\n          session.switchToParentFrame().then(works, broken);\n      }\n\n      // This URL is used by several tests below\n      const scrollTestUrl =\n        '<!DOCTYPE html><div id=\"a\" style=\"margin: 3000px;\"></div>';\n\n      // ios-driver 0.6.6-SNAPSHOT April 2014 calculates position based\n      // on a bogus origin and does not account for scrolling\n      if (capabilities.brokenElementPosition == null) {\n        testedCapabilities.brokenElementPosition = () =>\n          get(scrollTestUrl)\n            .then(() => session.findById('a'))\n            .then(element => element.getPosition())\n            .then(position => position.x !== 3000 || position.y !== 3000)\n            .catch(broken);\n      }\n\n      // At least ios-driver 0.6.6-SNAPSHOT April 2014 will never\n      // complete a refresh call\n      if (capabilities.brokenRefresh == null) {\n        testedCapabilities.brokenRefresh = () =>\n          session\n            .get('about:blank?1')\n            .then(() => {\n              let timer: NodeJS.Timer;\n              let refresh: CancellablePromise<boolean | void>;\n\n              return new Task(\n                resolve => {\n                  let settled = false;\n\n                  refresh = session\n                    .refresh()\n                    .then(\n                      () => {\n                        settled = true;\n                        clearTimeout(timer);\n                        resolve(false);\n                      },\n                      () => {\n                        settled = true;\n                        clearTimeout(timer);\n                        resolve(true);\n                      }\n                    )\n                    .finally(() => {\n                      if (!settled) {\n                        resolve(true);\n                      }\n                    });\n\n                  timer = setTimeout(function() {\n                    refresh.cancel();\n                  }, 2000);\n                },\n                () => {\n                  clearTimeout(timer);\n                  refresh.cancel();\n                }\n              );\n            })\n            .catch(broken);\n      }\n\n      if (capabilities.brokenMouseEvents == null && capabilities.mouseEnabled) {\n        // At least IE 10 and 11 on SauceLabs don't fire native mouse\n        // events consistently even though they support moveMouseTo\n        testedCapabilities.brokenMouseEvents = () =>\n          get(\n            '<!DOCTYPE html><div id=\"foo\">foo</div>' +\n              '<script>window.counter = 0; var d = document; d.onmousemove = function () { window.counter++; };</script>'\n          )\n            .then(() => session.findById('foo'))\n            .then(element => session.moveMouseTo(element, 20, 20))\n            .then(() => sleep(100))\n            .then(() => session.execute('return window.counter;'))\n            .then(counter => (counter > 0 ? works() : broken()), broken);\n\n        // At least ChromeDriver 2.12 through 2.19 will throw an error\n        // if mouse movement relative to the <html> element is\n        // attempted\n        if (capabilities.brokenHtmlMouseMove == null) {\n          testedCapabilities.brokenHtmlMouseMove = () =>\n            get('<!DOCTYPE html><html></html>')\n              .then(() =>\n                session\n                  .findByTagName('html')\n                  .then(element => session.moveMouseTo(element, 0, 0))\n              )\n              .then(works, broken);\n        }\n      }\n\n      // At least ChromeDriver 2.9.248307 does not correctly emit the\n      // entire sequence of events that would normally occur during a\n      // double-click\n      if (capabilities.brokenDoubleClick == null) {\n        testedCapabilities.brokenDoubleClick = function retry(): CancellablePromise<\n          any\n        > {\n          // InternetExplorerDriver is not buggy, but IE9 in\n          // quirks-mode is; since we cannot do feature tests in\n          // standards-mode in IE<10, force the value to false\n          // since it is not broken in this browser\n          if (\n            capabilities.browserName === 'internet explorer' &&\n            capabilities.browserVersion === '9'\n          ) {\n            return Task.resolve(false);\n          }\n\n          return get(\n            '<!DOCTYPE html><html><body><button id=\"clicker\">Clicker</button><script>' +\n              'window.counter = 0; var d = document; d.onclick = ' +\n              'd.onmousedown = d.onmouseup = function () { window.counter++; };' +\n              '</script></body></html>'\n          )\n            .then(() => session.findById('clicker'))\n            .then(element => session.moveMouseTo(element))\n            .then(() => sleep(100))\n            .then(() => session.doubleClick())\n            .then(() => session.execute('return window.counter;'))\n            .then(counter => {\n              // InternetExplorerDriver 2.41.0 has a race\n              // condition that makes this test sometimes\n              // fail\n              /* istanbul ignore if: inconsistent race condition */\n              if (counter === 0) {\n                return retry();\n              }\n\n              return counter !== 6;\n            })\n            .catch(broken);\n        };\n      }\n\n      if (capabilities.touchEnabled) {\n        // At least Selendroid 0.9.0 fails to perform a long tap due to\n        // an INJECT_EVENTS permission failure\n        if (capabilities.brokenLongTap == null) {\n          testedCapabilities.brokenLongTap = () =>\n            session\n              .findByTagName('body')\n              .then(element => session.longTap(element))\n              .then(works, broken);\n\n          // At least ios-driver 0.6.6-SNAPSHOT April 2014 claims to\n          // support touch press/move/release but actually fails when you\n          // try to use the commands\n          if (capabilities.brokenMoveFinger == null) {\n            testedCapabilities.brokenMoveFinger = () =>\n              session\n                .pressFinger(0, 0)\n                .then(\n                  works,\n                  error =>\n                    error.name === 'UnknownCommand' ||\n                    error.message.indexOf('need to specify the JS') > -1\n                );\n          }\n\n          // Touch scroll in ios-driver 0.6.6-SNAPSHOT is broken, does\n          // not scroll at all; in selendroid 0.9.0 it ignores the\n          // element argument\n          if (capabilities.brokenTouchScroll == null) {\n            testedCapabilities.brokenTouchScroll = () =>\n              get(scrollTestUrl)\n                .then(() => session.touchScroll(0, 20))\n                .then(() => session.execute('return window.scrollY !== 20;'))\n                .then(isBroken => {\n                  if (isBroken) {\n                    return true;\n                  }\n\n                  return session\n                    .findById('a')\n                    .then(element => session.touchScroll(element, 0, 0))\n                    .then(() =>\n                      session.execute('return window.scrollY !== 3000;')\n                    );\n                })\n                .catch(broken);\n          }\n        }\n\n        // Touch flick in ios-driver 0.6.6-SNAPSHOT is broken, does not\n        // scroll at all except in very broken ways if very tiny speeds\n        // are provided and the flick goes in the wrong direction\n        if (capabilities.brokenFlickFinger == null) {\n          testedCapabilities.brokenFlickFinger = () =>\n            get(scrollTestUrl)\n              .then(() => session.flickFinger(0, 400))\n              .then(() => session.execute('return window.scrollY === 0;'))\n              .catch(broken);\n        }\n      }\n\n      if (\n        capabilities.supportsCssTransforms &&\n        capabilities.brokenCssTransformedSize == null\n      ) {\n        testedCapabilities.brokenCssTransformedSize = () =>\n          get(\n            '<!DOCTYPE html><style>#a{width:8px;height:8px;' +\n              '-ms-transform:scale(0.5);-moz-transform:scale(0.5);' +\n              '-webkit-transform:scale(0.5);transform:scale(0.5);}' +\n              '</style><div id=\"a\"></div>'\n          )\n            .then(() =>\n              session\n                .execute<Element>('return document.getElementById(\"a\");')\n                .then(element => element.getSize())\n                .then(\n                  dimensions =>\n                    dimensions.width !== 4 || dimensions.height !== 4\n                )\n            )\n            .catch(broken);\n      }\n\n      // This test will cause at least Edge 18 (44) to hang\n      if (!isMsEdge(capabilities)) {\n        // At least Safari 12 isn't properly detecting disabled elements\n        if (capabilities.brokenElementEnabled == null) {\n          testedCapabilities.brokenElementEnabled = () =>\n            get('<!DOCTYPE html><input id=\"dis\" type=\"text\" disabled>').then(\n              () =>\n                session\n                  .execute<Element>('return document.getElementById(\"dis\");')\n                  .then(element => element.isEnabled())\n                  .then(isEnabled => (isEnabled ? broken() : works()))\n                  .catch(broken)\n            );\n        }\n      }\n\n      return Task.all(\n        Object.keys(testedCapabilities).map(key => testedCapabilities[key])\n      ).then(() => testedCapabilities);\n    };\n\n    if (capabilities._filled) {\n      return Task.resolve(session);\n    }\n\n    // At least geckodriver 0.11 and Firefox 49+ may hang when getting\n    // 'about:blank' in the first request\n    const promise: CancellablePromise<Session | void> = isFirefox(\n      capabilities,\n      49,\n      Infinity\n    )\n      ? Task.resolve(session)\n      : session.get('about:blank');\n\n    return promise\n      .then(discoverServerFeatures)\n      .then(addCapabilities)\n      .then(discoverFeatures)\n      .then(addCapabilities)\n      .then(() => session.get('about:blank'))\n      .then(discoverDefects)\n      .then(addCapabilities)\n      .then(() => session.get('about:blank'))\n      .then(() => session);\n  }\n\n  /**\n   * Gets a list of all currently active remote control sessions on this\n   * server.\n   */\n  getSessions(): CancellablePromise<Session[]> {\n    return this.get('sessions').then(function(sessions: any) {\n      // At least BrowserStack is now returning an array for the sessions\n      // response\n      if (sessions && !Array.isArray(sessions)) {\n        sessions = returnValue(sessions);\n      }\n\n      // At least ChromeDriver 2.19 uses the wrong keys\n      // https://code.google.com/p/chromedriver/issues/detail?id=1229\n      sessions.forEach(function(session: any) {\n        if (session.sessionId && !session.id) {\n          session.id = session.sessionId;\n        }\n      });\n\n      return sessions;\n    });\n  }\n\n  /**\n   * Gets information on the capabilities of a given session from the server.\n   * The list of capabilities returned by this command will not include any\n   * of the extra session capabilities detected by Leadfoot and may be\n   * inaccurate.\n   */\n  getSessionCapabilities(sessionId: string): CancellablePromise<Capabilities> {\n    return this.get('session/$0', undefined, [sessionId]).then(returnValue);\n  }\n\n  /**\n   * Terminates a session on the server.\n   */\n  deleteSession(sessionId: string) {\n    return this.delete<void>('session/$0', undefined, [sessionId]).then(noop);\n  }\n}\n\nfunction getErrorName(error: { name: string; detail: { error: string } }) {\n  if (\n    // Most browsers use 'Error' as the generic error name, but at least Safari\n    // 12 uses 'UnknownError'\n    (error.name !== 'Error' && error.name !== 'UnknownError') ||\n    !error.detail ||\n    !error.detail.error\n  ) {\n    return error.name;\n  }\n\n  // desc will be something like 'javascript error' or 'no such window'\n  const desc = error.detail.error;\n\n  // 'javascript error' is a special case because of...case (javascript ->\n  // JavaScript)\n  if (desc === 'javascript error') {\n    return 'JavaScriptError';\n  }\n\n  // For other error descriptions, just combine the description words into a\n  // Pascal case name\n  return desc\n    .split(' ')\n    .map(word => `${word[0].toUpperCase()}${word.slice(1)}`)\n    .join('');\n}\n\nfunction isAndroid(capabilities: Capabilities) {\n  const { browserName = '' } = capabilities;\n  return browserName.toLowerCase() === 'android';\n}\n\nfunction isAndroidEmulator(capabilities: Capabilities) {\n  const { deviceName = '' } = capabilities;\n  return deviceName.toLowerCase() === 'android emulator';\n}\n\nfunction isChrome(\n  capabilities: Capabilities,\n  minOrExactVersion?: number,\n  maxVersion?: number\n) {\n  const { browserName = '' } = capabilities;\n  if (browserName.toLowerCase() !== 'chrome') {\n    return false;\n  }\n  return isValidVersion(capabilities, minOrExactVersion, maxVersion);\n}\n\nfunction isIos(capabilities: Capabilities) {\n  const { platform = '', platformName = '' } = capabilities;\n  return (platformName || platform).toLowerCase() === 'ios';\n}\n\nfunction isMac(capabilities: Capabilities) {\n  const { platform = '', platformName = '' } = capabilities;\n  const _platform = platform || platformName;\n  return (\n    (/mac(os)?/i.test(_platform) || /darwin/i.test(_platform)) &&\n    _platform.toLowerCase() !== 'ios'\n  );\n}\n\nexport function isMsEdge(\n  capabilities: Capabilities,\n  minOrExactVersion?: number,\n  maxVersion?: number\n) {\n  const { browserName = '' } = capabilities;\n  if (browserName.toLowerCase() !== 'microsoftedge') {\n    return false;\n  }\n\n  return isValidVersion(capabilities, minOrExactVersion, maxVersion);\n}\n\nexport function isInternetExplorer(\n  capabilities: Capabilities,\n  minOrExactVersion?: number,\n  maxVersion?: number\n) {\n  const { browserName = '' } = capabilities;\n  if (browserName.toLowerCase() !== 'internet explorer') {\n    return false;\n  }\n\n  return isValidVersion(capabilities, minOrExactVersion, maxVersion);\n}\n\nexport function isSafari(\n  capabilities: Capabilities,\n  minOrExactVersion?: number,\n  maxVersion?: number\n) {\n  const { browserName = '' } = capabilities;\n  if (browserName.toLowerCase() !== 'safari') {\n    return false;\n  }\n\n  return isValidVersion(capabilities, minOrExactVersion, maxVersion);\n}\n\nexport function isFirefox(\n  capabilities: Capabilities,\n  minOrExactVersion?: number,\n  maxVersion?: number\n) {\n  const { browserName = '' } = capabilities;\n  if (browserName.toLowerCase() !== 'firefox') {\n    return false;\n  }\n\n  return isValidVersion(capabilities, minOrExactVersion, maxVersion);\n}\n\n/**\n * Check if a browserVersion is between a min (inclusive) and a max\n * (exclusive). If only one version is specified, it is treated as an exact\n * match.\n */\nfunction isValidVersion(\n  capabilities: Capabilities,\n  minOrExactVersion?: number,\n  maxVersion?: number\n) {\n  if (minOrExactVersion != null) {\n    const version = parseFloat(\n      (capabilities.browserVersion || capabilities.version)!\n    );\n\n    if (maxVersion != null) {\n      if (version < minOrExactVersion) {\n        return false;\n      }\n      if (version >= maxVersion) {\n        return false;\n      }\n    } else if (version !== minOrExactVersion) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\nfunction noop() {}\n\n/**\n * Returns the actual response value from the remote environment.\n *\n * @param response JsonWireProtocol response object.\n * @returns The actual response value.\n */\nfunction returnValue(response: any): any {\n  return response.value;\n}\n\ninterface ResponseData {\n  response: Response;\n  data: any;\n}\n"]}