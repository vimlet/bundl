<template>
    <app-combobox class="app-doc-viewer-templates-api-menu-properties app-doc-viewer-display-none"
        fixed-label="Properties" eon-ref="properties">
        <eon-item class="app-doc-api-menu-item-search-item">
            <eon-searchbar class="app-doc-viewer-templates-api-menu-properties-search"
                eon-ref="propertiesSearchSearchbar">
                <eon-text name="name" placeholder="Search" eon-ref="propertiesSearchText"></eon-text>
            </eon-searchbar>
        </eon-item>
    </app-combobox>
    <app-combobox class="app-doc-viewer-templates-api-menu-html-attributes app-doc-viewer-display-none"
        fixed-label="Html Attributes" eon-ref="htmlAttributes">
        <eon-item class="app-doc-api-menu-item-search-item">
            <eon-searchbar class="app-doc-viewer-templates-api-menu-html-attributes-search"
                eon-ref="htmlAttributesSearchSearchbar">
                <eon-text name="name" placeholder="Search" eon-ref="htmlAttributesSearchText"></eon-text>
            </eon-searchbar>
        </eon-item>
    </app-combobox>
    <app-combobox class="app-doc-viewer-templates-api-menu-functions app-doc-viewer-display-none"
        fixed-label="Functions" eon-ref="functions">
        <eon-item class="app-doc-api-menu-item-search-item">
            <eon-searchbar class="app-doc-viewer-templates-api-menu-functions-search"
                eon-ref="functionsSearchSearchbar">
                <eon-text name="name" placeholder="Search" eon-ref="functionsSearchText"></eon-text>
            </eon-searchbar>
        </eon-item>
    </app-combobox>
    <div class="app-separator"></div>
    <app-vicon class="app-doc-viewer-templates-api-menu-private" title-right="true" vicon="visibility"
        label="Show Private" eon-ref="togglePrivate"></app-vicon>
</template>

<script>
    eon.element({
        name: "app-doc-viewer-templates-api-menu",
        style: "app-doc-viewer-templates-api-menu.css",
        dependencies: [
            "../../../../app-vicon",
            "../../../../../eon/ui/eon-searchbar",
            "../../../../../eon/ui/eon-text",
            "../../../../../eon/ui/eon-item",
            "../../../../app-combobox"
        ],
        properties: {
            // @html-property value (public) [Selected value]
            value: {
                value: "",
                observe: true
            }
        },

        privateProperties: {
            refs: {
                value: {}
            },
            misc: {
                value: {
                    folderNodeOrderRegex: new RegExp("\\[\\d+\\]", "gm")
                }
            }
        },

        functions: {
            // @function setValue (public) @param value
            setValue: function (value) {
                var el = this;
                el.reset();
                if (value.properties.length > 0) {
                    el._setMenu(value.properties, el._refs.properties, el._refs.propertiesSearchSearchbar, el._refs.propertiesSearchText, "property");
                }
                if (value.htmlAttributes.length > 0) {
                    el._setMenu(value.htmlAttributes, el._refs.htmlAttributes, el._refs.htmlAttributesSearchSearchbar, el._refs.htmlAttributesSearchText,
                        "htmlAttribute");
                }
                if (value.methods.length > 0) {
                    el._setMenu(value.methods, el._refs.functions, el._refs.functionsSearchSearchbar, el._refs.functionsSearchText, "function");
                }
                el.togglePrivate();
            },
            // @function togglePrivate (public) [Hide/Show private elements]
            togglePrivate: function () {
                var el = this;
                el._misc.private.forEach(function (private) {
                    private.classList.toggle("app-doc-viewer-private-display-none");
                });
            },
            // @function reset (public) [Empty the menu]
            reset: function () {
                var el = this;
                el._misc.private = [];
                el._refs.properties.removeItem(el._misc.item.property);
                el._refs.htmlAttributes.removeItem(el._misc.item.htmlATtribute);
                el._refs.functions.removeItem(el._misc.item.function);
                el._misc.item = {
                    property: [],
                    htmlAttribute: [],
                    function: []
                }
                el._refs.properties.classList.add("app-doc-viewer-display-none");
                el._refs.htmlAttributes.classList.add("app-doc-viewer-display-none");
                el._refs.functions.classList.add("app-doc-viewer-display-none");
            }
        },

        privateFunctions: {
            // @function _init (private) [Initialize component]
            init: function () {
                var el = this;
                el._setUp();
            },
            // @function _setUp (private) [Set up component]
            setUp: function () {
                var el = this;
                if (el.value) {
                    el.setValue(el.value);
                }
                el._refs.propertiesSearchText.addEventListener("keyup", function (e) {
                    el._refs.propertiesSearchSearchbar.search();
                });
                el._refs.htmlAttributesSearchText.addEventListener("keyup", function (e) {
                    el._refs.htmlAttributesSearchSearchbar.search();
                });
                el._refs.functionsSearchText.addEventListener("keyup", function (e) {
                    el._refs.functionsSearchSearchbar.search();
                });
                el._refs.togglePrivate.addEventListener("click", function (e) {
                    if(el._refs.togglePrivate.vicon  === "visibility"){
                    el._refs.togglePrivate.vicon = "visibility-off";
                    el._refs.togglePrivate.label = "Hide Private";
                    }else{
                    el._refs.togglePrivate.vicon = "visibility";
                    el._refs.togglePrivate.label = "Show Private";
                    }
                    eon.triggerCallback("onTogglePrivate", el);
                });
                el._misc.item = {
                    property: [],
                    htmlAttribute: [],
                    function: []
                }                
            },
            // @function _setMenu (private) [Fill menu] @param data @param menu @param search @param text @param type
            setMenu: function (data, menu, search, text, type) {
                var el = this;
                search.onSearch(function (filters) {
                    for (var key in menu._ref.combobox._misc.items) {
                        var item = menu._ref.combobox._misc.items[key];
                        if (!item.classList.contains("app-doc-api-menu-item-search-item")) {
                            if (item.displayValue && item.displayValue.toLowerCase().indexOf(text
                                    .value.toLowerCase()) > -1) {
                                item.classList.remove("app-doc-viewer-display-none");
                            } else {
                                item.classList.add("app-doc-viewer-display-none");
                            }
                        }
                    }
                });
                data.forEach(function (elem) {
                    var item = document.createElement("eon-item");
                    item.name = elem.name;
                    item.value = elem.name;
                    item.displayValue = elem.name;
                    if (elem.scope == "private") {
                        item.classList.add("app-doc-viewer-templates-api-private");
                        el._misc.private.push(item);
                    }
                    item.addEventListener("click", function (e) {
                        el._refs.viewer.goTo("app-doc-viewer-" + type + "-" + elem.name);
                    });                    
                    el._misc.item[type].push(item);
                    menu.addItem(item);
                });
                menu.classList.remove("app-doc-viewer-display-none");
            }
        },

        onCreated: function () {
            var el = this;
            eon.createCallback("onTogglePrivate", el);
            el._refs.viewer = document.querySelector("app-doc-viewer-templates-api-content");
        },

        onRender: function () {
            var el = this;
            el._init();
        },

        onPropertyChanged: function (attrName, oldVal, newVal) {
            var el = this;
            switch (attrName) { 
                case "value":
                    this.setValue(newVal);
                    break;
            }
        }



    });
</script>